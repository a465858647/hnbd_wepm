window.GeoGlobe=window.GeoGlobe||{},window.GeoGlobe.Class=window.GeoGlobe.Class||{},window.GeoGlobe.LngLatBounds=window.GeoGlobe.LngLatBounds||{},window.GeoGlobe.LngLat=window.GeoGlobe.LngLat||{},window.GeoGlobe.Filter=window.GeoGlobe.Filter||{},window.GeoGlobe.Format=window.GeoGlobe.Format||{},window.GeoGlobe.Protocol=window.GeoGlobe.Protocol||{},window.GeoGlobe.Query=window.GeoGlobe.Query||{},window.GeoGlobe.Service=window.GeoGlobe.Service||{},window.GeoGlobe.Analysis=window.GeoGlobe.Analysis||{},GeoGlobe.getScriptLocation=function(e){for(var t="",o=new RegExp("(^|(.*?\\/))("+e+")(\\?|$)"),r=document.getElementsByTagName("script"),i=0,n=r.length;i<n;i++){var s=r[i].getAttribute("src");if(s){var a=s.match(o);if(a){t=a[1];break}}}return t},GeoGlobe.createNS=function(e){for(var t=e.split("."),o=window,r=0;r<t.length;r++)o[t[r]]||(o[t[r]]={}),o=o[t[r]]},GeoGlobe.Class=function(){var e=arguments.length,t=arguments[0],o=arguments[e-1],r="function"==typeof o.initialize?o.initialize:function(){t.prototype.initialize.apply(this,arguments)};if(e>1)[r,t].concat(Array.prototype.slice.call(arguments).slice(1,e-1),o);else r.prototype=o;return r},GeoGlobe.Class4OL=function(){var e=arguments.length,t=arguments[0],o=arguments[e-1],r="function"==typeof o.initialize?o.initialize:function(){t.prototype.initialize.apply(this,arguments)};if(e>1){var i=[r,t].concat(Array.prototype.slice.call(arguments).slice(1,e-1),o);GeoGlobe.inherit.apply(null,i)}else r.prototype=o;return r},GeoGlobe.inherit=function(e,t){var o,r,i,n=function(){};for(n.prototype=t.prototype,e.prototype=new n,o=2,r=arguments.length;o<r;o++)"function"==typeof(i=arguments[o])&&(i=i.prototype),GeoGlobe.Util.extend(e.prototype,i)},GeoGlobe.Util=GeoGlobe.Util||{},GeoGlobe.Util.extend=function(e,t){if(e=e||{},t){for(var o in t){var r=t[o];void 0!==r&&(e[o]=r)}!("function"==typeof window.Event&&t instanceof window.Event)&&t.hasOwnProperty&&t.hasOwnProperty("toString")&&(e.toString=t.toString)}return e},GeoGlobe.Util.deepExtend=function(e){for(var t=1;t<arguments.length;t++)for(var o in arguments[t])if(arguments[t].hasOwnProperty(o))switch(GeoGlobe.Util.getType(arguments[t][o])){case"array":e.hasOwnProperty(o)&&"array"===GeoGlobe.Util.getType(e[o])?GeoGlobe.Util.deepExtend(e[o],arguments[t][o]):e[o]=GeoGlobe.Util.deepExtend([],arguments[t][o]);break;case"object":e.hasOwnProperty(o)&&"object"===GeoGlobe.Util.getType(e[o])?GeoGlobe.Util.deepExtend(e[o],arguments[t][o]):e[o]=GeoGlobe.Util.deepExtend({},arguments[t][o]);break;default:e[o]=arguments[t][o]}return e},GeoGlobe.Util=GeoGlobe.Util||{},GeoGlobe.Util.getElement=function(){for(var e=[],t=0,o=arguments.length;t<o;t++){var r=arguments[t];if("string"==typeof r&&(r=document.getElementById(r)),1==arguments.length)return r;e.push(r)}return e},GeoGlobe.Util.isElement=function(e){return!(!e||1!==e.nodeType)},GeoGlobe.Util.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)},GeoGlobe.Util.removeItem=function(e,t){for(var o=e.length-1;o>=0;o--)e[o]==t&&e.splice(o,1);return e},GeoGlobe.Util.indexOf=function(e,t){if("function"==typeof e.indexOf)return e.indexOf(t);for(var o=0,r=e.length;o<r;o++)if(e[o]==t)return o;return-1},GeoGlobe.Util.dotless=/\./g,GeoGlobe.IMAGE_RELOAD_ATTEMPTS=0,GeoGlobe.Util.alphaHackNeeded=null,GeoGlobe.Util.alphaHack=function(){if(null==GeoGlobe.Util.alphaHackNeeded){var e=navigator.appVersion.split("MSIE"),t=parseFloat(e[1]),o=!1;try{o=!!document.body.filters}catch(e){}GeoGlobe.Util.alphaHackNeeded=o&&t>=5.5&&t<7}return GeoGlobe.Util.alphaHackNeeded},GeoGlobe.Util.upperCaseObject=function(e){var t={};for(var o in e)t[o.toUpperCase()]=e[o];return t},GeoGlobe.Util.applyDefaults=function(e,t){e=e||{};var o="function"==typeof window.Event&&t instanceof window.Event;for(var r in t)(void 0===e[r]||!o&&t.hasOwnProperty&&t.hasOwnProperty(r)&&!e.hasOwnProperty(r))&&(e[r]=t[r]);return!o&&t&&t.hasOwnProperty&&t.hasOwnProperty("toString")&&!e.hasOwnProperty("toString")&&(e.toString=t.toString),e},GeoGlobe.Util.getParameterString=function(e){var t=[];for(var o in e){var r=e[o];if(null!=r&&"function"!=typeof r){var i;if("object"==typeof r&&r.constructor==Array){for(var n,s=[],a=0,l=r.length;a<l;a++)n=r[a],s.push(encodeURIComponent(null===n||void 0===n?"":n));i=s.join(",")}else i=encodeURIComponent(r);t.push(encodeURIComponent(o)+"="+i)}}return t.join("&")},GeoGlobe.Util.urlAppend=function(e,t){var o=e;if(t){var r=(e+" ").split(/[?&]/);o+=" "===r.pop()?t:r.length?"&"+t:"?"+t}return o},GeoGlobe.Util.getImagesLocation=function(){return GeoGlobe.ImgPath||GeoGlobe._getScriptLocation()+"img/"},GeoGlobe.Util.getImageLocation=function(e){return GeoGlobe.Util.getImagesLocation()+e},GeoGlobe.Util.Try=function(){for(var e=null,t=0,o=arguments.length;t<o;t++){var r=arguments[t];try{e=r();break}catch(e){}}return e},GeoGlobe.Util.getXmlNodeValue=function(e){var t=null;return GeoGlobe.Util.Try(function(){(t=e.text)||(t=e.textContent),t||(t=e.firstChild.nodeValue)},function(){t=e.textContent}),t},GeoGlobe.Util.mouseLeft=function(e,t){for(var o=e.relatedTarget?e.relatedTarget:e.toElement;o!=t&&null!=o;)o=o.parentNode;return o!=t},GeoGlobe.Util.DEFAULT_PRECISION=14,GeoGlobe.Util.toFloat=function(e,t){return null==t&&(t=GeoGlobe.Util.DEFAULT_PRECISION),"number"!=typeof e&&(e=parseFloat(e)),0===t?e:parseFloat(e.toPrecision(t))},GeoGlobe.Util.rad=function(e){return e*Math.PI/180},GeoGlobe.Util.deg=function(e){return 180*e/Math.PI},GeoGlobe.Util.VincentyConstants={a:6378137,b:6356752.3142,f:1/298.257223563},GeoGlobe.Util.distVincenty=function(e,t){for(var o=GeoGlobe.Util.VincentyConstants,r=o.a,i=o.b,n=o.f,s=GeoGlobe.Util.rad(t.lng-e.lng),a=Math.atan((1-n)*Math.tan(GeoGlobe.Util.rad(e.lat))),l=Math.atan((1-n)*Math.tan(GeoGlobe.Util.rad(t.lat))),u=Math.sin(a),c=Math.cos(a),p=Math.sin(l),h=Math.cos(l),f=s,d=2*Math.PI,G=20;Math.abs(f-d)>1e-12&&--G>0;){var m=Math.sin(f),g=Math.cos(f),y=Math.sqrt(h*m*(h*m)+(c*p-u*h*g)*(c*p-u*h*g));if(0==y)return 0;var b=u*p+c*h*g,S=Math.atan2(y,b),v=Math.asin(c*h*m/y),N=Math.cos(v)*Math.cos(v),w=b-2*u*p/N,C=n/16*N*(4+n*(4-3*N));d=f,f=s+(1-C)*n*Math.sin(v)*(S+C*y*(w+C*b*(2*w*w-1)))}if(0==G)return NaN;var E=N*(r*r-i*i)/(i*i),T=E/1024*(256+E*(E*(74-47*E)-128));return(i*(1+E/16384*(4096+E*(E*(320-175*E)-768)))*(S-T*y*(w+T/4*(b*(2*w*w-1)-T/6*w*(4*y*y-3)*(4*w*w-3))))).toFixed(3)/1e3},GeoGlobe.Util.destinationVincenty=function(e,t,o){for(var r=GeoGlobe.Util,i=r.VincentyConstants,n=i.a,s=i.b,a=i.f,l=e.lng,u=e.lat,c=o,p=r.rad(t),h=Math.sin(p),f=Math.cos(p),d=(1-a)*Math.tan(r.rad(u)),G=1/Math.sqrt(1+d*d),m=d*G,g=Math.atan2(d,f),y=G*h,b=1-y*y,S=b*(n*n-s*s)/(s*s),v=1+S/16384*(4096+S*(S*(320-175*S)-768)),N=S/1024*(256+S*(S*(74-47*S)-128)),w=c/(s*v),C=2*Math.PI;Math.abs(w-C)>1e-12;){var E=Math.cos(2*g+w),T=Math.sin(w),x=Math.cos(w);C=w,w=c/(s*v)+N*T*(E+N/4*(x*(2*E*E-1)-N/6*E*(4*T*T-3)*(4*E*E-3)))}var L=m*T-G*x*f,_=Math.atan2(m*x+G*T*f,(1-a)*Math.sqrt(y*y+L*L)),P=a/16*b*(4+a*(4-3*b)),F=Math.atan2(T*h,G*x-m*T*f)-(1-P)*a*y*(w+P*T*(E+P*x*(2*E*E-1)));Math.atan2(y,-L);return new GeoGlobe.LngLat(l+r.deg(F),r.deg(_))},GeoGlobe.Util.getParameters=function(e,t){t=t||{},e=null===e||void 0===e?window.location.href:e;var o="";if(GeoGlobe.String.contains(e,"?")){var r=e.indexOf("?")+1,i=GeoGlobe.String.contains(e,"#")?e.indexOf("#"):e.length;o=e.substring(r,i)}for(var n={},s=o.split(/[&;]/),a=0,l=s.length;a<l;++a){var u=s[a].split("=");if(u[0]){var c=u[0];try{c=decodeURIComponent(c)}catch(e){c=unescape(c)}var p=(u[1]||"").replace(/\+/g," ");try{p=decodeURIComponent(p)}catch(e){p=unescape(p)}!1!==t.splitArgs&&(p=p.split(",")),1==p.length&&(p=p[0]),n[c]=p}}return n},GeoGlobe.Util.lastSeqID=0,GeoGlobe.Util.createUniqueID=function(e){return e=null==e?"id_":e.replace(GeoGlobe.Util.dotless,"_"),GeoGlobe.Util.lastSeqID+=1,e+GeoGlobe.Util.lastSeqID},GeoGlobe.INCHES_PER_UNIT={inches:1,ft:12,mi:63360,m:1/.0254,km:39370,dd:4374754,yd:36},GeoGlobe.INCHES_PER_UNIT.in=GeoGlobe.INCHES_PER_UNIT.inches,GeoGlobe.INCHES_PER_UNIT.degrees=GeoGlobe.INCHES_PER_UNIT.dd,GeoGlobe.INCHES_PER_UNIT.nmi=1852*GeoGlobe.INCHES_PER_UNIT.m,GeoGlobe.METERS_PER_INCH=.0254000508001016,GeoGlobe.Util.extend(GeoGlobe.INCHES_PER_UNIT,{Inch:GeoGlobe.INCHES_PER_UNIT.inches,Meter:1/GeoGlobe.METERS_PER_INCH,Foot:.3048006096012192/GeoGlobe.METERS_PER_INCH,IFoot:.3048/GeoGlobe.METERS_PER_INCH,ClarkeFoot:.3047972651151/GeoGlobe.METERS_PER_INCH,SearsFoot:.30479947153867626/GeoGlobe.METERS_PER_INCH,GoldCoastFoot:.3047997101815088/GeoGlobe.METERS_PER_INCH,IInch:.0254/GeoGlobe.METERS_PER_INCH,MicroInch:254e-7/GeoGlobe.METERS_PER_INCH,Mil:2.54e-8/GeoGlobe.METERS_PER_INCH,Centimeter:.01/GeoGlobe.METERS_PER_INCH,Kilometer:1e3/GeoGlobe.METERS_PER_INCH,Yard:.9144018288036576/GeoGlobe.METERS_PER_INCH,SearsYard:.914398414616029/GeoGlobe.METERS_PER_INCH,IndianYard:.9143985307444408/GeoGlobe.METERS_PER_INCH,IndianYd37:.91439523/GeoGlobe.METERS_PER_INCH,IndianYd62:.9143988/GeoGlobe.METERS_PER_INCH,IndianYd75:.9143985/GeoGlobe.METERS_PER_INCH,IndianFoot:.30479951/GeoGlobe.METERS_PER_INCH,IndianFt37:.30479841/GeoGlobe.METERS_PER_INCH,IndianFt62:.3047996/GeoGlobe.METERS_PER_INCH,IndianFt75:.3047995/GeoGlobe.METERS_PER_INCH,Mile:1609.3472186944373/GeoGlobe.METERS_PER_INCH,IYard:.9144/GeoGlobe.METERS_PER_INCH,IMile:1609.344/GeoGlobe.METERS_PER_INCH,NautM:1852/GeoGlobe.METERS_PER_INCH,"Lat-66":110943.31648893273/GeoGlobe.METERS_PER_INCH,"Lat-83":110946.25736872235/GeoGlobe.METERS_PER_INCH,Decimeter:.1/GeoGlobe.METERS_PER_INCH,Millimeter:.001/GeoGlobe.METERS_PER_INCH,Dekameter:10/GeoGlobe.METERS_PER_INCH,Decameter:10/GeoGlobe.METERS_PER_INCH,Hectometer:100/GeoGlobe.METERS_PER_INCH,GermanMeter:1.0000135965/GeoGlobe.METERS_PER_INCH,CaGrid:.999738/GeoGlobe.METERS_PER_INCH,ClarkeChain:20.1166194976/GeoGlobe.METERS_PER_INCH,GunterChain:20.11684023368047/GeoGlobe.METERS_PER_INCH,BenoitChain:20.116782494375872/GeoGlobe.METERS_PER_INCH,SearsChain:20.11676512155/GeoGlobe.METERS_PER_INCH,ClarkeLink:.201166194976/GeoGlobe.METERS_PER_INCH,GunterLink:.2011684023368047/GeoGlobe.METERS_PER_INCH,BenoitLink:.20116782494375873/GeoGlobe.METERS_PER_INCH,SearsLink:.2011676512155/GeoGlobe.METERS_PER_INCH,Rod:5.02921005842012/GeoGlobe.METERS_PER_INCH,IntnlChain:20.1168/GeoGlobe.METERS_PER_INCH,IntnlLink:.201168/GeoGlobe.METERS_PER_INCH,Perch:5.02921005842012/GeoGlobe.METERS_PER_INCH,Pole:5.02921005842012/GeoGlobe.METERS_PER_INCH,Furlong:201.1684023368046/GeoGlobe.METERS_PER_INCH,Rood:3.778266898/GeoGlobe.METERS_PER_INCH,CapeFoot:.3047972615/GeoGlobe.METERS_PER_INCH,Brealey:375/GeoGlobe.METERS_PER_INCH,ModAmFt:.304812252984506/GeoGlobe.METERS_PER_INCH,Fathom:1.8288/GeoGlobe.METERS_PER_INCH,"NautM-UK":1853.184/GeoGlobe.METERS_PER_INCH,"50kilometers":5e4/GeoGlobe.METERS_PER_INCH,"150kilometers":15e4/GeoGlobe.METERS_PER_INCH}),GeoGlobe.Util.extend(GeoGlobe.INCHES_PER_UNIT,{mm:GeoGlobe.INCHES_PER_UNIT.Meter/1e3,cm:GeoGlobe.INCHES_PER_UNIT.Meter/100,dm:100*GeoGlobe.INCHES_PER_UNIT.Meter,km:1e3*GeoGlobe.INCHES_PER_UNIT.Meter,kmi:GeoGlobe.INCHES_PER_UNIT.nmi,fath:GeoGlobe.INCHES_PER_UNIT.Fathom,ch:GeoGlobe.INCHES_PER_UNIT.IntnlChain,link:GeoGlobe.INCHES_PER_UNIT.IntnlLink,"us-in":GeoGlobe.INCHES_PER_UNIT.inches,"us-ft":GeoGlobe.INCHES_PER_UNIT.Foot,"us-yd":GeoGlobe.INCHES_PER_UNIT.Yard,"us-ch":GeoGlobe.INCHES_PER_UNIT.GunterChain,"us-mi":GeoGlobe.INCHES_PER_UNIT.Mile,"ind-yd":GeoGlobe.INCHES_PER_UNIT.IndianYd37,"ind-ft":GeoGlobe.INCHES_PER_UNIT.IndianFt37,"ind-ch":20.11669506/GeoGlobe.METERS_PER_INCH}),GeoGlobe.DOTS_PER_INCH=96,GeoGlobe.Util.normalizeScale=function(e){return e>1?1/e:e},GeoGlobe.Util.getResolutionFromScale=function(e,t){var o;e&&(null==t&&(t="degrees"),o=1/(GeoGlobe.Util.normalizeScale(e)*GeoGlobe.INCHES_PER_UNIT[t]*GeoGlobe.DOTS_PER_INCH));return o},GeoGlobe.Util.getScaleFromResolution=function(e,t){return null==t&&(t="degrees"),e*GeoGlobe.INCHES_PER_UNIT[t]*GeoGlobe.DOTS_PER_INCH},GeoGlobe.Util.pagePosition=function(e){var t=[0,0],o=GeoGlobe.Util.getViewportElement();if(!e||e==window||e==o)return t;var r,i=GeoGlobe.IS_GECKO&&document.getBoxObjectFor&&"absolute"==GeoGlobe.Element.getStyle(e,"position")&&(""==e.style.top||""==e.style.left),n=null;if(e.getBoundingClientRect){r=e.getBoundingClientRect();var s=window.pageYOffset||o.scrollTop,a=window.pageXOffset||o.scrollLeft;t[0]=r.left+a,t[1]=r.top+s}else if(document.getBoxObjectFor&&!i){r=document.getBoxObjectFor(e);var l=document.getBoxObjectFor(o);t[0]=r.screenX-l.screenX,t[1]=r.screenY-l.screenY}else{if(t[0]=e.offsetLeft,t[1]=e.offsetTop,(n=e.offsetParent)!=e)for(;n;)t[0]+=n.offsetLeft,t[1]+=n.offsetTop,n=n.offsetParent;var u=GeoGlobe.BROWSER_NAME;for(("opera"==u||"safari"==u&&"absolute"==GeoGlobe.Element.getStyle(e,"position"))&&(t[1]-=document.body.offsetTop),n=e.offsetParent;n&&n!=document.body;)t[0]-=n.scrollLeft,"opera"==u&&"TR"==n.tagName||(t[1]-=n.scrollTop),n=n.offsetParent}return t},GeoGlobe.Util.getViewportElement=function(){var e=arguments.callee.viewportElement;return void 0==e&&(e="msie"==GeoGlobe.BROWSER_NAME&&"CSS1Compat"!=document.compatMode?document.body:document.documentElement,arguments.callee.viewportElement=e),e},GeoGlobe.Util.isEquivalentUrl=function(e,t,o){o=o||{},GeoGlobe.Util.applyDefaults(o,{ignoreCase:!0,ignorePort80:!0,ignoreHash:!0,splitArgs:!1});var r=GeoGlobe.Util.createUrlObject(e,o),i=GeoGlobe.Util.createUrlObject(t,o);for(var n in r)if("args"!==n&&r[n]!=i[n])return!1;for(var n in r.args){if(r.args[n]!=i.args[n])return!1;delete i.args[n]}for(var n in i.args)return!1;return!0},GeoGlobe.Util.createUrlObject=function(e,t){if(t=t||{},!/^\w+:\/\//.test(e)){var o=window.location,r=o.port?":"+o.port:"",i=o.protocol+"//"+o.host.split(":").shift()+r;if(0===e.indexOf("/"))e=i+e;else{var n=o.pathname.split("/");n.pop(),e=i+n.join("/")+"/"+e}}t.ignoreCase&&(e=e.toLowerCase());var s=document.createElement("a");s.href=e;var a={};a.host=s.host.split(":").shift(),a.protocol=s.protocol,t.ignorePort80?a.port="80"==s.port||"0"==s.port?"":s.port:a.port=""==s.port||"0"==s.port?"80":s.port,a.hash=t.ignoreHash||"#"===s.hash?"":s.hash;var l=s.search;if(!l){var u=e.indexOf("?");l=-1!=u?e.substr(u):""}return a.args=GeoGlobe.Util.getParameters(l,{splitArgs:t.splitArgs}),a.pathname="/"==s.pathname.charAt(0)?s.pathname:"/"+s.pathname,a},GeoGlobe.Util.removeTail=function(e){var t=e.indexOf("?"),o=e.indexOf("#");return-1==t?-1!=o?e.substr(0,o):e:-1!=o?e.substr(0,Math.min(t,o)):e.substr(0,t)},GeoGlobe.IS_GECKO=function(){var e=navigator.userAgent.toLowerCase();return-1==e.indexOf("webkit")&&-1!=e.indexOf("gecko")}(),GeoGlobe.CANVAS_SUPPORTED=function(){var e=document.createElement("canvas");return!(!e.getContext||!e.getContext("2d"))}(),GeoGlobe.BROWSER_NAME=function(){var e="",t=navigator.userAgent.toLowerCase();return-1!=t.indexOf("opera")?e="opera":-1!=t.indexOf("msie")?e="msie":-1!=t.indexOf("safari")?e="safari":-1!=t.indexOf("mozilla")&&(e=-1!=t.indexOf("firefox")?"firefox":"mozilla"),e}(),GeoGlobe.Util.getBrowserName=function(){return GeoGlobe.BROWSER_NAME},GeoGlobe.Util.getScrollbarWidth=function(){var e=GeoGlobe.Util._scrollbarWidth;if(null==e){var t,o,r=null,i=null;(r=document.createElement("div")).style.position="absolute",r.style.top="-1000px",r.style.left="-1000px",r.style.width="100px",r.style.height="50px",r.style.overflow="hidden",(i=document.createElement("div")).style.width="100%",i.style.height="200px",r.appendChild(i),document.body.appendChild(r),t=i.offsetWidth,r.style.overflow="scroll",o=i.offsetWidth,document.body.removeChild(document.body.lastChild),GeoGlobe.Util._scrollbarWidth=t-o,e=GeoGlobe.Util._scrollbarWidth}return e},GeoGlobe.Util.randomStr=function(e){for(var t="",o=[],r=0;r<e;r++){var i=Math.ceil(25*Math.random());o.push(String.fromCharCode(97+i))}for(r=0;r<e;r++)t+=o[r];return t},GeoGlobe.Util.globalEval=function(e){e&&GeoGlobe.String.trim(e)&&(window.execScript||function(e){window.eval.call(window,e)})(e)},GeoGlobe.Util.getResolutionFromScale_DPI=function(e,t,o){var r;e&&(null==t&&(t="degrees"),r=1/(GeoGlobe.Util.normalizeScale(e)*GeoGlobe.INCHES_PER_UNIT[t]*o));return r},GeoGlobe.Util.getScaleFromResolution_DPI=function(e,t,o){return null==t&&(t="degrees"),e*GeoGlobe.INCHES_PER_UNIT[t]*o},GeoGlobe.Util.getMapLevelFormResolution=function(e,t){if(!t)return 0;var o,r,i=Number.POSITIVE_INFINITY,n=e.getResolutions();for(o=0,len=n.length;o<len&&!((r=Math.abs(n[o]-t))>i);o++)i=r;return Math.max(0,o-1)},GeoGlobe.Util.getMapLevelFormScale=function(e,t,o,r){o=o||"degrees",r=r||96;var i=GeoGlobe.Util.getResolutionFromScale_DPI(t,o,r);return GeoGlobe.Util.getMapLevelFormResolution(e,i)},GeoGlobe.Util.delayFun=function(e,t,o){var r;return function(){var i=this,n=arguments,s=o&&!r;clearTimeout(r),r=setTimeout(function(){r=null,o||e.apply(i,n)},t),s&&e.apply(i,n)}},GeoGlobe.Util.clone=function(e){if("object"!=typeof e)return e;if(null==e)return e;var t=e.constructor==Array?[]:{};for(var o in e)t[o]=GeoGlobe.Util.clone(e[o]);return t},GeoGlobe.Util.getType=function(e){var t=Object.prototype.toString;return e instanceof Element?"element":{"[object Boolean]":"boolean","[object Number]":"number","[object String]":"string","[object Function]":"function","[object Array]":"array","[object Date]":"date","[object RegExp]":"regExp","[object Undefined]":"undefined","[object Null]":"null","[object Object]":"object"}[t.call(e)]},GeoGlobe.Util.formatNumberToThousands=function(e,t,o){e=e.toString().replace(/\$|\,/g,""),isNaN(e)&&(e="0");var r=e===(e=Math.abs(e)),i=(e=Math.floor(e*Math.pow(10,t)+.50000000001))%Math.pow(10,t);for(e=Math.floor(e/Math.pow(10,t)).toString(),i=i.toString();i.length<t;)i="0"+i;if(o)for(var n=0;n<Math.floor((e.length-(1+n))/3);n++)e=e.substring(0,e.length-(4*n+3))+","+e.substring(e.length-(4*n+3));return t>0?(r?"":"-")+e+"."+i:(r?"":"-")+e},GeoGlobe.Util.getFormattedString=function(e,t){var o=t;if((o=(o=o.replace(/{a}/g,e.a)).replace(/{b}/g,e.b)).contains("{c"))for(var r=o.split("{c"),i=0,n=0;n<r.length-1;n++)i=r[n+1].split("}")[0],o=o.replace(new RegExp("{c"+i+"}","g"),GeoGlobe.Util.formatNumberToThousands(parseFloat(e.c),""===i?2:i,!0));return o},GeoGlobe.Util.getGradientImageData=function(e){var t=document.createElement("canvas"),o=t.getContext("2d");t.width=1,t.height=256;var r=o.createLinearGradient(0,0,0,256);for(var i in e)e.hasOwnProperty(i)&&r.addColorStop(i,e[i]);return o.fillStyle=r,o.fillRect(0,0,1,256),o.getImageData(0,0,1,256).data},GeoGlobe.Util.getRgbColor=function(e){if((e=e.toLowerCase())&&/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/.test(e)){if(4===e.length){for(var t="#",o=1;o<4;o+=1)t+=e.slice(o,o+1).concat(e.slice(o,o+1));e=t}t=[];for(o=1;o<7;o+=2)t.push(parseInt("0x"+e.slice(o,o+2)));return"rgb("+t.join(",")+")"}return e.startsWith("rgba")||e.startsWith("hsla")?e.substring(0,3)+e.substring(4,e.lastIndexOf(","))+")":e.startsWith("rgb")||e.startsWith("hsl")?e:""},GeoGlobe.Util.getShadeColor=function(e,t){e=(e=GeoGlobe.Util.getHexColor(e)).substr(1);var o=parseInt(e,16),r=Math.round(2.55*t),i=(o>>16)+r,n=(o>>8&255)+r,s=(255&o)+r;return"#"+(16777216+65536*(i<255?i<1?0:i:255)+256*(n<255?n<1?0:n:255)+(s<255?s<1?0:s:255)).toString(16).slice(1)},GeoGlobe.Util.getHexColor=function(e){if(e=e.toLowerCase(),/^(rgb|rgba)/.test(e)){for(var t=e.split("(")[1].split(")")[0].split(","),o="#",r=0;r<3;r++){var i=Number(t[r]).toString(16);"0"===i&&(i+=i),1===i.length&&(i="0"+i),o+=i}return 7!==o.length&&(o=e),o}if(!/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(e))return e;var n=e.replace(/#/,"").split("");if(6===n.length)return e;if(3===n.length){var s="#";for(r=0;r<n.length;r+=1)s+=n[r]+n[r];return s}},GeoGlobe.Util.transferToLonLat=function(e){return-238107693.23182276===e[1]?[e[0]/20037508.34*180,-90]:[e[0]/20037508.34*180,180/Math.PI*(2*Math.atan(Math.exp(e[1]/20037508.34*180*Math.PI/180))-Math.PI/2)]},GeoGlobe.Util.transferToMercator=function(e){return-90===e[1]?[20037508.34*e[0]/180,-238107693.23182276]:[20037508.34*e[0]/180,Math.log(Math.tan((90+e[1])*Math.PI/360))/(Math.PI/180)*20037508.34/180]},GeoGlobe.ProjAxisOrder={AXIS_ORDER_EN:!0,AXIS_ORDER_NE:!1},GeoGlobe.ProjAxisOrder.AxisOrder={"EPSG:900913":GeoGlobe.ProjAxisOrder.AXIS_ORDER_EN,WGS84:GeoGlobe.ProjAxisOrder.AXIS_ORDER_NE,"IGNF:WGS84G":GeoGlobe.ProjAxisOrder.AXIS_ORDER_NE,"EPSG:4326":GeoGlobe.ProjAxisOrder.AXIS_ORDER_NE,"EPSG:4490":GeoGlobe.ProjAxisOrder.AXIS_ORDER_NE,"EPSG:4269":GeoGlobe.ProjAxisOrder.AXIS_ORDER_NE,"EPSG:2361":GeoGlobe.ProjAxisOrder.AXIS_ORDER_NE,"EPSG:27700":GeoGlobe.ProjAxisOrder.AXIS_ORDER_EN,"EPSG:904490":GeoGlobe.ProjAxisOrder.AXIS_ORDER_NE,"EPSG:4171":GeoGlobe.ProjAxisOrder.AXIS_ORDER_NE,"EPSG:32637":GeoGlobe.ProjAxisOrder.AXIS_ORDER_EN,"EPSG:32638":GeoGlobe.ProjAxisOrder.AXIS_ORDER_EN,"EPSG:32639":GeoGlobe.ProjAxisOrder.AXIS_ORDER_EN,"EPSG:32640":GeoGlobe.ProjAxisOrder.AXIS_ORDER_EN,"EPSG:32641":GeoGlobe.ProjAxisOrder.AXIS_ORDER_EN,"EPSG:28991":GeoGlobe.ProjAxisOrder.AXIS_ORDER_EN,"EPSG:28992":GeoGlobe.ProjAxisOrder.AXIS_ORDER_EN,"EPSG:31300":GeoGlobe.ProjAxisOrder.AXIS_ORDER_EN,"EPSG:31370":GeoGlobe.ProjAxisOrder.AXIS_ORDER_EN,"EPSG:2176":GeoGlobe.ProjAxisOrder.AXIS_ORDER_EN,"EPSG:2177":GeoGlobe.ProjAxisOrder.AXIS_ORDER_EN,"EPSG:2178":GeoGlobe.ProjAxisOrder.AXIS_ORDER_EN,"EPSG:2179":GeoGlobe.ProjAxisOrder.AXIS_ORDER_EN,"EPSG:2180":GeoGlobe.ProjAxisOrder.AXIS_ORDER_EN,"EPSG:2154":GeoGlobe.ProjAxisOrder.AXIS_ORDER_EN,"EPSG:3346":GeoGlobe.ProjAxisOrder.AXIS_ORDER_EN,"EPSG:3857":GeoGlobe.ProjAxisOrder.AXIS_ORDER_EN,"EPSG:2065":GeoGlobe.ProjAxisOrder.AXIS_ORDER_EN},GeoGlobe.SpatialReference=GeoGlobe.Class({proj:null,projCode:null,titleRegEx:/\+title=[^\+]*/,initialize:function(e,t){GeoGlobe.Util.extend(this,t),this.projCode=e,"object"==typeof Proj4js&&(this.proj=new Proj4js.Proj(e))},getCode:function(){return this.proj?this.proj.srsCode:this.projCode},getUnits:function(){return this.proj?this.proj.units:null},toString:function(){return this.getCode()},equals:function(e){var t=e,o=!1;if(t)if(t instanceof GeoGlobe.SpatialReference||(t=new GeoGlobe.SpatialReference(t)),"object"==typeof Proj4js&&this.proj.defData&&t.proj.defData)o=this.proj.defData.replace(this.titleRegEx,"")==t.proj.defData.replace(this.titleRegEx,"");else if(t.getCode){var r=this.getCode(),i=t.getCode();o=r==i||!!GeoGlobe.SpatialReference.transforms[r]&&GeoGlobe.SpatialReference.transforms[r][i]===GeoGlobe.SpatialReference.nullTransform}return o},destroy:function(){delete this.proj,delete this.projCode},CLASS_NAME:"GeoGlobe.SpatialReference"}),GeoGlobe.SpatialReference.transforms={},GeoGlobe.SpatialReference.defaults={"EPSG:4326":{units:"degrees",maxExtent:[-180,-90,180,90],yx:!0},"CRS:84":{units:"degrees",maxExtent:[-180,-90,180,90]},"EPSG:900913":{units:"m",maxExtent:[-20037508.34,-20037508.34,20037508.34,20037508.34]}},GeoGlobe.SpatialReference.addTransform=function(e,t,o){if(o===GeoGlobe.SpatialReference.nullTransform){var r=GeoGlobe.SpatialReference.defaults[e];r&&!GeoGlobe.SpatialReference.defaults[t]&&(GeoGlobe.SpatialReference.defaults[t]=r)}GeoGlobe.SpatialReference.transforms[e]||(GeoGlobe.SpatialReference.transforms[e]={}),GeoGlobe.SpatialReference.transforms[e][t]=o},GeoGlobe.SpatialReference.transform=function(e,t,o){if(t&&o)if(t instanceof GeoGlobe.SpatialReference||(t=new GeoGlobe.SpatialReference(t)),o instanceof GeoGlobe.SpatialReference||(o=new GeoGlobe.SpatialReference(o)),t.proj&&o.proj)e=Proj4js.transform(t.proj,o.proj,e);else{var r=t.getCode(),i=o.getCode(),n=GeoGlobe.SpatialReference.transforms;n[r]&&n[r][i]&&n[r][i](e)}return e},GeoGlobe.SpatialReference.nullTransform=function(e){return e},function(){var e=20037508.34;function t(t){return t.x=180*t.x/e,t.y=180/Math.PI*(2*Math.atan(Math.exp(t.y/e*Math.PI))-Math.PI/2),t}function o(t){t.x=t.x*e/180;var o=Math.log(Math.tan((90+t.y)*Math.PI/360))/Math.PI*e;return t.y=Math.max(-20037508.34,Math.min(o,20037508.34)),t}function r(e,r){var i,n,s,a,l,u=GeoGlobe.SpatialReference.addTransform,c=GeoGlobe.SpatialReference.nullTransform;for(i=0,n=r.length;i<n;++i)for(u(e,s=r[i],o),u(s,e,t),l=i+1;l<n;++l)u(s,a=r[l],c),u(a,s,c)}var i,n=["EPSG:900913","EPSG:3857","EPSG:102113","EPSG:102100"],s=["CRS:84","urn:ogc:def:crs:EPSG:6.6:4326","EPSG:4326"];for(i=n.length-1;i>=0;--i)r(n[i],s);for(i=s.length-1;i>=0;--i)r(s[i],n)}(),GeoGlobe.Console={log:function(){},debug:function(){},info:function(){},warn:function(){},error:function(){},userError:function(e){alert(e)},assert:function(){},dir:function(){},dirxml:function(){},trace:function(){},group:function(){},groupEnd:function(){},time:function(){},timeEnd:function(){},profile:function(){},profileEnd:function(){},count:function(){},CLASS_NAME:"GeoGlobe.Console"},function(){for(var e=document.getElementsByTagName("script"),t=0,o=e.length;t<o;++t)if(-1!=e[t].src.indexOf("firebug.js")&&console){GeoGlobe.Util.extend(GeoGlobe.Console,console);break}}(),GeoGlobe.ProxyHost="",GeoGlobe.Request||(GeoGlobe.Request={}),GeoGlobe.Util.extend(GeoGlobe.Request,{DEFAULT_CONFIG:{method:"GET",url:window.location.href,async:!0,user:void 0,password:void 0,params:null,proxy:GeoGlobe.ProxyHost,headers:{},data:null,callback:function(){},success:null,failure:null,scope:null},URL_SPLIT_REGEX:/([^:]*:)\/\/([^:]*:?[^@]*@)?([^:\/\?]*):?([^\/\?]*)/,makeSameOrigin:function(e,t){var o=0!==e.indexOf("http"),r=!o&&e.match(this.URL_SPLIT_REGEX);if(r){var i=window.location;o=r[1]==i.protocol&&r[3]==i.hostname;var n=r[4],s=i.port;(80!=n&&""!=n||"80"!=s&&""!=s)&&(o=o&&n==s)}return o||t&&(e="function"==typeof t?t(e):e.indexOf("cts?")>=0?t+e:t+encodeURIComponent(e)),e},issue:function(e){var t=GeoGlobe.Util.extend(this.DEFAULT_CONFIG,{proxy:GeoGlobe.ProxyHost});(e=e||{}).headers=e.headers||{},(e=GeoGlobe.Util.applyDefaults(e,t)).headers=GeoGlobe.Util.applyDefaults(e.headers,t.headers);var o,r=!1;for(o in e.headers)e.headers.hasOwnProperty(o)&&"x-requested-with"===o.toLowerCase()&&(r=!0);!1===r&&(e.headers["X-Requested-With"]="XMLHttpRequest");var i=new GeoGlobe.Request.XMLHttpRequest;e.url=encodeURI(e.url);var n=GeoGlobe.Util.urlAppend(e.url,GeoGlobe.Util.getParameterString(e.params||{}));n=GeoGlobe.Request.makeSameOrigin(n,e.proxy),i.open(e.method,n,e.async,e.user,e.password);for(var s in e.headers)i.setRequestHeader(s,e.headers[s]);var a=this;return i.onreadystatechange=function(){if(i.readyState==GeoGlobe.Request.XMLHttpRequest.DONE){a.runCallbacks({request:i,config:e,requestUrl:n})}},!1===e.async?i.send(e.data):window.setTimeout(function(){0!==i.readyState&&i.send(e.data)},0),i},runCallbacks:function(e){var t,o,r=e.request,i=e.config,n=i.scope?GeoGlobe.Function.bind(i.callback,i.scope):i.callback;i.success&&(t=i.scope?GeoGlobe.Function.bind(i.success,i.scope):i.success),i.failure&&(o=i.scope?GeoGlobe.Function.bind(i.failure,i.scope):i.failure),"file:"==GeoGlobe.Util.createUrlObject(i.url).protocol&&r.responseText&&(r.status=200),n(r),(!r.status||r.status>=200&&r.status<300)&&t&&t(r),r.status&&(r.status<200||r.status>=300)&&o&&o(r)},GET:function(e){return e=GeoGlobe.Util.extend(e,{method:"GET"}),GeoGlobe.Request.issue(e)},POST:function(e){return(e=GeoGlobe.Util.extend(e,{method:"POST"})).headers=e.headers?e.headers:{},"CONTENT-TYPE"in GeoGlobe.Util.upperCaseObject(e.headers)||(e.headers["Content-Type"]="application/xml"),GeoGlobe.Request.issue(e)},PUT:function(e){return(e=GeoGlobe.Util.extend(e,{method:"PUT"})).headers=e.headers?e.headers:{},"CONTENT-TYPE"in GeoGlobe.Util.upperCaseObject(e.headers)||(e.headers["Content-Type"]="application/xml"),GeoGlobe.Request.issue(e)},DELETE:function(e){return e=GeoGlobe.Util.extend(e,{method:"DELETE"}),GeoGlobe.Request.issue(e)},HEAD:function(e){return e=GeoGlobe.Util.extend(e,{method:"HEAD"}),GeoGlobe.Request.issue(e)},OPTIONS:function(e){return e=GeoGlobe.Util.extend(e,{method:"OPTIONS"}),GeoGlobe.Request.issue(e)}}),GeoGlobe.nullHandler=function(e){GeoGlobe.Console.userError(GeoGlobe.i18n("unhandledRequest",{statusText:e.statusText}))},GeoGlobe.loadURL=function(e,t,o,r,i){"string"==typeof t&&(t=GeoGlobe.Util.getParameters(t));var n=r||GeoGlobe.nullHandler,s=i||GeoGlobe.nullHandler;return GeoGlobe.Request.GET({url:e,params:t,success:n,failure:s,scope:o})},GeoGlobe.Request.setProxyHost=function(e){GeoGlobe.ProxyHost=e},GeoGlobe.Request.getProxyHost=function(){return GeoGlobe.ProxyHost},GeoGlobe.appendToProxy=function(e){var t=e.split("?"),o=GeoGlobe.ProxyHost+encodeURI(encodeURI(t[0]));return 2===t.length&&(o+="?"+t[1]),o},GeoGlobe.loadScript=function(e){GeoGlobe.Request.GET({url:e,async:!1,headers:{Accept:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript, */*; q=0.01"},success:function(e){GeoGlobe.Util.globalEval(e.responseText)},failure:function(t){alert("加载:"+e+" 失败。")}})},function(){var e=window.XMLHttpRequest,t=!!window.controllers,o=window.document.all&&!window.opera,r=o&&window.navigator.userAgent.match(/MSIE 7.0/);function i(){this._object=e&&!r?new e:new window.ActiveXObject("Microsoft.XMLHTTP"),this._listeners=[]}function n(){return new i}function s(e){n.onreadystatechange&&n.onreadystatechange.apply(e),e.dispatchEvent({type:"readystatechange",bubbles:!1,cancelable:!1,timeStamp:new Date+0})}function a(e){try{e.responseText=e._object.responseText}catch(e){}try{e.responseXML=(t=e._object,r=t.responseXML,i=t.responseText,o&&i&&r&&!r.documentElement&&t.getResponseHeader("Content-Type").match(/[^\/]+\/[^\+]+\+xml/)&&((r=new window.ActiveXObject("Microsoft.XMLDOM")).async=!1,r.validateOnParse=!1,r.loadXML(i)),r&&(o&&0!=r.parseError||!r.documentElement||r.documentElement&&"parsererror"==r.documentElement.tagName)?null:r)}catch(e){}var t,r,i;try{e.status=e._object.status}catch(e){}try{e.statusText=e._object.statusText}catch(e){}}function l(e){e._object.onreadystatechange=new window.Function}n.prototype=i.prototype,t&&e.wrapped&&(n.wrapped=e.wrapped),n.UNSENT=0,n.OPENED=1,n.HEADERS_RECEIVED=2,n.LOADING=3,n.DONE=4,n.prototype.readyState=n.UNSENT,n.prototype.responseText="",n.prototype.responseXML=null,n.prototype.status=0,n.prototype.statusText="",n.prototype.priority="NORMAL",n.prototype.onreadystatechange=null,n.onreadystatechange=null,n.onopen=null,n.onsend=null,n.onabort=null,n.prototype.open=function(e,r,i,u,c){delete this._headers,arguments.length<3&&(i=!0),this._async=i;var p,h=this,f=this.readyState;o&&i&&(p=function(){f!=n.DONE&&(l(h),h.abort())},window.attachEvent("onunload",p)),n.onopen&&n.onopen.apply(this,arguments),arguments.length>4?this._object.open(e,r,i,u,c):arguments.length>3?this._object.open(e,r,i,u):this._object.open(e,r,i);try{this._object.responseType="msxml-document"}catch(e){}this.readyState=n.OPENED,s(this),this._object.onreadystatechange=function(){t&&!i||(h.readyState=h._object.readyState,a(h),h._aborted?h.readyState=n.UNSENT:(h.readyState==n.DONE&&(delete h._data,l(h),o&&i&&window.detachEvent("onunload",p)),f!=h.readyState&&s(h),f=h.readyState))}},n.prototype.send=function(e){n.onsend&&n.onsend.apply(this,arguments),arguments.length||(e=null),e&&e.nodeType&&(e=window.XMLSerializer?(new window.XMLSerializer).serializeToString(e):e.xml,this._headers["Content-Type"]||this._object.setRequestHeader("Content-Type","application/xml")),this._data=e,function(e){if(e._object.send(e._data),t&&!e._async)for(e.readyState=n.OPENED,a(e);e.readyState<n.DONE;)if(e.readyState++,s(e),e._aborted)return}(this)},n.prototype.abort=function(){n.onabort&&n.onabort.apply(this,arguments),this.readyState>n.UNSENT&&(this._aborted=!0),this._object.abort(),l(this),this.readyState=n.UNSENT,delete this._data},n.prototype.getAllResponseHeaders=function(){return this._object.getAllResponseHeaders()},n.prototype.getResponseHeader=function(e){return this._object.getResponseHeader(e)},n.prototype.setRequestHeader=function(e,t){return this._headers||(this._headers={}),this._headers[e]=t,this._object.setRequestHeader(e,t)},n.prototype.addEventListener=function(e,t,o){for(var r,i=0;r=this._listeners[i];i++)if(r[0]==e&&r[1]==t&&r[2]==o)return;this._listeners.push([e,t,o])},n.prototype.removeEventListener=function(e,t,o){for(var r,i=0;(r=this._listeners[i])&&(r[0]!=e||r[1]!=t||r[2]!=o);i++);r&&this._listeners.splice(i,1)},n.prototype.dispatchEvent=function(e){var t={type:e.type,target:this,currentTarget:this,eventPhase:2,bubbles:e.bubbles,cancelable:e.cancelable,timeStamp:e.timeStamp,stopPropagation:function(){},preventDefault:function(){},initEvent:function(){}};"readystatechange"==t.type&&this.onreadystatechange&&(this.onreadystatechange.handleEvent||this.onreadystatechange).apply(this,[t]);for(var o,r=0;o=this._listeners[r];r++)o[0]!=t.type||o[2]||(o[1].handleEvent||o[1]).apply(this,[t])},n.prototype.toString=function(){return"[object XMLHttpRequest]"},n.toString=function(){return"[XMLHttpRequest]"},window.Function.prototype.apply||(window.Function.prototype.apply=function(e,t){t||(t=[]),e.__func=this,e.__func(t[0],t[1],t[2],t[3],t[4]),delete e.__func}),GeoGlobe.Request||(GeoGlobe.Request={}),GeoGlobe.Request.XMLHttpRequest=n}(),GeoGlobe.Lang={code:null,defaultCode:"zh-CN",getCode:function(){return GeoGlobe.Lang.code||GeoGlobe.Lang.setCode(),GeoGlobe.Lang.code},setCode:function(e){var t;e||(e="msie"==GeoGlobe.BROWSER_NAME?navigator.userLanguage:navigator.language);var o=e.split("-");if(o[0]=o[0].toLowerCase(),"object"==typeof GeoGlobe.Lang[o[0]]&&(t=o[0]),o[1]){var r=o[0]+"-"+o[1].toUpperCase();"object"==typeof GeoGlobe.Lang[r]&&(t=r)}t||(GeoGlobe.Console.warn("Failed to find GeoGlobe.Lang."+o.join("-")+" dictionary, falling back to default language"),t=GeoGlobe.Lang.defaultCode),GeoGlobe.Lang.code=t},translate:function(e,t){var o=GeoGlobe.Lang[GeoGlobe.Lang.getCode()],r=o&&o[e];return r||(r=e),t&&(r=GeoGlobe.String.format(r,t)),r}},GeoGlobe.i18n=GeoGlobe.Lang.translate,GeoGlobe.Lang.en={unhandledRequest:"Unhandled request return ${statusText}",end:""},GeoGlobe.Lang["zh-CN"]={unhandledRequest:"未处理的请求，返回值为 ${statusText}",end:""},GeoGlobe.String={startsWith:function(e,t){return 0==e.indexOf(t)},contains:function(e,t){return-1!=e.indexOf(t)},trim:function(e){return e.replace(/^\s\s*/,"").replace(/\s\s*$/,"")},camelize:function(e){for(var t=e.split("-"),o=t[0],r=1,i=t.length;r<i;r++){var n=t[r];o+=n.charAt(0).toUpperCase()+n.substring(1)}return o},format:function(e,t,o){t||(t=window);return e.replace(GeoGlobe.String.tokenRegEx,function(e,r){for(var i,n=r.split(/\.+/),s=0;s<n.length&&(0==s&&(i=t),void 0!==i);s++)i=i[n[s]];return"function"==typeof i&&(i=o?i.apply(null,o):i()),void 0===i?"undefined":i})},tokenRegEx:/\$\{([\w.]+?)\}/g,numberRegEx:/^([+-]?)(?=\d|\.\d)\d*(\.\d*)?([Ee]([+-]?\d+))?$/,isNumeric:function(e){return GeoGlobe.String.numberRegEx.test(e)},numericIf:function(e,t){var o=e;return!0===t&&null!=e&&e.replace&&(e=e.replace(/^\s*|\s*$/g,"")),GeoGlobe.String.isNumeric(e)?parseFloat(e):o}},GeoGlobe.Number={decimalSeparator:".",thousandsSeparator:",",limitSigDigs:function(e,t){var o=0;return t>0&&(o=parseFloat(e.toPrecision(t))),o},format:function(e,t,o,r){t=void 0!==t?t:0,o=void 0!==o?o:GeoGlobe.Number.thousandsSeparator,r=void 0!==r?r:GeoGlobe.Number.decimalSeparator,null!=t&&(e=parseFloat(e.toFixed(t)));var i=e.toString().split(".");1==i.length&&null==t&&(t=0);var n,s=i[0];if(o)for(var a=/(-?[0-9]+)([0-9]{3})/;a.test(s);)s=s.replace(a,"$1"+o+"$2");if(0==t)n=s;else{var l=i.length>1?i[1]:"0";null!=t&&(l+=new Array(t-l.length+1).join("0")),n=s+r+l}return n},zeroPad:function(e,t,o){for(var r=e.toString(o||10);r.length<t;)r="0"+r;return r}},GeoGlobe.Function={bind:function(e,t){var o=Array.prototype.slice.apply(arguments,[2]);return function(){var r=o.concat(Array.prototype.slice.apply(arguments,[0]));return e.apply(t,r)}},bindAsEventListener:function(e,t){return function(o){return e.call(t,o||window.event)}},False:function(){return!1},True:function(){return!0},Void:function(){}},GeoGlobe.Array={filter:function(e,t,o){var r=[];if(Array.prototype.filter)r=e.filter(t,o);else{var i=e.length;if("function"!=typeof t)throw new TypeError;for(var n=0;n<i;n++)if(n in e){var s=e[n];t.call(o,s,n,e)&&r.push(s)}}return r}},String.prototype.endsWith||(String.prototype.endsWith=function(e,t){var o=this.toString();("number"!=typeof t||!isFinite(t)||Math.floor(t)!==t||t>o.length)&&(t=o.length),t-=e.length;var r=o.lastIndexOf(e,t);return-1!==r&&r===t}),GeoGlobe.Date={dateRegEx:/^(?:(\d{4})(?:-(\d{2})(?:-(\d{2}))?)?)?(?:(?:T(\d{1,2}):(\d{2}):(\d{2}(?:\.\d+)?)(Z|(?:[+-]\d{1,2}(?::(\d{2}))?)))|Z)?$/,toISOString:"toISOString"in Date.prototype?function(e){return e.toISOString()}:function(e){return isNaN(e.getTime())?"Invalid Date":e.getUTCFullYear()+"-"+GeoGlobe.Number.zeroPad(e.getUTCMonth()+1,2)+"-"+GeoGlobe.Number.zeroPad(e.getUTCDate(),2)+"T"+GeoGlobe.Number.zeroPad(e.getUTCHours(),2)+":"+GeoGlobe.Number.zeroPad(e.getUTCMinutes(),2)+":"+GeoGlobe.Number.zeroPad(e.getUTCSeconds(),2)+"."+GeoGlobe.Number.zeroPad(e.getUTCMilliseconds(),3)+"Z"},parse:function(e){var t,o=e.match(this.dateRegEx);if(o&&(o[1]||o[7])){var r=parseInt(o[1],10)||0,i=parseInt(o[2],10)-1||0,n=parseInt(o[3],10)||1;t=new Date(Date.UTC(r,i,n));var s=o[7];if(s){var a=parseInt(o[4],10),l=parseInt(o[5],10),u=parseFloat(o[6]),c=0|u,p=Math.round(1e3*(u-c));if(t.setUTCHours(a,l,c,p),"Z"!==s){var h=-1e3*(60*parseInt(s,10)*60+60*(parseInt(o[8],10)||0));t=new Date(t.getTime()+h)}}}else t=new Date("invalid");return t}},function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this)._GeoGlobe=e()}}(function(){return function e(t,o,r){function i(s,a){if(!o[s]){if(!t[s]){var l="function"==typeof require&&require;if(!a&&l)return l(s,!0);if(n)return n(s,!0);var u=new Error("Cannot find module '"+s+"'");throw u.code="MODULE_NOT_FOUND",u}var c=o[s]={exports:{}};t[s][0].call(c.exports,function(e){var o=t[s][1][e];return i(o||e)},c,c.exports,e,t,o,r)}return o[s].exports}for(var n="function"==typeof require&&require,s=0;s<r.length;s++)i(r[s]);return i}({1:[function(e,t,o){"use strict";var r=function(e,t){if(isNaN(e)||isNaN(t))throw new Error("Invalid LngLat object: ("+e+", "+t+")");this.lng=+e,this.lat=+t};r.prototype.wrap=function(){return new r((e=this.lng,(n=((e-(t=-180))%(i=(o=180)-t)+i)%i+t)===t?o:n),this.lat);var e,t,o,i,n},r.prototype.toArray=function(){return[this.lng,this.lat]},r.prototype.toString=function(){return"LngLat("+this.lng+", "+this.lat+")"},r.prototype.toBounds=function(t){var o=360*t/40075017,i=o/Math.cos(Math.PI/180*this.lat);return new(e("./lng_lat_bounds"))(new r(this.lng-i,this.lat-o),new r(this.lng+i,this.lat+o))},r.convert=function(e){if(e instanceof r)return e;if(Array.isArray(e)&&2===e.length)return new r(Number(e[0]),Number(e[1]));if(!Array.isArray(e)&&"object"==typeof e&&null!==e)return new r(Number(e.lng),Number(e.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")},t.exports=r},{"./lng_lat_bounds":2}],2:[function(e,t,o){"use strict";var r=e("./lng_lat"),i=function(e,t){e&&(t?this.setSouthWest(e).setNorthEast(t):4===e.length?this.setSouthWest([e[0],e[1]]).setNorthEast([e[2],e[3]]):this.setSouthWest(e[0]).setNorthEast(e[1]))};i.prototype.setNorthEast=function(e){return this._ne=e instanceof r?new r(e.lng,e.lat):r.convert(e),this},i.prototype.setSouthWest=function(e){return this._sw=e instanceof r?new r(e.lng,e.lat):r.convert(e),this},i.prototype.extend=function(e){var t,o,n=this._sw,s=this._ne;if(e instanceof r)t=e,o=e;else{if(!(e instanceof i))return Array.isArray(e)?e.every(Array.isArray)?this.extend(i.convert(e)):this.extend(r.convert(e)):this;if(t=e._sw,o=e._ne,!t||!o)return this}return n||s?(n.lng=Math.min(t.lng,n.lng),n.lat=Math.min(t.lat,n.lat),s.lng=Math.max(o.lng,s.lng),s.lat=Math.max(o.lat,s.lat)):(this._sw=new r(t.lng,t.lat),this._ne=new r(o.lng,o.lat)),this},i.prototype.getCenter=function(){return new r((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)},i.prototype.getSouthWest=function(){return this._sw},i.prototype.getNorthEast=function(){return this._ne},i.prototype.getNorthWest=function(){return new r(this.getWest(),this.getNorth())},i.prototype.getSouthEast=function(){return new r(this.getEast(),this.getSouth())},i.prototype.getWest=function(){return this._sw.lng},i.prototype.getSouth=function(){return this._sw.lat},i.prototype.getEast=function(){return this._ne.lng},i.prototype.getNorth=function(){return this._ne.lat},i.prototype.toArray=function(){return[this._sw.toArray(),this._ne.toArray()]},i.prototype.toString=function(){return"LngLatBounds("+this._sw.toString()+", "+this._ne.toString()+")"},i.convert=function(e){return!e||e instanceof i?e:new i(e)},t.exports=i},{"./lng_lat":1}],3:[function(e,t,o){"use strict";var r=e("./geo/lng_lat"),i=e("./geo/lng_lat_bounds");t.exports={LngLat:r,LngLatBounds:i}},{"./geo/lng_lat":1,"./geo/lng_lat_bounds":2}]},{},[3])(3)}),window.GeoGlobe.Util.extend(window.GeoGlobe,window._GeoGlobe),GeoGlobe.LngLat.prototype.CLASS_NAME="GeoGlobe.LngLat",GeoGlobe.LngLatBounds.prototype.clone=function(){return new GeoGlobe.LngLatBounds(this._sw,this._ne)},GeoGlobe.LngLatBounds.prototype.contains=function(e,t,o){if(null==o&&(o=!0),null==e||null==t)return!1;e=GeoGlobe.Util.toFloat(e),t=GeoGlobe.Util.toFloat(t);return o?e>=this._sw.lng&&e<=this._ne.lng&&t>=this._sw.lat&&t<=this._ne.lat:e>this._sw.lng&&e<this._ne.lng&&t>this._sw.lat&&t<this._ne.lat},GeoGlobe.LngLatBounds.prototype.getWidth=function(){return this._ne.lng-this._sw.lng},GeoGlobe.LngLatBounds.prototype.containsLonLat=function(e,t){"boolean"==typeof t&&(t={inclusive:t}),t=t||{};var o=this.contains(e.lng,e.lat,t.inclusive),r=t.worldBounds;if(r&&!o){var i=r.getWidth(),n=(r._sw.lng+r._ne.lng)/2,s=Math.round((e.lng-n)/i);o=this.containsLonLat({lng:e.lng-s*i,lat:e.lat},{inclusive:t.inclusive})}return o},GeoGlobe.LngLatBounds.prototype.equals=function(e){var t=!1;return null!=e&&(t=this._sw.lng==e._sw.lng&&this._ne.lng==e._ne.lng&&this._ne.lat==e._ne.lat&&this._sw.lat==e._sw.lat),t},GeoGlobe.LngLatBounds.prototype.toBBOX=function(e,t){null==e&&(e=6);var o=Math.pow(10,e),r=Math.round(this._sw.lng*o)/o,i=Math.round(this._sw.lat*o)/o,n=Math.round(this._ne.lng*o)/o,s=Math.round(this._ne.lat*o)/o;return!0===t?i+","+r+","+s+","+n:r+","+i+","+n+","+s},GeoGlobe.LngLatBounds.prototype.toGeometry=function(){return new GeoGlobe.Geometry.Polygon([new GeoGlobe.Geometry.LinearRing([new GeoGlobe.Geometry.Point(this._sw.lng,this._sw.lat),new GeoGlobe.Geometry.Point(this._ne.lng,this._sw.lat),new GeoGlobe.Geometry.Point(this._ne.lng,this._ne.lat),new GeoGlobe.Geometry.Point(this._sw.lng,this._ne.lat)])])},GeoGlobe.LngLatBounds.prototype.getCenterLonLat=function(){return this.centerLonLat||(this.centerLonLat=new GeoGlobe.LngLat((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)),this.centerLonLat},GeoGlobe.LngLatBounds.prototype.CLASS_NAME="GeoGlobe.LngLatBounds",GeoGlobe.LngLatBounds.fromString=function(e,t){var o=e.split(",");return GeoGlobe.LngLatBounds.fromArray(o,t)},GeoGlobe.LngLatBounds.fromArray=function(e,t){return!0===t?new GeoGlobe.LngLatBounds(new GeoGlobe.LngLat(e[1],e[0]),new GeoGlobe.LngLat(e[3],e[2])):new GeoGlobe.LngLatBounds(new GeoGlobe.LngLat(e[0],e[1]),new GeoGlobe.LngLat(e[2],e[3]))},GeoGlobe.Geometry=GeoGlobe.Class4OL({id:null,parent:null,bounds:null,initialize:function(){this.id=GeoGlobe.Util.createUniqueID(this.CLASS_NAME+"_")},destroy:function(){this.id=null,this.bounds=null},clone:function(){return new GeoGlobe.Geometry},setBounds:function(e){e&&(this.bounds=e.clone())},clearBounds:function(){this.bounds=null,this.parent&&this.parent.clearBounds()},extendBounds:function(e){this.getBounds()?this.bounds.extend(e):this.setBounds(e)},getBounds:function(){return null==this.bounds&&this.calculateBounds(),this.bounds},calculateBounds:function(){},distanceTo:function(e,t){},getVertices:function(e){},atPoint:function(e,t,o){var r=!1;if(null!=this.getBounds()&&null!=e){var i=null!=t?t:0,n=null!=o?o:0,s=new GeoGlobe.LngLat(this.bounds._sw.lng-i,this.bounds._sw.lat-n),a=new GeoGlobe.LngLat(this.bounds._ne.lng+i,this.bounds._ne.lat+n);r=new GeoGlobe.LngLatBounds(s,a).containsLonLat(e)}return r},getLength:function(){return 0},getArea:function(){return 0},getCentroid:function(){return null},toString:function(){return GeoGlobe.Format&&GeoGlobe.Format.WKT?GeoGlobe.Format.WKT.prototype.write(new GeoGlobe.Feature(this)):Object.prototype.toString.call(this)},CLASS_NAME:"GeoGlobe.Geometry"}),GeoGlobe.Geometry.fromWKT=function(e){var t;if(GeoGlobe.Format&&GeoGlobe.Format.WKT){var o=GeoGlobe.Geometry.fromWKT.format;o||(o=new GeoGlobe.Format.WKT,GeoGlobe.Geometry.fromWKT.format=o);var r=o.read(e);if(r instanceof GeoGlobe.Feature)t=r.geometry;else if(GeoGlobe.Util.isArray(r)){for(var i=r.length,n=new Array(i),s=0;s<i;++s)n[s]=r[s].geometry;t=new GeoGlobe.Geometry.Collection(n)}}return t},GeoGlobe.Geometry.segmentsIntersect=function(e,t,o){var r=o&&o.point,i=o&&o.tolerance,n=!1,s=e.x1-t.x1,a=e.y1-t.y1,l=e.x2-e.x1,u=e.y2-e.y1,c=t.y2-t.y1,p=t.x2-t.x1,h=c*l-p*u,f=p*a-c*s,d=l*a-u*s;if(0==h)0==f&&0==d&&(n=!0);else{var G=f/h,m=d/h;if(G>=0&&G<=1&&m>=0&&m<=1)if(r){var g=e.x1+G*l,y=e.y1+G*u;n=new GeoGlobe.Geometry.Point(g,y)}else n=!0}if(i)if(n){if(r){var b,S=[e,t];e:for(var v=0;v<2;++v){b=S[v];for(var N=1;N<3;++N)if(g=b["x"+N],y=b["y"+N],Math.sqrt(Math.pow(g-n.x,2)+Math.pow(y-n.y,2))<i){n.x=g,n.y=y;break e}}}}else{var w,C,E;S=[e,t];e:for(v=0;v<2;++v){w=S[v],C=S[(v+1)%2];for(N=1;N<3;++N)if(E={x:w["x"+N],y:w["y"+N]},GeoGlobe.Geometry.distanceToSegment(E,C).distance<i){n=!r||new GeoGlobe.Geometry.Point(E.x,E.y);break e}}}return n},GeoGlobe.Geometry.distanceToSegment=function(e,t){var o=GeoGlobe.Geometry.distanceSquaredToSegment(e,t);return o.distance=Math.sqrt(o.distance),o},GeoGlobe.Geometry.distanceSquaredToSegment=function(e,t){var o,r,i=e.x,n=e.y,s=t.x1,a=t.y1,l=t.x2,u=t.y2,c=l-s,p=u-a,h=0==c&&0==p?0:(c*(i-s)+p*(n-a))/(Math.pow(c,2)+Math.pow(p,2));return h<=0?(o=s,r=a):h>=1?(o=l,r=u):(o=s+h*c,r=a+h*p),{distance:Math.pow(o-i,2)+Math.pow(r-n,2),x:o,y:r,along:h}},GeoGlobe.Geometry.fromGeoJson=function(e){var t;if(GeoGlobe.Format&&GeoGlobe.Format.GeoJSON){format=new GeoGlobe.Format.GeoJSON;var o=null;try{o=format.parseGeometry(geojson)}catch(e){console.log(e)}t=o}return t},GeoGlobe.Geometry.Collection=GeoGlobe.Class4OL(GeoGlobe.Geometry,{components:null,componentTypes:null,initialize:function(e){GeoGlobe.Geometry.prototype.initialize.apply(this,arguments),this.components=[],null!=e&&this.addComponents(e)},destroy:function(){this.components.length=0,this.components=null,GeoGlobe.Geometry.prototype.destroy.apply(this,arguments)},clone:function(){for(var geometry=eval("new "+this.CLASS_NAME+"()"),i=0,len=this.components.length;i<len;i++)geometry.addComponent(this.components[i].clone());return GeoGlobe.Util.applyDefaults(geometry,this),geometry},getComponentsString:function(){for(var e=[],t=0,o=this.components.length;t<o;t++)e.push(this.components[t].toShortString());return e.join(",")},calculateBounds:function(){this.bounds=null;var e=new GeoGlobe.LngLatBounds,t=this.components;if(t)for(var o=0,r=t.length;o<r;o++)e.extend(t[o].getBounds());null!=e._sw&&null!=e._sw&&null!=e._ne&&null!=e._ne&&null!=e._sw.lng&&null!=e._sw.lat&&null!=e._ne.lng&&null!=e._ne.lat&&this.setBounds(e)},addComponents:function(e){GeoGlobe.Util.isArray(e)||(e=[e]);for(var t=0,o=e.length;t<o;t++)this.addComponent(e[t])},addComponent:function(e,t){var o=!1;if(e&&(null==this.componentTypes||GeoGlobe.Util.indexOf(this.componentTypes,e.CLASS_NAME)>-1)){if(null!=t&&t<this.components.length){var r=this.components.slice(0,t),i=this.components.slice(t,this.components.length);r.push(e),this.components=r.concat(i)}else this.components.push(e);e.parent=this,this.clearBounds(),o=!0}return o},removeComponents:function(e){var t=!1;GeoGlobe.Util.isArray(e)||(e=[e]);for(var o=e.length-1;o>=0;--o)t=this.removeComponent(e[o])||t;return t},removeComponent:function(e){return GeoGlobe.Util.removeItem(this.components,e),this.clearBounds(),!0},getLength:function(){for(var e=0,t=0,o=this.components.length;t<o;t++)e+=this.components[t].getLength();return e},getArea:function(){for(var e=0,t=0,o=this.components.length;t<o;t++)e+=this.components[t].getArea();return e},getGeodesicArea:function(e){for(var t=0,o=0,r=this.components.length;o<r;o++)t+=this.components[o].getGeodesicArea(e);return t},getCentroid:function(e){if(!e)return this.components.length&&this.components[0].getCentroid();var t=this.components.length;if(!t)return!1;for(var o,r=[],i=[],n=0,s=Number.MAX_VALUE,a=0;a<t;++a){var l=(o=this.components[a]).getArea(),u=o.getCentroid(!0);isNaN(l)||isNaN(u.x)||isNaN(u.y)||(r.push(l),n+=l,s=l<s&&l>0?l:s,i.push(u))}if(t=r.length,0===n){for(a=0;a<t;++a)r[a]=1;n=r.length}else{for(a=0;a<t;++a)r[a]/=s;n/=s}var c=0,p=0;for(a=0;a<t;++a)u=i[a],l=r[a],c+=u.x*l,p+=u.y*l;return new GeoGlobe.Geometry.Point(c/n,p/n)},getGeodesicLength:function(e){for(var t=0,o=0,r=this.components.length;o<r;o++)t+=this.components[o].getGeodesicLength(e);return t},move:function(e,t){for(var o=0,r=this.components.length;o<r;o++)this.components[o].move(e,t)},rotate:function(e,t){for(var o=0,r=this.components.length;o<r;++o)this.components[o].rotate(e,t)},resize:function(e,t,o){for(var r=0;r<this.components.length;++r)this.components[r].resize(e,t,o);return this},distanceTo:function(e,t){for(var o,r,i,n=!(t&&!1===t.edge)&&t&&t.details,s=Number.POSITIVE_INFINITY,a=0,l=this.components.length;a<l&&(o=this.components[a].distanceTo(e,t),!((i=n?o.distance:o)<s&&(r=o,0==(s=i))));++a);return r},equals:function(e){var t=!0;if(e&&e.CLASS_NAME&&this.CLASS_NAME==e.CLASS_NAME)if(GeoGlobe.Util.isArray(e.components)&&e.components.length==this.components.length){for(var o=0,r=this.components.length;o<r;++o)if(!this.components[o].equals(e.components[o])){t=!1;break}}else t=!1;else t=!1;return t},transform:function(e,t){if(e&&t){for(var o=0,r=this.components.length;o<r;o++){this.components[o].transform(e,t)}this.bounds=null}return this},intersects:function(e){for(var t=!1,o=0,r=this.components.length;o<r&&!(t=e.intersects(this.components[o]));++o);return t},getVertices:function(e){for(var t=[],o=0,r=this.components.length;o<r;++o)Array.prototype.push.apply(t,this.components[o].getVertices(e));return t},CLASS_NAME:"GeoGlobe.Geometry.Collection"}),GeoGlobe.Geometry.Point=GeoGlobe.Class4OL(GeoGlobe.Geometry,{x:null,y:null,initialize:function(e,t){GeoGlobe.Geometry.prototype.initialize.apply(this,arguments),this.x=parseFloat(e),this.y=parseFloat(t)},clone:function(e){return null==e&&(e=new GeoGlobe.Geometry.Point(this.x,this.y)),GeoGlobe.Util.applyDefaults(e,this),e},calculateBounds:function(){var e=new GeoGlobe.LngLat(this.x,this.y),t=new GeoGlobe.LngLat(this.x,this.y);this.bounds=new GeoGlobe.LngLatBounds(e,t)},distanceTo:function(e,t){var o,r,i,n,s,a,l=!(t&&!1===t.edge)&&t&&t.details;return e instanceof GeoGlobe.Geometry.Point?(r=this.x,i=this.y,n=e.x,s=e.y,o=Math.sqrt(Math.pow(r-n,2)+Math.pow(i-s,2)),a=l?{x0:r,y0:i,x1:n,y1:s,distance:o}:o):(a=e.distanceTo(this,t),l&&(a={x0:a.x1,y0:a.y1,x1:a.x0,y1:a.y0,distance:a.distance})),a},equals:function(e){var t=!1;return null!=e&&(t=this.x==e.x&&this.y==e.y||isNaN(this.x)&&isNaN(this.y)&&isNaN(e.x)&&isNaN(e.y)),t},toShortString:function(){return this.x+", "+this.y},move:function(e,t){this.x=this.x+e,this.y=this.y+t,this.clearBounds()},rotate:function(e,t){e*=Math.PI/180;var o=this.distanceTo(t),r=e+Math.atan2(this.y-t.y,this.x-t.x);this.x=t.x+o*Math.cos(r),this.y=t.y+o*Math.sin(r),this.clearBounds()},getCentroid:function(){return new GeoGlobe.Geometry.Point(this.x,this.y)},resize:function(e,t,o){return o=void 0==o?1:o,this.x=t.x+e*o*(this.x-t.x),this.y=t.y+e*(this.y-t.y),this.clearBounds(),this},intersects:function(e){return"GeoGlobe.Geometry.Point"==e.CLASS_NAME?this.equals(e):e.intersects(this)},transform:function(e,t){return e&&t&&(GeoGlobe.SpatialReference.transform(this,e,t),this.bounds=null),this},getVertices:function(e){return[this]},CLASS_NAME:"GeoGlobe.Geometry.Point"}),GeoGlobe.Geometry.MultiPoint=GeoGlobe.Class4OL(GeoGlobe.Geometry.Collection,{componentTypes:["GeoGlobe.Geometry.Point"],addPoint:function(e,t){this.addComponent(e,t)},removePoint:function(e){this.removeComponent(e)},CLASS_NAME:"GeoGlobe.Geometry.MultiPoint"}),GeoGlobe.Geometry.Curve=GeoGlobe.Class4OL(GeoGlobe.Geometry.MultiPoint,{componentTypes:["GeoGlobe.Geometry.Point"],getLength:function(){var e=0;if(this.components&&this.components.length>1)for(var t=1,o=this.components.length;t<o;t++)e+=this.components[t-1].distanceTo(this.components[t]);return e},getGeodesicLength:function(e){var t=this;if(e){var o=new GeoGlobe.SpatialReference("EPSG:4326");o.equals(e)||(t=this.clone().transform(e,o))}var r=0;if(t.components&&t.components.length>1)for(var i,n,s=1,a=t.components.length;s<a;s++)i=t.components[s-1],n=t.components[s],r+=GeoGlobe.Util.distVincenty({lng:i.x,lat:i.y},{lng:n.x,lat:n.y});return 1e3*r},CLASS_NAME:"GeoGlobe.Geometry.Curve"}),GeoGlobe.Geometry.LineString=GeoGlobe.Class4OL(GeoGlobe.Geometry.Curve,{removeComponent:function(e){var t=this.components&&this.components.length>2;return t&&GeoGlobe.Geometry.Collection.prototype.removeComponent.apply(this,arguments),t},intersects:function(e){var t=!1,o=e.CLASS_NAME;if("GeoGlobe.Geometry.LineString"==o||"GeoGlobe.Geometry.LinearRing"==o||"GeoGlobe.Geometry.Point"==o){var r,i,n,s,a,l,u,c,p,h=this.getSortedSegments();r="GeoGlobe.Geometry.Point"==o?[{x1:e.x,y1:e.y,x2:e.x,y2:e.y}]:e.getSortedSegments();e:for(var f=0,d=h.length;f<d;++f){n=(i=h[f]).x1,s=i.x2,a=i.y1,l=i.y2;for(var G=0,m=r.length;G<m&&!((u=r[G]).x1>s);++G)if(!(u.x2<n)&&(c=u.y1,p=u.y2,!(Math.min(c,p)>Math.max(a,l))&&!(Math.max(c,p)<Math.min(a,l))&&GeoGlobe.Geometry.segmentsIntersect(i,u))){t=!0;break e}}}else t=e.intersects(this);return t},getSortedSegments:function(){for(var e,t,o=this.components.length-1,r=new Array(o),i=0;i<o;++i)e=this.components[i],t=this.components[i+1],e.x<t.x?r[i]={x1:e.x,y1:e.y,x2:t.x,y2:t.y}:r[i]={x1:t.x,y1:t.y,x2:e.x,y2:e.y};return r.sort(function(e,t){return e.x1-t.x1})},splitWithSegment:function(e,t){for(var o,r,i,n,s=!(t&&!1===t.edge),a=t&&t.tolerance,l=[],u=this.getVertices(),c=[],p=[],h=!1,f={point:!0,tolerance:a},d=null,G=0,m=u.length-2;G<=m;++G)if(o=u[G],c.push(o.clone()),r=u[G+1],n={x1:o.x,y1:o.y,x2:r.x,y2:r.y},(i=GeoGlobe.Geometry.segmentsIntersect(e,n,f))instanceof GeoGlobe.Geometry.Point&&(!!(i.x===e.x1&&i.y===e.y1||i.x===e.x2&&i.y===e.y2||i.equals(o)||i.equals(r))||s)){if(i.equals(p[p.length-1])||p.push(i.clone()),0===G&&i.equals(o))continue;if(i.equals(r))continue;h=!0,i.equals(o)||c.push(i),l.push(new GeoGlobe.Geometry.LineString(c)),c=[i.clone()]}if(h&&(c.push(r.clone()),l.push(new GeoGlobe.Geometry.LineString(c))),p.length>0){var g=e.x1<e.x2?1:-1,y=e.y1<e.y2?1:-1;d={lines:l,points:p.sort(function(e,t){return g*e.x-g*t.x||y*e.y-y*t.y})}}return d},split:function(e,t){var o,r,i,n,s=null,a=t&&t.mutual;if(e instanceof GeoGlobe.Geometry.LineString){var l,u,c,p,h,f,d=this.getVertices(),G=[];i=[];for(var m=0,g=d.length-2;m<=g;++m){l=d[m],u=d[m+1],c={x1:l.x,y1:l.y,x2:u.x,y2:u.y},n=n||[e],a&&G.push(l.clone());for(var y=0;y<n.length;++y)if((p=n[y].splitWithSegment(c,t))&&((h=p.lines).length>0&&(h.unshift(y,1),Array.prototype.splice.apply(n,h),y+=h.length-2),a))for(var b=0,S=p.points.length;b<S;++b)(f=p.points[b]).equals(l)||(G.push(f),i.push(new GeoGlobe.Geometry.LineString(G)),G=f.equals(u)?[]:[f.clone()])}a&&i.length>0&&G.length>0&&(G.push(u.clone()),i.push(new GeoGlobe.Geometry.LineString(G)))}else s=e.splitWith(this,t);return n&&n.length>1?r=!0:n=[],i&&i.length>1?o=!0:i=[],(r||o)&&(s=a?[i,n]:n),s},splitWith:function(e,t){return e.split(this,t)},getVertices:function(e){return!0===e?[this.components[0],this.components[this.components.length-1]]:!1===e?this.components.slice(1,this.components.length-1):this.components.slice()},distanceTo:function(e,t){var o,r=!(t&&!1===t.edge)&&t&&t.details,i={},n=Number.POSITIVE_INFINITY;if(e instanceof GeoGlobe.Geometry.Point){for(var s,a=this.getSortedSegments(),l=e.x,u=e.y,c=0,p=a.length;c<p;++c)if(s=a[c],(o=GeoGlobe.Geometry.distanceToSegment(e,s)).distance<n){if(i=o,0===(n=o.distance))break}else if(s.x2>l&&(u>s.y1&&u<s.y2||u<s.y1&&u>s.y2))break;i=r?{distance:i.distance,x0:i.x,y0:i.y,x1:l,y1:u}:i.distance}else if(e instanceof GeoGlobe.Geometry.LineString){var h,f,d,G,m,g=this.getSortedSegments(),y=e.getSortedSegments(),b=y.length,S={point:!0};e:for(c=0,p=g.length;c<p;++c){G=(h=g[c]).x1,m=h.y1;for(var v=0;v<b;++v){if(f=y[v],d=GeoGlobe.Geometry.segmentsIntersect(h,f,S)){n=0,i={distance:0,x0:d.x,y0:d.y,x1:d.x,y1:d.y};break e}(o=GeoGlobe.Geometry.distanceToSegment({x:G,y:m},f)).distance<n&&(i={distance:n=o.distance,x0:G,y0:m,x1:o.x,y1:o.y})}}if(r||(i=i.distance),0!==n&&h){o=e.distanceTo(new GeoGlobe.Geometry.Point(h.x2,h.y2),t);var N=r?o.distance:o;N<n&&(i=r?{distance:n,x0:o.x1,y0:o.y1,x1:o.x0,y1:o.y0}:N)}}else i=e.distanceTo(this,t),r&&(i={distance:i.distance,x0:i.x1,y0:i.y1,x1:i.x0,y1:i.y0});return i},simplify:function(e){if(this&&null!==this){var t=this.getVertices();if(t.length<3)return this;var o=function(e,t,i,s){for(var a,l=0,u=0,c=t;c<i;c++)(a=r(e[t],e[i],e[c]))>l&&(l=a,u=c);l>s&&u!=t&&(n.push(u),o(e,t,u,s),o(e,u,i,s))},r=function(e,t,o){return Math.abs(.5*(e.x*t.y+t.x*o.y+o.x*e.y-t.x*e.y-o.x*t.y-e.x*o.y))/Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))*2},i=t.length-1,n=[];for(n.push(0),n.push(i);t[0].equals(t[i]);)i--,n.push(i);o(t,0,i,e);var s=[];n.sort(function(e,t){return e-t});for(var a=0;a<n.length;a++)s.push(t[n[a]]);return new GeoGlobe.Geometry.LineString(s)}return this},CLASS_NAME:"GeoGlobe.Geometry.LineString"}),GeoGlobe.Geometry.LineString.createCurveLine=function(e){for(var t=[],o=0;o<e.length-1;o++){var r=GeoGlobe.Geometry.LineString.getCurveCoordinatesByTwoPoints(e[o],e[o+1]);r&&r.length>0&&(t=t.concat(r))}return new GeoGlobe.Geometry.LineString(t)},GeoGlobe.Geometry.LineString.getCurveCoordinatesByTwoPoints=function(e,t){if(!(e&&t&&e instanceof GeoGlobe.Geometry.Point&&t instanceof GeoGlobe.Geometry.Point))return null;var o=function(e){return 1-2*e+e*e},r=function(e){return 2*e-2*e*e},i=function(e){return e*e};curveCoordinates=[];var n,s,a,l,u,c,p=0,h=0;if(void 0!==t){var f=parseFloat(e.y),d=parseFloat(t.y),G=parseFloat(e.x),m=parseFloat(t.x);for(m>G&&parseFloat(m-G)>180&&G<0&&(G=parseFloat(360+G)),G>m&&parseFloat(G-m)>180&&m<0&&(m=parseFloat(360+m)),0,c=0,d==f?(n=0,s=G-m):m==G?(n=Math.PI/2,s=f-d):(n=Math.atan((d-f)/(m-G)),s=(d-f)/Math.sin(n)),0==c&&(c=n+Math.PI/5),u=(a=s/2)*Math.cos(c)+G,l=a*Math.sin(c)+f,p=0;p<31;p++)curveCoordinates.push(new GeoGlobe.Geometry.Point(G*o(h)+u*r(h)+m*i(h),f*o(h)+l*r(h)+d*i(h))),h+=1/30;return curveCoordinates}"undefined"!=typeof curveCoordinates&&(curveCoordinates=[])},GeoGlobe.Geometry.LinearRing=GeoGlobe.Class4OL(GeoGlobe.Geometry.LineString,{componentTypes:["GeoGlobe.Geometry.Point"],addComponent:function(e,t){var o=!1,r=this.components.pop();null==t&&e.equals(r)||(o=GeoGlobe.Geometry.Collection.prototype.addComponent.apply(this,arguments));var i=this.components[0];return GeoGlobe.Geometry.Collection.prototype.addComponent.apply(this,[i]),o},removeComponent:function(e){var t=this.components&&this.components.length>3;if(t){this.components.pop(),GeoGlobe.Geometry.Collection.prototype.removeComponent.apply(this,arguments);var o=this.components[0];GeoGlobe.Geometry.Collection.prototype.addComponent.apply(this,[o])}return t},move:function(e,t){for(var o=0,r=this.components.length;o<r-1;o++)this.components[o].move(e,t)},rotate:function(e,t){for(var o=0,r=this.components.length;o<r-1;++o)this.components[o].rotate(e,t)},resize:function(e,t,o){for(var r=0,i=this.components.length;r<i-1;++r)this.components[r].resize(e,t,o);return this},transform:function(e,t){if(e&&t){for(var o=0,r=this.components.length;o<r-1;o++){this.components[o].transform(e,t)}this.bounds=null}return this},getCentroid:function(){if(this.components){var e=this.components.length;if(e>0&&e<=2)return this.components[0].clone();if(e>2){var t=0,o=0,r=this.components[0].x,i=this.components[0].y,n=-1*this.getArea();if(0!=n){for(var s=0;s<e-1;s++){var a=this.components[s],l=this.components[s+1];t+=(a.x+l.x-2*r)*((a.x-r)*(l.y-i)-(l.x-r)*(a.y-i)),o+=(a.y+l.y-2*i)*((a.x-r)*(l.y-i)-(l.x-r)*(a.y-i))}var u=r+t/(6*n),c=i+o/(6*n)}else{for(s=0;s<e-1;s++)t+=this.components[s].x,o+=this.components[s].y;u=t/(e-1),c=o/(e-1)}return new GeoGlobe.Geometry.Point(u,c)}return null}},getArea:function(){var e=0;if(this.components&&this.components.length>2){for(var t=0,o=0,r=this.components.length;o<r-1;o++){var i=this.components[o],n=this.components[o+1];t+=(i.x+n.x)*(n.y-i.y)}e=-t/2}return e},getGeodesicArea:function(e){var t=this;if(e){var o=new GeoGlobe.SpatialReference("EPSG:4326");o.equals(e)||(t=this.clone().transform(e,o))}var r=0,i=t.components&&t.components.length;if(i>2){for(var n,s,a=0;a<i-1;a++)n=t.components[a],s=t.components[a+1],r+=GeoGlobe.Util.rad(s.x-n.x)*(2+Math.sin(GeoGlobe.Util.rad(n.y))+Math.sin(GeoGlobe.Util.rad(s.y)));r=6378137*r*6378137/2}return r},containsPoint:function(e){var t=GeoGlobe.Number.limitSigDigs,o=t(e.x,14),r=t(e.y,14);for(var i,n,s,a,l,u,c,p,h,f=this.components.length-1,d=0,G=0;G<f;++G)if(s=t((i=this.components[G]).x,14),a=t(i.y,14),l=t((n=this.components[G+1]).x,14),a!=(u=t(n.y,14))){if((c=t(((p=l)-s)/((h=u)-a)*(r-h)+p,14))==o&&(a<u&&r>=a&&r<=u||a>u&&r<=a&&r>=u)){d=-1;break}c<=o||s!=l&&(c<Math.min(s,l)||c>Math.max(s,l))||(a<u&&r>=a&&r<u||a>u&&r<a&&r>=u)&&++d}else if(r==a&&(s<=l&&o>=s&&o<=l||s>=l&&o<=s&&o>=l)){d=-1;break}return-1==d?1:!!(1&d)},intersects:function(e){var t=!1;if("GeoGlobe.Geometry.Point"==e.CLASS_NAME)t=this.containsPoint(e);else if("GeoGlobe.Geometry.LineString"==e.CLASS_NAME)t=e.intersects(this);else if("GeoGlobe.Geometry.LinearRing"==e.CLASS_NAME)t=GeoGlobe.Geometry.LineString.prototype.intersects.apply(this,[e]);else for(var o=0,r=e.components.length;o<r&&!(t=e.components[o].intersects(this));++o);return t},getVertices:function(e){return!0===e?[]:this.components.slice(0,this.components.length-1)},CLASS_NAME:"GeoGlobe.Geometry.LinearRing"}),GeoGlobe.Geometry.Polygon=GeoGlobe.Class4OL(GeoGlobe.Geometry.Collection,{componentTypes:["GeoGlobe.Geometry.LinearRing"],getArea:function(){var e=0;if(this.components&&this.components.length>0){e+=Math.abs(this.components[0].getArea());for(var t=1,o=this.components.length;t<o;t++)e-=Math.abs(this.components[t].getArea())}return e},getGeodesicArea:function(e){var t=0;if(this.components&&this.components.length>0){t+=Math.abs(this.components[0].getGeodesicArea(e));for(var o=1,r=this.components.length;o<r;o++)t-=Math.abs(this.components[o].getGeodesicArea(e))}return t},containsPoint:function(e){var t=this.components.length,o=!1;if(t>0&&1!==(o=this.components[0].containsPoint(e))&&o&&t>1)for(var r,i=1;i<t;++i)if(r=this.components[i].containsPoint(e)){o=1===r&&1;break}return o},intersects:function(e){var t,o,r=!1;if("GeoGlobe.Geometry.Point"==e.CLASS_NAME)r=this.containsPoint(e);else if("GeoGlobe.Geometry.LineString"==e.CLASS_NAME||"GeoGlobe.Geometry.LinearRing"==e.CLASS_NAME){for(t=0,o=this.components.length;t<o&&!(r=e.intersects(this.components[t]));++t);if(!r)for(t=0,o=e.components.length;t<o&&!(r=this.containsPoint(e.components[t]));++t);}else for(t=0,o=e.components.length;t<o&&!(r=this.intersects(e.components[t]));++t);if(!r&&"GeoGlobe.Geometry.Polygon"==e.CLASS_NAME){var i=this.components[0];for(t=0,o=i.components.length;t<o&&!(r=e.containsPoint(i.components[t]));++t);}return r},distanceTo:function(e,t){return!!(t&&!1===t.edge)&&this.intersects(e)?0:GeoGlobe.Geometry.Collection.prototype.distanceTo.apply(this,[e,t])},CLASS_NAME:"GeoGlobe.Geometry.Polygon"}),GeoGlobe.Geometry.Polygon.createRegularPolygon=function(e,t,o,r){var i,n,s,a=Math.PI*(1/o-.5);r&&(a+=r/180*Math.PI);for(var l=[],u=0;u<o;++u)i=a+2*u*Math.PI/o,n=e.x+t*Math.cos(i),s=e.y+t*Math.sin(i),l.push(new GeoGlobe.Geometry.Point(n,s));var c=new GeoGlobe.Geometry.LinearRing(l);return new GeoGlobe.Geometry.Polygon([c])},GeoGlobe.Geometry.MultiLineString=GeoGlobe.Class4OL(GeoGlobe.Geometry.Collection,{componentTypes:["GeoGlobe.Geometry.LineString"],split:function(e,t){for(var o,r,i,n,s,a=null,l=t&&t.mutual,u=[],c=[e],p=0,h=this.components.length;p<h;++p){r=this.components[p],n=!1;for(var f=0;f<c.length;++f)if(o=r.split(c[f],t)){if(l){for(var d=0,G=(i=o[0]).length;d<G;++d)0===d&&u.length?u[u.length-1].addComponent(i[d]):u.push(new GeoGlobe.Geometry.MultiLineString([i[d]]));n=!0,o=o[1]}if(o.length){o.unshift(f,1),Array.prototype.splice.apply(c,o);break}}n||(u.length?u[u.length-1].addComponent(r.clone()):u=[new GeoGlobe.Geometry.MultiLineString(r.clone())])}return u&&u.length>1?n=!0:u=[],c&&c.length>1?s=!0:c=[],(n||s)&&(a=l?[u,c]:c),a},splitWith:function(e,t){var o,r,i,n,s,a,l,u=null,c=t&&t.mutual;if(e instanceof GeoGlobe.Geometry.LineString){l=[],a=[e];for(var p=0,h=this.components.length;p<h;++p){s=!1,r=this.components[p];for(var f=0;f<a.length;++f)if(o=a[f].split(r,t)){c&&((i=o[0]).length&&(i.unshift(f,1),Array.prototype.splice.apply(a,i),f+=i.length-2),0===(o=o[1]).length&&(o=[r.clone()]));for(var d=0,G=o.length;d<G;++d)0===d&&l.length?l[l.length-1].addComponent(o[d]):l.push(new GeoGlobe.Geometry.MultiLineString([o[d]]));s=!0}s||(l.length?l[l.length-1].addComponent(r.clone()):l=[new GeoGlobe.Geometry.MultiLineString([r.clone()])])}}else u=e.split(this);return a&&a.length>1?n=!0:a=[],l&&l.length>1?s=!0:l=[],(n||s)&&(u=c?[a,l]:l),u},CLASS_NAME:"GeoGlobe.Geometry.MultiLineString"}),GeoGlobe.Geometry.MultiPolygon=GeoGlobe.Class4OL(GeoGlobe.Geometry.Collection,{componentTypes:["GeoGlobe.Geometry.Polygon"],CLASS_NAME:"GeoGlobe.Geometry.MultiPolygon"}),GeoGlobe.State={UNKNOWN:"Unknown",INSERT:"Insert",UPDATE:"Update",DELETE:"Delete"},GeoGlobe.Feature=GeoGlobe.Class4OL({id:null,fid:null,lonlat:null,geometry:null,attributes:null,data:null,bounds:null,state:null,url:null,modified:null,initialize:function(e,t){this.data=null!=t?t:{},this.id=GeoGlobe.Util.createUniqueID(this.CLASS_NAME+"_"),this.lonlat=null,this.geometry=e||null,this.state=null,this.attributes={},t&&(this.attributes=GeoGlobe.Util.extend(this.attributes,t))},destroy:function(){this.geometry=null,this.modified=null,this.id=null,this.lonlat=null,this.data=null},clone:function(){return new GeoGlobe.Feature(this.geometry?this.geometry.clone():null,this.attributes)},createMarker:function(){return null},destroyMarker:function(){},createPopup:function(){return null},atPoint:function(e,t,o){var r=!1;return this.geometry&&(r=this.geometry.atPoint(e,t,o)),r},destroyPopup:function(){},toState:function(e){if(e==GeoGlobe.State.UPDATE)switch(this.state){case GeoGlobe.State.UNKNOWN:case GeoGlobe.State.DELETE:this.state=e;break;case GeoGlobe.State.UPDATE:case GeoGlobe.State.INSERT:}else if(e==GeoGlobe.State.INSERT)switch(this.state){case GeoGlobe.State.UNKNOWN:break;default:this.state=e}else if(e==GeoGlobe.State.DELETE)switch(this.state){case GeoGlobe.State.INSERT:case GeoGlobe.State.DELETE:break;case GeoGlobe.State.UNKNOWN:case GeoGlobe.State.UPDATE:this.state=e}else e==GeoGlobe.State.UNKNOWN&&(this.state=e)},CLASS_NAME:"GeoGlobe.Feature"}),GeoGlobe.Feature.getBoundsByFeatures=function(e){for(var t=e.length,o=new Array(t),r=0;r<t;++r)o[r]=e[r].geometry;var i=new GeoGlobe.Geometry.Collection(o);return i.calculateBounds(),i.bounds},GeoGlobe.Feature.fromGeoJson=function(e){if(GeoGlobe.Format&&GeoGlobe.Format.GeoJSON){format=new GeoGlobe.Format.GeoJSON;var t=format.read(e)}return t},GeoGlobe.Filter=GeoGlobe.Class4OL({initialize:function(e){GeoGlobe.Util.extend(this,e)},destroy:function(){},evaluate:function(e){return!0},clone:function(){return null},toString:function(){return GeoGlobe.Format&&GeoGlobe.Format.CQL?GeoGlobe.Format.CQL.prototype.write(this):Object.prototype.toString.call(this)},CLASS_NAME:"GeoGlobe.Filter"}),GeoGlobe.Filter.FeatureId=GeoGlobe.Class4OL(GeoGlobe.Filter,{fids:null,type:"FID",initialize:function(e){this.fids=[],GeoGlobe.Filter.prototype.initialize.apply(this,[e])},evaluate:function(e){for(var t=0,o=this.fids.length;t<o;t++){if((e.fid||e.id)==this.fids[t])return!0}return!1},clone:function(){var e=new GeoGlobe.Filter.FeatureId;return GeoGlobe.Util.extend(e,this),e.fids=this.fids.slice(),e},CLASS_NAME:"GeoGlobe.Filter.FeatureId"}),GeoGlobe.Filter.Logical=GeoGlobe.Class4OL(GeoGlobe.Filter,{filters:null,type:null,initialize:function(e){this.filters=[],GeoGlobe.Filter.prototype.initialize.apply(this,[e])},destroy:function(){this.filters=null,GeoGlobe.Filter.prototype.destroy.apply(this)},evaluate:function(e){var t,o;switch(this.type){case GeoGlobe.Filter.Logical.AND:for(t=0,o=this.filters.length;t<o;t++)if(0==this.filters[t].evaluate(e))return!1;return!0;case GeoGlobe.Filter.Logical.OR:for(t=0,o=this.filters.length;t<o;t++)if(1==this.filters[t].evaluate(e))return!0;return!1;case GeoGlobe.Filter.Logical.NOT:return!this.filters[0].evaluate(e)}},clone:function(){for(var e=[],t=0,o=this.filters.length;t<o;++t)e.push(this.filters[t].clone());return new GeoGlobe.Filter.Logical({type:this.type,filters:e})},CLASS_NAME:"GeoGlobe.Filter.Logical"}),GeoGlobe.Filter.Logical.AND="&&",GeoGlobe.Filter.Logical.OR="||",GeoGlobe.Filter.Logical.NOT="!",GeoGlobe.Filter.Comparison=GeoGlobe.Class4OL(GeoGlobe.Filter,{type:null,property:null,value:null,matchCase:!0,lowerBoundary:null,upperBoundary:null,initialize:function(e){GeoGlobe.Filter.prototype.initialize.apply(this,[e]),this.type===GeoGlobe.Filter.Comparison.LIKE&&void 0===e.matchCase&&(this.matchCase=null)},evaluate:function(e){e instanceof GeoGlobe.Feature&&(e=e.attributes);var t,o=!1,r=e[this.property];if(void 0===r)return!1;switch(this.type){case GeoGlobe.Filter.Comparison.EQUAL_TO:t=this.value,o=this.matchCase||"string"!=typeof r||"string"!=typeof t?r==t:r.toUpperCase()==t.toUpperCase();break;case GeoGlobe.Filter.Comparison.NOT_EQUAL_TO:t=this.value,o=this.matchCase||"string"!=typeof r||"string"!=typeof t?r!=t:r.toUpperCase()!=t.toUpperCase();break;case GeoGlobe.Filter.Comparison.LESS_THAN:o=r<this.value;break;case GeoGlobe.Filter.Comparison.GREATER_THAN:o=r>this.value;break;case GeoGlobe.Filter.Comparison.LESS_THAN_OR_EQUAL_TO:o=r<=this.value;break;case GeoGlobe.Filter.Comparison.GREATER_THAN_OR_EQUAL_TO:o=r>=this.value;break;case GeoGlobe.Filter.Comparison.BETWEEN:o=r>=this.lowerBoundary&&r<=this.upperBoundary;break;case GeoGlobe.Filter.Comparison.LIKE:o=new RegExp(this.value,"gi").test(r);break;case GeoGlobe.Filter.Comparison.IS_NULL:o=null===r}return o},value2regex:function(e,t,o){if("."==e)throw new Error("'.' is an unsupported wildCard character for GeoGlobe.Filter.Comparison");return e=e||"*",t=t||".",o=o||"!",this.value=this.value.replace(new RegExp("\\"+o+"(.|$)","g"),"\\$1"),this.value=this.value.replace(new RegExp("\\"+t,"g"),"."),this.value=this.value.replace(new RegExp("\\"+e,"g"),".*"),this.value=this.value.replace(new RegExp("\\\\.\\*","g"),"\\"+e),this.value=this.value.replace(new RegExp("\\\\\\.","g"),"\\"+t),this.value},regex2value:function(){var e=this.value;return e=(e=(e=(e=(e=e.replace(/!/g,"!!")).replace(/(\\)?\\\./g,function(e,t){return t?e:"!."})).replace(/(\\)?\\\*/g,function(e,t){return t?e:"!*"})).replace(/\\\\/g,"\\")).replace(/\.\*/g,"*")},clone:function(){return GeoGlobe.Util.extend(new GeoGlobe.Filter.Comparison,this)},CLASS_NAME:"GeoGlobe.Filter.Comparison"}),GeoGlobe.Filter.Comparison.EQUAL_TO="==",GeoGlobe.Filter.Comparison.NOT_EQUAL_TO="!=",GeoGlobe.Filter.Comparison.LESS_THAN="<",GeoGlobe.Filter.Comparison.GREATER_THAN=">",GeoGlobe.Filter.Comparison.LESS_THAN_OR_EQUAL_TO="<=",GeoGlobe.Filter.Comparison.GREATER_THAN_OR_EQUAL_TO=">=",GeoGlobe.Filter.Comparison.BETWEEN="..",GeoGlobe.Filter.Comparison.LIKE="~",GeoGlobe.Filter.Comparison.IS_NULL="NULL",GeoGlobe.Filter.Spatial=GeoGlobe.Class4OL(GeoGlobe.Filter,{type:null,property:null,value:null,distance:null,distanceUnits:null,evaluate:function(e){var t=!1;switch(this.type){case GeoGlobe.Filter.Spatial.BBOX:case GeoGlobe.Filter.Spatial.INTERSECTS:if(e.geometry){var o=this.value;"GeoGlobe.LngLatBounds"==this.value.CLASS_NAME&&(o=this.value.toGeometry()),e.geometry.intersects(o)&&(t=!0)}break;default:throw new Error("evaluate is not implemented for this filter type.")}return t},clone:function(){var e=GeoGlobe.Util.applyDefaults({value:this.value&&this.value.clone&&this.value.clone()},this);return new GeoGlobe.Filter.Spatial(e)},CLASS_NAME:"GeoGlobe.Filter.Spatial"}),GeoGlobe.Filter.Spatial.BBOX="BBOX",GeoGlobe.Filter.Spatial.INTERSECTS="INTERSECTS",GeoGlobe.Filter.Spatial.DWITHIN="DWITHIN",GeoGlobe.Filter.Spatial.WITHIN="WITHIN",GeoGlobe.Filter.Spatial.CONTAINS="CONTAINS",GeoGlobe.Filter.Function=GeoGlobe.Class4OL(GeoGlobe.Filter,{name:null,params:null,CLASS_NAME:"GeoGlobe.Filter.Function"}),GeoGlobe.Protocol=GeoGlobe.Class4OL({format:null,options:null,autoDestroy:!0,defaultFilter:null,initialize:function(e){e=e||{},GeoGlobe.Util.extend(this,e),this.options=e},mergeWithDefaultFilter:function(e){return e&&this.defaultFilter?new GeoGlobe.Filter.Logical({type:GeoGlobe.Filter.Logical.AND,filters:[this.defaultFilter,e]}):e||this.defaultFilter||void 0},destroy:function(){this.options=null,this.format=null},read:function(e){(e=e||{}).filter=this.mergeWithDefaultFilter(e.filter)},create:function(){},update:function(){},delete:function(){},commit:function(){},abort:function(e){},createCallback:function(e,t,o){return GeoGlobe.Function.bind(function(){e.apply(this,[t,o])},this)},CLASS_NAME:"GeoGlobe.Protocol"}),GeoGlobe.Protocol.Response=GeoGlobe.Class4OL({code:null,requestType:null,last:!0,features:null,data:null,reqFeatures:null,priv:null,error:null,initialize:function(e){GeoGlobe.Util.extend(this,e)},success:function(){return this.code>0},CLASS_NAME:"GeoGlobe.Protocol.Response"}),GeoGlobe.Protocol.Response.SUCCESS=1,GeoGlobe.Protocol.Response.FAILURE=0,GeoGlobe.Protocol.HTTP=GeoGlobe.Class4OL(GeoGlobe.Protocol,{url:null,headers:null,params:null,callback:null,scope:null,readWithPOST:!1,updateWithPOST:!1,deleteWithPOST:!1,wildcarded:!1,srsInBBOX:!1,initialize:function(e){if(e=e||{},this.params={},this.headers={},GeoGlobe.Protocol.prototype.initialize.apply(this,arguments),!this.filterToParams&&GeoGlobe.Format.QueryStringFilter){var t=new GeoGlobe.Format.QueryStringFilter({wildcarded:this.wildcarded,srsInBBOX:this.srsInBBOX});this.filterToParams=function(e,o){return t.write(e,o)}}},destroy:function(){this.params=null,this.headers=null,GeoGlobe.Protocol.prototype.destroy.apply(this)},read:function(e){GeoGlobe.Protocol.prototype.read.apply(this,arguments),(e=e||{}).params=GeoGlobe.Util.applyDefaults(e.params,this.options.params),(e=GeoGlobe.Util.applyDefaults(e,this.options)).filter&&this.filterToParams&&(e.params=this.filterToParams(e.filter,e.params));var t=void 0!==e.readWithPOST?e.readWithPOST:this.readWithPOST,o=new GeoGlobe.Protocol.Response({requestType:"read"});if(t){var r=e.headers||{};r["Content-Type"]="application/x-www-form-urlencoded",o.priv=GeoGlobe.Request.POST({url:e.url,callback:this.createCallback(this.handleRead,o,e),data:GeoGlobe.Util.getParameterString(e.params),headers:r})}else o.priv=GeoGlobe.Request.GET({url:e.url,callback:this.createCallback(this.handleRead,o,e),params:e.params,headers:e.headers});return o},handleRead:function(e,t){this.handleResponse(e,t)},create:function(e,t){t=GeoGlobe.Util.applyDefaults(t,this.options);var o=new GeoGlobe.Protocol.Response({reqFeatures:e,requestType:"create"});return o.priv=GeoGlobe.Request.POST({url:t.url,callback:this.createCallback(this.handleCreate,o,t),headers:t.headers,data:this.format.write(e)}),o},handleCreate:function(e,t){this.handleResponse(e,t)},update:function(e,t){var o=(t=t||{}).url||e.url||this.options.url+"/"+e.fid;t=GeoGlobe.Util.applyDefaults(t,this.options);var r=new GeoGlobe.Protocol.Response({reqFeatures:e,requestType:"update"}),i=this.updateWithPOST?"POST":"PUT";return r.priv=GeoGlobe.Request[i]({url:o,callback:this.createCallback(this.handleUpdate,r,t),headers:t.headers,data:this.format.write(e)}),r},handleUpdate:function(e,t){this.handleResponse(e,t)},delete:function(e,t){var o=(t=t||{}).url||e.url||this.options.url+"/"+e.fid;t=GeoGlobe.Util.applyDefaults(t,this.options);var r=new GeoGlobe.Protocol.Response({reqFeatures:e,requestType:"delete"}),i=this.deleteWithPOST?"POST":"DELETE",n={url:o,callback:this.createCallback(this.handleDelete,r,t),headers:t.headers};return this.deleteWithPOST&&(n.data=this.format.write(e)),r.priv=GeoGlobe.Request[i](n),r},handleDelete:function(e,t){this.handleResponse(e,t)},handleResponse:function(e,t){var o=e.priv;t.callback&&(o.status>=200&&o.status<300?("delete"!=e.requestType&&(e.features=this.parseFeatures(o)),e.code=GeoGlobe.Protocol.Response.SUCCESS):e.code=GeoGlobe.Protocol.Response.FAILURE,t.callback.call(t.scope,e))},parseFeatures:function(e){var t=e.responseXML;return t&&t.documentElement||(t=e.responseText),!t||t.length<=0?null:this.format.read(t)},commit:function(e,t){t=GeoGlobe.Util.applyDefaults(t,this.options);var o=[],r=0,i={};i[GeoGlobe.State.INSERT]=[],i[GeoGlobe.State.UPDATE]=[],i[GeoGlobe.State.DELETE]=[];for(var n,s,a=[],l=0,u=e.length;l<u;++l)(s=i[(n=e[l]).state])&&(s.push(n),a.push(n));var c=(i[GeoGlobe.State.INSERT].length>0?1:0)+i[GeoGlobe.State.UPDATE].length+i[GeoGlobe.State.DELETE].length,p=!0,h=new GeoGlobe.Protocol.Response({reqFeatures:a});function f(e){this.callUserCallback(e,t),p=p&&e.success(),++r>=c&&t.callback&&(h.code=p?GeoGlobe.Protocol.Response.SUCCESS:GeoGlobe.Protocol.Response.FAILURE,t.callback.apply(t.scope,[h]))}var d=i[GeoGlobe.State.INSERT];d.length>0&&o.push(this.create(d,GeoGlobe.Util.applyDefaults({callback:function(e){for(var t=e.features?e.features.length:0,o=new Array(t),r=0;r<t;++r)o[r]=e.features[r].fid;h.insertIds=o,f.apply(this,[e])},scope:this},t.create)));for(l=(d=i[GeoGlobe.State.UPDATE]).length-1;l>=0;--l)o.push(this.update(d[l],GeoGlobe.Util.applyDefaults({callback:f,scope:this},t.update)));for(l=(d=i[GeoGlobe.State.DELETE]).length-1;l>=0;--l)o.push(this.delete(d[l],GeoGlobe.Util.applyDefaults({callback:f,scope:this},t.delete)));return o},abort:function(e){e&&e.priv.abort()},callUserCallback:function(e,t){var o=t[e.requestType];o&&o.callback&&o.callback.call(o.scope,e)},CLASS_NAME:"GeoGlobe.Protocol.HTTP"}),GeoGlobe.Protocol.WFS=function(e){e=GeoGlobe.Util.applyDefaults(e,GeoGlobe.Protocol.WFS.DEFAULTS);var t=GeoGlobe.Protocol.WFS["v"+e.version.replace(/\./g,"_")];if(!t)throw"Unsupported WFS version: "+e.version;return new t(e)},GeoGlobe.Protocol.WFS.DEFAULTS={version:"1.0.0"},GeoGlobe.Protocol.WFS.v1=GeoGlobe.Class4OL(GeoGlobe.Protocol,{version:null,srsName:"EPSG:4326",featureType:null,featureNS:null,geometryName:"the_geom",schema:null,featurePrefix:"feature",formatOptions:null,readFormat:null,readOptions:null,initialize:function(e){GeoGlobe.Protocol.prototype.initialize.apply(this,[e]),e.format||(this.format=GeoGlobe.Format.WFST(GeoGlobe.Util.extend({version:this.version,featureType:this.featureType,featureNS:this.featureNS,featurePrefix:this.featurePrefix,geometryName:this.geometryName,srsName:this.srsName,schema:this.schema},this.formatOptions))),!e.geometryName&&parseFloat(this.format.version)>1&&this.setGeometryName(null)},destroy:function(){this.options&&!this.options.format&&this.format.destroy(),this.format=null,GeoGlobe.Protocol.prototype.destroy.apply(this)},read:function(e){GeoGlobe.Protocol.prototype.read.apply(this,arguments),e=GeoGlobe.Util.extend({},e),GeoGlobe.Util.applyDefaults(e,this.options||{});var t=new GeoGlobe.Protocol.Response({requestType:"read"}),o=GeoGlobe.Format.XML.prototype.write.apply(this.format,[this.format.writeNode("wfs:GetFeature",e)]);return t.priv=GeoGlobe.Request.POST({url:e.url,callback:this.createCallback(this.handleRead,t,e),params:e.params,headers:e.headers,data:o}),t},setFeatureType:function(e){this.featureType=e,this.format.featureType=e},setGeometryName:function(e){this.geometryName=e,this.format.geometryName=e},handleRead:function(e,t){if(t=GeoGlobe.Util.extend({},t),GeoGlobe.Util.applyDefaults(t,this.options),t.callback){var o=e.priv;if(o.status>=200&&o.status<300){var r=this.parseResponse(o,t.readOptions);r&&!1!==r.success?(t.readOptions&&"object"==t.readOptions.output?GeoGlobe.Util.extend(e,r):e.features=r,e.code=GeoGlobe.Protocol.Response.SUCCESS):(e.code=GeoGlobe.Protocol.Response.FAILURE,e.error=r)}else e.code=GeoGlobe.Protocol.Response.FAILURE;t.callback.call(t.scope,e)}},parseResponse:function(e,t){var o=e.responseXML;if(o&&o.documentElement||(o=e.responseText),!o||o.length<=0)return null;var r=null;try{r=null!==this.readFormat?this.readFormat.read(o):this.format.read(o,t)}catch(e){var i="程序运行异常："+e.name+"，"+e.message;alert(i)}if(!this.featureNS){var n=this.readFormat||this.format;this.featureNS=n.featureNS,n.autoConfig=!1,this.geometryName||this.setGeometryName(n.geometryName)}return r},commit:function(e,t){t=GeoGlobe.Util.extend({},t),GeoGlobe.Util.applyDefaults(t,this.options);var o=new GeoGlobe.Protocol.Response({requestType:"commit",reqFeatures:e});return o.priv=GeoGlobe.Request.POST({url:t.url,headers:t.headers,data:this.format.write(e,t),callback:this.createCallback(this.handleCommit,o,t)}),o},handleCommit:function(e,t){if(t.callback){var o=e.priv,r=o.responseXML;r&&r.documentElement||(r=o.responseText);var i=this.format.read(r)||{};e.insertIds=i.insertIds||[],i.success?e.code=GeoGlobe.Protocol.Response.SUCCESS:(e.code=GeoGlobe.Protocol.Response.FAILURE,e.error=i),t.callback.call(t.scope,e)}},filterDelete:function(e,t){t=GeoGlobe.Util.extend({},t),GeoGlobe.Util.applyDefaults(t,this.options);new GeoGlobe.Protocol.Response({requestType:"commit"});var o=this.format.createElementNSPlus("wfs:Transaction",{attributes:{service:"WFS",version:this.version}}),r=this.format.createElementNSPlus("wfs:Delete",{attributes:{typeName:(t.featureNS?this.featurePrefix+":":"")+t.featureType}});t.featureNS&&r.setAttribute("xmlns:"+this.featurePrefix,t.featureNS);var i=this.format.writeNode("ogc:Filter",e);r.appendChild(i),o.appendChild(r);var n=GeoGlobe.Format.XML.prototype.write.apply(this.format,[o]);return GeoGlobe.Request.POST({url:this.url,callback:t.callback||function(){},data:n})},abort:function(e){e&&e.priv.abort()},CLASS_NAME:"GeoGlobe.Protocol.WFS.v1"}),GeoGlobe.Protocol.WFS.v1_0_0=GeoGlobe.Class4OL(GeoGlobe.Protocol.WFS.v1,{version:"1.0.0",CLASS_NAME:"GeoGlobe.Protocol.WFS.v1_0_0"}),GeoGlobe.Protocol.WFS.v1_1_0=GeoGlobe.Class4OL(GeoGlobe.Protocol.WFS.v1,{version:"1.1.0",initialize:function(e){GeoGlobe.Protocol.WFS.v1.prototype.initialize.apply(this,arguments),this.outputFormat&&!this.readFormat&&("gml2"==this.outputFormat.toLowerCase()?this.readFormat=new GeoGlobe.Format.GML.v2({featureType:this.featureType,featureNS:this.featureNS,geometryName:this.geometryName}):"json"==this.outputFormat.toLowerCase()&&(this.readFormat=new GeoGlobe.Format.GeoJSON))},CLASS_NAME:"GeoGlobe.Protocol.WFS.v1_1_0"}),GeoGlobe.Protocol.CSW=function(e){e=GeoGlobe.Util.applyDefaults(e,GeoGlobe.Protocol.CSW.DEFAULTS);var t=GeoGlobe.Protocol.CSW["v"+e.version.replace(/\./g,"_")];if(!t)throw"Unsupported CSW version: "+e.version;return new t(e)},GeoGlobe.Protocol.CSW.DEFAULTS={version:"2.0.2"},GeoGlobe.Protocol.CSW.v2_0_2=GeoGlobe.Class4OL(GeoGlobe.Protocol,{formatOptions:null,initialize:function(e){GeoGlobe.Protocol.prototype.initialize.apply(this,[e]),e.format||(this.format=new GeoGlobe.Format.CSWGetRecords.v2_0_2(GeoGlobe.Util.extend({},this.formatOptions)))},destroy:function(){this.options&&!this.options.format&&this.format.destroy(),this.format=null,GeoGlobe.Protocol.prototype.destroy.apply(this)},read:function(e){e=GeoGlobe.Util.extend({},e),GeoGlobe.Util.applyDefaults(e,this.options||{});var t=new GeoGlobe.Protocol.Response({requestType:"read"}),o=this.format.write(e.params||e);return t.priv=GeoGlobe.Request.POST({url:e.url,callback:this.createCallback(this.handleRead,t,e),params:e.params,headers:e.headers,data:o}),t},handleRead:function(e,t){if(t.callback){var o=e.priv;o.status>=200&&o.status<300?(e.data=this.parseData(o),e.code=GeoGlobe.Protocol.Response.SUCCESS):e.code=GeoGlobe.Protocol.Response.FAILURE,t.callback.call(t.scope,e)}},parseData:function(e){var t=e.responseXML;return t&&t.documentElement||(t=e.responseText),!t||t.length<=0?null:this.format.read(t)},CLASS_NAME:"GeoGlobe.Protocol.CSW.v2_0_2"}),GeoGlobe.Protocol.Script=GeoGlobe.Class4OL(GeoGlobe.Protocol,{url:null,params:null,callback:null,callbackTemplate:"GeoGlobe.Protocol.Script.registry.${id}",callbackKey:"callback",callbackPrefix:"",scope:null,format:null,pendingRequests:null,srsInBBOX:!1,initialize:function(e){if(e=e||{},this.params={},this.pendingRequests={},GeoGlobe.Protocol.prototype.initialize.apply(this,arguments),this.format||(this.format=new GeoGlobe.Format.GeoJSON),!this.filterToParams&&GeoGlobe.Format.QueryStringFilter){var t=new GeoGlobe.Format.QueryStringFilter({srsInBBOX:this.srsInBBOX});this.filterToParams=function(e,o){return t.write(e,o)}}},read:function(e){GeoGlobe.Protocol.prototype.read.apply(this,arguments),(e=GeoGlobe.Util.applyDefaults(e,this.options)).params=GeoGlobe.Util.applyDefaults(e.params,this.options.params),e.filter&&this.filterToParams&&(e.params=this.filterToParams(e.filter,e.params));var t=new GeoGlobe.Protocol.Response({requestType:"read"}),o=this.createRequest(e.url,e.params,GeoGlobe.Function.bind(function(o){t.data=o,this.handleRead(t,e)},this));return t.priv=o,t},createRequest:function(e,t,o){var r=GeoGlobe.Protocol.Script.register(o),i=GeoGlobe.String.format(this.callbackTemplate,{id:r});(t=GeoGlobe.Util.extend({},t))[this.callbackKey]=this.callbackPrefix+i,e=GeoGlobe.Util.urlAppend(e,GeoGlobe.Util.getParameterString(t));var n=document.createElement("script");return n.type="text/javascript",n.src=e,n.id="GeoGlobe_Protocol_Script_"+r,this.pendingRequests[n.id]=n,document.getElementsByTagName("head")[0].appendChild(n),n},destroyRequest:function(e){GeoGlobe.Protocol.Script.unregister(e.id.split("_").pop()),delete this.pendingRequests[e.id],e.parentNode&&e.parentNode.removeChild(e)},handleRead:function(e,t){this.handleResponse(e,t)},handleResponse:function(e,t){t.callback&&(e.data?(e.features=this.parseFeatures(e.data),e.code=GeoGlobe.Protocol.Response.SUCCESS):e.code=GeoGlobe.Protocol.Response.FAILURE,this.destroyRequest(e.priv),t.callback.call(t.scope,e))},parseFeatures:function(e){return this.format.read(e)},abort:function(e){if(e)this.destroyRequest(e.priv);else for(var t in this.pendingRequests)this.destroyRequest(this.pendingRequests[t])},destroy:function(){this.abort(),delete this.params,delete this.format,GeoGlobe.Protocol.prototype.destroy.apply(this)},CLASS_NAME:"GeoGlobe.Protocol.Script"}),function(){var e=GeoGlobe.Protocol.Script,t=0;e.registry={},e.register=function(o){var r="c"+ ++t;return e.registry[r]=function(){o.apply(this,arguments)},r},e.unregister=function(t){delete e.registry[t]}}(),GeoGlobe.Format=GeoGlobe.Class4OL({options:null,externalProjection:null,internalProjection:null,data:null,keepData:!1,initialize:function(e){GeoGlobe.Util.extend(this,e),this.options=e},destroy:function(){},read:function(e){throw new Error("Read not implemented.")},write:function(e){throw new Error("Write not implemented.")},CLASS_NAME:"GeoGlobe.Format"}),GeoGlobe.Format.XML=GeoGlobe.Class4OL(GeoGlobe.Format,{namespaces:null,namespaceAlias:null,defaultPrefix:null,readers:{},writers:{},xmldom:null,initialize:function(e){window.ActiveXObject&&(this.xmldom=new ActiveXObject("Microsoft.XMLDOM")),GeoGlobe.Format.prototype.initialize.apply(this,[e]),this.namespaces=GeoGlobe.Util.extend({},this.namespaces),this.namespaceAlias={};for(var t in this.namespaces)this.namespaceAlias[this.namespaces[t]]=t},destroy:function(){this.xmldom=null,GeoGlobe.Format.prototype.destroy.apply(this,arguments)},setNamespace:function(e,t){this.namespaces[e]=t,this.namespaceAlias[t]=e},read:function(e){var t=e.indexOf("<");t>0&&(e=e.substring(t));var o=GeoGlobe.Util.Try(GeoGlobe.Function.bind(function(){var t;return(t=window.ActiveXObject&&!this.xmldom?new ActiveXObject("Microsoft.XMLDOM"):this.xmldom).loadXML(e),t},this),function(){return(new DOMParser).parseFromString(e,"text/xml")},function(){var t=new XMLHttpRequest;return t.open("GET","data:text/xml;charset=utf-8,"+encodeURIComponent(e),!1),t.overrideMimeType&&t.overrideMimeType("text/xml"),t.send(null),t.responseXML});return this.keepData&&(this.data=o),o},write:function(e){var t;if(e.xml)t=e.xml;else{var o=new XMLSerializer;if(1==e.nodeType){var r=document.implementation.createDocument("","",null);r.importNode&&(e=r.importNode(e,!0)),r.appendChild(e),t=o.serializeToString(r)}else t=o.serializeToString(e)}return t},createElementNS:function(e,t){return this.xmldom?"string"==typeof e?this.xmldom.createNode(1,t,e):this.xmldom.createNode(1,t,""):document.createElementNS(e,t)},createDocumentFragment:function(){return this.xmldom?this.xmldom.createDocumentFragment():document.createDocumentFragment()},createTextNode:function(e){return"string"!=typeof e&&(e=String(e)),this.xmldom?this.xmldom.createTextNode(e):document.createTextNode(e)},getElementsByTagNameNS:function(e,t,o){var r=[];if(e.getElementsByTagNameNS)r=e.getElementsByTagNameNS(t,o);else for(var i,n,s=e.getElementsByTagName("*"),a=0,l=s.length;a<l;++a)n=(i=s[a]).prefix?i.prefix+":"+o:o,"*"!=o&&n!=i.nodeName||"*"!=t&&t!=i.namespaceURI||r.push(i);return r},getAttributeNodeNS:function(e,t,o){var r=null;if(e.getAttributeNodeNS)r=e.getAttributeNodeNS(t,o);else for(var i,n=e.attributes,s=0,a=n.length;s<a;++s)if((i=n[s]).namespaceURI==t&&(i.prefix?i.prefix+":"+o:o)==i.nodeName){r=i;break}return r},getAttributeNS:function(e,t,o){var r="";if(e.getAttributeNS)r=e.getAttributeNS(t,o)||"";else{var i=this.getAttributeNodeNS(e,t,o);i&&(r=i.nodeValue)}return r},getChildValue:function(e,t){var o=t||"";if(e)for(var r=e.firstChild;r;r=r.nextSibling)switch(r.nodeType){case 3:case 4:o+=r.nodeValue}return o},isSimpleContent:function(e){for(var t=!0,o=e.firstChild;o;o=o.nextSibling)if(1===o.nodeType){t=!1;break}return t},contentType:function(e){for(var t=!1,o=!1,r=GeoGlobe.Format.XML.CONTENT_TYPE.EMPTY,i=e.firstChild;i;i=i.nextSibling){switch(i.nodeType){case 1:o=!0;break;case 8:break;default:t=!0}if(o&&t)break}if(o&&t)r=GeoGlobe.Format.XML.CONTENT_TYPE.MIXED;else{if(o)return GeoGlobe.Format.XML.CONTENT_TYPE.COMPLEX;if(t)return GeoGlobe.Format.XML.CONTENT_TYPE.SIMPLE}return r},hasAttributeNS:function(e,t,o){return e.hasAttributeNS?e.hasAttributeNS(t,o):!!this.getAttributeNodeNS(e,t,o)},setAttributeNS:function(e,t,o,r){if(e.setAttributeNS)e.setAttributeNS(t,o,r);else{if(!this.xmldom)throw"setAttributeNS not implemented";if(t){var i=e.ownerDocument.createNode(2,o,t);i.nodeValue=r,e.setAttributeNode(i)}else e.setAttribute(o,r)}},createElementNSPlus:function(e,t){var o=(t=t||{}).uri||this.namespaces[t.prefix];if(!o){var r=e.indexOf(":");o=this.namespaces[e.substring(0,r)]}o||(o=this.namespaces[this.defaultPrefix]);var i=this.createElementNS(o,e);t.attributes&&this.setAttributes(i,t.attributes);var n=t.value;return null!=n&&i.appendChild(this.createTextNode(n)),i},setAttributes:function(e,t){var o,r;for(var i in t)null!=t[i]&&t[i].toString&&(o=t[i].toString(),r=this.namespaces[i.substring(0,i.indexOf(":"))]||null,this.setAttributeNS(e,r,i,o))},readNode:function(e,t){t||(t={});var o=this.readers[e.namespaceURI?this.namespaceAlias[e.namespaceURI]:this.defaultPrefix];if(o){var r=o[e.localName||e.nodeName.split(":").pop()]||o["*"];r&&r.apply(this,[e,t])}return t},readChildNodes:function(e,t){t||(t={});for(var o,r=e.childNodes,i=0,n=r.length;i<n;++i)1==(o=r[i]).nodeType&&this.readNode(o,t);return t},writeNode:function(e,t,o){var r,i,n=e.indexOf(":");n>0?(r=e.substring(0,n),i=e.substring(n+1)):(r=o?this.namespaceAlias[o.namespaceURI]:this.defaultPrefix,i=e);var s=this.writers[r][i].apply(this,[t]);return o&&o.appendChild(s),s},getChildEl:function(e,t,o){return e&&this.getThisOrNextEl(e.firstChild,t,o)},getNextEl:function(e,t,o){return e&&this.getThisOrNextEl(e.nextSibling,t,o)},getThisOrNextEl:function(e,t,o){e:for(var r=e;r;r=r.nextSibling)switch(r.nodeType){case 1:if(!(t&&t!==(r.localName||r.nodeName.split(":").pop())||o&&o!==r.namespaceURI))break e;r=null;break e;case 3:if(/^\s*$/.test(r.nodeValue))break;case 4:case 6:case 12:case 10:case 11:r=null;break e}return r||null},lookupNamespaceURI:function(e,t){var o=null;if(e)if(e.lookupNamespaceURI)o=e.lookupNamespaceURI(t);else e:switch(e.nodeType){case 1:if(null!==e.namespaceURI&&e.prefix===t){o=e.namespaceURI;break e}var r=e.attributes.length;if(r)for(var i,n=0;n<r;++n){if("xmlns"===(i=e.attributes[n]).prefix&&i.name==="xmlns:"+t){o=i.value||null;break e}if("xmlns"===i.name&&null===t){o=i.value||null;break e}}o=this.lookupNamespaceURI(e.parentNode,t);break e;case 2:o=this.lookupNamespaceURI(e.ownerElement,t);break e;case 9:o=this.lookupNamespaceURI(e.documentElement,t);break e;case 6:case 12:case 10:case 11:break e;default:o=this.lookupNamespaceURI(e.parentNode,t)}return o},getXMLDoc:function(){return GeoGlobe.Format.XML.document||this.xmldom||(document.implementation&&document.implementation.createDocument?GeoGlobe.Format.XML.document=document.implementation.createDocument("","",null):!this.xmldom&&window.ActiveXObject&&(this.xmldom=new ActiveXObject("Microsoft.XMLDOM"))),GeoGlobe.Format.XML.document||this.xmldom},CLASS_NAME:"GeoGlobe.Format.XML"}),GeoGlobe.Format.XML.CONTENT_TYPE={EMPTY:0,SIMPLE:1,COMPLEX:2,MIXED:3},GeoGlobe.Format.XML.lookupNamespaceURI=GeoGlobe.Function.bind(GeoGlobe.Format.XML.prototype.lookupNamespaceURI,GeoGlobe.Format.XML.prototype),GeoGlobe.Format.XML.document=null,GeoGlobe.Format.XML.VersionedOGC=GeoGlobe.Class4OL(GeoGlobe.Format.XML,{defaultVersion:null,version:null,profile:null,allowFallback:!1,name:null,stringifyOutput:!1,parser:null,initialize:function(e){GeoGlobe.Format.XML.prototype.initialize.apply(this,[e]);var t=this.CLASS_NAME;this.name=t.substring(t.lastIndexOf(".")+1)},getVersion:function(e,t){var o;return e?(o=this.version)||(o=e.getAttribute("version"))||(o=this.defaultVersion):o=t&&t.version||this.version||this.defaultVersion,o},getParser:function(e){e=e||this.defaultVersion;var t=this.profile?"_"+this.profile:"";if(!this.parser||this.parser.VERSION!=e){var o=GeoGlobe.Format[this.name]["v"+e.replace(/\./g,"_")+t];if(!o&&(""!==t&&this.allowFallback&&(t="",o=GeoGlobe.Format[this.name]["v"+e.replace(/\./g,"_")]),!o))throw"Can't find a "+this.name+" parser for version "+e+t;this.parser=new o(this.options)}return this.parser},write:function(e,t){var o=this.getVersion(null,t);this.parser=this.getParser(o);var r=this.parser.write(e,t);return!1===this.stringifyOutput?r:GeoGlobe.Format.XML.prototype.write.apply(this,[r])},read:function(e,t){"string"==typeof e&&(e=GeoGlobe.Format.XML.prototype.read.apply(this,[e]));var o=e.documentElement,r=this.getVersion(o);this.parser=this.getParser(r);var i=this.parser.read(e,t),n=this.parser.errorProperty||null;if(null!==n&&void 0===i[n]){var s=new GeoGlobe.Format.OGCExceptionReport;i.error=s.read(e)}return i.version=r,i},CLASS_NAME:"GeoGlobe.Format.XML.VersionedOGC"}),GeoGlobe.Format.GML=GeoGlobe.Class4OL(GeoGlobe.Format.XML,{featureNS:"http://mapserver.gis.umn.edu/mapserver",featurePrefix:"feature",featureName:"featureMember",layerName:"features",geometryName:"geometry",collectionName:"FeatureCollection",gmlns:"http://www.opengis.net/gml",extractAttributes:!0,xy:!0,initialize:function(e){this.regExes={trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},GeoGlobe.Format.XML.prototype.initialize.apply(this,[e])},read:function(e){"string"==typeof e&&(e=GeoGlobe.Format.XML.prototype.read.apply(this,[e]));for(var t=this.getElementsByTagNameNS(e.documentElement,this.gmlns,this.featureName),o=[],r=0;r<t.length;r++){var i=this.parseFeature(t[r]);i&&o.push(i)}return o},parseFeature:function(e){for(var t,o,r,i,n,s=["MultiPolygon","Polygon","MultiLineString","LineString","MultiPoint","Point","Envelope"],a=0;a<s.length;++a)if(t=s[a],(o=this.getElementsByTagNameNS(e,this.gmlns,t)).length>0){if(!(i=this.parseGeometry[t.toLowerCase()]))throw new TypeError("Unsupported geometry type: "+t);r=i.apply(this,[o[0]]),this.internalProjection&&this.externalProjection&&r.transform(this.externalProjection,this.internalProjection);break}var l,u=this.getElementsByTagNameNS(e,this.gmlns,"Box");for(a=0;a<u.length;++a){var c=u[a],p=this.parseGeometry.box.apply(this,[c]),h=c.parentNode;"boundedBy"===(h.localName||h.nodeName.split(":").pop())?n=p:r=p.toGeometry()}this.extractAttributes&&(l=this.parseAttributes(e));var f=new GeoGlobe.Feature(r,l);f.bounds=n,f.gml={featureType:e.firstChild.nodeName.split(":")[1],featureNS:e.firstChild.namespaceURI,featureNSPrefix:e.firstChild.prefix};for(var d,G=e.firstChild;G&&(1!=G.nodeType||!(d=G.getAttribute("fid")||G.getAttribute("id")));)G=G.nextSibling;return f.fid=d,f},parseGeometry:{point:function(e){var t,o=[];if((t=this.getElementsByTagNameNS(e,this.gmlns,"pos")).length>0&&(o=t[0].firstChild.nodeValue.replace(this.regExes.trimSpace,"").split(this.regExes.splitSpace)),0==o.length&&(t=this.getElementsByTagNameNS(e,this.gmlns,"coordinates")).length>0&&(o=t[0].firstChild.nodeValue.replace(this.regExes.removeSpace,"").split(",")),0==o.length&&(t=this.getElementsByTagNameNS(e,this.gmlns,"coord")).length>0){var r=this.getElementsByTagNameNS(t[0],this.gmlns,"X"),i=this.getElementsByTagNameNS(t[0],this.gmlns,"Y");r.length>0&&i.length>0&&(o=[r[0].firstChild.nodeValue,i[0].firstChild.nodeValue])}return 2==o.length&&(o[2]=null),this.xy?new GeoGlobe.Geometry.Point(o[0],o[1],o[2]):new GeoGlobe.Geometry.Point(o[1],o[0],o[2])},multipoint:function(e){var t=this.getElementsByTagNameNS(e,this.gmlns,"Point"),o=[];if(t.length>0)for(var r,i=0;i<t.length;++i)(r=this.parseGeometry.point.apply(this,[t[i]]))&&o.push(r);return new GeoGlobe.Geometry.MultiPoint(o)},linestring:function(e,t){var o,r=[],i=[];if((o=this.getElementsByTagNameNS(e,this.gmlns,"posList")).length>0){r=this.getChildValue(o[0]).replace(this.regExes.trimSpace,"").split(this.regExes.splitSpace);for(var n,s,a,l,u=parseInt(o[0].getAttribute("dimension")),c=0;c<r.length/u;++c)s=r[n=c*u],a=r[n+1],l=2==u?null:r[n+2],this.xy?i.push(new GeoGlobe.Geometry.Point(s,a,l)):i.push(new GeoGlobe.Geometry.Point(a,s,l))}if(0==r.length&&(o=this.getElementsByTagNameNS(e,this.gmlns,"coordinates")).length>0){var p=this.getChildValue(o[0]).replace(this.regExes.trimSpace,"").replace(this.regExes.trimComma,",").split(this.regExes.splitSpace);for(c=0;c<p.length;++c)2==(r=p[c].split(",")).length&&(r[2]=null),this.xy?i.push(new GeoGlobe.Geometry.Point(r[0],r[1],r[2])):i.push(new GeoGlobe.Geometry.Point(r[1],r[0],r[2]))}var h=null;return 0!=i.length&&(h=t?new GeoGlobe.Geometry.LinearRing(i):new GeoGlobe.Geometry.LineString(i)),h},multilinestring:function(e){var t=this.getElementsByTagNameNS(e,this.gmlns,"LineString"),o=[];if(t.length>0)for(var r,i=0;i<t.length;++i)(r=this.parseGeometry.linestring.apply(this,[t[i]]))&&o.push(r);return new GeoGlobe.Geometry.MultiLineString(o)},polygon:function(e){var t=this.getElementsByTagNameNS(e,this.gmlns,"LinearRing"),o=[];if(t.length>0)for(var r,i=0;i<t.length;++i)(r=this.parseGeometry.linestring.apply(this,[t[i],!0]))&&o.push(r);return new GeoGlobe.Geometry.Polygon(o)},multipolygon:function(e){var t=this.getElementsByTagNameNS(e,this.gmlns,"Polygon"),o=[];if(t.length>0)for(var r,i=0;i<t.length;++i)(r=this.parseGeometry.polygon.apply(this,[t[i]]))&&o.push(r);return new GeoGlobe.Geometry.MultiPolygon(o)},envelope:function(e){var t,o=[],r=this.getElementsByTagNameNS(e,this.gmlns,"lowerCorner");if(r.length>0){var i=[];if(r.length>0&&(i=r[0].firstChild.nodeValue.replace(this.regExes.trimSpace,"").split(this.regExes.splitSpace)),2==i.length&&(i[2]=null),this.xy)var n=new GeoGlobe.Geometry.Point(i[0],i[1],i[2]);else n=new GeoGlobe.Geometry.Point(i[1],i[0],i[2])}var s=this.getElementsByTagNameNS(e,this.gmlns,"upperCorner");if(s.length>0){i=[];if(s.length>0&&(i=s[0].firstChild.nodeValue.replace(this.regExes.trimSpace,"").split(this.regExes.splitSpace)),2==i.length&&(i[2]=null),this.xy)var a=new GeoGlobe.Geometry.Point(i[0],i[1],i[2]);else a=new GeoGlobe.Geometry.Point(i[1],i[0],i[2])}if(n&&a){o.push(new GeoGlobe.Geometry.Point(n.x,n.y)),o.push(new GeoGlobe.Geometry.Point(a.x,n.y)),o.push(new GeoGlobe.Geometry.Point(a.x,a.y)),o.push(new GeoGlobe.Geometry.Point(n.x,a.y)),o.push(new GeoGlobe.Geometry.Point(n.x,n.y));var l=new GeoGlobe.Geometry.LinearRing(o);t=new GeoGlobe.Geometry.Polygon([l])}return t},box:function(e){var t,o=this.getElementsByTagNameNS(e,this.gmlns,"coordinates"),r=null,i=null;if(o.length>0&&2==(t=o[0].firstChild.nodeValue.split(" ")).length&&(r=t[0].split(","),i=t[1].split(",")),null!==r&&null!==i){var n=new GeoGlobe.LngLat(parseFloat(r[0]),parseFloat(r[1])),s=new GeoGlobe.LngLat(parseFloat(i[0]),parseFloat(i[1]));return new GeoGlobe.LngLatBounds(n,s)}}},parseAttributes:function(e){for(var t,o,r,i,n,s,a,l={},u=e.firstChild;u;){if(1==u.nodeType){for(t=u.childNodes,o=0;o<t.length;++o)1==(r=t[o]).nodeType&&(1==(i=r.childNodes).length?3!=(n=i[0]).nodeType&&4!=n.nodeType||(s=r.prefix?r.nodeName.split(":")[1]:r.nodeName,a=n.nodeValue.replace(this.regExes.trimSpace,""),l[s]=a):l[r.nodeName.split(":").pop()]=null);break}u=u.nextSibling}return l},write:function(e){GeoGlobe.Util.isArray(e)||(e=[e]);for(var t=this.createElementNS("http://www.opengis.net/wfs","wfs:"+this.collectionName),o=0;o<e.length;o++)t.appendChild(this.createFeatureXML(e[o]));return GeoGlobe.Format.XML.prototype.write.apply(this,[t])},createFeatureXML:function(e){var t=e.geometry,o=this.buildGeometryNode(t),r=this.createElementNS(this.featureNS,this.featurePrefix+":"+this.geometryName);r.appendChild(o);var i=this.createElementNS(this.gmlns,"gml:"+this.featureName),n=this.createElementNS(this.featureNS,this.featurePrefix+":"+this.layerName),s=e.fid||e.id;n.setAttribute("fid",s),n.appendChild(r);for(var a in e.attributes){var l=this.createTextNode(e.attributes[a]),u=a.substring(a.lastIndexOf(":")+1),c=this.createElementNS(this.featureNS,this.featurePrefix+":"+u);c.appendChild(l),n.appendChild(c)}return i.appendChild(n),i},buildGeometryNode:function(e){this.externalProjection&&this.internalProjection&&(e=e.clone()).transform(this.internalProjection,this.externalProjection);var t=e.CLASS_NAME,o=t.substring(t.lastIndexOf(".")+1);return this.buildGeometry[o.toLowerCase()].apply(this,[e])},buildGeometry:{point:function(e){var t=this.createElementNS(this.gmlns,"gml:Point");return t.appendChild(this.buildCoordinatesNode(e)),t},multipoint:function(e){for(var t,o,r=this.createElementNS(this.gmlns,"gml:MultiPoint"),i=e.components,n=0;n<i.length;n++)t=this.createElementNS(this.gmlns,"gml:pointMember"),o=this.buildGeometry.point.apply(this,[i[n]]),t.appendChild(o),r.appendChild(t);return r},linestring:function(e){var t=this.createElementNS(this.gmlns,"gml:LineString");return t.appendChild(this.buildCoordinatesNode(e)),t},multilinestring:function(e){for(var t,o,r=this.createElementNS(this.gmlns,"gml:MultiLineString"),i=e.components,n=0;n<i.length;++n)t=this.createElementNS(this.gmlns,"gml:lineStringMember"),o=this.buildGeometry.linestring.apply(this,[i[n]]),t.appendChild(o),r.appendChild(t);return r},linearring:function(e){var t=this.createElementNS(this.gmlns,"gml:LinearRing");return t.appendChild(this.buildCoordinatesNode(e)),t},polygon:function(e){for(var t,o,r,i=this.createElementNS(this.gmlns,"gml:Polygon"),n=e.components,s=0;s<n.length;++s)r=0==s?"outerBoundaryIs":"innerBoundaryIs",t=this.createElementNS(this.gmlns,"gml:"+r),o=this.buildGeometry.linearring.apply(this,[n[s]]),t.appendChild(o),i.appendChild(t);return i},multipolygon:function(e){for(var t,o,r=this.createElementNS(this.gmlns,"gml:MultiPolygon"),i=e.components,n=0;n<i.length;++n)t=this.createElementNS(this.gmlns,"gml:polygonMember"),o=this.buildGeometry.polygon.apply(this,[i[n]]),t.appendChild(o),r.appendChild(t);return r},lnglatbounds:function(e){var t=this.createElementNS(this.gmlns,"gml:Box");return t.appendChild(this.buildCoordinatesNode(e)),t}},buildCoordinatesNode:function(e){var t=this.createElementNS(this.gmlns,"gml:coordinates");t.setAttribute("decimal","."),t.setAttribute("cs",","),t.setAttribute("ts"," ");var o=[];if(e instanceof GeoGlobe.LngLatBounds)o.push(e.getWest()+","+e.getSouth()),o.push(e.getEast()+","+e.getNorth());else for(var r=e.components?e.components:[e],i=0;i<r.length;i++)o.push(r[i].x+","+r[i].y);var n=this.createTextNode(o.join(" "));return t.appendChild(n),t},CLASS_NAME:"GeoGlobe.Format.GML"}),GeoGlobe.Format.GML||(GeoGlobe.Format.GML={}),GeoGlobe.Format.GML.Base=GeoGlobe.Class4OL(GeoGlobe.Format.XML,{namespaces:{gml:"http://www.opengis.net/gml",xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance",wfs:"http://www.opengis.net/wfs"},defaultPrefix:"gml",schemaLocation:null,featureType:null,featureNS:null,geometryName:"geometry",extractAttributes:!0,srsName:null,xy:!0,geometryTypes:null,singleFeatureType:null,regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g,featureMember:/^(.*:)?featureMembers?$/},initialize:function(e){GeoGlobe.Format.XML.prototype.initialize.apply(this,[e]),this.setGeometryTypes(),e&&e.featureNS&&this.setNamespace("feature",e.featureNS),this.singleFeatureType=!e||"string"==typeof e.featureType},read:function(e){"string"==typeof e&&(e=GeoGlobe.Format.XML.prototype.read.apply(this,[e])),e&&9==e.nodeType&&(e=e.documentElement);var t,o=[];if(this.readNode(e,{features:o},!0),0==o.length)if((t=this.getElementsByTagNameNS(e,this.namespaces.gml,"featureMember")).length)for(var r=0,i=t.length;r<i;++r)this.readNode(t[r],{features:o},!0);else(t=this.getElementsByTagNameNS(e,this.namespaces.gml,"featureMembers")).length&&this.readNode(t[0],{features:o},!0);return o},readNode:function(e,t,o){return!0===o&&!0===this.autoConfig&&(this.featureType=null,delete this.namespaceAlias[this.featureNS],delete this.namespaces.feature,this.featureNS=null),this.featureNS||e.prefix in this.namespaces||e.parentNode.namespaceURI!=this.namespaces.gml||!this.regExes.featureMember.test(e.parentNode.nodeName)||(this.featureType=e.nodeName.split(":").pop(),this.setNamespace("feature",e.namespaceURI),this.featureNS=e.namespaceURI,this.autoConfig=!0),GeoGlobe.Format.XML.prototype.readNode.apply(this,[e,t])},readers:{gml:{_inherit:function(e,t,o){},featureMember:function(e,t){this.readChildNodes(e,t)},featureMembers:function(e,t){this.readChildNodes(e,t)},name:function(e,t){t.name=this.getChildValue(e)},boundedBy:function(e,t){var o={};this.readChildNodes(e,o),o.components&&o.components.length>0&&(t.bounds=o.components[0])},Point:function(e,t){var o={points:[]};this.readChildNodes(e,o),t.components||(t.components=[]),t.components.push(o.points[0])},coordinates:function(e,t){for(var o,r=this.getChildValue(e).replace(this.regExes.trimSpace,""),i=(r=r.replace(this.regExes.trimComma,",")).split(this.regExes.splitSpace),n=i.length,s=new Array(n),a=0;a<n;++a)o=i[a].split(","),this.xy?s[a]=new GeoGlobe.Geometry.Point(o[0],o[1],o[2]):s[a]=new GeoGlobe.Geometry.Point(o[1],o[0],o[2]);t.points=s},coord:function(e,t){var o={};this.readChildNodes(e,o),t.points||(t.points=[]),t.points.push(new GeoGlobe.Geometry.Point(o.x,o.y,o.z))},X:function(e,t){t.x=this.getChildValue(e)},Y:function(e,t){t.y=this.getChildValue(e)},Z:function(e,t){t.z=this.getChildValue(e)},MultiPoint:function(e,t){var o={components:[]};this.readers.gml._inherit.apply(this,[e,o,t]),this.readChildNodes(e,o),t.components=[new GeoGlobe.Geometry.MultiPoint(o.components)]},pointMember:function(e,t){this.readChildNodes(e,t)},LineString:function(e,t){var o={};this.readers.gml._inherit.apply(this,[e,o,t]),this.readChildNodes(e,o),t.components||(t.components=[]),t.components.push(new GeoGlobe.Geometry.LineString(o.points))},MultiLineString:function(e,t){var o={components:[]};this.readers.gml._inherit.apply(this,[e,o,t]),this.readChildNodes(e,o),t.components=[new GeoGlobe.Geometry.MultiLineString(o.components)]},lineStringMember:function(e,t){this.readChildNodes(e,t)},Polygon:function(e,t){var o={outer:null,inner:[]};this.readers.gml._inherit.apply(this,[e,o,t]),this.readChildNodes(e,o),o.inner.unshift(o.outer),t.components||(t.components=[]),t.components.push(new GeoGlobe.Geometry.Polygon(o.inner))},LinearRing:function(e,t){var o={};this.readers.gml._inherit.apply(this,[e,o]),this.readChildNodes(e,o),t.components=[new GeoGlobe.Geometry.LinearRing(o.points)]},MultiPolygon:function(e,t){var o={components:[]};this.readers.gml._inherit.apply(this,[e,o,t]),this.readChildNodes(e,o),t.components=[new GeoGlobe.Geometry.MultiPolygon(o.components)]},polygonMember:function(e,t){this.readChildNodes(e,t)},GeometryCollection:function(e,t){var o={components:[]};this.readers.gml._inherit.apply(this,[e,o,t]),this.readChildNodes(e,o),t.components=[new GeoGlobe.Geometry.Collection(o.components)]},geometryMember:function(e,t){this.readChildNodes(e,t)}},feature:{"*":function(e,t){var o,r=e.localName||e.nodeName.split(":").pop();if(t.features)if(this.singleFeatureType||-1===GeoGlobe.Util.indexOf(this.featureType,r)){if(r===this.featureType)o="_typeName";else if(GeoGlobe.Util.isArray(this.featureType_))for(var i=0;i<this.featureType_.length;i++)if(this.featureType_[i]===r){o="_typeName";break}}else o="_typeName";else 0==e.childNodes.length||1==e.childNodes.length&&3==e.firstChild.nodeType?this.extractAttributes&&(o="_attribute"):o="_geometry";o&&this.readers.feature[o].apply(this,[e,t])},_typeName:function(e,t){var o={components:[],attributes:{}};this.readChildNodes(e,o),o.name&&(o.attributes.name=o.name);var r=new GeoGlobe.Feature(o.components[0],o.attributes);this.singleFeatureType||(r.type=e.nodeName.split(":").pop(),r.namespace=e.namespaceURI);var i=e.getAttribute("fid")||this.getAttributeNS(e,this.namespaces.gml,"id");i&&(r.fid=i),this.internalProjection&&this.externalProjection&&r.geometry&&r.geometry.transform(this.externalProjection,this.internalProjection),o.bounds&&(r.bounds=o.bounds),t.features.push(r)},_geometry:function(e,t){this.geometryName||(this.geometryName=e.nodeName.split(":").pop()),this.readChildNodes(e,t)},_attribute:function(e,t){var o=e.localName||e.nodeName.split(":").pop(),r=this.getChildValue(e);t.attributes[o]=r}},wfs:{FeatureCollection:function(e,t){this.readChildNodes(e,t)}}},write:function(e){var t;t=GeoGlobe.Util.isArray(e)?"featureMembers":"featureMember";var o=this.writeNode("gml:"+t,e);return this.setAttributeNS(o,this.namespaces.xsi,"xsi:schemaLocation",this.schemaLocation),GeoGlobe.Format.XML.prototype.write.apply(this,[o])},writers:{gml:{featureMember:function(e){var t=this.createElementNSPlus("gml:featureMember");return this.writeNode("feature:_typeName",e,t),t},MultiPoint:function(e){for(var t=this.createElementNSPlus("gml:MultiPoint"),o=e.components||[e],r=0,i=o.length;r<i;++r)this.writeNode("pointMember",o[r],t);return t},pointMember:function(e){var t=this.createElementNSPlus("gml:pointMember");return this.writeNode("Point",e,t),t},MultiLineString:function(e){for(var t=this.createElementNSPlus("gml:MultiLineString"),o=e.components||[e],r=0,i=o.length;r<i;++r)this.writeNode("lineStringMember",o[r],t);return t},lineStringMember:function(e){var t=this.createElementNSPlus("gml:lineStringMember");return this.writeNode("LineString",e,t),t},MultiPolygon:function(e){for(var t=this.createElementNSPlus("gml:MultiPolygon"),o=e.components||[e],r=0,i=o.length;r<i;++r)this.writeNode("polygonMember",o[r],t);return t},polygonMember:function(e){var t=this.createElementNSPlus("gml:polygonMember");return this.writeNode("Polygon",e,t),t},GeometryCollection:function(e){for(var t=this.createElementNSPlus("gml:GeometryCollection"),o=0,r=e.components.length;o<r;++o)this.writeNode("geometryMember",e.components[o],t);return t},geometryMember:function(e){var t=this.createElementNSPlus("gml:geometryMember"),o=this.writeNode("feature:_geometry",e);return t.appendChild(o.firstChild),t}},feature:{_typeName:function(e){var t=this.createElementNSPlus("feature:"+this.featureType,{attributes:{fid:e.fid}});e.geometry&&this.writeNode("feature:_geometry",e.geometry,t);for(var o in e.attributes){var r=e.attributes[o];null!=r&&this.writeNode("feature:_attribute",{name:o,value:r},t)}return t},_geometry:function(e){this.externalProjection&&this.internalProjection&&(e=e.clone().transform(this.internalProjection,this.externalProjection));var t=this.createElementNSPlus("feature:"+this.geometryName),o=this.geometryTypes[e.CLASS_NAME],r=this.writeNode("gml:"+o,e,t);return this.srsName&&r.setAttribute("srsName",this.srsName),t},_attribute:function(e){return this.createElementNSPlus("feature:"+e.name,{value:e.value})}},wfs:{FeatureCollection:function(e){for(var t=this.createElementNSPlus("wfs:FeatureCollection"),o=0,r=e.length;o<r;++o)this.writeNode("gml:featureMember",e[o],t);return t}}},setGeometryTypes:function(){this.geometryTypes={"GeoGlobe.Geometry.Point":"Point","GeoGlobe.Geometry.MultiPoint":"MultiPoint","GeoGlobe.Geometry.LineString":"LineString","GeoGlobe.Geometry.MultiLineString":"MultiLineString","GeoGlobe.Geometry.Polygon":"Polygon","GeoGlobe.Geometry.MultiPolygon":"MultiPolygon","GeoGlobe.Geometry.Collection":"GeometryCollection"}},setFeatureType_:function(e){this.featureType_=e},CLASS_NAME:"GeoGlobe.Format.GML.Base"}),GeoGlobe.Format.GML.v2=GeoGlobe.Class4OL(GeoGlobe.Format.GML.Base,{schemaLocation:"http://www.opengis.net/gml http://schemas.opengis.net/gml/2.1.2/feature.xsd",initialize:function(e){GeoGlobe.Format.GML.Base.prototype.initialize.apply(this,[e])},readers:{gml:GeoGlobe.Util.applyDefaults({outerBoundaryIs:function(e,t){var o={};this.readChildNodes(e,o),t.outer=o.components[0]},innerBoundaryIs:function(e,t){var o={};this.readChildNodes(e,o),t.inner.push(o.components[0])},Box:function(e,t){var o={};this.readChildNodes(e,o),t.components||(t.components=[]);var r=o.points[0],i=o.points[1],n=new GeoGlobe.LngLat(r.x,r.y),s=new GeoGlobe.LngLat(i.x,i.y);t.components.push(new GeoGlobe.LngLatBounds(n,s))}},GeoGlobe.Format.GML.Base.prototype.readers.gml),feature:GeoGlobe.Format.GML.Base.prototype.readers.feature,wfs:GeoGlobe.Format.GML.Base.prototype.readers.wfs},write:function(e){var t;t=GeoGlobe.Util.isArray(e)?"wfs:FeatureCollection":"gml:featureMember";var o=this.writeNode(t,e);return this.setAttributeNS(o,this.namespaces.xsi,"xsi:schemaLocation",this.schemaLocation),GeoGlobe.Format.XML.prototype.write.apply(this,[o])},writers:{gml:GeoGlobe.Util.applyDefaults({Point:function(e){var t=this.createElementNSPlus("gml:Point");return this.writeNode("coordinates",[e],t),t},coordinates:function(e){for(var t,o=e.length,r=new Array(o),i=0;i<o;++i)t=e[i],this.xy?r[i]=t.x+","+t.y:r[i]=t.y+","+t.x,void 0!=t.z&&(r[i]+=","+t.z);return this.createElementNSPlus("gml:coordinates",{attributes:{decimal:".",cs:",",ts:" "},value:1==o?r[0]:r.join(" ")})},LineString:function(e){var t=this.createElementNSPlus("gml:LineString");return this.writeNode("coordinates",e.components,t),t},Polygon:function(e){var t=this.createElementNSPlus("gml:Polygon");this.writeNode("outerBoundaryIs",e.components[0],t);for(var o=1;o<e.components.length;++o)this.writeNode("innerBoundaryIs",e.components[o],t);return t},outerBoundaryIs:function(e){var t=this.createElementNSPlus("gml:outerBoundaryIs");return this.writeNode("LinearRing",e,t),t},innerBoundaryIs:function(e){var t=this.createElementNSPlus("gml:innerBoundaryIs");return this.writeNode("LinearRing",e,t),t},LinearRing:function(e){var t=this.createElementNSPlus("gml:LinearRing");return this.writeNode("coordinates",e.components,t),t},Box:function(e){var t=this.createElementNSPlus("gml:Box");return this.writeNode("coordinates",[{x:e._sw.lng,y:e._sw.lat},{x:e._ne.lng,y:e._ne.lat}],t),this.srsName&&t.setAttribute("srsName",this.srsName),t}},GeoGlobe.Format.GML.Base.prototype.writers.gml),feature:GeoGlobe.Format.GML.Base.prototype.writers.feature,wfs:GeoGlobe.Format.GML.Base.prototype.writers.wfs},CLASS_NAME:"GeoGlobe.Format.GML.v2"}),GeoGlobe.Format.GML.v3=GeoGlobe.Class4OL(GeoGlobe.Format.GML.Base,{schemaLocation:"http://www.opengis.net/gml http://schemas.opengis.net/gml/3.1.1/profiles/gmlsfProfile/1.0.0/gmlsf.xsd",curve:!1,multiCurve:!0,surface:!1,multiSurface:!0,initialize:function(e){GeoGlobe.Format.GML.Base.prototype.initialize.apply(this,[e])},readers:{gml:GeoGlobe.Util.applyDefaults({_inherit:function(e,t,o){var r=parseInt(e.getAttribute("srsDimension"),10)||o&&o.srsDimension;r&&(t.srsDimension=r)},featureMembers:function(e,t){this.readChildNodes(e,t)},Curve:function(e,t){var o={points:[]};this.readers.gml._inherit.apply(this,[e,o,t]),this.readChildNodes(e,o),t.components||(t.components=[]),t.components.push(new GeoGlobe.Geometry.LineString(o.points))},segments:function(e,t){this.readChildNodes(e,t)},LineStringSegment:function(e,t){var o={};this.readChildNodes(e,o),o.points&&Array.prototype.push.apply(t.points,o.points)},pos:function(e,t){var o,r=this.getChildValue(e).replace(this.regExes.trimSpace,"").split(this.regExes.splitSpace);o=this.xy?new GeoGlobe.Geometry.Point(r[0],r[1],r[2]):new GeoGlobe.Geometry.Point(r[1],r[0],r[2]),t.points=[o]},posList:function(e,t){for(var o,r,i,n=this.getChildValue(e).replace(this.regExes.trimSpace,"").split(this.regExes.splitSpace),s=t.srsDimension||parseInt(e.getAttribute("srsDimension")||e.getAttribute("dimension"),10)||2,a=n.length/s,l=new Array(a),u=0,c=n.length;u<c;u+=s)o=n[u],r=n[u+1],i=2==s?void 0:n[u+2],this.xy?l[u/s]=new GeoGlobe.Geometry.Point(o,r,i):l[u/s]=new GeoGlobe.Geometry.Point(r,o,i);t.points=l},Surface:function(e,t){this.readChildNodes(e,t)},patches:function(e,t){this.readChildNodes(e,t)},PolygonPatch:function(e,t){this.readers.gml.Polygon.apply(this,[e,t])},exterior:function(e,t){var o={};this.readChildNodes(e,o),t.outer=o.components[0]},interior:function(e,t){var o={};this.readChildNodes(e,o),t.inner.push(o.components[0])},MultiCurve:function(e,t){var o={components:[]};this.readers.gml._inherit.apply(this,[e,o,t]),this.readChildNodes(e,o),o.components.length>0&&(t.components=[new GeoGlobe.Geometry.MultiLineString(o.components)])},curveMember:function(e,t){this.readChildNodes(e,t)},MultiSurface:function(e,t){var o={components:[]};this.readers.gml._inherit.apply(this,[e,o,t]),this.readChildNodes(e,o),o.components.length>0&&(t.components=[new GeoGlobe.Geometry.MultiPolygon(o.components)])},surfaceMember:function(e,t){this.readChildNodes(e,t)},surfaceMembers:function(e,t){this.readChildNodes(e,t)},pointMembers:function(e,t){this.readChildNodes(e,t)},lineStringMembers:function(e,t){this.readChildNodes(e,t)},polygonMembers:function(e,t){this.readChildNodes(e,t)},geometryMembers:function(e,t){this.readChildNodes(e,t)},Envelope:function(e,t){var o={points:new Array(2)};this.readChildNodes(e,o),t.components||(t.components=[]);var r=o.points[0],i=o.points[1],n=new GeoGlobe.LngLat(r.x,r.y),s=new GeoGlobe.LngLat(i.x,i.y);t.components.push(new GeoGlobe.LngLatBounds(n,s))},lowerCorner:function(e,t){var o={};this.readers.gml.pos.apply(this,[e,o]),t.points[0]=o.points[0]},upperCorner:function(e,t){var o={};this.readers.gml.pos.apply(this,[e,o]),t.points[1]=o.points[0]}},GeoGlobe.Format.GML.Base.prototype.readers.gml),feature:GeoGlobe.Format.GML.Base.prototype.readers.feature,wfs:GeoGlobe.Format.GML.Base.prototype.readers.wfs},write:function(e){var t;t=GeoGlobe.Util.isArray(e)?"featureMembers":"featureMember";var o=this.writeNode("gml:"+t,e);return this.setAttributeNS(o,this.namespaces.xsi,"xsi:schemaLocation",this.schemaLocation),GeoGlobe.Format.XML.prototype.write.apply(this,[o])},writers:{gml:GeoGlobe.Util.applyDefaults({featureMembers:function(e){for(var t=this.createElementNSPlus("gml:featureMembers"),o=0,r=e.length;o<r;++o)this.writeNode("feature:_typeName",e[o],t);return t},Point:function(e){var t=this.createElementNSPlus("gml:Point");return this.writeNode("pos",e,t),t},pos:function(e){var t=this.xy?e.x+" "+e.y:e.y+" "+e.x;return this.createElementNSPlus("gml:pos",{value:t})},LineString:function(e){var t=this.createElementNSPlus("gml:LineString");return this.writeNode("posList",e.components,t),t},Curve:function(e){var t=this.createElementNSPlus("gml:Curve");return this.writeNode("segments",e,t),t},segments:function(e){var t=this.createElementNSPlus("gml:segments");return this.writeNode("LineStringSegment",e,t),t},LineStringSegment:function(e){var t=this.createElementNSPlus("gml:LineStringSegment");return this.writeNode("posList",e.components,t),t},posList:function(e){for(var t,o=e.length,r=new Array(o),i=0;i<o;++i)t=e[i],this.xy?r[i]=t.x+" "+t.y:r[i]=t.y+" "+t.x;return this.createElementNSPlus("gml:posList",{value:r.join(" ")})},Surface:function(e){var t=this.createElementNSPlus("gml:Surface");return this.writeNode("patches",e,t),t},patches:function(e){var t=this.createElementNSPlus("gml:patches");return this.writeNode("PolygonPatch",e,t),t},PolygonPatch:function(e){var t=this.createElementNSPlus("gml:PolygonPatch",{attributes:{interpolation:"planar"}});this.writeNode("exterior",e.components[0],t);for(var o=1,r=e.components.length;o<r;++o)this.writeNode("interior",e.components[o],t);return t},Polygon:function(e){var t=this.createElementNSPlus("gml:Polygon");this.writeNode("exterior",e.components[0],t);for(var o=1,r=e.components.length;o<r;++o)this.writeNode("interior",e.components[o],t);return t},exterior:function(e){var t=this.createElementNSPlus("gml:exterior");return this.writeNode("LinearRing",e,t),t},interior:function(e){var t=this.createElementNSPlus("gml:interior");return this.writeNode("LinearRing",e,t),t},LinearRing:function(e){var t=this.createElementNSPlus("gml:LinearRing");return this.writeNode("posList",e.components,t),t},MultiCurve:function(e){for(var t=this.createElementNSPlus("gml:MultiCurve"),o=e.components||[e],r=0,i=o.length;r<i;++r)this.writeNode("curveMember",o[r],t);return t},curveMember:function(e){var t=this.createElementNSPlus("gml:curveMember");return this.curve?this.writeNode("Curve",e,t):this.writeNode("LineString",e,t),t},MultiSurface:function(e){for(var t=this.createElementNSPlus("gml:MultiSurface"),o=e.components||[e],r=0,i=o.length;r<i;++r)this.writeNode("surfaceMember",o[r],t);return t},surfaceMember:function(e){var t=this.createElementNSPlus("gml:surfaceMember");return this.surface?this.writeNode("Surface",e,t):this.writeNode("Polygon",e,t),t},Envelope:function(e){var t=this.createElementNSPlus("gml:Envelope");return this.writeNode("lowerCorner",e,t),this.writeNode("upperCorner",e,t),this.srsName&&t.setAttribute("srsName",this.srsName),t},lowerCorner:function(e){var t=this.xy?e._sw.lng+" "+e._sw.lat:e._sw.lat+" "+e._sw.lng;return this.createElementNSPlus("gml:lowerCorner",{value:t})},upperCorner:function(e){var t=this.xy?e._ne.lng+" "+e._ne.lat:e._ne.lat+" "+e._ne.lng;return this.createElementNSPlus("gml:upperCorner",{value:t})}},GeoGlobe.Format.GML.Base.prototype.writers.gml),feature:GeoGlobe.Format.GML.Base.prototype.writers.feature,wfs:GeoGlobe.Format.GML.Base.prototype.writers.wfs},setGeometryTypes:function(){this.geometryTypes={"GeoGlobe.Geometry.Point":"Point","GeoGlobe.Geometry.MultiPoint":"MultiPoint","GeoGlobe.Geometry.LineString":!0===this.curve?"Curve":"LineString","GeoGlobe.Geometry.MultiLineString":!1===this.multiCurve?"MultiLineString":"MultiCurve","GeoGlobe.Geometry.Polygon":!0===this.surface?"Surface":"Polygon","GeoGlobe.Geometry.MultiPolygon":!1===this.multiSurface?"MultiPolygon":"MultiSurface","GeoGlobe.Geometry.Collection":"GeometryCollection"}},CLASS_NAME:"GeoGlobe.Format.GML.v3"}),GeoGlobe.Format.KML=GeoGlobe.Class4OL(GeoGlobe.Format.XML,{namespaces:{kml:"http://www.opengis.net/kml/2.2",gx:"http://www.google.com/kml/ext/2.2"},kmlns:"http://earth.google.com/kml/2.0",placemarksDesc:"No description available",foldersName:"GeoGlobe export",foldersDesc:"Exported on "+new Date,extractAttributes:!0,kvpAttributes:!1,extractStyles:!1,extractTracks:!1,trackAttributes:null,internalns:null,features:null,styles:null,styleBaseUrl:"",fetched:null,maxDepth:0,initialize:function(e){this.regExes={trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g,kmlColor:/(\w{2})(\w{2})(\w{2})(\w{2})/,kmlIconPalette:/root:\/\/icons\/palette-(\d+)(\.\w+)/,straightBracket:/\$\[(.*?)\]/g},this.externalProjection=new GeoGlobe.SpatialReference("EPSG:4326"),GeoGlobe.Format.XML.prototype.initialize.apply(this,[e])},read:function(e){this.features=[],this.styles={},this.fetched={};var t={depth:0,styleBaseUrl:this.styleBaseUrl};return this.parseData(e,t)},parseData:function(e,t){"string"==typeof e&&(e=GeoGlobe.Format.XML.prototype.read.apply(this,[e]));for(var o=["Link","NetworkLink","Style","StyleMap","Placemark"],r=0,i=o.length;r<i;++r){var n=o[r],s=this.getElementsByTagNameNS(e,"*",n);if(0!=s.length)switch(n.toLowerCase()){case"link":case"networklink":this.parseLinks(s,t);break;case"style":this.extractStyles&&this.parseStyles(s,t);break;case"stylemap":this.extractStyles&&this.parseStyleMaps(s,t);break;case"placemark":this.parseFeatures(s,t)}}return this.features},parseLinks:function(e,t){if(t.depth>=this.maxDepth)return!1;var o=GeoGlobe.Util.extend({},t);o.depth++;for(var r=0,i=e.length;r<i;r++){var n=this.parseProperty(e[r],"*","href");if(n&&!this.fetched[n]){this.fetched[n]=!0;var s=this.fetchLink(n);s&&this.parseData(s,o)}}},fetchLink:function(e){var t=GeoGlobe.Request.GET({url:e,async:!1});if(t)return t.responseText},parseStyles:function(e,t){for(var o=0,r=e.length;o<r;o++){var i=this.parseStyle(e[o]);if(i){var n=(t.styleBaseUrl||"")+"#"+i.id;this.styles[n]=i}}},parseKmlColor:function(e){var t=null;if(e){var o=e.match(this.regExes.kmlColor);o&&(t={color:"#"+o[4]+o[3]+o[2],opacity:parseInt(o[1],16)/255})}return t},parseStyle:function(e){for(var t,o,r={},i=["LineStyle","PolyStyle","IconStyle","BalloonStyle","LabelStyle"],n=0,s=i.length;n<s;++n)if(t=i[n],o=this.getElementsByTagNameNS(e,"*",t)[0])switch(t.toLowerCase()){case"linestyle":var a=this.parseProperty(o,"*","color");(C=this.parseKmlColor(a))&&(r.strokeColor=C.color,r.strokeOpacity=C.opacity),(u=this.parseProperty(o,"*","width"))&&(r.strokeWidth=u);break;case"polystyle":a=this.parseProperty(o,"*","color");(C=this.parseKmlColor(a))&&(r.fillOpacity=C.opacity,r.fillColor=C.color),"0"==this.parseProperty(o,"*","fill")&&(r.fillColor="none"),"0"==this.parseProperty(o,"*","outline")&&(r.strokeWidth="0");break;case"iconstyle":var l=parseFloat(this.parseProperty(o,"*","scale")||1),u=32*l,c=32*l,p=this.getElementsByTagNameNS(o,"*","Icon")[0];if(p){var h=this.parseProperty(p,"*","href");if(h){var f=this.parseProperty(p,"*","w"),d=this.parseProperty(p,"*","h");!GeoGlobe.String.startsWith(h,"http://maps.google.com/mapfiles/kml")||f||d||(f=64,d=64,l/=2),f=f||d,d=d||f,f&&(u=parseInt(f)*l),d&&(c=parseInt(d)*l);var G=h.match(this.regExes.kmlIconPalette);if(G){var m=G[1],g=G[2],y=this.parseProperty(p,"*","x");h="http://maps.google.com/mapfiles/kml/pal"+m+"/icon"+(8*((S=this.parseProperty(p,"*","y"))?7-S/32:7)+(y?y/32:0))+g}r.graphicOpacity=1,r.externalGraphic=h}}var b=this.getElementsByTagNameNS(o,"*","hotSpot")[0];if(b){y=parseFloat(b.getAttribute("x"));var S=parseFloat(b.getAttribute("y")),v=b.getAttribute("xunits");"pixels"==v?r.graphicXOffset=-y*l:"insetPixels"==v?r.graphicXOffset=y*l-u:"fraction"==v&&(r.graphicXOffset=-u*y);var N=b.getAttribute("yunits");"pixels"==N?r.graphicYOffset=S*l-c+1:"insetPixels"==N?r.graphicYOffset=-S*l+1:"fraction"==N&&(r.graphicYOffset=-c*(1-S)+1)}r.graphicWidth=u,r.graphicHeight=c;break;case"balloonstyle":var w=GeoGlobe.Util.getXmlNodeValue(o);w&&(r.balloonStyle=w.replace(this.regExes.straightBracket,"${$1}"));break;case"labelstyle":var C;a=this.parseProperty(o,"*","color");(C=this.parseKmlColor(a))&&(r.fontColor=C.color,r.fontOpacity=C.opacity)}!r.strokeColor&&r.fillColor&&(r.strokeColor=r.fillColor);var E=e.getAttribute("id");return E&&r&&(r.id=E),r},parseStyleMaps:function(e,t){for(var o=0,r=e.length;o<r;o++)for(var i=e[o],n=this.getElementsByTagNameNS(i,"*","Pair"),s=i.getAttribute("id"),a=0,l=n.length;a<l;a++){var u=n[a],c=this.parseProperty(u,"*","key"),p=this.parseProperty(u,"*","styleUrl");p&&"normal"==c&&(this.styles[(t.styleBaseUrl||"")+"#"+s]=this.styles[(t.styleBaseUrl||"")+p])}},parseFeatures:function(e,t){for(var o=[],r=0,i=e.length;r<i;r++){var n=e[r],s=this.parseFeature.apply(this,[n]);if(!s)throw"Bad Placemark: "+r;if(this.extractStyles&&s.attributes&&s.attributes.styleUrl&&(s.style=this.getStyle(s.attributes.styleUrl,t)),this.extractStyles){var a=this.getElementsByTagNameNS(n,"*","Style")[0];if(a){var l=this.parseStyle(a);l&&(s.style=GeoGlobe.Util.extend(s.style,l))}}if(this.extractTracks){var u=this.getElementsByTagNameNS(n,this.namespaces.gx,"Track");if(u&&u.length>0){var c=u[0],p={features:[],feature:s};this.readNode(c,p),p.features.length>0&&o.push.apply(o,p.features)}}else o.push(s)}this.features=this.features.concat(o)},readers:{kml:{when:function(e,t){t.whens.push(GeoGlobe.Date.parse(this.getChildValue(e)))},_trackPointAttribute:function(e,t){var o=e.nodeName.split(":").pop();t.attributes[o].push(this.getChildValue(e))}},gx:{Track:function(e,t){var o={whens:[],points:[],angles:[]};if(this.trackAttributes){o.attributes={};for(var r=0,i=this.trackAttributes.length;r<i;++r)p=this.trackAttributes[r],o.attributes[p]=[],p in this.readers.kml||(this.readers.kml[p]=this.readers.kml._trackPointAttribute)}if(this.readChildNodes(e,o),o.whens.length!==o.points.length)throw new Error("gx:Track with unequal number of when ("+o.whens.length+") and gx:coord ("+o.points.length+") elements.");var n,s,a,l=o.angles.length>0;if(l&&o.whens.length!==o.angles.length)throw new Error("gx:Track with unequal number of when ("+o.whens.length+") and gx:angles ("+o.angles.length+") elements.");for(r=0,i=o.whens.length;r<i;++r){if((n=t.feature.clone()).fid=t.feature.fid||t.feature.id,s=o.points[r],n.geometry=s,"z"in s&&(n.attributes.altitude=s.z),this.internalProjection&&this.externalProjection&&n.geometry.transform(this.externalProjection,this.internalProjection),this.trackAttributes)for(var u=0,c=this.trackAttributes.length;u<c;++u){var p=this.trackAttributes[u];n.attributes[p]=o.attributes[p][r]}n.attributes.when=o.whens[r],n.attributes.trackId=t.feature.id,l&&(a=o.angles[r],n.attributes.heading=parseFloat(a[0]),n.attributes.tilt=parseFloat(a[1]),n.attributes.roll=parseFloat(a[2])),t.features.push(n)}},coord:function(e,t){var o=this.getChildValue(e).replace(this.regExes.trimSpace,"").split(/\s+/),r=new GeoGlobe.Geometry.Point(o[0],o[1]);o.length>2&&(r.z=parseFloat(o[2])),t.points.push(r)},angles:function(e,t){var o=this.getChildValue(e).replace(this.regExes.trimSpace,"").split(/\s+/);t.angles.push(o)}}},parseFeature:function(e){for(var t,o,r,i,n=["MultiGeometry","Polygon","LineString","Point"],s=0,a=n.length;s<a;++s)if(t=n[s],this.internalns=e.namespaceURI?e.namespaceURI:this.kmlns,(o=this.getElementsByTagNameNS(e,this.internalns,t)).length>0){var l;if(!(l=this.parseGeometry[t.toLowerCase()]))throw new TypeError("Unsupported geometry type: "+t);r=l.apply(this,[o[0]]),this.internalProjection&&this.externalProjection&&r.transform(this.externalProjection,this.internalProjection);break}this.extractAttributes&&(i=this.parseAttributes(e));var u=new GeoGlobe.Feature(r,i),c=e.getAttribute("id")||e.getAttribute("name");return null!=c&&(u.fid=c),u},getStyle:function(e,t){var o=GeoGlobe.Util.removeTail(e),r=GeoGlobe.Util.extend({},t);if(r.depth++,r.styleBaseUrl=o,!this.styles[e]&&!GeoGlobe.String.startsWith(e,"#")&&r.depth<=this.maxDepth&&!this.fetched[o]){var i=this.fetchLink(o);i&&this.parseData(i,r)}return GeoGlobe.Util.extend({},this.styles[e])},parseGeometry:{point:function(e){var t=this.getElementsByTagNameNS(e,this.internalns,"coordinates"),o=[];if(t.length>0){var r=t[0].firstChild.nodeValue;o=(r=r.replace(this.regExes.removeSpace,"")).split(",")}if(!(o.length>1))throw"Bad coordinate string: "+r;return 2==o.length&&(o[2]=null),new GeoGlobe.Geometry.Point(o[0],o[1],o[2])},linestring:function(e,t){var o=this.getElementsByTagNameNS(e,this.internalns,"coordinates"),r=null;if(o.length>0){for(var i,n=this.getChildValue(o[0]),s=(n=(n=n.replace(this.regExes.trimSpace,"")).replace(this.regExes.trimComma,",")).split(this.regExes.splitSpace),a=s.length,l=new Array(a),u=0;u<a;++u){if(!((i=s[u].split(",")).length>1))throw"Bad LineString point coordinates: "+s[u];2==i.length&&(i[2]=null),l[u]=new GeoGlobe.Geometry.Point(i[0],i[1],i[2])}if(!a)throw"Bad LineString coordinates: "+n;r=t?new GeoGlobe.Geometry.LinearRing(l):new GeoGlobe.Geometry.LineString(l)}return r},polygon:function(e){var t=this.getElementsByTagNameNS(e,this.internalns,"LinearRing"),o=t.length,r=new Array(o);if(o>0)for(var i,n=0,s=t.length;n<s;++n){if(!(i=this.parseGeometry.linestring.apply(this,[t[n],!0])))throw"Bad LinearRing geometry: "+n;r[n]=i}return new GeoGlobe.Geometry.Polygon(r)},multigeometry:function(e){for(var t,o=[],r=e.childNodes,i=0,n=r.length;i<n;++i)if(1==(t=r[i]).nodeType){var s,a=t.prefix?t.nodeName.split(":")[1]:t.nodeName;(s=this.parseGeometry[a.toLowerCase()])&&o.push(s.apply(this,[t]))}return new GeoGlobe.Geometry.Collection(o)}},parseAttributes:function(e){var t,o,r={},i=e.getElementsByTagName("ExtendedData");i.length&&(r=this.parseExtendedData(i[0]));for(var n=e.childNodes,s=0,a=n.length;s<a;++s)if(1==(t=n[s]).nodeType&&(o=t.childNodes).length>=1&&o.length<=3){var l;switch(o.length){case 1:l=o[0];break;case 2:var u=o[0],c=o[1];l=3==u.nodeType||4==u.nodeType?u:c;break;case 3:default:l=o[1]}if(3==l.nodeType||4==l.nodeType){var p=t.prefix?t.nodeName.split(":")[1]:t.nodeName,h=GeoGlobe.Util.getXmlNodeValue(l);h&&(h=h.replace(this.regExes.trimSpace,""),r[p]=h)}}return r},parseExtendedData:function(e){var t,o,r,i,n={},s=e.getElementsByTagName("Data");for(t=0,o=s.length;t<o;t++){i=(r=s[t]).getAttribute("name");var a={},l=r.getElementsByTagName("value");if(l.length&&(a.value=this.getChildValue(l[0])),this.kvpAttributes)n[i]=a.value;else{var u=r.getElementsByTagName("displayName");u.length&&(a.displayName=this.getChildValue(u[0])),n[i]=a}}var c=e.getElementsByTagName("SimpleData");for(t=0,o=c.length;t<o;t++){a={};i=(r=c[t]).getAttribute("name"),a.value=this.getChildValue(r),this.kvpAttributes?n[i]=a.value:(a.displayName=i,n[i]=a)}return n},parseProperty:function(e,t,o){var r,i=this.getElementsByTagNameNS(e,t,o);try{r=GeoGlobe.Util.getXmlNodeValue(i[0])}catch(e){r=null}return r},write:function(e){GeoGlobe.Util.isArray(e)||(e=[e]);for(var t=this.createElementNS(this.kmlns,"kml"),o=this.createFolderXML(),r=0,i=e.length;r<i;++r)o.appendChild(this.createPlacemarkXML(e[r]));return t.appendChild(o),GeoGlobe.Format.XML.prototype.write.apply(this,[t])},createFolderXML:function(){var e=this.createElementNS(this.kmlns,"Folder");if(this.foldersName){var t=this.createElementNS(this.kmlns,"name"),o=this.createTextNode(this.foldersName);t.appendChild(o),e.appendChild(t)}if(this.foldersDesc){var r=this.createElementNS(this.kmlns,"description"),i=this.createTextNode(this.foldersDesc);r.appendChild(i),e.appendChild(r)}return e},createPlacemarkXML:function(e){var t=this.createElementNS(this.kmlns,"name"),o=e.style&&e.style.label?e.style.label:e.id,r=e.attributes.name||o;t.appendChild(this.createTextNode(r));var i=this.createElementNS(this.kmlns,"description"),n=e.attributes.description||this.placemarksDesc;i.appendChild(this.createTextNode(n));var s=this.createElementNS(this.kmlns,"Placemark");null!=e.fid&&s.setAttribute("id",e.fid),s.appendChild(t),s.appendChild(i);var a=this.buildGeometryNode(e.geometry);if(s.appendChild(a),e.attributes){var l=this.buildExtendedData(e.attributes);l&&s.appendChild(l)}return s},buildGeometryNode:function(e){var t=e.CLASS_NAME,o=t.substring(t.lastIndexOf(".")+1),r=this.buildGeometry[o.toLowerCase()],i=null;return r&&(i=r.apply(this,[e])),i},buildGeometry:{point:function(e){var t=this.createElementNS(this.kmlns,"Point");return t.appendChild(this.buildCoordinatesNode(e)),t},multipoint:function(e){return this.buildGeometry.collection.apply(this,[e])},linestring:function(e){var t=this.createElementNS(this.kmlns,"LineString");return t.appendChild(this.buildCoordinatesNode(e)),t},multilinestring:function(e){return this.buildGeometry.collection.apply(this,[e])},linearring:function(e){var t=this.createElementNS(this.kmlns,"LinearRing");return t.appendChild(this.buildCoordinatesNode(e)),t},polygon:function(e){for(var t,o,r,i=this.createElementNS(this.kmlns,"Polygon"),n=e.components,s=0,a=n.length;s<a;++s)r=0==s?"outerBoundaryIs":"innerBoundaryIs",t=this.createElementNS(this.kmlns,r),o=this.buildGeometry.linearring.apply(this,[n[s]]),t.appendChild(o),i.appendChild(t);return i},multipolygon:function(e){return this.buildGeometry.collection.apply(this,[e])},collection:function(e){for(var t,o=this.createElementNS(this.kmlns,"MultiGeometry"),r=0,i=e.components.length;r<i;++r)(t=this.buildGeometryNode.apply(this,[e.components[r]]))&&o.appendChild(t);return o}},buildCoordinatesNode:function(e){var t,o=this.createElementNS(this.kmlns,"coordinates"),r=e.components;if(r){for(var i,n=r.length,s=new Array(n),a=0;a<n;++a)i=r[a],s[a]=this.buildCoordinates(i);t=s.join(" ")}else t=this.buildCoordinates(e);var l=this.createTextNode(t);return o.appendChild(l),o},buildCoordinates:function(e){return this.internalProjection&&this.externalProjection&&(e=e.clone()).transform(this.internalProjection,this.externalProjection),e.x+","+e.y},buildExtendedData:function(e){var t=this.createElementNS(this.kmlns,"ExtendedData");for(var o in e)if(e[o]&&"name"!=o&&"description"!=o&&"styleUrl"!=o){var r=this.createElementNS(this.kmlns,"Data");r.setAttribute("name",o);var i=this.createElementNS(this.kmlns,"value");if("object"==typeof e[o]){if(e[o].value&&i.appendChild(this.createTextNode(e[o].value)),e[o].displayName){var n=this.createElementNS(this.kmlns,"displayName");n.appendChild(this.getXMLDoc().createCDATASection(e[o].displayName)),r.appendChild(n)}}else i.appendChild(this.createTextNode(e[o]));r.appendChild(i),t.appendChild(r)}return this.isSimpleContent(t)?null:t},CLASS_NAME:"GeoGlobe.Format.KML"}),GeoGlobe.Format.OWSCommon=GeoGlobe.Class4OL(GeoGlobe.Format.XML.VersionedOGC,{defaultVersion:"1.0.0",getVersion:function(e,t){var o=this.version;if(!o){var r=e.getAttribute("xmlns:ows");r&&"1.1"===r.substring(r.lastIndexOf("/")+1)&&(o="1.1.0"),o||(o=this.defaultVersion)}return o},CLASS_NAME:"GeoGlobe.Format.OWSCommon"}),GeoGlobe.Format.OWSCommon.v1=GeoGlobe.Class4OL(GeoGlobe.Format.XML,{regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},read:function(e,t){t=GeoGlobe.Util.applyDefaults(t,this.options);var o={};return this.readChildNodes(e,o),o},readers:{ows:{Exception:function(e,t){var o={code:e.getAttribute("exceptionCode"),locator:e.getAttribute("locator"),texts:[]};t.exceptions.push(o),this.readChildNodes(e,o)},ExceptionText:function(e,t){var o=this.getChildValue(e);t.texts.push(o)},ServiceIdentification:function(e,t){t.serviceIdentification={},this.readChildNodes(e,t.serviceIdentification)},Title:function(e,t){t.title=this.getChildValue(e)},Abstract:function(e,t){t.abstract=this.getChildValue(e)},Keywords:function(e,t){t.keywords={},this.readChildNodes(e,t.keywords)},Keyword:function(e,t){t[this.getChildValue(e)]=!0},ServiceType:function(e,t){t.serviceType={codeSpace:e.getAttribute("codeSpace"),value:this.getChildValue(e)}},ServiceTypeVersion:function(e,t){t.serviceTypeVersion=this.getChildValue(e)},Fees:function(e,t){t.fees=this.getChildValue(e)},AccessConstraints:function(e,t){t.accessConstraints=this.getChildValue(e)},ServiceProvider:function(e,t){t.serviceProvider={},this.readChildNodes(e,t.serviceProvider)},ProviderName:function(e,t){t.providerName=this.getChildValue(e)},ProviderSite:function(e,t){t.providerSite=this.getAttributeNS(e,this.namespaces.xlink,"href")},ServiceContact:function(e,t){t.serviceContact={},this.readChildNodes(e,t.serviceContact)},IndividualName:function(e,t){t.individualName=this.getChildValue(e)},PositionName:function(e,t){t.positionName=this.getChildValue(e)},ContactInfo:function(e,t){t.contactInfo={},this.readChildNodes(e,t.contactInfo)},Phone:function(e,t){t.phone={},this.readChildNodes(e,t.phone)},Voice:function(e,t){t.voice=this.getChildValue(e)},Address:function(e,t){t.address={},this.readChildNodes(e,t.address)},DeliveryPoint:function(e,t){t.deliveryPoint=this.getChildValue(e)},City:function(e,t){t.city=this.getChildValue(e)},AdministrativeArea:function(e,t){t.administrativeArea=this.getChildValue(e)},PostalCode:function(e,t){t.postalCode=this.getChildValue(e)},Country:function(e,t){t.country=this.getChildValue(e)},ElectronicMailAddress:function(e,t){t.electronicMailAddress=this.getChildValue(e)},Role:function(e,t){t.role=this.getChildValue(e)},OperationsMetadata:function(e,t){t.operationsMetadata={},this.readChildNodes(e,t.operationsMetadata)},Operation:function(e,t){var o=e.getAttribute("name");t[o]={},this.readChildNodes(e,t[o])},DCP:function(e,t){t.dcp={},this.readChildNodes(e,t.dcp)},HTTP:function(e,t){t.http={},this.readChildNodes(e,t.http)},Get:function(e,t){t.get||(t.get=[]);var o={url:this.getAttributeNS(e,this.namespaces.xlink,"href")};this.readChildNodes(e,o),t.get.push(o)},Post:function(e,t){t.post||(t.post=[]);var o={url:this.getAttributeNS(e,this.namespaces.xlink,"href")};this.readChildNodes(e,o),t.post.push(o)},Parameter:function(e,t){t.parameters||(t.parameters={});var o=e.getAttribute("name");t.parameters[o]={},this.readChildNodes(e,t.parameters[o])},Constraint:function(e,t){t.constraints||(t.constraints={});var o=e.getAttribute("name");t.constraints[o]={},this.readChildNodes(e,t.constraints[o])},Value:function(e,t){t[this.getChildValue(e)]=!0},OutputFormat:function(e,t){t.formats.push({value:this.getChildValue(e)}),this.readChildNodes(e,t)},WGS84BoundingBox:function(e,t){var o={};o.crs=e.getAttribute("crs"),t.BoundingBox?t.BoundingBox.push(o):(t.projection=o.crs,o=t),this.readChildNodes(e,o)},BoundingBox:function(e,t){this.readers.ows.WGS84BoundingBox.apply(this,[e,t])},LowerCorner:function(e,t){var o=this.getChildValue(e).replace(this.regExes.trimSpace,""),r=(o=o.replace(this.regExes.trimComma,",")).split(this.regExes.splitSpace);t.left=r[0],t.bottom=r[1]},UpperCorner:function(e,t){var o=this.getChildValue(e).replace(this.regExes.trimSpace,""),r=(o=o.replace(this.regExes.trimComma,",")).split(this.regExes.splitSpace);t.right=r[0],t.top=r[1],t.bounds=new GeoGlobe.LngLatBounds(new GeoGlobe.LngLat(t.left,t.bottom),new GeoGlobe.LngLat(t.right,t.top)),delete t.left,delete t.bottom,delete t.right,delete t.top},Language:function(e,t){t.language=this.getChildValue(e)}}},writers:{ows:{BoundingBox:function(e,t){var o=this.createElementNSPlus(t||"ows:BoundingBox",{attributes:{crs:e.projection}});return this.writeNode("ows:LowerCorner",e,o),this.writeNode("ows:UpperCorner",e,o),o},LowerCorner:function(e){return this.createElementNSPlus("ows:LowerCorner",{value:e.bounds._sw.lng+" "+e.bounds._sw.lat})},UpperCorner:function(e){return this.createElementNSPlus("ows:UpperCorner",{value:e.bounds._ne.lng+" "+e.bounds._ne.lat})},Identifier:function(e){return this.createElementNSPlus("ows:Identifier",{value:e})},Title:function(e){return this.createElementNSPlus("ows:Title",{value:e})},Abstract:function(e){return this.createElementNSPlus("ows:Abstract",{value:e})},OutputFormat:function(e){return this.createElementNSPlus("ows:OutputFormat",{value:e})}}},CLASS_NAME:"GeoGlobe.Format.OWSCommon.v1"}),GeoGlobe.Format.OWSCommon.v1_0_0=GeoGlobe.Class4OL(GeoGlobe.Format.OWSCommon.v1,{namespaces:{ows:"http://www.opengis.net/ows",xlink:"http://www.w3.org/1999/xlink"},readers:{ows:GeoGlobe.Util.applyDefaults({ExceptionReport:function(e,t){t.success=!1,t.exceptionReport={version:e.getAttribute("version"),language:e.getAttribute("language"),exceptions:[]},this.readChildNodes(e,t.exceptionReport)}},GeoGlobe.Format.OWSCommon.v1.prototype.readers.ows)},writers:{ows:GeoGlobe.Format.OWSCommon.v1.prototype.writers.ows},CLASS_NAME:"GeoGlobe.Format.OWSCommon.v1_0_0"}),GeoGlobe.Format.OWSCommon.v1_1_0=GeoGlobe.Class4OL(GeoGlobe.Format.OWSCommon.v1,{namespaces:{ows:"http://www.opengis.net/ows/1.1",xlink:"http://www.w3.org/1999/xlink"},readers:{ows:GeoGlobe.Util.applyDefaults({ExceptionReport:function(e,t){t.exceptionReport={version:e.getAttribute("version"),language:e.getAttribute("xml:lang"),exceptions:[]},this.readChildNodes(e,t.exceptionReport)},AllowedValues:function(e,t){t.allowedValues={},this.readChildNodes(e,t.allowedValues)},AnyValue:function(e,t){t.anyValue=!0},DataType:function(e,t){t.dataType=this.getChildValue(e)},Range:function(e,t){t.range={},this.readChildNodes(e,t.range)},MinimumValue:function(e,t){t.minValue=this.getChildValue(e)},MaximumValue:function(e,t){t.maxValue=this.getChildValue(e)},Identifier:function(e,t){t.identifier=this.getChildValue(e)},SupportedCRS:function(e,t){t.supportedCRS=this.getChildValue(e)}},GeoGlobe.Format.OWSCommon.v1.prototype.readers.ows)},writers:{ows:GeoGlobe.Util.applyDefaults({Range:function(e){var t=this.createElementNSPlus("ows:Range",{attributes:{"ows:rangeClosure":e.closure}});return this.writeNode("ows:MinimumValue",e.minValue,t),this.writeNode("ows:MaximumValue",e.maxValue,t),t},MinimumValue:function(e){return this.createElementNSPlus("ows:MinimumValue",{value:e})},MaximumValue:function(e){return this.createElementNSPlus("ows:MaximumValue",{value:e})},Value:function(e){return this.createElementNSPlus("ows:Value",{value:e})}},GeoGlobe.Format.OWSCommon.v1.prototype.writers.ows)},CLASS_NAME:"GeoGlobe.Format.OWSCommon.v1_1_0"}),GeoGlobe.Format.WFSCapabilities=GeoGlobe.Class4OL(GeoGlobe.Format.XML.VersionedOGC,{defaultVersion:"1.1.0",CLASS_NAME:"GeoGlobe.Format.WFSCapabilities"}),GeoGlobe.Format.WFSCapabilities.v1=GeoGlobe.Class4OL(GeoGlobe.Format.XML,{namespaces:{wfs:"http://www.opengis.net/wfs",xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance",ows:"http://www.opengis.net/ows"},errorProperty:"featureTypeList",defaultPrefix:"wfs",read:function(e){"string"==typeof e&&(e=GeoGlobe.Format.XML.prototype.read.apply(this,[e]));e&&9==e.nodeType&&(e=e.documentElement);var t={};return this.readNode(e,t),t},readers:{wfs:{WFS_Capabilities:function(e,t){this.readChildNodes(e,t)},FeatureTypeList:function(e,t){t.featureTypeList={featureTypes:[]},this.readChildNodes(e,t.featureTypeList)},FeatureType:function(e,t){var o={};this.readChildNodes(e,o),t.featureTypes.push(o)},Name:function(e,t){var o=this.getChildValue(e);if(o){var r=o.split(":");t.name=r.pop(),r.length>0&&(t.featureNS=this.lookupNamespaceURI(e,r[0]))}},Title:function(e,t){var o=this.getChildValue(e);o&&(t.title=o)},Abstract:function(e,t){var o=this.getChildValue(e);o&&(t.abstract=o)}}},CLASS_NAME:"GeoGlobe.Format.WFSCapabilities.v1"}),GeoGlobe.Format.WFSCapabilities.v1_0_0=GeoGlobe.Class4OL(GeoGlobe.Format.WFSCapabilities.v1,{readers:{wfs:GeoGlobe.Util.applyDefaults({Service:function(e,t){t.service={},this.readChildNodes(e,t.service)},Fees:function(e,t){var o=this.getChildValue(e);o&&"none"!=o.toLowerCase()&&(t.fees=o)},AccessConstraints:function(e,t){var o=this.getChildValue(e);o&&"none"!=o.toLowerCase()&&(t.accessConstraints=o)},OnlineResource:function(e,t){var o=this.getChildValue(e);o&&"none"!=o.toLowerCase()&&(t.onlineResource=o)},Keywords:function(e,t){var o=this.getChildValue(e);o&&"none"!=o.toLowerCase()&&(t.keywords=o.split(", "))},Capability:function(e,t){t.capability={},this.readChildNodes(e,t.capability)},Request:function(e,t){t.request={},this.readChildNodes(e,t.request)},GetFeature:function(e,t){t.getfeature={href:{},formats:[]},this.readChildNodes(e,t.getfeature)},ResultFormat:function(e,t){for(var o,r=e.childNodes,i=0;i<r.length;i++)1==(o=r[i]).nodeType&&t.formats.push(o.nodeName)},DCPType:function(e,t){this.readChildNodes(e,t)},HTTP:function(e,t){this.readChildNodes(e,t.href)},Get:function(e,t){t.get=e.getAttribute("onlineResource")},Post:function(e,t){t.post=e.getAttribute("onlineResource")},SRS:function(e,t){var o=this.getChildValue(e);o&&(t.srs=o)},LatLongBoundingBox:function(e,t){var o=e.getAttribute("minx"),r=e.getAttribute("miny"),i=e.getAttribute("maxx"),n=e.getAttribute("maxy");t.bbox=o+","+r+","+i+","+n},TemporalFeatureLayer:function(e,t){t.temporalFeatureLayers=[];var o={};this.readChildNodes(e,o),t.temporalFeatureLayers.push(o)},Extent:function(e,t){t.defaultTime=e.getAttribute("default");var o=this.getChildValue(e).split("/");t.time=o},Dimension:function(e,t){t.defaultTime=e.getAttribute("default");var o=this.getChildValue(e).split("/");t.time=o}},GeoGlobe.Format.WFSCapabilities.v1.prototype.readers.wfs)},CLASS_NAME:"GeoGlobe.Format.WFSCapabilities.v1_0_0"}),GeoGlobe.Format.WFSCapabilities.v1_1_0=GeoGlobe.Class4OL(GeoGlobe.Format.WFSCapabilities.v1,{regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},readers:{wfs:GeoGlobe.Util.applyDefaults({DefaultSRS:function(e,t){var o=this.getChildValue(e);o&&(t.srs=o)},WGS84BoundingBox:function(e,t){var o=e.getElementsByTagName("ows:LowerCorner"),r=this.getChildValue(o[0]).split(" "),i=e.getElementsByTagName("ows:UpperCorner"),n=this.getChildValue(i[0]).split(" ");t.bbox=r[0]+","+r[1]+","+n[0]+","+n[1]},TemporalFeatureLayer:function(e,t){t.temporalFeatureLayers=[];var o={};this.readChildNodes(e,o),t.temporalFeatureLayers.push(o)},Extent:function(e,t){t.defaultTime=e.getAttribute("default");var o=this.getChildValue(e).split("/");t.time=o},Dimension:function(e,t){t.defaultTime=e.getAttribute("default");var o=this.getChildValue(e).split("/");t.time=o}},GeoGlobe.Format.WFSCapabilities.v1.prototype.readers.wfs),ows:GeoGlobe.Format.OWSCommon.v1.prototype.readers.ows},CLASS_NAME:"GeoGlobe.Format.WFSCapabilities.v1_1_0"}),GeoGlobe.Format.WFSDescribeFeatureType=GeoGlobe.Class4OL(GeoGlobe.Format.XML,{regExes:{trimSpace:/^\s*|\s*$/g},namespaces:{xsd:"http://www.w3.org/2001/XMLSchema"},readers:{xsd:{schema:function(e,t){var o,r,i=[],n={},s={complexTypes:i,customTypes:n};this.readChildNodes(e,s);var a,l,u,c,p=e.attributes;for(o=0,r=p.length;o<r;++o)0===(l=(a=p[o]).name).indexOf("xmlns")?this.setNamespace(l.split(":")[1]||"",a.value):t[l]=a.value;for(t.featureTypes=i,t.targetPrefix=this.namespaceAlias[t.targetNamespace],o=0,r=i.length;o<r;++o)c=n[(u=i[o]).typeName],n[u.typeName]&&(u.typeName=c.name)},complexType:function(e,t){var o={typeName:e.getAttribute("name")};this.readChildNodes(e,o),t.complexTypes.push(o)},complexContent:function(e,t){this.readChildNodes(e,t)},extension:function(e,t){this.readChildNodes(e,t)},sequence:function(e,t){var o={elements:[]};this.readChildNodes(e,o),t.properties=o.elements},element:function(e,t){var o;if(t.elements){for(var r,i={},n=e.attributes,s=0,a=n.length;s<a;++s)i[(r=n[s]).name]=r.value;(o=i.type||i.ref)||(o={},this.readChildNodes(e,o),i.restriction=o,i.type=o.base);var l=o.base||o;i.localType=l.split(":").pop(),t.elements.push(i),this.readChildNodes(e,i)}if(t.complexTypes){var u=(o=e.getAttribute("type")).split(":").pop();t.customTypes[u]={name:e.getAttribute("name"),type:o}}},annotation:function(e,t){t.annotation={},this.readChildNodes(e,t.annotation)},appinfo:function(e,t){t.appinfo||(t.appinfo=[]),t.appinfo.push(this.getChildValue(e))},documentation:function(e,t){t.documentation||(t.documentation=[]);var o=this.getChildValue(e);t.documentation.push({lang:e.getAttribute("xml:lang"),textContent:o.replace(this.regExes.trimSpace,"")})},simpleType:function(e,t){this.readChildNodes(e,t)},restriction:function(e,t){t.base=e.getAttribute("base"),this.readRestriction(e,t)}}},readRestriction:function(e,t){for(var o,r,i,n=e.childNodes,s=0,a=n.length;s<a;++s)1==(o=n[s]).nodeType&&(r=o.nodeName.split(":").pop(),i=o.getAttribute("value"),t[r]?("string"==typeof t[r]&&(t[r]=[t[r]]),t[r].push(i)):t[r]=i)},read:function(e){"string"==typeof e&&(e=GeoGlobe.Format.XML.prototype.read.apply(this,[e])),e&&9==e.nodeType&&(e=e.documentElement);var t={};if("ExceptionReport"===e.nodeName.split(":").pop()){var o=new GeoGlobe.Format.OGCExceptionReport;t.error=o.read(e)}else this.readNode(e,t);return t},CLASS_NAME:"GeoGlobe.Format.WFSDescribeFeatureType"}),GeoGlobe.Format.WKT=GeoGlobe.Class4OL(GeoGlobe.Format,{initialize:function(e){this.regExes={typeStr:/^\s*(\w+)\s*\(\s*(.*)\s*\)\s*$/,spaces:/\s+/,parenComma:/\)\s*,\s*\(/,doubleParenComma:/\)\s*\)\s*,\s*\(\s*\(/,trimParens:/^\s*\(?(.*?)\)?\s*$/},GeoGlobe.Format.prototype.initialize.apply(this,[e])},read:function(e){var t,o,r;e=e.replace(/[\n\r]/g," ");var i=this.regExes.typeStr.exec(e);if(i&&(o=i[1].toLowerCase(),r=i[2],this.parse[o]&&(t=this.parse[o].apply(this,[r])),this.internalProjection&&this.externalProjection))if(t&&"GeoGlobe.Feature"==t.CLASS_NAME)t.geometry.transform(this.externalProjection,this.internalProjection);else if(t&&"geometrycollection"!=o&&"object"==typeof t)for(var n=0,s=t.length;n<s;n++){t[n].geometry.transform(this.externalProjection,this.internalProjection)}return t},write:function(e){var t,o,r;e.constructor==Array?(t=e,r=!0):(t=[e],r=!1);var i=[];r&&i.push("GEOMETRYCOLLECTION(");for(var n=0,s=t.length;n<s;++n)r&&n>0&&i.push(","),o=t[n].geometry,i.push(this.extractGeometry(o));return r&&i.push(")"),i.join("")},extractGeometry:function(e){var t=e.CLASS_NAME.split(".")[2].toLowerCase();return this.extract[t]?(this.internalProjection&&this.externalProjection&&(e=e.clone()).transform(this.internalProjection,this.externalProjection),("collection"==t?"GEOMETRYCOLLECTION":t.toUpperCase())+"("+this.extract[t].apply(this,[e])+")"):null},extract:{point:function(e){return e.x+" "+e.y},multipoint:function(e){for(var t=[],o=0,r=e.components.length;o<r;++o)t.push("("+this.extract.point.apply(this,[e.components[o]])+")");return t.join(",")},linestring:function(e){for(var t=[],o=0,r=e.components.length;o<r;++o)t.push(this.extract.point.apply(this,[e.components[o]]));return t.join(",")},multilinestring:function(e){for(var t=[],o=0,r=e.components.length;o<r;++o)t.push("("+this.extract.linestring.apply(this,[e.components[o]])+")");return t.join(",")},polygon:function(e){for(var t=[],o=0,r=e.components.length;o<r;++o)t.push("("+this.extract.linestring.apply(this,[e.components[o]])+")");return t.join(",")},multipolygon:function(e){for(var t=[],o=0,r=e.components.length;o<r;++o)t.push("("+this.extract.polygon.apply(this,[e.components[o]])+")");return t.join(",")},collection:function(e){for(var t=[],o=0,r=e.components.length;o<r;++o)t.push(this.extractGeometry.apply(this,[e.components[o]]));return t.join(",")}},parse:{point:function(e){var t=GeoGlobe.String.trim(e).split(this.regExes.spaces);return new GeoGlobe.Feature(new GeoGlobe.Geometry.Point(t[0],t[1]))},multipoint:function(e){for(var t,o=GeoGlobe.String.trim(e).split(","),r=[],i=0,n=o.length;i<n;++i)t=o[i].replace(this.regExes.trimParens,"$1"),r.push(this.parse.point.apply(this,[t]).geometry);return new GeoGlobe.Feature(new GeoGlobe.Geometry.MultiPoint(r))},linestring:function(e){for(var t=GeoGlobe.String.trim(e).split(","),o=[],r=0,i=t.length;r<i;++r)o.push(this.parse.point.apply(this,[t[r]]).geometry);return new GeoGlobe.Feature(new GeoGlobe.Geometry.LineString(o))},multilinestring:function(e){for(var t,o=GeoGlobe.String.trim(e).split(this.regExes.parenComma),r=[],i=0,n=o.length;i<n;++i)t=o[i].replace(this.regExes.trimParens,"$1"),r.push(this.parse.linestring.apply(this,[t]).geometry);return new GeoGlobe.Feature(new GeoGlobe.Geometry.MultiLineString(r))},polygon:function(e){for(var t,o,r,i=GeoGlobe.String.trim(e).split(this.regExes.parenComma),n=[],s=0,a=i.length;s<a;++s)t=i[s].replace(this.regExes.trimParens,"$1"),o=this.parse.linestring.apply(this,[t]).geometry,r=new GeoGlobe.Geometry.LinearRing(o.components),n.push(r);return new GeoGlobe.Feature(new GeoGlobe.Geometry.Polygon(n))},multipolygon:function(e){for(var t,o=GeoGlobe.String.trim(e).split(this.regExes.doubleParenComma),r=[],i=0,n=o.length;i<n;++i)t=o[i].replace(this.regExes.trimParens,"$1"),r.push(this.parse.polygon.apply(this,[t]).geometry);return new GeoGlobe.Feature(new GeoGlobe.Geometry.MultiPolygon(r))},geometrycollection:function(e){e=e.replace(/,\s*([A-Za-z])/g,"|$1");for(var t=GeoGlobe.String.trim(e).split("|"),o=[],r=0,i=t.length;r<i;++r)o.push(GeoGlobe.Format.WKT.prototype.read.apply(this,[t[r]]));return o}},CLASS_NAME:"GeoGlobe.Format.WKT"}),GeoGlobe.Format.CQL=function(){var e,t={PROPERTY:/^[_a-zA-Z]\w*/,COMPARISON:/^(=|<>|<=|<|>=|>|LIKE)/i,IS_NULL:/^IS NULL/i,COMMA:/^,/,LOGICAL:/^(AND|OR)/i,VALUE:/^('([^']|'')*'|\d+(\.\d*)?|\.\d+)/,LPAREN:/^\(/,RPAREN:/^\)/,SPATIAL:/^(BBOX|INTERSECTS|DWITHIN|WITHIN|CONTAINS)/i,NOT:/^NOT/i,BETWEEN:/^BETWEEN/i,GEOMETRY:function(e){var t=/^(POINT|LINESTRING|POLYGON|MULTIPOINT|MULTILINESTRING|MULTIPOLYGON|GEOMETRYCOLLECTION)/.exec(e);if(t){var o=e.length,r=e.indexOf("(",t[0].length);if(r>-1)for(var i=1;r<o&&i>0;)switch(r++,e.charAt(r)){case"(":i++;break;case")":i--}return[e.substr(0,r+1)]}},END:/^$/},o={LPAREN:["GEOMETRY","SPATIAL","PROPERTY","VALUE","LPAREN"],RPAREN:["NOT","LOGICAL","END","RPAREN"],PROPERTY:["COMPARISON","BETWEEN","COMMA","IS_NULL"],BETWEEN:["VALUE"],IS_NULL:["END"],COMPARISON:["VALUE"],COMMA:["GEOMETRY","VALUE","PROPERTY"],VALUE:["LOGICAL","COMMA","RPAREN","END"],SPATIAL:["LPAREN"],LOGICAL:["NOT","VALUE","SPATIAL","PROPERTY","LPAREN"],NOT:["PROPERTY","LPAREN"],GEOMETRY:["COMMA","RPAREN"]},r={"=":GeoGlobe.Filter.Comparison.EQUAL_TO,"<>":GeoGlobe.Filter.Comparison.NOT_EQUAL_TO,"<":GeoGlobe.Filter.Comparison.LESS_THAN,"<=":GeoGlobe.Filter.Comparison.LESS_THAN_OR_EQUAL_TO,">":GeoGlobe.Filter.Comparison.GREATER_THAN,">=":GeoGlobe.Filter.Comparison.GREATER_THAN_OR_EQUAL_TO,LIKE:GeoGlobe.Filter.Comparison.LIKE,BETWEEN:GeoGlobe.Filter.Comparison.BETWEEN,"IS NULL":GeoGlobe.Filter.Comparison.IS_NULL},i={},n={AND:GeoGlobe.Filter.Logical.AND,OR:GeoGlobe.Filter.Logical.OR},s={},a={RPAREN:3,LOGICAL:2,COMPARISON:1};for(e in r)r.hasOwnProperty(e)&&(i[r[e]]=e);for(e in n)n.hasOwnProperty(e)&&(s[n[e]]=e);function l(e,o){var r,i,n,s,a=o.length;for(r=0;r<a;r++){i=o[r];var l=t[i],u=(n=e,(s=l)instanceof RegExp?s.exec(n):s(n));if(u){var c=u[0];return{type:i,text:c,remainder:e.substr(c.length).replace(/^\s*/,"")}}}var p="ERROR: In parsing: ["+e+"], expected one of: ";for(r=0;r<a;r++)p+="\n    "+(i=o[r])+": "+t[i];throw new Error(p)}return GeoGlobe.Class4OL(GeoGlobe.Format,{read:function(e){var t=function(e){for(var t=[],o=[];e.length;){var i=e.shift();switch(i.type){case"PROPERTY":case"GEOMETRY":case"VALUE":o.push(i);break;case"COMPARISON":case"BETWEEN":case"IS_NULL":case"LOGICAL":for(var s=a[i.type];t.length>0&&a[t[t.length-1].type]<=s;)o.push(t.pop());t.push(i);break;case"SPATIAL":case"NOT":case"LPAREN":t.push(i);break;case"RPAREN":for(;t.length>0&&"LPAREN"!=t[t.length-1].type;)o.push(t.pop());t.pop(),t.length>0&&"SPATIAL"==t[t.length-1].type&&o.push(t.pop());case"COMMA":case"END":break;default:throw new Error("Unknown token type "+i.type)}}for(;t.length>0;)o.push(t.pop());var l=function e(){var t=o.pop();switch(t.type){case"LOGICAL":var i=e(),s=e();return new GeoGlobe.Filter.Logical({filters:[s,i],type:n[t.text.toUpperCase()]});case"NOT":var a=e();return new GeoGlobe.Filter.Logical({filters:[a],type:GeoGlobe.Filter.Logical.NOT});case"BETWEEN":var l,u;return o.pop(),u=e(),l=e(),p=e(),new GeoGlobe.Filter.Comparison({property:p,lowerBoundary:l,upperBoundary:u,type:GeoGlobe.Filter.Comparison.BETWEEN});case"COMPARISON":var c=e(),p=e();return new GeoGlobe.Filter.Comparison({property:p,value:c,type:r[t.text.toUpperCase()]});case"IS_NULL":return p=e(),new GeoGlobe.Filter.Comparison({property:p,type:r[t.text.toUpperCase()]});case"VALUE":var h=t.text.match(/^'(.*)'$/);return h?h[1].replace(/''/g,"'"):Number(t.text);case"SPATIAL":switch(t.text.toUpperCase()){case"BBOX":var f=e(),d=e(),G=e(),m=e(),g=e();return new GeoGlobe.Filter.Spatial({type:GeoGlobe.Filter.Spatial.BBOX,property:g,value:GeoGlobe.LngLatBounds.fromArray([m,G,d,f])});case"INTERSECTS":return c=e(),p=e(),new GeoGlobe.Filter.Spatial({type:GeoGlobe.Filter.Spatial.INTERSECTS,property:p,value:c});case"WITHIN":return c=e(),p=e(),new GeoGlobe.Filter.Spatial({type:GeoGlobe.Filter.Spatial.WITHIN,property:p,value:c});case"CONTAINS":return c=e(),p=e(),new GeoGlobe.Filter.Spatial({type:GeoGlobe.Filter.Spatial.CONTAINS,property:p,value:c});case"DWITHIN":var y=e();return c=e(),p=e(),new GeoGlobe.Filter.Spatial({type:GeoGlobe.Filter.Spatial.DWITHIN,value:c,property:p,distance:Number(y)})}case"GEOMETRY":return GeoGlobe.Geometry.fromWKT(t.text);default:return t.text}}();if(o.length>0){for(var u="Remaining tokens after building AST: \n",c=o.length-1;c>=0;c--)u+=o[c].type+": "+o[c].text+"\n";throw new Error(u)}return l}(function(e){var t,r=[],i=["NOT","GEOMETRY","SPATIAL","PROPERTY","LPAREN"];do{if(e=(t=l(e,i)).remainder,i=o[t.type],"END"!=t.type&&!i)throw new Error("No follows list for "+t.type);r.push(t)}while("END"!=t.type);return r}(e));return this.keepData&&(this.data=t),t},write:function(e){if(e instanceof GeoGlobe.Geometry)return e.toString();switch(e.CLASS_NAME){case"GeoGlobe.Filter.Spatial":switch(e.type){case GeoGlobe.Filter.Spatial.BBOX:return"BBOX("+e.property+","+e.value.toBBOX()+")";case GeoGlobe.Filter.Spatial.DWITHIN:return"DWITHIN("+e.property+", "+this.write(e.value)+", "+e.distance+")";case GeoGlobe.Filter.Spatial.WITHIN:return"WITHIN("+e.property+", "+this.write(e.value)+")";case GeoGlobe.Filter.Spatial.INTERSECTS:return"INTERSECTS("+e.property+", "+this.write(e.value)+")";case GeoGlobe.Filter.Spatial.CONTAINS:return"CONTAINS("+e.property+", "+this.write(e.value)+")";default:throw new Error("Unknown spatial filter type: "+e.type)}case"GeoGlobe.Filter.Logical":if(e.type==GeoGlobe.Filter.Logical.NOT)return"NOT ("+this.write(e.filters[0])+")";for(var t="(",o=!0,r=0;r<e.filters.length;r++)o?o=!1:t+=") "+s[e.type]+" (",t+=this.write(e.filters[r]);return t+")";case"GeoGlobe.Filter.Comparison":return e.type==GeoGlobe.Filter.Comparison.BETWEEN?e.property+" BETWEEN "+this.write(e.lowerBoundary)+" AND "+this.write(e.upperBoundary):null!==e.value?e.property+" "+i[e.type]+" "+this.write(e.value):e.property+" "+i[e.type];case void 0:if("string"==typeof e)return"'"+e.replace(/'/g,"''")+"'";if("number"==typeof e)return String(e);default:throw new Error("Can't encode: "+e.CLASS_NAME+" "+e)}},CLASS_NAME:"GeoGlobe.Format.CQL"})}(),GeoGlobe.Format.Filter=GeoGlobe.Class4OL(GeoGlobe.Format.XML.VersionedOGC,{defaultVersion:"1.0.0",CLASS_NAME:"GeoGlobe.Format.Filter"}),GeoGlobe.Format.Filter.v1=GeoGlobe.Class4OL(GeoGlobe.Format.XML,{namespaces:{ogc:"http://www.opengis.net/ogc",gml:"http://www.opengis.net/gml",xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance"},defaultPrefix:"ogc",schemaLocation:null,initialize:function(e){GeoGlobe.Format.XML.prototype.initialize.apply(this,[e])},read:function(e){var t={};return this.readers.ogc.Filter.apply(this,[e,t]),t.filter},readers:{ogc:{_expression:function(e){for(var t,o="",r=e.firstChild;r;r=r.nextSibling)switch(r.nodeType){case 1:(t=this.readNode(r)).property?o+="${"+t.property+"}":void 0!==t.value&&(o+=t.value);break;case 3:case 4:o+=r.nodeValue}return o},Filter:function(e,t){var o={fids:[],filters:[]};this.readChildNodes(e,o),o.fids.length>0?t.filter=new GeoGlobe.Filter.FeatureId({fids:o.fids}):o.filters.length>0&&(t.filter=o.filters[0])},FeatureId:function(e,t){var o=e.getAttribute("fid");o&&t.fids.push(o)},And:function(e,t){var o=new GeoGlobe.Filter.Logical({type:GeoGlobe.Filter.Logical.AND});this.readChildNodes(e,o),t.filters.push(o)},Or:function(e,t){var o=new GeoGlobe.Filter.Logical({type:GeoGlobe.Filter.Logical.OR});this.readChildNodes(e,o),t.filters.push(o)},Not:function(e,t){var o=new GeoGlobe.Filter.Logical({type:GeoGlobe.Filter.Logical.NOT});this.readChildNodes(e,o),t.filters.push(o)},PropertyIsLessThan:function(e,t){var o=new GeoGlobe.Filter.Comparison({type:GeoGlobe.Filter.Comparison.LESS_THAN});this.readChildNodes(e,o),t.filters.push(o)},PropertyIsGreaterThan:function(e,t){var o=new GeoGlobe.Filter.Comparison({type:GeoGlobe.Filter.Comparison.GREATER_THAN});this.readChildNodes(e,o),t.filters.push(o)},PropertyIsLessThanOrEqualTo:function(e,t){var o=new GeoGlobe.Filter.Comparison({type:GeoGlobe.Filter.Comparison.LESS_THAN_OR_EQUAL_TO});this.readChildNodes(e,o),t.filters.push(o)},PropertyIsGreaterThanOrEqualTo:function(e,t){var o=new GeoGlobe.Filter.Comparison({type:GeoGlobe.Filter.Comparison.GREATER_THAN_OR_EQUAL_TO});this.readChildNodes(e,o),t.filters.push(o)},PropertyIsBetween:function(e,t){var o=new GeoGlobe.Filter.Comparison({type:GeoGlobe.Filter.Comparison.BETWEEN});this.readChildNodes(e,o),t.filters.push(o)},Literal:function(e,t){t.value=GeoGlobe.String.numericIf(this.getChildValue(e),!0)},PropertyName:function(e,t){t.property=this.getChildValue(e)},LowerBoundary:function(e,t){t.lowerBoundary=GeoGlobe.String.numericIf(this.readers.ogc._expression.call(this,e),!0)},UpperBoundary:function(e,t){t.upperBoundary=GeoGlobe.String.numericIf(this.readers.ogc._expression.call(this,e),!0)},Intersects:function(e,t){this.readSpatial(e,t,GeoGlobe.Filter.Spatial.INTERSECTS)},Within:function(e,t){this.readSpatial(e,t,GeoGlobe.Filter.Spatial.WITHIN)},Contains:function(e,t){this.readSpatial(e,t,GeoGlobe.Filter.Spatial.CONTAINS)},DWithin:function(e,t){this.readSpatial(e,t,GeoGlobe.Filter.Spatial.DWITHIN)},Distance:function(e,t){t.distance=parseInt(this.getChildValue(e)),t.distanceUnits=e.getAttribute("units")},Function:function(e,t){},PropertyIsNull:function(e,t){var o=new GeoGlobe.Filter.Comparison({type:GeoGlobe.Filter.Comparison.IS_NULL});this.readChildNodes(e,o),t.filters.push(o)}}},readSpatial:function(e,t,o){var r=new GeoGlobe.Filter.Spatial({type:o});this.readChildNodes(e,r),r.value=r.components[0],delete r.components,t.filters.push(r)},encodeLiteral:function(e){return e instanceof Date&&(e=GeoGlobe.Date.toISOString(e)),e},writeOgcExpression:function(e,t){return e instanceof GeoGlobe.Filter.Function?this.writeNode("Function",e,t):this.writeNode("Literal",e,t),t},write:function(e){return this.writers.ogc.Filter.apply(this,[e])},writers:{ogc:{Filter:function(e){var t=this.createElementNSPlus("ogc:Filter");return this.writeNode(this.getFilterType(e),e,t),t},_featureIds:function(e){for(var t=this.createDocumentFragment(),o=0,r=e.fids.length;o<r;++o)this.writeNode("ogc:FeatureId",e.fids[o],t);return t},FeatureId:function(e){return this.createElementNSPlus("ogc:FeatureId",{attributes:{fid:e}})},And:function(e){for(var t,o=this.createElementNSPlus("ogc:And"),r=0,i=e.filters.length;r<i;++r)t=e.filters[r],this.writeNode(this.getFilterType(t),t,o);return o},Or:function(e){for(var t,o=this.createElementNSPlus("ogc:Or"),r=0,i=e.filters.length;r<i;++r)t=e.filters[r],this.writeNode(this.getFilterType(t),t,o);return o},Not:function(e){var t=this.createElementNSPlus("ogc:Not"),o=e.filters[0];return this.writeNode(this.getFilterType(o),o,t),t},PropertyIsLessThan:function(e){var t=this.createElementNSPlus("ogc:PropertyIsLessThan");return this.writeNode("PropertyName",e,t),this.writeOgcExpression(e.value,t),t},PropertyIsGreaterThan:function(e){var t=this.createElementNSPlus("ogc:PropertyIsGreaterThan");return this.writeNode("PropertyName",e,t),this.writeOgcExpression(e.value,t),t},PropertyIsLessThanOrEqualTo:function(e){var t=this.createElementNSPlus("ogc:PropertyIsLessThanOrEqualTo");return this.writeNode("PropertyName",e,t),this.writeOgcExpression(e.value,t),t},PropertyIsGreaterThanOrEqualTo:function(e){var t=this.createElementNSPlus("ogc:PropertyIsGreaterThanOrEqualTo");return this.writeNode("PropertyName",e,t),this.writeOgcExpression(e.value,t),t},PropertyIsBetween:function(e){var t=this.createElementNSPlus("ogc:PropertyIsBetween");return this.writeNode("PropertyName",e,t),this.writeNode("LowerBoundary",e,t),this.writeNode("UpperBoundary",e,t),t},PropertyName:function(e){return this.createElementNSPlus("ogc:PropertyName",{value:e.property})},Literal:function(e){var t=this.encodeLiteral||GeoGlobe.Format.Filter.v1.prototype.encodeLiteral;return this.createElementNSPlus("ogc:Literal",{value:t(e)})},LowerBoundary:function(e){var t=this.createElementNSPlus("ogc:LowerBoundary");return this.writeOgcExpression(e.lowerBoundary,t),t},UpperBoundary:function(e){var t=this.createElementNSPlus("ogc:UpperBoundary");return this.writeNode("Literal",e.upperBoundary,t),t},INTERSECTS:function(e){return this.writeSpatial(e,"Intersects")},WITHIN:function(e){return this.writeSpatial(e,"Within")},CONTAINS:function(e){return this.writeSpatial(e,"Contains")},DWITHIN:function(e){var t=this.writeSpatial(e,"DWithin");return this.writeNode("Distance",e,t),t},Distance:function(e){return this.createElementNSPlus("ogc:Distance",{attributes:{units:e.distanceUnits},value:e.distance})},Function:function(e){for(var t=this.createElementNSPlus("ogc:Function",{attributes:{name:e.name}}),o=e.params,r=0,i=o.length;r<i;r++)this.writeOgcExpression(o[r],t);return t},PropertyIsNull:function(e){var t=this.createElementNSPlus("ogc:PropertyIsNull");return this.writeNode("PropertyName",e,t),t},SortBy:function(e){for(var t=this.createElementNSPlus("ogc:SortBy"),o=0,r=e.length;o<r;o++)this.writeNode("ogc:SortProperty",e[o],t);return t},SortProperty:function(e){var t=this.createElementNSPlus("ogc:SortProperty");return this.writeNode("ogc:PropertyName",e,t),this.writeNode("ogc:SortOrder","DESC"==e.order?"DESC":"ASC",t),t},SortOrder:function(e){return this.createElementNSPlus("ogc:SortOrder",{value:e})}}},getFilterType:function(e){var t=this.filterMap[e.type];if(!t)throw"Filter writing not supported for rule type: "+e.type;return t},filterMap:{"&&":"And","||":"Or","!":"Not","==":"PropertyIsEqualTo","!=":"PropertyIsNotEqualTo","<":"PropertyIsLessThan",">":"PropertyIsGreaterThan","<=":"PropertyIsLessThanOrEqualTo",">=":"PropertyIsGreaterThanOrEqualTo","..":"PropertyIsBetween","~":"PropertyIsLike",NULL:"PropertyIsNull",BBOX:"BBOX",DWITHIN:"DWITHIN",WITHIN:"WITHIN",CONTAINS:"CONTAINS",INTERSECTS:"INTERSECTS",FID:"_featureIds"},CLASS_NAME:"GeoGlobe.Format.Filter.v1"}),GeoGlobe.Format.Filter.v1_0_0=GeoGlobe.Class4OL(GeoGlobe.Format.GML.v2,GeoGlobe.Format.Filter.v1,{VERSION:"1.0.0",schemaLocation:"http://www.opengis.net/ogc/filter/1.0.0/filter.xsd",initialize:function(e){GeoGlobe.Format.GML.v2.prototype.initialize.apply(this,[e])},readers:{ogc:GeoGlobe.Util.applyDefaults({PropertyIsEqualTo:function(e,t){var o=new GeoGlobe.Filter.Comparison({type:GeoGlobe.Filter.Comparison.EQUAL_TO});this.readChildNodes(e,o),t.filters.push(o)},PropertyIsNotEqualTo:function(e,t){var o=new GeoGlobe.Filter.Comparison({type:GeoGlobe.Filter.Comparison.NOT_EQUAL_TO});this.readChildNodes(e,o),t.filters.push(o)},PropertyIsLike:function(e,t){var o=new GeoGlobe.Filter.Comparison({type:GeoGlobe.Filter.Comparison.LIKE});this.readChildNodes(e,o);var r=e.getAttribute("wildCard"),i=e.getAttribute("singleChar"),n=e.getAttribute("escape");o.value2regex(r,i,n),t.filters.push(o)}},GeoGlobe.Format.Filter.v1.prototype.readers.ogc),gml:GeoGlobe.Format.GML.v2.prototype.readers.gml,feature:GeoGlobe.Format.GML.v2.prototype.readers.feature},writers:{ogc:GeoGlobe.Util.applyDefaults({PropertyIsEqualTo:function(e){var t=this.createElementNSPlus("ogc:PropertyIsEqualTo");return this.writeNode("PropertyName",e,t),this.writeOgcExpression(e.value,t),t},PropertyIsNotEqualTo:function(e){var t=this.createElementNSPlus("ogc:PropertyIsNotEqualTo");return this.writeNode("PropertyName",e,t),this.writeOgcExpression(e.value,t),t},PropertyIsLike:function(e){var t=this.createElementNSPlus("ogc:PropertyIsLike",{attributes:{wildCard:"*",singleChar:".",escape:"!"}});return this.writeNode("PropertyName",e,t),this.writeNode("Literal",e.regex2value(),t),t},BBOX:function(e){var t=this.createElementNSPlus("ogc:BBOX");e.property&&this.writeNode("PropertyName",e,t);var o=this.writeNode("gml:Box",e.value,t);return e.projection&&o.setAttribute("srsName",e.projection),t}},GeoGlobe.Format.Filter.v1.prototype.writers.ogc),gml:GeoGlobe.Format.GML.v2.prototype.writers.gml,feature:GeoGlobe.Format.GML.v2.prototype.writers.feature},writeSpatial:function(e,t){var o,r=this.createElementNSPlus("ogc:"+t);(this.writeNode("PropertyName",e,r),e.value instanceof GeoGlobe.Filter.Function)?this.writeNode("Function",e.value,r):(o=e.value instanceof GeoGlobe.Geometry?this.writeNode("feature:_geometry",e.value).firstChild:this.writeNode("gml:Box",e.value),e.projection&&o.setAttribute("srsName",e.projection),r.appendChild(o));return r},CLASS_NAME:"GeoGlobe.Format.Filter.v1_0_0"}),GeoGlobe.Format.Filter.v1_1_0=GeoGlobe.Class4OL(GeoGlobe.Format.GML.v3,GeoGlobe.Format.Filter.v1,{VERSION:"1.1.0",schemaLocation:"http://www.opengis.net/ogc/filter/1.1.0/filter.xsd",initialize:function(e){GeoGlobe.Format.GML.v3.prototype.initialize.apply(this,[e])},readers:{ogc:GeoGlobe.Util.applyDefaults({PropertyIsEqualTo:function(e,t){var o=e.getAttribute("matchCase"),r=new GeoGlobe.Filter.Comparison({type:GeoGlobe.Filter.Comparison.EQUAL_TO,matchCase:!("false"===o||"0"===o)});this.readChildNodes(e,r),t.filters.push(r)},PropertyIsNotEqualTo:function(e,t){var o=e.getAttribute("matchCase"),r=new GeoGlobe.Filter.Comparison({type:GeoGlobe.Filter.Comparison.NOT_EQUAL_TO,matchCase:!("false"===o||"0"===o)});this.readChildNodes(e,r),t.filters.push(r)},PropertyIsLike:function(e,t){var o=new GeoGlobe.Filter.Comparison({type:GeoGlobe.Filter.Comparison.LIKE});this.readChildNodes(e,o);var r=e.getAttribute("wildCard"),i=e.getAttribute("singleChar"),n=e.getAttribute("escapeChar");o.value2regex(r,i,n),t.filters.push(o)}},GeoGlobe.Format.Filter.v1.prototype.readers.ogc),gml:GeoGlobe.Format.GML.v3.prototype.readers.gml,feature:GeoGlobe.Format.GML.v3.prototype.readers.feature},writers:{ogc:GeoGlobe.Util.applyDefaults({PropertyIsEqualTo:function(e){var t=this.createElementNSPlus("ogc:PropertyIsEqualTo",{attributes:{matchCase:e.matchCase}});return this.writeNode("PropertyName",e,t),this.writeOgcExpression(e.value,t),t},PropertyIsNotEqualTo:function(e){var t=this.createElementNSPlus("ogc:PropertyIsNotEqualTo",{attributes:{matchCase:e.matchCase}});return this.writeNode("PropertyName",e,t),this.writeOgcExpression(e.value,t),t},PropertyIsLike:function(e){var t=this.createElementNSPlus("ogc:PropertyIsLike",{attributes:{matchCase:e.matchCase,wildCard:"*",singleChar:".",escapeChar:"!"}});return this.writeNode("PropertyName",e,t),this.writeNode("Literal",e.regex2value(),t),t},BBOX:function(e){var t=this.createElementNSPlus("ogc:BBOX");e.property&&this.writeNode("PropertyName",e,t);var o=this.writeNode("gml:Envelope",e.value);return e.projection&&o.setAttribute("srsName",e.projection),t.appendChild(o),t},SortBy:function(e){for(var t=this.createElementNSPlus("ogc:SortBy"),o=0,r=e.length;o<r;o++)this.writeNode("ogc:SortProperty",e[o],t);return t},SortProperty:function(e){var t=this.createElementNSPlus("ogc:SortProperty");return this.writeNode("ogc:PropertyName",e,t),this.writeNode("ogc:SortOrder","DESC"==e.order?"DESC":"ASC",t),t},SortOrder:function(e){return this.createElementNSPlus("ogc:SortOrder",{value:e})}},GeoGlobe.Format.Filter.v1.prototype.writers.ogc),gml:GeoGlobe.Format.GML.v3.prototype.writers.gml,feature:GeoGlobe.Format.GML.v3.prototype.writers.feature},writeSpatial:function(e,t){var o,r=this.createElementNSPlus("ogc:"+t);(this.writeNode("PropertyName",e,r),e.value instanceof GeoGlobe.Filter.Function)?this.writeNode("Function",e.value,r):(o=e.value instanceof GeoGlobe.Geometry?this.writeNode("feature:_geometry",e.value).firstChild:this.writeNode("gml:Envelope",e.value),e.projection&&o.setAttribute("srsName",e.projection),r.appendChild(o));return r},CLASS_NAME:"GeoGlobe.Format.Filter.v1_1_0"}),GeoGlobe.Format.WFST=function(e){e=GeoGlobe.Util.applyDefaults(e,GeoGlobe.Format.WFST.DEFAULTS);var t=GeoGlobe.Format.WFST["v"+e.version.replace(/\./g,"_")];if(!t)throw"Unsupported WFST version: "+e.version;return new t(e)},GeoGlobe.Format.WFST.DEFAULTS={version:"1.0.0"},GeoGlobe.Format.WFST.v1=GeoGlobe.Class4OL(GeoGlobe.Format.XML,{namespaces:{xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance",wfs:"http://www.opengis.net/wfs",gml:"http://www.opengis.net/gml",ogc:"http://www.opengis.net/ogc",ows:"http://www.opengis.net/ows"},defaultPrefix:"wfs",version:null,schemaLocations:null,srsName:null,extractAttributes:!0,xy:!0,stateName:null,initialize:function(e){this.stateName={},this.stateName[GeoGlobe.State.INSERT]="wfs:Insert",this.stateName[GeoGlobe.State.UPDATE]="wfs:Update",this.stateName[GeoGlobe.State.DELETE]="wfs:Delete",GeoGlobe.Format.XML.prototype.initialize.apply(this,[e])},getSrsName:function(e,t){var o=t&&t.srsName;return o||(o=e&&e.layer?e.layer.projection.getCode():this.srsName),o},read:function(e,t){t=t||{},GeoGlobe.Util.applyDefaults(t,{output:"features"}),"string"==typeof e&&(e=GeoGlobe.Format.XML.prototype.read.apply(this,[e])),e&&9==e.nodeType&&(e=e.documentElement);var o={};return e&&this.readNode(e,o,!0),o.features&&"features"===t.output&&(o=o.features),o},readers:{wfs:{FeatureCollection:function(e,t){t.features=[],this.readChildNodes(e,t)}}},write:function(e,t){var o=this.writeNode("wfs:Transaction",{features:e,options:t}),r=this.schemaLocationAttr();return r&&this.setAttributeNS(o,this.namespaces.xsi,"xsi:schemaLocation",r),GeoGlobe.Format.XML.prototype.write.apply(this,[o])},writers:{wfs:{GetFeature:function(e){var t=this.createElementNSPlus("wfs:GetFeature",{attributes:{service:"WFS",version:this.version,outputFormat:e&&e.outputFormat,maxFeatures:e&&e.maxFeatures,resultType:e&&e.resultType,startPosition:e&&e.startPosition,"xsi:schemaLocation":this.schemaLocationAttr(e)}});if("string"==typeof this.featureType)this.writeNode("Query",e,t);else for(var o=0,r=this.featureType.length;o<r;o++)e.featureType=this.featureType[o],this.writeNode("Query",e,t);return t},Transaction:function(e){var t,o,r=(e=e||{}).options||{},i=this.createElementNSPlus("wfs:Transaction",{attributes:{service:"WFS",version:this.version,handle:r.handle}}),n=e.features;if(n){var s,a;for(!0===r.multi&&GeoGlobe.Util.extend(this.geometryTypes,{"GeoGlobe.Geometry.Point":"MultiPoint","GeoGlobe.Geometry.LineString":!0===this.multiCurve?"MultiCurve":"MultiLineString","GeoGlobe.Geometry.Polygon":!0===this.multiSurface?"MultiSurface":"MultiPolygon"}),t=0,o=n.length;t<o;++t)a=n[t],(s=this.stateName[a.state])&&this.writeNode(s,{feature:a,options:r},i);!0===r.multi&&this.setGeometryTypes()}if(r.nativeElements)for(t=0,o=r.nativeElements.length;t<o;++t)this.writeNode("wfs:Native",r.nativeElements[t],i);return i},Native:function(e){return this.createElementNSPlus("wfs:Native",{attributes:{vendorId:e.vendorId,safeToIgnore:e.safeToIgnore},value:e.value})},Insert:function(e){var t=e.feature,o=e.options,r=this.createElementNSPlus("wfs:Insert",{attributes:{handle:o&&o.handle}});return this.srsName=this.getSrsName(t),this.writeNode("feature:_typeName",t,r),r},Update:function(e){var t=e.feature,o=e.options,r=this.createElementNSPlus("wfs:Update",{attributes:{handle:o&&o.handle,typeName:(this.featureNS?this.featurePrefix+":":"")+this.featureType}});this.featureNS&&r.setAttribute("xmlns:"+this.featurePrefix,this.featureNS);var i=t.modified;null===this.geometryName||i&&void 0===i.geometry||(this.srsName=this.getSrsName(t),this.writeNode("Property",{name:this.geometryName,value:t.geometry},r));for(var n in t.attributes)void 0===t.attributes[n]||i&&i.attributes&&(!i.attributes||void 0===i.attributes[n])||this.writeNode("Property",{name:n,value:t.attributes[n]},r);return this.writeNode("ogc:Filter",new GeoGlobe.Filter.FeatureId({fids:[t.fid]}),r),r},Property:function(e){var t=this.createElementNSPlus("wfs:Property");return this.writeNode("Name",e.name,t),null!==e.value&&this.writeNode("Value",e.value,t),t},Name:function(e){return this.createElementNSPlus("wfs:Name",{value:e})},Value:function(e){var t;if(e instanceof GeoGlobe.Geometry){t=this.createElementNSPlus("wfs:Value");var o=this.writeNode("feature:_geometry",e).firstChild;t.appendChild(o)}else t=this.createElementNSPlus("wfs:Value",{value:e});return t},Delete:function(e){var t=e.feature,o=e.options,r=this.createElementNSPlus("wfs:Delete",{attributes:{handle:o&&o.handle,typeName:(this.featureNS?this.featurePrefix+":":"")+this.featureType}});return this.featureNS&&r.setAttribute("xmlns:"+this.featurePrefix,this.featureNS),this.writeNode("ogc:Filter",new GeoGlobe.Filter.FeatureId({fids:[t.fid]}),r),r}}},schemaLocationAttr:function(e){e=GeoGlobe.Util.extend({featurePrefix:this.featurePrefix,schema:this.schema},e);var t=GeoGlobe.Util.extend({},this.schemaLocations);e.schema&&(t[e.featurePrefix]=e.schema);var o,r=[];for(var i in t)(o=this.namespaces[i])&&r.push(o+" "+t[i]);return r.join(" ")||void 0},setFilterProperty:function(e){if(e.filters)for(var t=0,o=e.filters.length;t<o;++t)GeoGlobe.Format.WFST.v1.prototype.setFilterProperty.call(this,e.filters[t]);else e instanceof GeoGlobe.Filter.Spatial&&!e.property&&(e.property=this.geometryName)},CLASS_NAME:"GeoGlobe.Format.WFST.v1"}),GeoGlobe.Format.WFST.v1_0_0=GeoGlobe.Class4OL(GeoGlobe.Format.Filter.v1_0_0,GeoGlobe.Format.WFST.v1,{version:"1.0.0",srsNameInQuery:!1,schemaLocations:{wfs:"http://schemas.opengis.net/wfs/1.0.0/WFS-transaction.xsd"},initialize:function(e){GeoGlobe.Format.Filter.v1_0_0.prototype.initialize.apply(this,[e]),GeoGlobe.Format.WFST.v1.prototype.initialize.apply(this,[e])},readNode:function(e,t,o){return GeoGlobe.Format.GML.v2.prototype.readNode.apply(this,arguments)},readers:{wfs:GeoGlobe.Util.applyDefaults({WFS_TransactionResponse:function(e,t){t.insertIds=[],t.success=!1,this.readChildNodes(e,t)},InsertResult:function(e,t){var o={fids:[]};this.readChildNodes(e,o),t.insertIds=t.insertIds.concat(o.fids)},TransactionResult:function(e,t){this.readChildNodes(e,t)},Status:function(e,t){this.readChildNodes(e,t)},SUCCESS:function(e,t){t.success=!0}},GeoGlobe.Format.WFST.v1.prototype.readers.wfs),gml:GeoGlobe.Format.GML.v2.prototype.readers.gml,feature:GeoGlobe.Format.GML.v2.prototype.readers.feature,ogc:GeoGlobe.Format.Filter.v1_0_0.prototype.readers.ogc},writers:{wfs:GeoGlobe.Util.applyDefaults({Query:function(e){var t=(e=GeoGlobe.Util.extend({featureNS:this.featureNS,featurePrefix:this.featurePrefix,featureType:this.featureType,srsName:this.srsName,srsNameInQuery:this.srsNameInQuery},e)).featurePrefix,o=this.createElementNSPlus("wfs:Query",{attributes:{typeName:(e.featureNS?t+":":"")+e.featureType,time:e&&e.time,userecent:e&&e.userecent}});if(e.srsNameInQuery&&e.srsName&&o.setAttribute("srsName",e.srsName),e.featureNS&&o.setAttribute("xmlns:"+t,e.featureNS),e.propertyNames)for(var r=0,i=e.propertyNames.length;r<i;r++)this.writeNode("ogc:PropertyName",{property:e.propertyNames[r]},o);return e.filter&&(this.setFilterProperty(e.filter),this.writeNode("ogc:Filter",e.filter,o)),e.sortBy&&this.writeNode("ogc:SortBy",e.sortBy,o),e.groupBy&&this.writeNode("ogc:GroupBy",e.groupBy,o),o}},GeoGlobe.Format.WFST.v1.prototype.writers.wfs),gml:GeoGlobe.Format.GML.v2.prototype.writers.gml,feature:GeoGlobe.Format.GML.v2.prototype.writers.feature,ogc:GeoGlobe.Format.Filter.v1_0_0.prototype.writers.ogc},CLASS_NAME:"GeoGlobe.Format.WFST.v1_0_0"}),GeoGlobe.Format.WFST.v1_1_0=GeoGlobe.Class4OL(GeoGlobe.Format.Filter.v1_1_0,GeoGlobe.Format.WFST.v1,{version:"1.1.0",schemaLocations:{wfs:"http://schemas.opengis.net/wfs/1.1.0/wfs.xsd"},initialize:function(e){GeoGlobe.Format.Filter.v1_1_0.prototype.initialize.apply(this,[e]),GeoGlobe.Format.WFST.v1.prototype.initialize.apply(this,[e])},readNode:function(e,t,o){return GeoGlobe.Format.GML.v3.prototype.readNode.apply(this,arguments)},readers:{wfs:GeoGlobe.Util.applyDefaults({FeatureCollection:function(e,t){t.numberOfFeatures=parseInt(e.getAttribute("numberOfFeatures")),GeoGlobe.Format.WFST.v1.prototype.readers.wfs.FeatureCollection.apply(this,arguments)},TransactionResponse:function(e,t){t.insertIds=[],t.success=!1,this.readChildNodes(e,t)},TransactionSummary:function(e,t){t.success=!0},InsertResults:function(e,t){this.readChildNodes(e,t)},Feature:function(e,t){var o={fids:[]};this.readChildNodes(e,o),t.insertIds.push(o.fids[0])}},GeoGlobe.Format.WFST.v1.prototype.readers.wfs),gml:GeoGlobe.Format.GML.v3.prototype.readers.gml,feature:GeoGlobe.Format.GML.v3.prototype.readers.feature,ogc:GeoGlobe.Format.Filter.v1_1_0.prototype.readers.ogc,ows:GeoGlobe.Format.OWSCommon.v1_0_0.prototype.readers.ows},writers:{wfs:GeoGlobe.Util.applyDefaults({GetFeature:function(e){var t=GeoGlobe.Format.WFST.v1.prototype.writers.wfs.GetFeature.apply(this,arguments);return e&&this.setAttributes(t,{resultType:e.resultType,startIndex:e.startIndex,count:e.count}),t},Query:function(e){var t=(e=GeoGlobe.Util.extend({featureNS:this.featureNS,featurePrefix:this.featurePrefix,featureType:this.featureType,srsName:this.srsName},e)).featurePrefix,o=this.createElementNSPlus("wfs:Query",{attributes:{typeName:(e.featureNS?t+":":"")+e.featureType,srsName:e.srsName,time:e&&e.time,userecent:e&&e.userecent}});if(e.featureNS&&o.setAttribute("xmlns:"+t,e.featureNS),e.propertyNames)for(var r=0,i=e.propertyNames.length;r<i;r++)this.writeNode("wfs:PropertyName",{property:e.propertyNames[r]},o);return e.filter&&(GeoGlobe.Format.WFST.v1_1_0.prototype.setFilterProperty.call(this,e.filter),this.writeNode("ogc:Filter",e.filter,o)),e.sortBy&&this.writeNode("ogc:SortBy",e.sortBy,o),e.groupBy&&this.writeNode("ogc:GroupBy",e.groupBy,o),o},PropertyName:function(e){return this.createElementNSPlus("wfs:PropertyName",{value:e.property})}},GeoGlobe.Format.WFST.v1.prototype.writers.wfs),gml:GeoGlobe.Format.GML.v3.prototype.writers.gml,feature:GeoGlobe.Format.GML.v3.prototype.writers.feature,ogc:GeoGlobe.Format.Filter.v1_1_0.prototype.writers.ogc},CLASS_NAME:"GeoGlobe.Format.WFST.v1_1_0"}),GeoGlobe.Format.JSON=GeoGlobe.Class4OL(GeoGlobe.Format,{indent:"    ",space:" ",newline:"\n",level:0,pretty:!1,nativeJSON:!(!window.JSON||"function"!=typeof JSON.parse||"function"!=typeof JSON.stringify),read:function(json,filter){var object;if(this.nativeJSON)object=JSON.parse(json,filter);else try{if(/^[\],:{}\s]*$/.test(json.replace(/\\["\\\/bfnrtu]/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))&&(object=eval("("+json+")"),"function"==typeof filter)){function walk(e,t){if(t&&"object"==typeof t)for(var o in t)t.hasOwnProperty(o)&&(t[o]=walk(o,t[o]));return filter(e,t)}object=walk("",object)}}catch(e){}return this.keepData&&(this.data=object),object},write:function(e,t){this.pretty=!!t;var o=null,r=typeof e;if(this.serialize[r])try{o=!this.pretty&&this.nativeJSON?JSON.stringify(e):this.serialize[r].apply(this,[e])}catch(e){GeoGlobe.Console.error("Trouble serializing: "+e)}return o},writeIndent:function(){var e=[];if(this.pretty)for(var t=0;t<this.level;++t)e.push(this.indent);return e.join("")},writeNewline:function(){return this.pretty?this.newline:""},writeSpace:function(){return this.pretty?this.space:""},serialize:{object:function(e){if(null==e)return"null";if(e.constructor==Date)return this.serialize.date.apply(this,[e]);if(e.constructor==Array)return this.serialize.array.apply(this,[e]);var t,o,r,i=["{"];this.level+=1;var n=!1;for(t in e)e.hasOwnProperty(t)&&(o=GeoGlobe.Format.JSON.prototype.write.apply(this,[t,this.pretty]),r=GeoGlobe.Format.JSON.prototype.write.apply(this,[e[t],this.pretty]),null!=o&&null!=r&&(n&&i.push(","),i.push(this.writeNewline(),this.writeIndent(),o,":",this.writeSpace(),r),n=!0));return this.level-=1,i.push(this.writeNewline(),this.writeIndent(),"}"),i.join("")},array:function(e){var t,o=["["];this.level+=1;for(var r=0,i=e.length;r<i;++r)null!=(t=GeoGlobe.Format.JSON.prototype.write.apply(this,[e[r],this.pretty]))&&(r>0&&o.push(","),o.push(this.writeNewline(),this.writeIndent(),t));return this.level-=1,o.push(this.writeNewline(),this.writeIndent(),"]"),o.join("")},string:function(e){var t={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return/["\\\x00-\x1f]/.test(e)?'"'+e.replace(/([\x00-\x1f\\"])/g,function(e,o){var r=t[o];return r||(r=o.charCodeAt(),"\\u00"+Math.floor(r/16).toString(16)+(r%16).toString(16))})+'"':'"'+e+'"'},number:function(e){return isFinite(e)?String(e):"null"},boolean:function(e){return String(e)},date:function(e){function t(e){return e<10?"0"+e:e}return'"'+e.getFullYear()+"-"+t(e.getMonth()+1)+"-"+t(e.getDate())+"T"+t(e.getHours())+":"+t(e.getMinutes())+":"+t(e.getSeconds())+'"'}},CLASS_NAME:"GeoGlobe.Format.JSON"}),GeoGlobe.Format.GeoJSON=GeoGlobe.Class4OL(GeoGlobe.Format.JSON,{ignoreExtraDims:!1,read:function(e,t,o){t=t||"FeatureCollection";var r=null,i=null;if(i="string"==typeof e?GeoGlobe.Format.JSON.prototype.read.apply(this,[e,o]):e){if("string"!=typeof i.type)GeoGlobe.Console.error("Bad GeoJSON - no type: "+e);else if(this.isValidType(i,t))switch(t){case"Geometry":try{r=this.parseGeometry(i)}catch(e){GeoGlobe.Console.error(e)}break;case"Feature":try{(r=this.parseFeature(i)).type="Feature"}catch(e){GeoGlobe.Console.error(e)}break;case"FeatureCollection":switch(r=[],i.type){case"Feature":try{r.push(this.parseFeature(i))}catch(e){r=null,GeoGlobe.Console.error(e)}break;case"FeatureCollection":for(var n=0,s=i.features.length;n<s;++n)try{r.push(this.parseFeature(i.features[n]))}catch(e){r=null,GeoGlobe.Console.error(e)}break;default:try{var a=this.parseGeometry(i);r.push(new GeoGlobe.Feature(a))}catch(e){r=null,GeoGlobe.Console.error(e)}}}}else GeoGlobe.Console.error("Bad JSON: "+e);return r},isValidType:function(e,t){var o=!1;switch(t){case"Geometry":-1==GeoGlobe.Util.indexOf(["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon","Box","GeometryCollection"],e.type)?GeoGlobe.Console.error("Unsupported geometry type: "+e.type):o=!0;break;case"FeatureCollection":o=!0;break;default:e.type==t?o=!0:GeoGlobe.Console.error("Cannot convert types from "+e.type+" to "+t)}return o},parseFeature:function(e){var t,o,r,i;r=e.properties?e.properties:{},i=e.geometry&&e.geometry.bbox||e.bbox;try{o=this.parseGeometry(e.geometry)}catch(e){throw e}return t=new GeoGlobe.Feature(o,r),i&&(t.bounds=GeoGlobe.LngLatBounds.fromArray(i)),e.id&&(t.fid=e.id),t},parseGeometry:function(e){if(null==e)return null;var t,o=!1;if("GeometryCollection"==e.type){if(!GeoGlobe.Util.isArray(e.geometries))throw"GeometryCollection must have geometries array: "+e;for(var r=e.geometries.length,i=new Array(r),n=0;n<r;++n)i[n]=this.parseGeometry.apply(this,[e.geometries[n]]);t=new GeoGlobe.Geometry.Collection(i),o=!0}else{if(!GeoGlobe.Util.isArray(e.coordinates))throw"Geometry must have coordinates array: "+e;if(!this.parseCoords[e.type.toLowerCase()])throw"Unsupported geometry type: "+e.type;try{t=this.parseCoords[e.type.toLowerCase()].apply(this,[e.coordinates])}catch(e){throw e}}return this.internalProjection&&this.externalProjection&&!o&&t.transform(this.externalProjection,this.internalProjection),t},parseCoords:{point:function(e){if(0==this.ignoreExtraDims&&2!=e.length)throw"Only 2D points are supported: "+e;return new GeoGlobe.Geometry.Point(e[0],e[1])},multipoint:function(e){for(var t=[],o=null,r=0,i=e.length;r<i;++r){try{o=this.parseCoords.point.apply(this,[e[r]])}catch(e){throw e}t.push(o)}return new GeoGlobe.Geometry.MultiPoint(t)},linestring:function(e){for(var t=[],o=null,r=0,i=e.length;r<i;++r){try{o=this.parseCoords.point.apply(this,[e[r]])}catch(e){throw e}t.push(o)}return new GeoGlobe.Geometry.LineString(t)},multilinestring:function(e){for(var t=[],o=null,r=0,i=e.length;r<i;++r){try{o=this.parseCoords.linestring.apply(this,[e[r]])}catch(e){throw e}t.push(o)}return new GeoGlobe.Geometry.MultiLineString(t)},polygon:function(e){for(var t,o,r=[],i=0,n=e.length;i<n;++i){try{o=this.parseCoords.linestring.apply(this,[e[i]])}catch(e){throw e}t=new GeoGlobe.Geometry.LinearRing(o.components),r.push(t)}return new GeoGlobe.Geometry.Polygon(r)},multipolygon:function(e){for(var t=[],o=null,r=0,i=e.length;r<i;++r){try{o=this.parseCoords.polygon.apply(this,[e[r]])}catch(e){throw e}t.push(o)}return new GeoGlobe.Geometry.MultiPolygon(t)},box:function(e){if(2!=e.length)throw"GeoJSON box coordinates must have 2 elements";return new GeoGlobe.Geometry.Polygon([new GeoGlobe.Geometry.LinearRing([new GeoGlobe.Geometry.Point(e[0][0],e[0][1]),new GeoGlobe.Geometry.Point(e[1][0],e[0][1]),new GeoGlobe.Geometry.Point(e[1][0],e[1][1]),new GeoGlobe.Geometry.Point(e[0][0],e[1][1]),new GeoGlobe.Geometry.Point(e[0][0],e[0][1])])])}},write:function(e,t){var o={type:null};if(GeoGlobe.Util.isArray(e)){o.type="FeatureCollection";var r=e.length;o.features=new Array(r);for(var i=0;i<r;++i){var n=e[i];if(!n instanceof GeoGlobe.Feature)throw"FeatureCollection only supports collections of features: "+n;o.features[i]=this.extract.feature.apply(this,[n])}}else 0==e.CLASS_NAME.indexOf("GeoGlobe.Geometry")?o=this.extract.geometry.apply(this,[e]):e instanceof GeoGlobe.Feature&&(o=this.extract.feature.apply(this,[e]),e.layer&&e.layer.projection&&(o.crs=this.createCRSObject(e)));return GeoGlobe.Format.JSON.prototype.write.apply(this,[o,t])},createCRSObject:function(e){var t=e.layer.projection.toString(),o={};if(t.match(/epsg:/i)){var r=parseInt(t.substring(t.indexOf(":")+1));o=4326==r?{type:"name",properties:{name:"urn:ogc:def:crs:OGC:1.3:CRS84"}}:{type:"name",properties:{name:"EPSG:"+r}}}return o},extract:{feature:function(e){var t=this.extract.geometry.apply(this,[e.geometry]),o={type:"Feature",properties:e.attributes,geometry:t};return null!=e.fid&&(o.id=e.fid),o},geometry:function(e){if(null==e)return null;this.internalProjection&&this.externalProjection&&(e=e.clone()).transform(this.internalProjection,this.externalProjection);var t=e.CLASS_NAME.split(".")[2],o=this.extract[t.toLowerCase()].apply(this,[e]);return"Collection"==t?{type:"GeometryCollection",geometries:o}:{type:t,coordinates:o}},point:function(e){return[e.x,e.y]},multipoint:function(e){for(var t=[],o=0,r=e.components.length;o<r;++o)t.push(this.extract.point.apply(this,[e.components[o]]));return t},linestring:function(e){for(var t=[],o=0,r=e.components.length;o<r;++o)t.push(this.extract.point.apply(this,[e.components[o]]));return t},multilinestring:function(e){for(var t=[],o=0,r=e.components.length;o<r;++o)t.push(this.extract.linestring.apply(this,[e.components[o]]));return t},polygon:function(e){for(var t=[],o=0,r=e.components.length;o<r;++o)t.push(this.extract.linestring.apply(this,[e.components[o]]));return t},multipolygon:function(e){for(var t=[],o=0,r=e.components.length;o<r;++o)t.push(this.extract.polygon.apply(this,[e.components[o]]));return t},collection:function(e){for(var t=e.components.length,o=new Array(t),r=0;r<t;++r)o[r]=this.extract.geometry.apply(this,[e.components[r]]);return o}},CLASS_NAME:"GeoGlobe.Format.GeoJSON"}),GeoGlobe.Format.WMTS=GeoGlobe.Class4OL({initialize:function(e){GeoGlobe.Util.extend(this,e)},getWMTSCapabilities:function(e){var t=null;return this.getCapabilities(e,function(e){var o=e.responseXML;o&&o.documentElement||(o=e.responseText);var r=new GeoGlobe.Format.WMTSCapabilities.v1_0_0;t=r.read(o)},function(){alert("WMTS服务请求失败，请检查服务是否正常运行或请求地址是否正确。\n请求地址："+e+"\n操作类型：GetCapabilities")}),t},getCapabilities:function(e,t,o){"function"!=typeof o&&(o=function(){alert("WMTS服务请求失败，请检查服务是否正常运行或请求地址是否正确。\n请求地址："+e+"\n操作类型：GetCapabilities")}),GeoGlobe.Request.GET({url:e,params:{REQUEST:"GetCapabilities",SERVICE:"WMTS"},scope:this,async:!1,success:function(e){"function"==typeof t&&t(e)},failure:o})},createLayerOption:function(e,t,o){if(!("layer"in o))throw new Error("Missing property 'layer' in configuration.");for(var r,i=t.contents,n=(i.layers,0),s=i.layers.length;n<s;++n)if(i.layers[n].identifier===o.layer){r=i.layers[n];break}if(!r)throw new Error("Layer not found");var a,l,u=o.format;if(!u&&r.formats&&r.formats.length&&(u=r.formats[0]),o.matrixSet)a=i.tileMatrixSets[o.matrixSet];else if(o.projection){n=0;for(var c=r.tileMatrixSetLinks.length;n<c;n++)if(i.tileMatrixSets[r.tileMatrixSetLinks[n].tileMatrixSet].supportedCRS.replace(/urn:ogc:def:crs:(\w+):(.*:)?(\w+)$/,"$1:$3")===o.projection){a=i.tileMatrixSets[r.tileMatrixSetLinks[n].tileMatrixSet];break}}else r.tileMatrixSetLinks.length>=1&&(a=i.tileMatrixSets[r.tileMatrixSetLinks[0].tileMatrixSet]);if(!a)throw new Error("matrixSet not found");for(n=0,s=r.styles.length;n<s&&!(l=r.styles[n]).isDefault;++n);var p=o.requestEncoding;p||(p="KVP",t.operationsMetadata.GetTile.dcp.http);var h=[],f=o.params||{};delete o.params;for(var d=0,G=r.dimensions.length;d<G;d++){var m=r.dimensions[d];h.push(m.identifier),f.hasOwnProperty(m.identifier)||(f[m.identifier]=m.default)}var g,y,b,S=o.projection||a.supportedCRS.replace(/urn:ogc:def:crs:(\w+):(.*:)?(\w+)$/,"$1:$3"),v=o.units||("EPSG:4326"===S?"degrees":"m"),N=[],w=[],C=r.tileMatrixSetLinks,E=function(e){N.push(28e-5*e/GeoGlobe.METERS_PER_INCH/GeoGlobe.INCHES_PER_UNIT[v]),(!g||g>e)&&(g=e),(!y||y<e)&&(y=e)},T=0;for(c=C.length;T<c;T++)if((b=C[T]).tileMatrixSet===a.identifier){if(b.tileMatrixSetLimits){for(var x,L={},_=0,P=a.matrixIds.length;_<P;_++)L[a.matrixIds[_].identifier]=a.matrixIds[_];for(_=0,P=b.tileMatrixSetLimits.length;_<P;_++)x=L[b.tileMatrixSetLimits[_].tileMatrix],w.push(x),E(x.scaleDenominator)}else for(_=0,P=a.matrixIds.length;_<P;_++)E(a.matrixIds[_].scaleDenominator);break}N.sort(function(e,t){return t-e});var F="",R=this.getParameterString({SERVICE:"WMTS",REQUEST:"GetTile",VERSION:t.version,LAYER:r.identifier,STYLE:l.identifier,TILEMATRIXSET:a.identifier,FORMAT:u,TILEMATRIX:"{z}",TILEROW:"{y}",TILECOL:"{x}"});F=e.endsWith("?")?GeoGlobe.ProxyHost+e+R:GeoGlobe.ProxyHost+e+"?"+R;var A=GeoGlobe.Util.randomStr(10);if(r.bounds)var M=[r.bounds._sw.lng,r.bounds._sw.lat,r.bounds._ne.lng,r.bounds._ne.lat];else if(r.BoundingBox)M=r.BoundingBox[0].bounds.toBBOX();var I=r.tileMatrixSetLinks[0].tileMatrixSet,O=i.tileMatrixSets[I].matrixIds[0].identifier,U={name:r.identifier,srs:S,bbox:M,format:r.formats,zoomoffset:O};return{id:"layer_"+r.identifier+"_"+A,type:"raster",source:{type:"raster",tiles:[F],tileSize:256},metadata:U,paint:{"raster-opacity":1}}},createLayer:function(e,t){var o=this.getWMTSCapabilities(e);if(t)var r={layer:t.layer};else r={layer:o.contents.layers[0].identifier};return this.createLayerOption(e,o,r)},createLayers:function(e){for(var t=this.getWMTSCapabilities(e),o=t.contents.layers,r=[],i=0;i<o.length;i++){var n={layer:o[i].identifier},s=this.createLayerOption(e,t,n);r.push(s)}return r},getParameterString:function(e){var t=[];for(var o in e){var r=e[o];null!=r&&"function"!=typeof r&&t.push(o+"="+r)}return t.join("&")},CLASS_NAME:"GeoGlobe.Format.WMTS"}),GeoGlobe.Format.WMS=GeoGlobe.Class4OL({initialize:function(e){GeoGlobe.Util.extend(this,e)},getWMSCapabilities:function(e){var t=null;return this.getCapabilities(e,function(e){var o=e.responseXML;o&&o.documentElement||(o=e.responseText);var r=new GeoGlobe.Format.WMSCapabilities.v1_1_1;t=r.read(o)},function(){alert("WMS服务请求失败，请检查服务是否正常运行或请求地址是否正确。\n请求地址："+e+"\n操作类型：GetCapabilities")}),t},getCapabilities:function(e,t,o){"function"!=typeof o&&(o=function(){alert("WMS服务请求失败，请检查服务是否正常运行或请求地址是否正确。\n请求地址："+e+"\n操作类型：GetCapabilities")}),GeoGlobe.Request.GET({url:e,params:{REQUEST:"GetCapabilities",SERVICE:"WMS",VERSION:"1.1.1"},scope:this,async:!1,success:function(e){"function"==typeof t&&t(e)},failure:o})},createLayerOption:function(url,capabilities,config){var layer;if(!("layer"in config))throw new Error("Missing property 'layer' in configuration.");for(var contents=capabilities.capability,layers=contents.layers,layerDef,i=0,ii=contents.layers.length;i<ii;++i)if(contents.layers[i].name===config.layer){layerDef=contents.layers[i];break}if(!layerDef)throw new Error("Layer not found");var format=config.format;if(!format&&layerDef.formats&&layerDef.formats.length){for(var f=0;f<layerDef.formats.length;f++)"image/png"==layerDef.formats[f]&&(format=layerDef.formats[f]);"image/png"!=format&&(format=layerDef.formats[0])}var styles=config.styles;!styles&&layerDef.styles&&layerDef.styles.length&&(styles=layerDef.styles[0].name);var srs=eval(layerDef.srs),SRS;for(var o in srs)SRS=o;var wms_url="",transparent=config.transparent;if(config.isTile){var param=this.getParameterString({SERVICE:"WMS",REQUEST:"GetMap",VERSION:"1.1.1",LAYERS:layerDef.name,styles:styles,FORMAT:format,TRANSPARENT:transparent,BBOX:"{bbox-epsg-3857}",WIDTH:"256",HEIGHT:"256",SRS:SRS});wms_url=url.endsWith("?")?url+param:url+"?"+param,wms_url=GeoGlobe.appendToProxy(wms_url);var randomNum=GeoGlobe.Util.randomStr(10),metadata={name:layerDef.name,srs:SRS,bbox:layerDef.bbox,format:format},layerOption={id:"layer_"+layerDef.name+"_"+randomNum,type:"raster",source:{type:"raster",tiles:[wms_url],tileSize:256},metadata:metadata,paint:{"raster-opacity":1}};return layerOption}return layerOption=new GeoGlobe.Layer.WMS({url:url,layer:layerDef.name,format:format,version:"1.1.1",SRS:SRS,styles:styles,bbox:layerDef.bbox,isTile:!1}),layerOption},createLayer:function(e,t,o){this.url=e,o=!(void 0!==o&&!o);var r=!!(t&&void 0===t.transparent||t.transparent),i=this.getWMSCapabilities(e),n={layer:t&&t.layer?t.layer:i.capability.layers[0].name,transparent:r,isTile:o};return this.createLayerOption(e,i,n)},createLayers:function(e,t,o){o=!(void 0!==o&&!o);for(var r=!!(t&&void 0===t.transparent||t.transparent),i=this.getWMSCapabilities(e),n=i.capability.layers,s=[],a=0;a<n.length;a++){var l={layer:n[a].name,transparent:r,isTile:o},u=this.createLayerOption(e,i,l);s.push(u)}return s},getParameterString:function(e){var t=[];for(var o in e){var r=e[o];null!=r&&"function"!=typeof r&&t.push(o+"="+r)}return t.join("&")},CLASS_NAME:"GeoGlobe.Format.WMS"}),GeoGlobe.Format.VTS=GeoGlobe.Class4OL({initialize:function(e){GeoGlobe.Util.extend(this,e)},getVTSCapabilities:function(e){this.url=e;var t=null;return this.getCapabilities(e,function(e){var o=e.responseXML;o&&o.documentElement||(o=e.responseText);var r=new GeoGlobe.Format.VTSCapabilities.v1_0_0;t=r.read(o)},function(){alert("VTS服务请求失败，请检查服务是否正常运行或请求地址是否正确。\n请求地址："+e+"\n操作类型：GetCapabilities")}),t},getCapabilities:function(e,t,o){"function"!=typeof o&&(o=function(){alert("VTS服务请求失败，请检查服务是否正常运行或请求地址是否正确。\n请求地址："+e+"\n操作类型：GetCapabilities")}),GeoGlobe.Request.GET({url:e,params:{REQUEST:"GetCapabilities",SERVICE:"WMTS"},scope:this,async:!1,success:function(e){"function"==typeof t&&t(e)},failure:o})},createLayerOption:function(e,t,o){if(!("layer"in o))throw new Error("Missing property 'layer' in configuration.");for(var r,i=t.contents,n=(i.layers,0),s=i.layers.length;n<s;++n)if(i.layers[n].identifier===o.layer){r=i.layers[n];break}if(!r)throw new Error("Layer not found");var a,l=o.format;if(!l&&r.formats&&r.formats.length&&(l=r.formats[0]),o.matrixSet)a=i.tileMatrixSets[o.matrixSet];else if(o.projection){n=0;for(var u=r.tileMatrixSetLinks.length;n<u;n++)if(i.tileMatrixSets[r.tileMatrixSetLinks[n].tileMatrixSet].supportedCRS.replace(/urn:ogc:def:crs:(\w+):(.*:)?(\w+)$/,"$1:$3")===o.projection){a=i.tileMatrixSets[r.tileMatrixSetLinks[n].tileMatrixSet];break}}else r.tileMatrixSetLinks.length>=1&&(a=i.tileMatrixSets[r.tileMatrixSetLinks[0].tileMatrixSet]);if(!a)throw new Error("matrixSet not found");var c=[];o.styleName&&""!=o.styleName?c[0]=o.styleName:this.GetStyleName(function(e){c=e});var p=o.requestEncoding;p||(p="KVP",t.operationsMetadata.GetTile.dcp.http);var h=[],f=o.params||{};delete o.params;for(var d=0,G=r.dimensions.length;d<G;d++){var m=r.dimensions[d];h.push(m.identifier),f.hasOwnProperty(m.identifier)||(f[m.identifier]=m.default)}var g,y,b,S=o.projection||a.supportedCRS.replace(/urn:ogc:def:crs:(\w+):(.*:)?(\w+)$/,"$1:$3"),v=o.units||("EPSG:4326"===S?"degrees":"m"),N=[],w=[],C=r.tileMatrixSetLinks,E=function(e){N.push(28e-5*e/GeoGlobe.METERS_PER_INCH/GeoGlobe.INCHES_PER_UNIT[v]),(!g||g>e)&&(g=e),(!y||y<e)&&(y=e)},T=0;for(u=C.length;T<u;T++)if((b=C[T]).tileMatrixSet===a.identifier){if(b.tileMatrixSetLimits){for(var x,L={},_=0,P=a.matrixIds.length;_<P;_++)L[a.matrixIds[_].identifier]=a.matrixIds[_];for(_=0,P=b.tileMatrixSetLimits.length;_<P;_++)x=L[b.tileMatrixSetLimits[_].tileMatrix],w.push(x),E(x.scaleDenominator)}else for(_=0,P=a.matrixIds.length;_<P;_++)E(a.matrixIds[_].scaleDenominator);break}N.sort(function(e,t){return t-e});var F="",R={layers:[],source:{},source_id:"",url:"",url_tmpl:"",layerType:"VTS"},A=this.getParameterString({SERVICE:"WMTS",REQUEST:"GetTile",VERSION:t.version,LAYER:r.identifier,TILEMATRIXSET:a.identifier,FORMAT:"protobuf",TILEMATRIX:"{z}",TILEROW:"{y}",TILECOL:"{x}"});R.url=e,F=e.endsWith("?")?GeoGlobe.ProxyHost+e+A:GeoGlobe.ProxyHost+e+"?"+A,R.url_tmpl=F;GeoGlobe.Util.randomStr(10);if(r.bounds)var M=[r.bounds._sw.lng,r.bounds._sw.lat,r.bounds._ne.lng,r.bounds._ne.lat];else if(r.BoundingBox)M=r.BoundingBox[0].bounds.toBBOX();var I=r.tileMatrixSetLinks[0].tileMatrixSet,O=i.tileMatrixSets[I].matrixIds[0].identifier;return this.GetStyle(c[0],function(e){if(e.sprite)var t=GeoGlobe.ProxyHost+e.sprite;else t="";if(e.glyphs)var o=GeoGlobe.ProxyHost+e.glyphs;else o="";var i={name:r.identifier,sprite:t,glyphs:o,styleName:e.styleName,srs:S,bbox:M,format:r.formats,zoomoffset:O},n="source_vts_"+GeoGlobe.Util.randomStr(6);if(R.source_id=n,R.source={type:"vector",tiles:[F]},e.styleData)for(var s=0;s<e.styleData.layers.length;s++)e.styleData.layers[s].metadata=i,e.styleData.layers[s].source=n,R.layers[s]=e.styleData.layers[s];else for(s=0;s<e.layers.length;s++)e.layers[s].metadata=i,e.layers[s].source=n,R.layers[s]=e.layers[s]},function(){alert("WMTS服务请求失败，请检查服务是否正常运行或请求地址是否正确。\n请求地址："+e+"\n操作类型：GetCapabilities")}),R},createLayer:function(e,t){var o=this.getVTSCapabilities(e);return(t=t||{}).layer=t.layer?t.layer:o.contents.layers[0].identifier,t.styleName=t.styleName?t.styleName:"",this.createLayerOption(e,o,t)},createLayers:function(e){for(var t=this.getVTSCapabilities(e),o=t.contents.layers,r=[],i=0;i<o.length;i++){var n={layer:o[i].identifier},s=this.createLayerOption(e,t,n);r.push(s)}return r},GetStyleName:function(e,t){var o=this.url,r={REQUEST:"GetStyle",SERVICE:"WMTS",VERSION:"1.0.0"};t||(t=function(){this.failFn(r.REQUEST)}),GeoGlobe.Request.GET({url:o,params:r,scope:this,async:!1,success:function(o){var r=o.responseText;if(!r)return t(),!1;var i=(new GeoGlobe.Format.JSON).read(r),n=[];if(i.style)for(var s=0;s<i.style.length;s++)n.push(i.style[s].styleName);else if(i.styleName)for(var a=0;a<i.styleName.length;a++)n.push(i.styleName[a]);e(n)},failure:t})},GetStyle:function(e,t,o){var r=this.url;if(""!=e&&void 0!=e){var i={REQUEST:"GetStyle",SERVICE:"WMTS",VERSION:"1.0.0",STYLENAME:e};o||(o=function(){this.failFn(i.REQUEST)}),GeoGlobe.Request.GET({url:r,params:i,scope:this,async:!1,success:function(e){var r=e.responseText;if(!r)return o(),!1;var i=(new GeoGlobe.Format.JSON).read(r);t(i)},failure:o})}else alert("请查看样式名称是否存在")},getParameterString:function(e){var t=[];for(var o in e){var r=e[o];null!=r&&"function"!=typeof r&&t.push(o+"="+r)}return t.join("&")},CLASS_NAME:"GeoGlobe.Format.VTS"}),GeoGlobe.Format.WMSCapabilities=GeoGlobe.Class4OL(GeoGlobe.Format.XML.VersionedOGC,{defaultVersion:"1.1.1",profile:null,CLASS_NAME:"GeoGlobe.Format.WMSCapabilities"}),GeoGlobe.Format.WMSCapabilities.v1=GeoGlobe.Class4OL(GeoGlobe.Format.XML,{namespaces:{wms:"http://www.opengis.net/wms",xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance"},defaultPrefix:"wms",read:function(e){"string"==typeof e&&(e=GeoGlobe.Format.XML.prototype.read.apply(this,[e]));var t=e;e&&9==e.nodeType&&(e=e.documentElement);var o={};if(this.readNode(e,o),void 0===o.service){var r=new GeoGlobe.Format.OGCExceptionReport;o.error=r.read(t)}return o},readers:{wms:{Service:function(e,t){t.service={},this.readChildNodes(e,t.service)},Name:function(e,t){t.name=this.getChildValue(e)},Title:function(e,t){t.title=this.getChildValue(e)},Abstract:function(e,t){t.abstract=this.getChildValue(e)},BoundingBox:function(e,t){var o={};o.bbox=[parseFloat(e.getAttribute("minx")),parseFloat(e.getAttribute("miny")),parseFloat(e.getAttribute("maxx")),parseFloat(e.getAttribute("maxy"))];var r={x:parseFloat(e.getAttribute("resx")),y:parseFloat(e.getAttribute("resy"))};return isNaN(r.x)&&isNaN(r.y)||(o.res=r),o},OnlineResource:function(e,t){t.href=this.getAttributeNS(e,this.namespaces.xlink,"href")},ContactInformation:function(e,t){t.contactInformation={},this.readChildNodes(e,t.contactInformation)},ContactPersonPrimary:function(e,t){t.personPrimary={},this.readChildNodes(e,t.personPrimary)},ContactPerson:function(e,t){t.person=this.getChildValue(e)},ContactOrganization:function(e,t){t.organization=this.getChildValue(e)},ContactPosition:function(e,t){t.position=this.getChildValue(e)},ContactAddress:function(e,t){t.contactAddress={},this.readChildNodes(e,t.contactAddress)},AddressType:function(e,t){t.type=this.getChildValue(e)},Address:function(e,t){t.address=this.getChildValue(e)},City:function(e,t){t.city=this.getChildValue(e)},StateOrProvince:function(e,t){t.stateOrProvince=this.getChildValue(e)},PostCode:function(e,t){t.postcode=this.getChildValue(e)},Country:function(e,t){t.country=this.getChildValue(e)},ContactVoiceTelephone:function(e,t){t.phone=this.getChildValue(e)},ContactFacsimileTelephone:function(e,t){t.fax=this.getChildValue(e)},ContactElectronicMailAddress:function(e,t){t.email=this.getChildValue(e)},Fees:function(e,t){var o=this.getChildValue(e);o&&"none"!=o.toLowerCase()&&(t.fees=o)},AccessConstraints:function(e,t){var o=this.getChildValue(e);o&&"none"!=o.toLowerCase()&&(t.accessConstraints=o)},Capability:function(e,t){t.capability={nestedLayers:[],layers:[]},this.readChildNodes(e,t.capability)},Request:function(e,t){t.request={},this.readChildNodes(e,t.request)},GetCapabilities:function(e,t){t.getcapabilities={formats:[]},this.readChildNodes(e,t.getcapabilities)},Format:function(e,t){GeoGlobe.Util.isArray(t.formats)?t.formats.push(this.getChildValue(e)):t.format=this.getChildValue(e)},DCPType:function(e,t){this.readChildNodes(e,t)},HTTP:function(e,t){this.readChildNodes(e,t)},Get:function(e,t){t.get={},this.readChildNodes(e,t.get),t.href||(t.href=t.get.href)},Post:function(e,t){t.post={},this.readChildNodes(e,t.post),t.href||(t.href=t.get.href)},GetMap:function(e,t){t.getmap={formats:[]},this.readChildNodes(e,t.getmap)},GetFeatureInfo:function(e,t){t.getfeatureinfo={formats:[]},this.readChildNodes(e,t.getfeatureinfo)},Exception:function(e,t){t.exception={formats:[]},this.readChildNodes(e,t.exception)},Layer:function(e,t){var o,r;t.capability?(r=t.capability,o=t):r=t;var i=e.getAttributeNode("queryable"),n=i&&i.specified?e.getAttribute("queryable"):null,s=(i=e.getAttributeNode("cascaded"))&&i.specified?e.getAttribute("cascaded"):null,a=(i=e.getAttributeNode("opaque"))&&i.specified?e.getAttribute("opaque"):null,l=e.getAttribute("noSubsets"),u=e.getAttribute("fixedWidth"),c=e.getAttribute("fixedHeight"),p=o||{},h=GeoGlobe.Util.extend,f={nestedLayers:[],styles:o?[].concat(o.styles):[],srs:o?h({},p.srs):{},metadataURLs:[],bbox:o?h({},p.bbox):{},llbbox:p.llbbox,dimensions:o?h({},p.dimensions):{},authorityURLs:o?h({},p.authorityURLs):{},identifiers:{},keywords:[],queryable:n&&""!==n?"1"===n||"true"===n:p.queryable||!1,cascaded:null!==s?parseInt(s):p.cascaded||0,opaque:a?"1"===a||"true"===a:p.opaque||!1,noSubsets:null!==l?"1"===l||"true"===l:p.noSubsets||!1,fixedWidth:null!=u?parseInt(u):p.fixedWidth||0,fixedHeight:null!=c?parseInt(c):p.fixedHeight||0,minScale:p.minScale,maxScale:p.maxScale,attribution:p.attribution};if(t.nestedLayers.push(f),f.capability=r,this.readChildNodes(e,f),delete f.capability,f.name){var d=f.name.split(":"),G=r.request,m=G.getfeatureinfo;d.length>0&&(f.prefix=d[0]),r.layers.push(f),void 0===f.formats&&(f.formats=G.getmap.formats),void 0===f.infoFormats&&m&&(f.infoFormats=m.formats)}},Attribution:function(e,t){t.attribution={},this.readChildNodes(e,t.attribution)},LogoURL:function(e,t){t.logo={width:e.getAttribute("width"),height:e.getAttribute("height")},this.readChildNodes(e,t.logo)},Style:function(e,t){var o={};t.styles.push(o),this.readChildNodes(e,o)},LegendURL:function(e,t){var o={width:e.getAttribute("width"),height:e.getAttribute("height")};t.legend=o,this.readChildNodes(e,o)},MetadataURL:function(e,t){var o={type:e.getAttribute("type")};t.metadataURLs.push(o),this.readChildNodes(e,o)},DataURL:function(e,t){t.dataURL={},this.readChildNodes(e,t.dataURL)},FeatureListURL:function(e,t){t.featureListURL={},this.readChildNodes(e,t.featureListURL)},AuthorityURL:function(e,t){var o=e.getAttribute("name"),r={};this.readChildNodes(e,r),t.authorityURLs[o]=r.href},Identifier:function(e,t){var o=e.getAttribute("authority");t.identifiers[o]=this.getChildValue(e)},KeywordList:function(e,t){this.readChildNodes(e,t)},SRS:function(e,t){t.srs[this.getChildValue(e)]=!0}}},CLASS_NAME:"GeoGlobe.Format.WMSCapabilities.v1"}),GeoGlobe.Format.WMSCapabilities.v1_1=GeoGlobe.Class4OL(GeoGlobe.Format.WMSCapabilities.v1,{readers:{wms:GeoGlobe.Util.applyDefaults({WMT_MS_Capabilities:function(e,t){this.readChildNodes(e,t)},Keyword:function(e,t){t.keywords&&t.keywords.push(this.getChildValue(e))},DescribeLayer:function(e,t){t.describelayer={formats:[]},this.readChildNodes(e,t.describelayer)},GetLegendGraphic:function(e,t){t.getlegendgraphic={formats:[]},this.readChildNodes(e,t.getlegendgraphic)},GetStyles:function(e,t){t.getstyles={formats:[]},this.readChildNodes(e,t.getstyles)},PutStyles:function(e,t){t.putstyles={formats:[]},this.readChildNodes(e,t.putstyles)},UserDefinedSymbolization:function(e,t){var o={supportSLD:1==parseInt(e.getAttribute("SupportSLD")),userLayer:1==parseInt(e.getAttribute("UserLayer")),userStyle:1==parseInt(e.getAttribute("UserStyle")),remoteWFS:1==parseInt(e.getAttribute("RemoteWFS"))};t.userSymbols=o},LatLonBoundingBox:function(e,t){t.llbbox=[parseFloat(e.getAttribute("minx")),parseFloat(e.getAttribute("miny")),parseFloat(e.getAttribute("maxx")),parseFloat(e.getAttribute("maxy"))]},BoundingBox:function(e,t){var o=GeoGlobe.Format.WMSCapabilities.v1.prototype.readers.wms.BoundingBox.apply(this,[e,t]);o.srs=e.getAttribute("SRS"),t.bbox[o.srs]=o},ScaleHint:function(e,t){var o=e.getAttribute("min"),r=e.getAttribute("max"),i=Math.pow(2,.5),n=GeoGlobe.INCHES_PER_UNIT.m;0!=o&&(t.maxScale=parseFloat((o/i*n*GeoGlobe.DOTS_PER_INCH).toPrecision(13))),r!=Number.POSITIVE_INFINITY&&(t.minScale=parseFloat((r/i*n*GeoGlobe.DOTS_PER_INCH).toPrecision(13)))},Dimension:function(e,t){var o={name:e.getAttribute("name").toLowerCase(),units:e.getAttribute("units"),unitsymbol:e.getAttribute("unitSymbol")};t.dimensions[o.name]=o},Extent:function(e,t){var o=e.getAttribute("name").toLowerCase();if(o in t.dimensions){var r=t.dimensions[o];r.nearestVal="1"===e.getAttribute("nearestValue"),r.multipleVal="1"===e.getAttribute("multipleValues"),r.current="1"===e.getAttribute("current"),r.default=e.getAttribute("default")||"";var i=this.getChildValue(e);r.values=i.split(",")}}},GeoGlobe.Format.WMSCapabilities.v1.prototype.readers.wms)},CLASS_NAME:"GeoGlobe.Format.WMSCapabilities.v1_1"}),GeoGlobe.Format.WMSCapabilities.v1_1_0=GeoGlobe.Class4OL(GeoGlobe.Format.WMSCapabilities.v1_1,{version:"1.1.0",readers:{wms:GeoGlobe.Util.applyDefaults({SRS:function(e,t){for(var o=this.getChildValue(e).split(/ +/),r=0,i=o.length;r<i;r++)t.srs[o[r]]=!0}},GeoGlobe.Format.WMSCapabilities.v1_1.prototype.readers.wms)},CLASS_NAME:"GeoGlobe.Format.WMSCapabilities.v1_1_0"}),GeoGlobe.Format.WMSCapabilities.v1_1_1=GeoGlobe.Class4OL(GeoGlobe.Format.WMSCapabilities.v1_1,{version:"1.1.1",readers:{wms:GeoGlobe.Util.applyDefaults({SRS:function(e,t){t.srs[this.getChildValue(e)]=!0}},GeoGlobe.Format.WMSCapabilities.v1_1.prototype.readers.wms)},CLASS_NAME:"GeoGlobe.Format.WMSCapabilities.v1_1_1"}),GeoGlobe.Format.WMSCapabilities.v1_1_1_WMSC=GeoGlobe.Class4OL(GeoGlobe.Format.WMSCapabilities.v1_1_1,{version:"1.1.1",profile:"WMSC",readers:{wms:GeoGlobe.Util.applyDefaults({VendorSpecificCapabilities:function(e,t){t.vendorSpecific={tileSets:[]},this.readChildNodes(e,t.vendorSpecific)},TileSet:function(e,t){var o={srs:{},bbox:{},resolutions:[]};this.readChildNodes(e,o),t.tileSets.push(o)},Resolutions:function(e,t){for(var o=this.getChildValue(e).split(" "),r=0,i=o.length;r<i;r++)""!=o[r]&&t.resolutions.push(parseFloat(o[r]))},Width:function(e,t){t.width=parseInt(this.getChildValue(e))},Height:function(e,t){t.height=parseInt(this.getChildValue(e))},Layers:function(e,t){t.layers=this.getChildValue(e)},Styles:function(e,t){t.styles=this.getChildValue(e)}},GeoGlobe.Format.WMSCapabilities.v1_1_1.prototype.readers.wms)},CLASS_NAME:"GeoGlobe.Format.WMSCapabilities.v1_1_1_WMSC"}),GeoGlobe.Format.WMSCapabilities.v1_3=GeoGlobe.Class4OL(GeoGlobe.Format.WMSCapabilities.v1,{readers:{wms:GeoGlobe.Util.applyDefaults({WMS_Capabilities:function(e,t){this.readChildNodes(e,t)},LayerLimit:function(e,t){t.layerLimit=parseInt(this.getChildValue(e))},MaxWidth:function(e,t){t.maxWidth=parseInt(this.getChildValue(e))},MaxHeight:function(e,t){t.maxHeight=parseInt(this.getChildValue(e))},BoundingBox:function(e,t){var o=GeoGlobe.Format.WMSCapabilities.v1.prototype.readers.wms.BoundingBox.apply(this,[e,t]);o.srs=e.getAttribute("CRS"),t.bbox[o.srs]=o},CRS:function(e,t){this.readers.wms.SRS.apply(this,[e,t])},EX_GeographicBoundingBox:function(e,t){t.llbbox=[],this.readChildNodes(e,t.llbbox)},westBoundLongitude:function(e,t){t[0]=this.getChildValue(e)},eastBoundLongitude:function(e,t){t[2]=this.getChildValue(e)},southBoundLatitude:function(e,t){t[1]=this.getChildValue(e)},northBoundLatitude:function(e,t){t[3]=this.getChildValue(e)},MinScaleDenominator:function(e,t){t.maxScale=parseFloat(this.getChildValue(e)).toPrecision(16)},MaxScaleDenominator:function(e,t){t.minScale=parseFloat(this.getChildValue(e)).toPrecision(16)},Dimension:function(e,t){var o={name:e.getAttribute("name").toLowerCase(),units:e.getAttribute("units"),unitsymbol:e.getAttribute("unitSymbol"),nearestVal:"1"===e.getAttribute("nearestValue"),multipleVal:"1"===e.getAttribute("multipleValues"),default:e.getAttribute("default")||"",current:"1"===e.getAttribute("current"),values:this.getChildValue(e).split(",")};t.dimensions[o.name]=o},Keyword:function(e,t){var o={value:this.getChildValue(e),vocabulary:e.getAttribute("vocabulary")};t.keywords&&t.keywords.push(o)}},GeoGlobe.Format.WMSCapabilities.v1.prototype.readers.wms),sld:{UserDefinedSymbolization:function(e,t){this.readers.wms.UserDefinedSymbolization.apply(this,[e,t]),t.userSymbols.inlineFeature=1==parseInt(e.getAttribute("InlineFeature")),t.userSymbols.remoteWCS=1==parseInt(e.getAttribute("RemoteWCS"))},DescribeLayer:function(e,t){this.readers.wms.DescribeLayer.apply(this,[e,t])},GetLegendGraphic:function(e,t){this.readers.wms.GetLegendGraphic.apply(this,[e,t])}}},CLASS_NAME:"GeoGlobe.Format.WMSCapabilities.v1_3"}),GeoGlobe.Format.WMSCapabilities.v1_3_0=GeoGlobe.Class4OL(GeoGlobe.Format.WMSCapabilities.v1_3,{version:"1.3.0",CLASS_NAME:"GeoGlobe.Format.WMSCapabilities.v1_3_0"}),GeoGlobe.Format.WMTSCapabilities=GeoGlobe.Class4OL(GeoGlobe.Format.XML.VersionedOGC,{defaultVersion:"1.0.0",yx:{"urn:ogc:def:crs:EPSG::4326":!0},createLayer:function(e,t){if(!("layer"in t))throw new Error("Missing property 'layer' in configuration.");for(var o,r=e.contents,i=(r.layers,0),n=r.layers.length;i<n;++i)if(r.layers[i].identifier===t.layer){o=r.layers[i];break}if(!o)throw new Error("Layer not found");var s,a,l=t.format;if(!l&&o.formats&&o.formats.length&&(l=o.formats[0]),t.matrixSet)s=r.tileMatrixSets[t.matrixSet];else if(t.projection){i=0;for(var u=o.tileMatrixSetLinks.length;i<u;i++)if(r.tileMatrixSets[o.tileMatrixSetLinks[i].tileMatrixSet].supportedCRS.replace(/urn:ogc:def:crs:(\w+):(.*:)?(\w+)$/,"$1:$3")===t.projection){s=r.tileMatrixSets[o.tileMatrixSetLinks[i].tileMatrixSet];break}}else o.tileMatrixSetLinks.length>=1&&(s=r.tileMatrixSets[o.tileMatrixSetLinks[0].tileMatrixSet]);if(!s)throw new Error("matrixSet not found");for(i=0,n=o.styles.length;i<n&&!(a=o.styles[i]).isDefault;++i);var c=t.requestEncoding;c||(c="KVP",e.operationsMetadata.GetTile.dcp.http);var p=[],h=t.params||{};delete t.params;for(var f=0,d=o.dimensions.length;f<d;f++){var G=o.dimensions[f];p.push(G.identifier),h.hasOwnProperty(G.identifier)||(h[G.identifier]=G.default)}var m,g,y,b,S=t.projection||s.supportedCRS.replace(/urn:ogc:def:crs:(\w+):(.*:)?(\w+)$/,"$1:$3"),v=t.units||("EPSG:4326"===S?"degrees":"m"),N=[],w=[],C=o.tileMatrixSetLinks,E=function(e){N.push(28e-5*e/GeoGlobe.METERS_PER_INCH/GeoGlobe.INCHES_PER_UNIT[v]),(!m||m>e)&&(m=e),(!g||g<e)&&(g=e)},T=0;for(u=C.length;T<u;T++)if((y=C[T]).tileMatrixSet===s.identifier){if(y.tileMatrixSetLimits){for(var x,L={},_=0,P=s.matrixIds.length;_<P;_++)L[s.matrixIds[_].identifier]=s.matrixIds[_];for(_=0,P=y.tileMatrixSetLimits.length;_<P;_++)x=L[y.tileMatrixSetLimits[_].tileMatrix],w.push(x),E(x.scaleDenominator)}else for(_=0,P=s.matrixIds.length;_<P;_++)E(s.matrixIds[_].scaleDenominator);break}if("REST"===c&&o.resourceUrls){b=[];o.resourceUrls;for(var F,R=0,A=o.resourceUrls.length;R<A;++R)(F=o.resourceUrls[R]).format===l&&"tile"===F.resourceType&&b.push(F.template)}else{var M,I=e.operationsMetadata.GetTile.dcp.http.get;b=[];for(i=0,n=I.length;i<n;i++)(!(M=I[i].constraints)||M&&M.GetEncoding.allowedValues[c])&&b.push(I[i].url)}N.sort(function(e,t){return t-e});var O="",U="SERVICE=WMTS&REQUEST=GetTile&VERSION="+e.version+"&LAYER="+o.identifier+"&STYLE="+a.identifier+"&TILEMATRIXSET="+s.identifier+"&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&FORMAT="+l;O=b[0].endsWith("?")?b[0]+U:b[0]+"?"+U;var D=GeoGlobe.Util.applyDefaults(t,{id:o.identifier,url:[O]}),B={id:D.id,layer:{id:D.id,type:"raster",source:D.id},source:{type:"raster",tiles:D.url,tileSize:256}};return B.matrixSet=s,B.identifier=o.identifier,B.bounds=o.bounds,B},CLASS_NAME:"GeoGlobe.Format.WMTSCapabilities"}),GeoGlobe.Format.WMTSCapabilities.v1_0_0=GeoGlobe.Class4OL(GeoGlobe.Format.OWSCommon.v1_1_0,{version:"1.0.0",namespaces:{ows:"http://www.opengis.net/ows/1.1",wmts:"http://www.opengis.net/wmts/1.0",xlink:"http://www.w3.org/1999/xlink"},yx:null,defaultPrefix:"wmts",initialize:function(e){GeoGlobe.Format.XML.prototype.initialize.apply(this,[e]),this.options=e;var t=GeoGlobe.Util.extend({},GeoGlobe.Format.WMTSCapabilities.prototype.yx);this.yx=GeoGlobe.Util.extend(t,this.yx)},read:function(e){"string"==typeof e&&(e=GeoGlobe.Format.XML.prototype.read.apply(this,[e])),e&&9==e.nodeType&&(e=e.documentElement);var t={};return this.readNode(e,t),t.version=this.version,t},readers:{wmts:{Capabilities:function(e,t){this.readChildNodes(e,t)},Contents:function(e,t){t.contents={},t.contents.layers=[],t.contents.tileMatrixSets={},this.readChildNodes(e,t.contents)},Layer:function(e,t){var o={styles:[],formats:[],dimensions:[],tileMatrixSetLinks:[]};this.readChildNodes(e,o),t.layers.push(o)},Style:function(e,t){var o={};o.isDefault="true"===e.getAttribute("isDefault"),this.readChildNodes(e,o),t.styles.push(o)},Format:function(e,t){t.formats.push(this.getChildValue(e))},TileMatrixSetLink:function(e,t){var o={};this.readChildNodes(e,o),t.tileMatrixSetLinks.push(o)},TileMatrixSet:function(e,t){if(t.layers){var o={matrixIds:[]};this.readChildNodes(e,o),t.tileMatrixSets[o.identifier]=o}else t.tileMatrixSet=this.getChildValue(e)},TileMatrixSetLimits:function(e,t){t.tileMatrixSetLimits=[],this.readChildNodes(e,t)},TileMatrixLimits:function(e,t){var o={};this.readChildNodes(e,o),t.tileMatrixSetLimits.push(o)},MinTileRow:function(e,t){t.minTileRow=parseInt(this.getChildValue(e))},MaxTileRow:function(e,t){t.maxTileRow=parseInt(this.getChildValue(e))},MinTileCol:function(e,t){t.minTileCol=parseInt(this.getChildValue(e))},MaxTileCol:function(e,t){t.maxTileCol=parseInt(this.getChildValue(e))},TileMatrix:function(e,t){if(t.identifier){var o={supportedCRS:t.supportedCRS};this.readChildNodes(e,o),t.matrixIds.push(o)}else t.tileMatrix=this.getChildValue(e)},ScaleDenominator:function(e,t){t.scaleDenominator=parseFloat(this.getChildValue(e))},TopLeftCorner:function(e,t){var o,r=this.getChildValue(e).split(" ");if(t.supportedCRS){var i=t.supportedCRS.replace(/urn:ogc:def:crs:(\w+):.+:(\w+)$/,"urn:ogc:def:crs:$1::$2");o=!!this.yx[i]}t.topLeftCorner=o?new GeoGlobe.LngLat(r[1],r[0]):new GeoGlobe.LngLat(r[0],r[1])},TileWidth:function(e,t){t.tileWidth=parseInt(this.getChildValue(e))},TileHeight:function(e,t){t.tileHeight=parseInt(this.getChildValue(e))},MatrixWidth:function(e,t){t.matrixWidth=parseInt(this.getChildValue(e))},MatrixHeight:function(e,t){t.matrixHeight=parseInt(this.getChildValue(e))},ResourceURL:function(e,t){t.resourceUrl=t.resourceUrl||{};var o=e.getAttribute("resourceType");t.resourceUrls||(t.resourceUrls=[]);var r=t.resourceUrl[o]={format:e.getAttribute("format"),template:e.getAttribute("template"),resourceType:o};t.resourceUrls.push(r)},LegendURL:function(e,t){t.legends=t.legends||[];var o={format:e.getAttribute("format"),href:e.getAttribute("xlink:href")},r=e.getAttribute("width"),i=e.getAttribute("height"),n=e.getAttribute("minScaleDenominator"),s=e.getAttribute("maxScaleDenominator");null!==r&&(o.width=parseInt(r)),null!==i&&(o.height=parseInt(i)),null!==n&&(o.minScaleDenominator=parseInt(n)),null!==s&&(o.maxScaleDenominator=parseInt(s)),t.legends.push(o)},InfoFormat:function(e,t){t.infoFormats=t.infoFormats||[],t.infoFormats.push(this.getChildValue(e))},WSDL:function(e,t){t.wsdl={},t.wsdl.href=e.getAttribute("xlink:href")},ServiceMetadataURL:function(e,t){t.serviceMetadataUrl={},t.serviceMetadataUrl.href=e.getAttribute("xlink:href")},Dimension:function(e,t){var o={values:[]};this.readChildNodes(e,o),t.dimensions.push(o)},Default:function(e,t){t.default=this.getChildValue(e)},Value:function(e,t){t.values.push(this.getChildValue(e))}},ows:GeoGlobe.Format.OWSCommon.v1_1_0.prototype.readers.ows},CLASS_NAME:"GeoGlobe.Format.WMTSCapabilities.v1_0_0"}),GeoGlobe.Format.VTSCapabilities=GeoGlobe.Class4OL(GeoGlobe.Format.XML.VersionedOGC,{defaultVersion:"1.0.0",yx:{"urn:ogc:def:crs:EPSG::4326":!0},createLayer:function(e,t){if(!("layer"in t))throw new Error("Missing property 'layer' in configuration.");for(var o,r=e.contents,i=(r.layers,0),n=r.layers.length;i<n;++i)if(r.layers[i].identifier===t.layer){o=r.layers[i];break}if(!o)throw new Error("Layer not found");var s,a,l=t.format;if(!l&&o.formats&&o.formats.length&&(l=o.formats[0]),t.matrixSet)s=r.tileMatrixSets[t.matrixSet];else if(t.projection){i=0;for(var u=o.tileMatrixSetLinks.length;i<u;i++)if(r.tileMatrixSets[o.tileMatrixSetLinks[i].tileMatrixSet].supportedCRS.replace(/urn:ogc:def:crs:(\w+):(.*:)?(\w+)$/,"$1:$3")===t.projection){s=r.tileMatrixSets[o.tileMatrixSetLinks[i].tileMatrixSet];break}}else o.tileMatrixSetLinks.length>=1&&(s=r.tileMatrixSets[o.tileMatrixSetLinks[0].tileMatrixSet]);if(!s)throw new Error("matrixSet not found");for(i=0,n=o.styles.length;i<n&&!(a=o.styles[i]).isDefault;++i);var c=t.requestEncoding;c||(c="KVP",e.operationsMetadata.GetTile.dcp.http);var p=[],h=t.params||{};delete t.params;for(var f=0,d=o.dimensions.length;f<d;f++){var G=o.dimensions[f];p.push(G.identifier),h.hasOwnProperty(G.identifier)||(h[G.identifier]=G.default)}var m,g,y,b,S=t.projection||s.supportedCRS.replace(/urn:ogc:def:crs:(\w+):(.*:)?(\w+)$/,"$1:$3"),v=t.units||("EPSG:4326"===S?"degrees":"m"),N=[],w=[],C=o.tileMatrixSetLinks,E=function(e){N.push(28e-5*e/GeoGlobe.METERS_PER_INCH/GeoGlobe.INCHES_PER_UNIT[v]),(!m||m>e)&&(m=e),(!g||g<e)&&(g=e)},T=0;for(u=C.length;T<u;T++)if((y=C[T]).tileMatrixSet===s.identifier){if(y.tileMatrixSetLimits){for(var x,L={},_=0,P=s.matrixIds.length;_<P;_++)L[s.matrixIds[_].identifier]=s.matrixIds[_];for(_=0,P=y.tileMatrixSetLimits.length;_<P;_++)x=L[y.tileMatrixSetLimits[_].tileMatrix],w.push(x),E(x.scaleDenominator)}else for(_=0,P=s.matrixIds.length;_<P;_++)E(s.matrixIds[_].scaleDenominator);break}if("REST"===c&&o.resourceUrls){b=[];o.resourceUrls;for(var F,R=0,A=o.resourceUrls.length;R<A;++R)(F=o.resourceUrls[R]).format===l&&"tile"===F.resourceType&&b.push(F.template)}else{var M,I=e.operationsMetadata.GetTile.dcp.http.get;b=[];for(i=0,n=I.length;i<n;i++)(!(M=I[i].constraints)||M&&M.GetEncoding.allowedValues[c])&&b.push(I[i].url)}N.sort(function(e,t){return t-e});var O="",U="SERVICE=WMTS&REQUEST=GetTile&VERSION="+e.version+"&LAYER="+o.identifier+"&STYLE="+a.identifier+"&TILEMATRIXSET="+s.identifier+"&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&FORMAT="+l;O=b[0].endsWith("?")?b[0]+U:b[0]+"?"+U;var D=GeoGlobe.Util.applyDefaults(t,{id:o.identifier,url:[O]}),B=new GeoGlobe.Layer.VTS(D);return B.matrixSet=s,B.identifier=o.identifier,B.bounds=o.bounds,B},CLASS_NAME:"GeoGlobe.Format.VTSCapabilities"}),GeoGlobe.Format.VTSCapabilities.v1_0_0=GeoGlobe.Class4OL(GeoGlobe.Format.OWSCommon.v1_1_0,{version:"1.0.0",namespaces:{ows:"http://www.opengis.net/ows/1.1",wmts:"http://www.opengis.net/wmts/1.0",xlink:"http://www.w3.org/1999/xlink"},yx:null,defaultPrefix:"wmts",initialize:function(e){GeoGlobe.Format.XML.prototype.initialize.apply(this,[e]),this.options=e;var t=GeoGlobe.Util.extend({},GeoGlobe.Format.VTSCapabilities.prototype.yx);this.yx=GeoGlobe.Util.extend(t,this.yx)},read:function(e){"string"==typeof e&&(e=GeoGlobe.Format.XML.prototype.read.apply(this,[e])),e&&9==e.nodeType&&(e=e.documentElement);var t={};return this.readNode(e,t),t.version=this.version,t},readers:{wmts:{Capabilities:function(e,t){this.readChildNodes(e,t)},Contents:function(e,t){t.contents={},t.contents.layers=[],t.contents.tileMatrixSets={},this.readChildNodes(e,t.contents)},Layer:function(e,t){var o={styles:[],formats:[],dimensions:[],tileMatrixSetLinks:[]};this.readChildNodes(e,o),t.layers.push(o)},Style:function(e,t){var o={};o.isDefault="true"===e.getAttribute("isDefault"),this.readChildNodes(e,o),t.styles.push(o)},Format:function(e,t){t.formats.push(this.getChildValue(e))},TileMatrixSetLink:function(e,t){var o={};this.readChildNodes(e,o),t.tileMatrixSetLinks.push(o)},TileMatrixSet:function(e,t){if(t.layers){var o={matrixIds:[]};this.readChildNodes(e,o),t.tileMatrixSets[o.identifier]=o}else t.tileMatrixSet=this.getChildValue(e)},TileMatrixSetLimits:function(e,t){t.tileMatrixSetLimits=[],this.readChildNodes(e,t)},TileMatrixLimits:function(e,t){var o={};this.readChildNodes(e,o),t.tileMatrixSetLimits.push(o)},MinTileRow:function(e,t){t.minTileRow=parseInt(this.getChildValue(e))},MaxTileRow:function(e,t){t.maxTileRow=parseInt(this.getChildValue(e))},MinTileCol:function(e,t){t.minTileCol=parseInt(this.getChildValue(e))},MaxTileCol:function(e,t){t.maxTileCol=parseInt(this.getChildValue(e))},TileMatrix:function(e,t){if(t.identifier){var o={supportedCRS:t.supportedCRS};this.readChildNodes(e,o),t.matrixIds.push(o)}else t.tileMatrix=this.getChildValue(e)},ScaleDenominator:function(e,t){t.scaleDenominator=parseFloat(this.getChildValue(e))},TopLeftCorner:function(e,t){var o,r=this.getChildValue(e).split(" ");if(t.supportedCRS){var i=t.supportedCRS.replace(/urn:ogc:def:crs:(\w+):.+:(\w+)$/,"urn:ogc:def:crs:$1::$2");o=!!this.yx[i]}t.topLeftCorner=o?new GeoGlobe.LngLat(r[1],r[0]):new GeoGlobe.LngLat(r[0],r[1])},TileWidth:function(e,t){t.tileWidth=parseInt(this.getChildValue(e))},TileHeight:function(e,t){t.tileHeight=parseInt(this.getChildValue(e))},MatrixWidth:function(e,t){t.matrixWidth=parseInt(this.getChildValue(e))},MatrixHeight:function(e,t){t.matrixHeight=parseInt(this.getChildValue(e))},ResourceURL:function(e,t){t.resourceUrl=t.resourceUrl||{};var o=e.getAttribute("resourceType");t.resourceUrls||(t.resourceUrls=[]);var r=t.resourceUrl[o]={format:e.getAttribute("format"),template:e.getAttribute("template"),resourceType:o};t.resourceUrls.push(r)},LegendURL:function(e,t){t.legends=t.legends||[];var o={format:e.getAttribute("format"),href:e.getAttribute("xlink:href")},r=e.getAttribute("width"),i=e.getAttribute("height"),n=e.getAttribute("minScaleDenominator"),s=e.getAttribute("maxScaleDenominator");null!==r&&(o.width=parseInt(r)),null!==i&&(o.height=parseInt(i)),null!==n&&(o.minScaleDenominator=parseInt(n)),null!==s&&(o.maxScaleDenominator=parseInt(s)),t.legends.push(o)},InfoFormat:function(e,t){t.infoFormats=t.infoFormats||[],t.infoFormats.push(this.getChildValue(e))},WSDL:function(e,t){t.wsdl={},t.wsdl.href=e.getAttribute("xlink:href")},ServiceMetadataURL:function(e,t){t.serviceMetadataUrl={},t.serviceMetadataUrl.href=e.getAttribute("xlink:href")},Dimension:function(e,t){var o={values:[]};this.readChildNodes(e,o),t.dimensions.push(o)},Default:function(e,t){t.default=this.getChildValue(e)},Value:function(e,t){t.values.push(this.getChildValue(e))}},ows:GeoGlobe.Format.OWSCommon.v1_1_0.prototype.readers.ows},CLASS_NAME:"GeoGlobe.Format.VTSCapabilities.v1_0_0"}),GeoGlobe.Format.WPSCapabilities=GeoGlobe.Class4OL(GeoGlobe.Format.XML.VersionedOGC,{defaultVersion:"1.0.0",CLASS_NAME:"GeoGlobe.Format.WPSCapabilities"}),GeoGlobe.Format.WPSCapabilities.v1_0_0=GeoGlobe.Class4OL(GeoGlobe.Format.XML,{namespaces:{ows:"http://www.opengis.net/ows/1.1",wps:"http://www.opengis.net/wps/1.0.0",xlink:"http://www.w3.org/1999/xlink"},regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},initialize:function(e){GeoGlobe.Format.XML.prototype.initialize.apply(this,[e])},read:function(e){"string"==typeof e&&(e=GeoGlobe.Format.XML.prototype.read.apply(this,[e])),e&&9==e.nodeType&&(e=e.documentElement);var t={};return this.readNode(e,t),t},readers:{wps:{Capabilities:function(e,t){this.readChildNodes(e,t)},ProcessOfferings:function(e,t){t.processOfferings={},this.readChildNodes(e,t.processOfferings)},Process:function(e,t){var o={processVersion:this.getAttributeNS(e,this.namespaces.wps,"processVersion")};this.readChildNodes(e,o),t[o.identifier]=o},Languages:function(e,t){t.languages=[],this.readChildNodes(e,t.languages)},Default:function(e,t){var o={isDefault:!0};this.readChildNodes(e,o),t.push(o)},Supported:function(e,t){var o={};this.readChildNodes(e,o),t.push(o)}},ows:GeoGlobe.Format.OWSCommon.v1_1_0.prototype.readers.ows},CLASS_NAME:"GeoGlobe.Format.WPSCapabilities.v1_0_0"}),GeoGlobe.Format.WCSGetCoverage=GeoGlobe.Class4OL(GeoGlobe.Format.XML,{namespaces:{ows:"http://www.opengis.net/ows/1.1",wcs:"http://www.opengis.net/wcs/1.1",xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance"},regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},VERSION:"1.1.2",schemaLocation:"http://www.opengis.net/wcs/1.1 http://schemas.opengis.net/wcs/1.1/wcsGetCoverage.xsd",write:function(e){var t=this.writeNode("wcs:GetCoverage",e);return this.setAttributeNS(t,this.namespaces.xsi,"xsi:schemaLocation",this.schemaLocation),GeoGlobe.Format.XML.prototype.write.apply(this,[t])},writers:{wcs:{GetCoverage:function(e){var t=this.createElementNSPlus("wcs:GetCoverage",{attributes:{version:e.version||this.VERSION,service:"WCS"}});return this.writeNode("ows:Identifier",e.identifier,t),this.writeNode("wcs:DomainSubset",e.domainSubset,t),this.writeNode("wcs:Output",e.output,t),t},DomainSubset:function(e){var t=this.createElementNSPlus("wcs:DomainSubset",{});return this.writeNode("ows:BoundingBox",e.boundingBox,t),e.temporalSubset&&this.writeNode("wcs:TemporalSubset",e.temporalSubset,t),t},TemporalSubset:function(e){for(var t=this.createElementNSPlus("wcs:TemporalSubset",{}),o=0,r=e.timePeriods.length;o<r;++o)this.writeNode("wcs:TimePeriod",e.timePeriods[o],t);return t},TimePeriod:function(e){var t=this.createElementNSPlus("wcs:TimePeriod",{});return this.writeNode("wcs:BeginPosition",e.begin,t),this.writeNode("wcs:EndPosition",e.end,t),e.resolution&&this.writeNode("wcs:TimeResolution",e.resolution,t),t},BeginPosition:function(e){return this.createElementNSPlus("wcs:BeginPosition",{value:e})},EndPosition:function(e){return this.createElementNSPlus("wcs:EndPosition",{value:e})},TimeResolution:function(e){return this.createElementNSPlus("wcs:TimeResolution",{value:e})},Output:function(e){var t=this.createElementNSPlus("wcs:Output",{attributes:{format:e.format,store:e.store}});return e.gridCRS&&this.writeNode("wcs:GridCRS",e.gridCRS,t),t},GridCRS:function(e){var t=this.createElementNSPlus("wcs:GridCRS",{});return this.writeNode("wcs:GridBaseCRS",e.baseCRS,t),e.type&&this.writeNode("wcs:GridType",e.type,t),e.origin&&this.writeNode("wcs:GridOrigin",e.origin,t),this.writeNode("wcs:GridOffsets",e.offsets,t),e.CS&&this.writeNode("wcs:GridCS",e.CS,t),t},GridBaseCRS:function(e){return this.createElementNSPlus("wcs:GridBaseCRS",{value:e})},GridOrigin:function(e){return this.createElementNSPlus("wcs:GridOrigin",{value:e})},GridType:function(e){return this.createElementNSPlus("wcs:GridType",{value:e})},GridOffsets:function(e){return this.createElementNSPlus("wcs:GridOffsets",{value:e})},GridCS:function(e){return this.createElementNSPlus("wcs:GridCS",{value:e})}},ows:GeoGlobe.Format.OWSCommon.v1_1_0.prototype.writers.ows},CLASS_NAME:"GeoGlobe.Format.WCSGetCoverage"}),GeoGlobe.Format.WPSExecute=GeoGlobe.Class4OL(GeoGlobe.Format.XML,GeoGlobe.Format.Filter.v1_1_0,{namespaces:{ows:"http://www.opengis.net/ows/1.1",gml:"http://www.opengis.net/gml",wps:"http://www.opengis.net/wps/1.0.0",wfs:"http://www.opengis.net/wfs",ogc:"http://www.opengis.net/ogc",wcs:"http://www.opengis.net/wcs",xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance"},regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},VERSION:"1.0.0",schemaLocation:"http://www.opengis.net/wps/1.0.0 http://schemas.opengis.net/wps/1.0.0/wpsAll.xsd",schemaLocationAttr:function(e){},write:function(e){var t;GeoGlobe.Format.XML.supportActiveX?(t=new ActiveXObject("Microsoft.XMLDOM"),this.xmldom=t):t=document.implementation.createDocument("","",null);var o=this.writeNode("wps:Execute",e,t);return this.setAttributeNS(o,this.namespaces.xsi,"xsi:schemaLocation",this.schemaLocation),GeoGlobe.Format.XML.prototype.write.apply(this,[o])},read:function(e){"string"==typeof e&&(e=GeoGlobe.Format.XML.prototype.read.apply(this,[e])),e&&9==e.nodeType&&(e=e.documentElement);var t={};return this.readNode(e,t),t},writers:{wps:{Execute:function(e){var t=this.createElementNSPlus("wps:Execute",{attributes:{version:this.VERSION,service:"WPS"}});return this.writeNode("ows:Identifier",e.identifier,t),this.writeNode("wps:DataInputs",e.dataInputs,t),this.writeNode("wps:ResponseForm",e.responseForm,t),t},ResponseForm:function(e){var t=this.createElementNSPlus("wps:ResponseForm",{});return e.rawDataOutput&&this.writeNode("wps:RawDataOutput",e.rawDataOutput,t),e.responseDocument&&this.writeNode("wps:ResponseDocument",e.responseDocument,t),t},ResponseDocument:function(e){var t=this.createElementNSPlus("wps:ResponseDocument",{attributes:{storeExecuteResponse:e.storeExecuteResponse,lineage:e.lineage,status:e.status}});if(e.outputs)for(var o=0,r=e.outputs.length;o<r;o++)this.writeNode("wps:Output",e.outputs[o],t);return t},Output:function(e){var t=this.createElementNSPlus("wps:Output",{attributes:{asReference:e.asReference,mimeType:e.mimeType,encoding:e.encoding,schema:e.schema}});return this.writeNode("ows:Identifier",e.identifier,t),this.writeNode("ows:Title",e.title,t),this.writeNode("ows:Abstract",e.abstract,t),t},RawDataOutput:function(e){var t=this.createElementNSPlus("wps:RawDataOutput",{attributes:{mimeType:e.mimeType,encoding:e.encoding,schema:e.schema}});return this.writeNode("ows:Identifier",e.identifier,t),t},DataInputs:function(e){for(var t=this.createElementNSPlus("wps:DataInputs",{}),o=0,r=e.length;o<r;++o)this.writeNode("wps:Input",e[o],t);return t},Input:function(e){var t=this.createElementNSPlus("wps:Input",{});return this.writeNode("ows:Identifier",e.identifier,t),e.title&&this.writeNode("ows:Title",e.title,t),e.data&&this.writeNode("wps:Data",e.data,t),e.reference&&this.writeNode("wps:Reference",e.reference,t),e.boundingBoxData&&this.writeNode("wps:BoundingBoxData",e.boundingBoxData,t),t},Data:function(e){var t=this.createElementNSPlus("wps:Data",{});return e.literalData?this.writeNode("wps:LiteralData",e.literalData,t):e.complexData?this.writeNode("wps:ComplexData",e.complexData,t):e.boundingBoxData&&this.writeNode("ows:BoundingBox",e.boundingBoxData,t),t},LiteralData:function(e){return this.createElementNSPlus("wps:LiteralData",{attributes:{uom:e.uom},value:e.value})},ComplexData:function(e){var t=this.createElementNSPlus("wps:ComplexData",{attributes:{mimeType:e.mimeType,encoding:e.encoding,schema:e.schema}}),o=e.value;return"string"==typeof o?t.appendChild(this.getXMLDoc().createCDATASection(e.value)):t.appendChild(o),t},Reference:function(e){var t=this.createElementNSPlus("wps:Reference",{attributes:{mimeType:e.mimeType,"xlink:href":e.href,method:e.method,encoding:e.encoding,schema:e.schema}});return e.body&&this.writeNode("wps:Body",e.body,t),t},BoundingBoxData:function(e,t){this.writers.ows.BoundingBox.apply(this,[e,t,"wps:BoundingBoxData"])},Body:function(e){var t=this.createElementNSPlus("wps:Body",{});return e.wcs?this.writeNode("wcs:GetCoverage",e.wcs,t):e.wfs?(this.featureType=e.wfs.featureType,this.version=e.wfs.version,this.writeNode("wfs:GetFeature",e.wfs,t)):this.writeNode("wps:Execute",e,t),t}},wcs:GeoGlobe.Format.WCSGetCoverage.prototype.writers.wcs,wfs:GeoGlobe.Format.WFST.v1_1_0.prototype.writers.wfs,ogc:GeoGlobe.Format.Filter.v1_1_0.prototype.writers.ogc,ows:GeoGlobe.Format.OWSCommon.v1_1_0.prototype.writers.ows},readers:{wps:{ExecuteResponse:function(e,t){t.executeResponse={lang:e.getAttribute("lang"),statusLocation:e.getAttribute("statusLocation"),serviceInstance:e.getAttribute("serviceInstance"),service:e.getAttribute("service")},this.readChildNodes(e,t.executeResponse)},Process:function(e,t){t.process={},this.readChildNodes(e,t.process)},Status:function(e,t){t.status={creationTime:e.getAttribute("creationTime")},this.readChildNodes(e,t.status)},ProcessSucceeded:function(e,t){t.processSucceeded=!0},ProcessOutputs:function(e,t){t.processOutputs=[],this.readChildNodes(e,t.processOutputs)},Output:function(e,t){var o={};this.readChildNodes(e,o),t.push(o)},Reference:function(e,t){t.reference={href:e.getAttribute("href"),mimeType:e.getAttribute("mimeType"),encoding:e.getAttribute("encoding"),schema:e.getAttribute("schema")}},Data:function(e,t){t.data={},this.readChildNodes(e,t)},LiteralData:function(e,t){t.literalData={dataType:e.getAttribute("dataType"),uom:e.getAttribute("uom"),value:this.getChildValue(e)}},ComplexData:function(e,t){var o;if(t.complexData={mimeType:e.getAttribute("mimeType"),schema:e.getAttribute("schema"),encoding:e.getAttribute("encoding"),value:""},this.isSimpleContent(e))for(o=e.firstChild;o;o=o.nextSibling)switch(o.nodeType){case 3:case 4:t.complexData.value+=o.nodeValue}else for(o=e.firstChild;o;o=o.nextSibling)1==o.nodeType&&(t.complexData.value=o)},BoundingBox:function(e,t){t.boundingBoxData={dimensions:e.getAttribute("dimensions"),crs:e.getAttribute("crs")},this.readChildNodes(e,t.boundingBoxData)}},ows:GeoGlobe.Format.OWSCommon.v1_1_0.prototype.readers.ows},CLASS_NAME:"GeoGlobe.Format.WPSExecute"}),GeoGlobe.Format.OGCExceptionReport=GeoGlobe.Class4OL(GeoGlobe.Format.XML,{namespaces:{ogc:"http://www.opengis.net/ogc"},regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},defaultPrefix:"ogc",read:function(e){"string"==typeof e&&(e=GeoGlobe.Format.XML.prototype.read.apply(this,[e]));var t={exceptionReport:null};return e.documentElement&&(this.readChildNodes(e,t),null===t.exceptionReport&&(t=(new GeoGlobe.Format.OWSCommon).read(e))),t},readers:{ogc:{ServiceExceptionReport:function(e,t){t.exceptionReport={exceptions:[]},this.readChildNodes(e,t.exceptionReport)},ServiceException:function(e,t){var o={code:e.getAttribute("code"),locator:e.getAttribute("locator"),text:this.getChildValue(e)};t.exceptions.push(o)}}},CLASS_NAME:"GeoGlobe.Format.OGCExceptionReport"}),GeoGlobe.Format.QueryStringFilter=function(){var e={};return e[GeoGlobe.Filter.Comparison.EQUAL_TO]="eq",e[GeoGlobe.Filter.Comparison.NOT_EQUAL_TO]="ne",e[GeoGlobe.Filter.Comparison.LESS_THAN]="lt",e[GeoGlobe.Filter.Comparison.LESS_THAN_OR_EQUAL_TO]="lte",e[GeoGlobe.Filter.Comparison.GREATER_THAN]="gt",e[GeoGlobe.Filter.Comparison.GREATER_THAN_OR_EQUAL_TO]="gte",e[GeoGlobe.Filter.Comparison.LIKE]="ilike",GeoGlobe.Class4OL(GeoGlobe.Format,{wildcarded:!1,srsInBBOX:!1,write:function(t,o){o=o||{};var r=t.CLASS_NAME,i=r.substring(r.lastIndexOf(".")+1);switch(i){case"Spatial":switch(t.type){case GeoGlobe.Filter.Spatial.BBOX:o.bbox=t.value.toArray(),this.srsInBBOX&&t.projection&&o.bbox.push(t.projection.getCode());break;case GeoGlobe.Filter.Spatial.DWITHIN:o.tolerance=t.distance;case GeoGlobe.Filter.Spatial.WITHIN:o.lon=t.value.x,o.lat=t.value.y;break;default:GeoGlobe.Console.warn("Unknown spatial filter type "+t.type)}break;case"Comparison":var n=e[t.type];if(void 0!==n){var s=t.value;t.type==GeoGlobe.Filter.Comparison.LIKE&&(s=s.replace(/%/g,"\\%").replace(/\\\\\.(\*)?/g,function(e,t){return t?e:"\\\\_"}).replace(/\\\\\.\*/g,"\\\\%").replace(/(\\)?\.(\*)?/g,function(e,t,o){return t||o?e:"_"}).replace(/(\\)?\.\*/g,function(e,t){return t?e:"%"}).replace(/\\\./g,".").replace(/(\\)?\\\*/g,function(e,t){return t?e:"*"}),this.wildcarded&&(s="%"+s+"%")),o[t.property+"__"+n]=s,o.queryable=o.queryable||[],o.queryable.push(t.property)}else GeoGlobe.Console.warn("Unknown comparison filter type "+t.type);break;case"Logical":if(t.type===GeoGlobe.Filter.Logical.AND)for(var a=0,l=t.filters.length;a<l;a++)o=this.write(t.filters[a],o);else GeoGlobe.Console.warn("Unsupported logical filter type "+t.type);break;default:GeoGlobe.Console.warn("Unknown filter type "+i)}return o},CLASS_NAME:"GeoGolobe.Format.QueryStringFilter"})}(),GeoGlobe.Format.BusCapabilities=GeoGlobe.Class4OL(GeoGlobe.Format.XML,{tagName:"NETWORK_Capabilities",read:function(e){var t;"string"==typeof e&&(e=GeoGlobe.Format.XML.prototype.read.apply(this,[e]));var o={};return(t=e.nodeName!=this.tagName?e.getElementsByTagName(this.tagName):[e]).length>0&&this.runChildNodes(o,t[0]),o},runChildNodes:function(e,t,o){for(var r,i,n=t.childNodes,s=0;s<n.length;++s)1==(r=n[s]).nodeType&&(i=o?this["read_"+o+"_"+r.nodeName]:this["read_"+r.nodeName])&&i.apply(this,[e,r])},read_Service:function(e,t){var o={};this.runChildNodes(o,t,"Service"),e.service=o},read_Service_Name:function(e,t){var o=this.getChildValue(t);o&&(e.name=o)},read_Service_Title:function(e,t){var o=this.getChildValue(t);o&&(e.title=o)},read_Service_Abstract:function(e,t){var o=this.getChildValue(t);o&&(e.serviceAbstract=o)},read_Service_KeywordList:function(e,t){},read_Service_OnlineResource:function(e,t){var o=this.getChildValue(t);e&&(e.onlineResource=o)},read_Capability:function(e,t){var o={};this.runChildNodes(o,t,"Capability"),e.capability=o},read_Capability_Request:function(e,t){var o={};this.runChildNodes(o,t,"Capability_Request"),e.request=o},read_Capability_Request_GetCapabilities:function(e,t){var o=t.getElementsByTagName("HTTP"),r={};o[0]&&this.runChildNodes(r,o[0],"Capability_Request_GetCapabilities_DCPType_HTTP"),e.getCapabilities=r},read_Capability_Request_GetCapabilities_DCPType_HTTP_Get:function(e,t){var o=t.getAttribute("onlineResource");o&&(e.getUrl=o)},read_Capability_Request_GetCapabilities_DCPType_HTTP_Post:function(e,t){var o=t.getAttribute("onlineResource");o&&(e.postUrl=o)},read_Capability_Request_queryStation:function(e,t){var o=t.getElementsByTagName("HTTP"),r={};o[0]&&this.runChildNodes(r,o[0],"Capability_Request_queryStation_DCPType_HTTP"),e.queryStation=r},read_Capability_Request_queryStation_DCPType_HTTP_Get:function(e,t){var o=t.getAttribute("onlineResource");o&&(e.getUrl=o)},read_Capability_Request_queryStation_DCPType_HTTP_Post:function(e,t){var o=t.getAttribute("onlineResource");o&&(e.postUrl=o)},read_Capability_Request_queryLine:function(e,t){var o=t.getElementsByTagName("HTTP"),r={};o[0]&&this.runChildNodes(r,o[0],"Capability_Request_queryLine_DCPType_HTTP"),e.queryLine=r},read_Capability_Request_queryLine_DCPType_HTTP_Get:function(e,t){var o=t.getAttribute("onlineResource");o&&(e.getUrl=o)},read_Capability_Request_queryLine_DCPType_HTTP_Post:function(e,t){var o=t.getAttribute("onlineResource");o&&(e.postUrl=o)},read_Capability_Request_queryChange:function(e,t){var o=t.getElementsByTagName("HTTP");o[0]&&this.runChildNodes({},o[0],"Capability_Request_queryChange_DCPType_HTTP")},read_Capability_Request_queryChange_DCPType_HTTP_Get:function(e,t){var o=t.getAttribute("onlineResource");o&&(e.getUrl=o)},read_Capability_Request_queryChange_DCPType_HTTP_Post:function(e,t){var o=t.getAttribute("onlineResource");o&&(e.postUrl=o)},read_Capability_Networks:function(e,t){for(var o=t.getElementsByTagName("Name"),r=[],i=0;i<o.length;i++){var n=this.getChildValue(o[i]);n&&r.push(n)}e.networks=r},CLASS_NAME:"GeoGlobe.Format.BusCapabilities"}),GeoGlobe.Format.XML2JSON=GeoGlobe.Class4OL({initialize:function(){},read:function(e,t,o){t||(t=""),e=(e=e.replace(/\s*\/>/g,"/>")).replace(/<\?[^>]*>/g,"").replace(/<\![^>]*>/g,""),t.sort||(t=t.split(","));var r=this.no_fast_endings(e);r=this.attris_to_tags(r),r=(r=escape(r)).split("%3C").join("<").split("%3E").join(">").split("%3D").join("=").split("%22").join('"');for(var i=0;i<t.length;i++)r=(r=r.replace(new RegExp("<"+t[i]+">","g"),"*$**"+t[i]+"**$*")).replace(new RegExp("</"+t[i]+">","g"),"*$***"+t[i]+"**$*");r="<JSONTAGWRAPPER>"+r+"</JSONTAGWRAPPER>",this.xmlobject={};var n=this.xml_to_object(r).JSONTAGWRAPPER;return o&&(n=this.show_json_structure(n,o)),n},xml_to_object:function(xmlcode){var x=xmlcode.replace(/<\//g,"?");x=x.split("<");for(var y=[],level=0,opentags=[],i=1;i<x.length;i++){var tagname=x[i].split(">")[0];for(opentags.push(tagname),level++,y.push(level+"<"+x[i].split("?")[0]);x[i].indexOf("?"+opentags[opentags.length-1]+">")>=0;)level--,opentags.pop()}for(var oldniva=-1,objname="this.xmlobject",i=0;i<y.length;i++){var preeval="",niva=y[i].split("<")[0],tagnamn=y[i].split("<")[1].split(">")[0];tagnamn=tagnamn.replace(/%3A/,"_");var rest=y[i].split(">")[1];if(niva<=oldniva)for(var tabort=oldniva-niva+1,j=0;j<tabort;j++)objname=objname.substring(0,objname.lastIndexOf("."));objname+="."+tagnamn;var pobject=objname.substring(0,objname.lastIndexOf("."));"object"!=eval("typeof "+pobject)&&(preeval+=pobject+"={value:"+pobject+"};\n");var objlast=objname.substring(objname.lastIndexOf(".")+1),already=!1;for(k in eval(pobject))k==objlast&&(already=!0);for(var onlywhites=!0,s=0;s<rest.length;s+=3)"%"!=rest.charAt(s)&&(onlywhites=!1);""==rest||onlywhites?rest="{}":rest/1!=rest&&(rest="'"+rest.replace(/\'/g,"\\'")+"'",rest=rest.replace(/\*\$\*\*\*/g,"</"),rest=rest.replace(/\*\$\*\*/g,"<"),rest=rest.replace(/\*\*\$\*/g,">")),"'"==rest.charAt(0)&&(rest="unescape("+rest+")"),already&&!eval(objname+".sort")&&(preeval+=objname+"=["+objname+"];\n");var before="=";after="",already&&(before=".push(",after=")");var toeval=preeval+objname+before+rest+after;eval(toeval),eval(objname+".sort")&&(objname+="["+eval(objname+".length-1")+"]"),oldniva=niva}return this.xmlobject},show_json_structure:function(e,t,o){var r="";e.sort?r+="[\n":r+="{\n";for(var i in e){if(e.sort||(r+=i+":"),"object"==typeof e[i])r+=this.show_json_structure(e[i],!1,1);else if("function"==typeof e[i])r+=e[i]+"";else"string"!=typeof e[i]?r+=e[i]+",\n":r+="'"+e[i].replace(/\'/g,"\\'").replace(/\n/g,"\\n").replace(/\t/g,"\\t").replace(/\r/g,"\\r")+"',\n"}if(e.sort?r+="],\n":r+="},\n",!o){var n=(r=(r=(r=r.substring(0,r.lastIndexOf(","))).replace(new RegExp(",\n}","g"),"\n}")).replace(new RegExp(",\n]","g"),"\n]")).split("\n");r="";var s=0;for(i=0;i<n.length;i++){(n[i].indexOf("}")>=0||n[i].indexOf("]")>=0)&&s--,tabs="";for(var a=0;a<s;a++)tabs+="\t";r+=tabs+n[i]+"\n",(n[i].indexOf("{")>=0||n[i].indexOf("[")>=0)&&s++}"html"==t&&(r=(r=r.replace(/</g,"&lt;").replace(/>/g,"&gt;")).replace(/\n/g,"<BR>").replace(/\t/g,"&nbsp;&nbsp;&nbsp;&nbsp;")),"compact"==t&&(r=r.replace(/\n/g,"").replace(/\t/g,""))}return r},no_fast_endings:function(e){e=e.split("/>");for(var t=1;t<e.length;t++){var o=e[t-1].substring(e[t-1].lastIndexOf("<")+1).split(" ")[0];e[t]="></"+o+">"+e[t]}return e=e.join("")},attris_to_tags:function(e){var t=" =\"'".split("");e=e.split(">");for(var o=0;o<e.length;o++){for(var r=e[o].split("<"),i=0;i<4;i++)r[0]=r[0].replace(new RegExp(t[i],"g"),"_jsonconvtemp"+i+"_");if(r[1]){r[1]=r[1].replace(/'/g,'"'),r[1]=r[1].split('"');for(var n=1;n<r[1].length;n+=2)for(i=0;i<4;i++)r[1][n]=r[1][n].replace(new RegExp(t[i],"g"),"_jsonconvtemp"+i+"_");r[1]=r[1].join('"')}e[o]=r.join("<")}e=(e=(e=e.join(">")).replace(/ ([^=]*)=([^ |>]*)/g,"><$1>$2</$1")).replace(/>"/g,">").replace(/"</g,"<");for(i=0;i<4;i++)e=e.replace(new RegExp("_jsonconvtemp"+i+"_","g"),t[i]);return e},CLASS_NAME:"GeoGlobe.Format.XML2JSON"}),GeoGlobe.Format.CSWGetRecords=function(e){e=GeoGlobe.Util.applyDefaults(e,GeoGlobe.Format.CSWGetRecords.DEFAULTS);var t=GeoGlobe.Format.CSWGetRecords["v"+e.version.replace(/\./g,"_")];if(!t)throw"Unsupported CSWGetRecords version: "+e.version;return new t(e)},GeoGlobe.Format.CSWGetRecords.DEFAULTS={version:"2.0.2"},GeoGlobe.Format.CSWGetRecords.v2_0_2=GeoGlobe.Class4OL(GeoGlobe.Format.XML,{namespaces:{csw:"http://www.opengis.net/cat/csw/2.0.2",dc:"http://purl.org/dc/elements/1.1/",dct:"http://purl.org/dc/terms/",gmd:"http://www.isotc211.org/2005/gmd",geonet:"http://www.fao.org/geonetwork",ogc:"http://www.opengis.net/ogc",ows:"http://www.opengis.net/ows",xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance"},defaultPrefix:"csw",version:"2.0.2",schemaLocation:"http://www.opengis.net/cat/csw/2.0.2 http://schemas.opengis.net/csw/2.0.2/CSW-discovery.xsd",requestId:null,resultType:null,outputFormat:null,outputSchema:null,startPosition:null,maxRecords:null,DistributedSearch:null,ResponseHandler:null,Query:null,regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},initialize:function(e){GeoGlobe.Format.XML.prototype.initialize.apply(this,[e])},read:function(e){"string"==typeof e&&(e=GeoGlobe.Format.XML.prototype.read.apply(this,[e])),e&&9==e.nodeType&&(e=e.documentElement);var t={};return this.readNode(e,t),t},readers:{csw:{GetRecordsResponse:function(e,t){t.records=[],this.readChildNodes(e,t);var o=this.getAttributeNS(e,"","version");""!=o&&(t.version=o)},RequestId:function(e,t){t.RequestId=this.getChildValue(e)},SearchStatus:function(e,t){t.SearchStatus={};var o=this.getAttributeNS(e,"","timestamp");""!=o&&(t.SearchStatus.timestamp=o)},SearchResults:function(e,t){this.readChildNodes(e,t);for(var o=e.attributes,r={},i=0,n=o.length;i<n;++i)"numberOfRecordsMatched"==o[i].name||"numberOfRecordsReturned"==o[i].name||"nextRecord"==o[i].name?r[o[i].name]=parseInt(o[i].nodeValue):r[o[i].name]=o[i].nodeValue;t.SearchResults=r},SummaryRecord:function(e,t){var o={type:"SummaryRecord"};this.readChildNodes(e,o),t.records.push(o)},BriefRecord:function(e,t){var o={type:"BriefRecord"};this.readChildNodes(e,o),t.records.push(o)},DCMIRecord:function(e,t){var o={type:"DCMIRecord"};this.readChildNodes(e,o),t.records.push(o)},Record:function(e,t){var o={type:"Record"};this.readChildNodes(e,o),t.records.push(o)},"*":function(e,t){t[e.localName||e.nodeName.split(":").pop()]=this.getChildValue(e)}},geonet:{info:function(e,t){var o={};this.readChildNodes(e,o),t.gninfo=o}},dc:{"*":function(e,t){var o=e.localName||e.nodeName.split(":").pop();GeoGlobe.Util.isArray(t[o])||(t[o]=[]);for(var r={},i=e.attributes,n=0,s=i.length;n<s;++n)r[i[n].name]=i[n].nodeValue;r.value=this.getChildValue(e),""!=r.value&&t[o].push(r)}},dct:{"*":function(e,t){var o=e.localName||e.nodeName.split(":").pop();GeoGlobe.Util.isArray(t[o])||(t[o]=[]),t[o].push(this.getChildValue(e))}},ows:GeoGlobe.Util.applyDefaults({BoundingBox:function(e,t){t.bounds&&(t.BoundingBox=[{crs:t.projection,value:[t.bounds._sw.lng,t.bounds._sw.lat,t.bounds._ne.lng,t.bounds._ne.lat]}],delete t.projection,delete t.bounds),GeoGlobe.Format.OWSCommon.v1_0_0.prototype.readers.ows.BoundingBox.apply(this,arguments)}},GeoGlobe.Format.OWSCommon.v1_0_0.prototype.readers.ows)},write:function(e){var t=this.writeNode("csw:GetRecords",e);return t.setAttribute("xmlns:gmd",this.namespaces.gmd),GeoGlobe.Format.XML.prototype.write.apply(this,[t])},writers:{csw:{GetRecords:function(e){e||(e={});var t=this.createElementNSPlus("csw:GetRecords",{attributes:{service:"CSW",version:this.version,requestId:e.requestId||this.requestId,resultType:e.resultType||this.resultType,outputFormat:e.outputFormat||this.outputFormat,outputSchema:e.outputSchema||this.outputSchema,startPosition:e.startPosition||this.startPosition,maxRecords:e.maxRecords||this.maxRecords}});(e.DistributedSearch||this.DistributedSearch)&&this.writeNode("csw:DistributedSearch",e.DistributedSearch||this.DistributedSearch,t);var o=e.ResponseHandler||this.ResponseHandler;if(GeoGlobe.Util.isArray(o)&&o.length>0)for(var r=0,i=o.length;r<i;r++)this.writeNode("csw:ResponseHandler",o[r],t);return this.writeNode("Query",e.Query||this.Query,t),t},DistributedSearch:function(e){return this.createElementNSPlus("csw:DistributedSearch",{attributes:{hopCount:e.hopCount}})},ResponseHandler:function(e){return this.createElementNSPlus("csw:ResponseHandler",{value:e.value})},Query:function(e){e||(e={});var t=this.createElementNSPlus("csw:Query",{attributes:{typeNames:e.typeNames||"csw:Record"}}),o=e.ElementName;if(GeoGlobe.Util.isArray(o)&&o.length>0)for(var r=0,i=o.length;r<i;r++)this.writeNode("csw:ElementName",o[r],t);else this.writeNode("csw:ElementSetName",e.ElementSetName||{value:"summary"},t);return e.Constraint&&this.writeNode("csw:Constraint",e.Constraint,t),e.SortBy&&this.writeNode("ogc:SortBy",e.SortBy,t),t},ElementName:function(e){return this.createElementNSPlus("csw:ElementName",{value:e.value})},ElementSetName:function(e){return this.createElementNSPlus("csw:ElementSetName",{attributes:{typeNames:e.typeNames},value:e.value})},Constraint:function(e){var t=this.createElementNSPlus("csw:Constraint",{attributes:{version:e.version}});if(e.Filter){var o=new GeoGlobe.Format.Filter({version:e.version});t.appendChild(o.write(e.Filter))}else if(e.CqlText){var r=this.createElementNSPlus("CqlText",{value:e.CqlText.value});t.appendChild(r)}return t}},ogc:GeoGlobe.Format.Filter.v1_1_0.prototype.writers.ogc},CLASS_NAME:"GeoGlobe.Format.CSWGetRecords.v2_0_2"}),function(e,t){e.GeoGlobe.Format.X2JS=function(e){"use strict";e=e||{},void 0===e.escapeMode&&(e.escapeMode=!0),e.attributePrefix=e.attributePrefix||"_",e.arrayAccessForm=e.arrayAccessForm||"none",e.emptyNodeForm=e.emptyNodeForm||"text",void 0===e.enableToStringFunc&&(e.enableToStringFunc=!0),e.arrayAccessFormPaths=e.arrayAccessFormPaths||[],void 0===e.skipEmptyTextNodesForObj&&(e.skipEmptyTextNodesForObj=!0),void 0===e.stripWhitespaces&&(e.stripWhitespaces=!0),e.datetimeAccessFormPaths=e.datetimeAccessFormPaths||[],void 0===e.useDoubleQuotes&&(e.useDoubleQuotes=!1),e.xmlElementsFilter=e.xmlElementsFilter||[],e.jsonPropertiesFilter=e.jsonPropertiesFilter||[],void 0===e.keepCData&&(e.keepCData=!1);var t={ELEMENT_NODE:1,TEXT_NODE:3,CDATA_SECTION_NODE:4,COMMENT_NODE:8,DOCUMENT_NODE:9};function o(e){var t=e.localName;return null==t&&(t=e.baseName),null!=t&&""!=t||(t=e.nodeName),t}function r(e){return"string"==typeof e?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;"):e}function i(e,t,o,r){for(var i=0;i<e.length;i++){var n=e[i];if("string"==typeof n){if(n==r)break}else if(n instanceof RegExp){if(n.test(r))break}else if("function"==typeof n&&n(t,o,r))break}return i!=e.length}function n(t,o,r){switch(e.arrayAccessForm){case"property":t[o]instanceof Array?t[o+"_asArray"]=t[o]:t[o+"_asArray"]=[t[o]]}!(t[o]instanceof Array)&&e.arrayAccessFormPaths.length>0&&i(e.arrayAccessFormPaths,t,o,r)&&(t[o]=[t[o]])}function s(e){var t=e.split(/[-T:+Z]/g),o=new Date(t[0],t[1]-1,t[2]),r=t[5].split(".");if(o.setHours(t[3],t[4],r[0]),r.length>1&&o.setMilliseconds(r[1]),t[6]&&t[7]){var i=60*t[6]+Number(t[7]),n=/\d\d-\d\d:\d\d$/.test(e)?"-":"+";i=0+("-"==n?-1*i:i),o.setMinutes(o.getMinutes()-i-o.getTimezoneOffset())}else-1!==e.indexOf("Z",e.length-1)&&(o=new Date(Date.UTC(o.getFullYear(),o.getMonth(),o.getDate(),o.getHours(),o.getMinutes(),o.getSeconds(),o.getMilliseconds())));return o}function a(o,r,n,s){return!(r==t.ELEMENT_NODE&&e.xmlElementsFilter.length>0)||i(e.xmlElementsFilter,o,n,s)}function l(r,u){if(r.nodeType==t.DOCUMENT_NODE){for(var c=new Object,p=r.childNodes,h=0;h<p.length;h++){var f=p.item(h);if(f.nodeType==t.ELEMENT_NODE){var d=o(f);c[d]=l(f,d)}}return c}if(r.nodeType==t.ELEMENT_NODE){var c=new Object;c.__cnt=0;for(var p=r.childNodes,h=0;h<p.length;h++){var f=p.item(h),d=o(f);if(f.nodeType!=t.COMMENT_NODE){var G=u+"."+d;a(c,f.nodeType,d,G)&&(c.__cnt++,null==c[d]?(c[d]=l(f,G),n(c,d,G)):(null!=c[d]&&(c[d]instanceof Array||(c[d]=[c[d]],n(c,d,G))),c[d][c[d].length]=l(f,G)))}}for(var m=0;m<r.attributes.length;m++){var g=r.attributes.item(m);c.__cnt++,c[e.attributePrefix+g.name]=g.value}var y=r.prefix;return null!=y&&""!=y&&(c.__cnt++,c.__prefix=y),null!=c["#text"]&&(c.__text=c["#text"],c.__text instanceof Array&&(c.__text=c.__text.join("\n")),e.stripWhitespaces&&(c.__text=c.__text.trim()),delete c["#text"],"property"==e.arrayAccessForm&&delete c["#text_asArray"],c.__text=function(t,o,r){if(e.datetimeAccessFormPaths.length>0){var n=r.split(".#")[0];return i(e.datetimeAccessFormPaths,t,o,n)?s(t):t}return t}(c.__text,d,u+"."+d)),null!=c["#cdata-section"]&&(c.__cdata=c["#cdata-section"],delete c["#cdata-section"],"property"==e.arrayAccessForm&&delete c["#cdata-section_asArray"]),0==c.__cnt&&"text"==e.emptyNodeForm?c="":1==c.__cnt&&null!=c.__text?c=c.__text:1!=c.__cnt||null==c.__cdata||e.keepCData?c.__cnt>1&&null!=c.__text&&e.skipEmptyTextNodesForObj&&(e.stripWhitespaces&&""==c.__text||""==c.__text.trim())&&delete c.__text:c=c.__cdata,delete c.__cnt,!e.enableToStringFunc||null==c.__text&&null==c.__cdata||(c.toString=function(){return(null!=this.__text?this.__text:"")+(null!=this.__cdata?this.__cdata:"")}),c}if(r.nodeType==t.TEXT_NODE||r.nodeType==t.CDATA_SECTION_NODE)return r.nodeValue}function u(t,o,i,n){var s="<"+(null!=t&&null!=t.__prefix?t.__prefix+":":"")+o;if(null!=i)for(var a=0;a<i.length;a++){var l=i[a],u=t[l];e.escapeMode&&(u=r(u)),s+=" "+l.substr(e.attributePrefix.length)+"=",e.useDoubleQuotes?s+='"'+u+'"':s+="'"+u+"'"}return s+=n?"/>":">"}function c(e,t){return"</"+(null!=e.__prefix?e.__prefix+":":"")+t+">"}function p(t,o){return"property"==e.arrayAccessForm&&(r=o.toString(),i="_asArray",-1!==r.indexOf(i,r.length-i.length))||0==o.toString().indexOf(e.attributePrefix)||0==o.toString().indexOf("__")||t[o]instanceof Function;var r,i}function h(e){var t=0;if(e instanceof Object)for(var o in e)p(e,o)||t++;return t}function f(t){var o=[];if(t instanceof Object)for(var r in t)-1==r.toString().indexOf("__")&&0==r.toString().indexOf(e.attributePrefix)&&o.push(r);return o}function d(t){var o,i,n="";return t instanceof Object?n+=(i="",null!=(o=t).__cdata&&(i+="<![CDATA["+o.__cdata+"]]>"),null!=o.__text&&(e.escapeMode?i+=r(o.__text):i+=o.__text),i):null!=t&&(e.escapeMode?n+=r(t):n+=t),n}function G(e,t){return""===e?t:e+"."+t}function m(e,t,o,r){var i="";if(0==e.length)i+=u(e,t,o,!0);else for(var n=0;n<e.length;n++)i+=u(e[n],t,f(e[n]),!1),i+=g(e[n],G(r,t)),i+=c(e[n],t);return i}function g(t,o){var r,n,s,a="",l=h(t);if(l>0)for(var y in t)if(!p(t,y)&&(""==o||(r=t,n=y,s=G(o,y),0==e.jsonPropertiesFilter.length||""==s||i(e.jsonPropertiesFilter,r,n,s)))){var b=t[y],S=f(b);if(null==b||void 0==b)a+=u(b,y,S,!0);else if(b instanceof Object)if(b instanceof Array)a+=m(b,y,S,o);else if(b instanceof Date)a+=u(b,y,S,!1),a+=b.toISOString(),a+=c(b,y);else{var v=h(b);v>0||null!=b.__text||null!=b.__cdata?(a+=u(b,y,S,!1),a+=g(b,G(o,y)),a+=c(b,y)):a+=u(b,y,S,!0)}else a+=u(b,y,S,!1),a+=d(b),a+=c(b,y)}return a+=d(t)}this.parseXmlString=function(e){var t,o=window.ActiveXObject||"ActiveXObject"in window;if(void 0===e)return null;if(window.DOMParser){var r=new window.DOMParser,i=null;if(!o)try{i=r.parseFromString("INVALID","text/xml").getElementsByTagName("parsererror")[0].namespaceURI}catch(e){i=null}try{t=r.parseFromString(e,"text/xml"),null!=i&&t.getElementsByTagNameNS(i,"parsererror").length>0&&(t=null)}catch(e){t=null}}else 0==e.indexOf("<?")&&(e=e.substr(e.indexOf("?>")+2)),(t=new ActiveXObject("Microsoft.XMLDOM")).async="false",t.loadXML(e);return t},this.asArray=function(e){return void 0===e||null==e?[]:e instanceof Array?e:[e]},this.toXmlDateTime=function(e){return e instanceof Date?e.toISOString():"number"==typeof e?new Date(e).toISOString():null},this.asDateTime=function(e){return"string"==typeof e?s(e):e},this.xml2json=function(e){return l(e)},this.xml_str2json=function(e){var t=this.parseXmlString(e);return null!=t?this.xml2json(t):null},this.json2xml_str=function(e){return g(e,"")},this.json2xml=function(e){var t=this.json2xml_str(e);return this.parseXmlString(t)},this.getVersion=function(){return"1.2.0"}},e.GeoGlobe.Format.X2JS.CLASS_NAME="GeoGlobe.Format.X2JS"}(window),GeoGlobe.Query.Service=GeoGlobe.Class4OL({name:null,url:null,version:null,userid:"test@liferay.com",initialize:function(e,t,o){this.name=e,this.url=t,GeoGlobe.Util.extend(this,o)},getCapabilities:function(e,t){},isExist:function(){},failFn:function(e){alert("服务请求失败，请检查服务是否正常运行或请求地址是否正确。\n请求地址："+this.url+"\n操作类型："+e)},_parseToXML:function(e){var t=e.responseXML;return t&&t.documentElement||(t=e.responseText),(new GeoGlobe.Format.XML).read(t)},_checkIsError:function(e){return(new GeoGlobe.Format.XML).read(e).selectNodes("ServiceExceptionReport").length>0?this._parseToJSON(e):null},_isException:function(e){return!(!e||!e.ServiceExceptionReport)},_parseToJSON:function(e){return(new GeoGlobe.Util.Format.XML2JSON).read(e)},CLASS_NAME:"GeoGlobe.Query.Service"}),GeoGlobe.Query.RouteQuery=GeoGlobe.Class4OL(GeoGlobe.Query.Service,{_format:null,initialize:function(e,t,o){this.name=e,this.url=t,this._format=new GeoGlobe.Format.RouteQuery,GeoGlobe.Util.extend(this,o)},getCapabilities:function(e,t){var o=this.url;GeoGlobe.loadURL(o,{REQUEST:"GetCapabilities"},this,e,t)},findRoute:function(e,t,o){var r={REQUEST:"FindRoute",SERVICE:"ROUTE",VERSION:"1.0.0"};for(var i in{data:!0,orig:!0,dest:!0})if(!(i in e))throw new Error("Missing property '"+i+"'");r.DATA=e.data,r.ORIG=e.orig,r.DEST=e.dest,null!==e.service&&void 0!==e.service&&(r.SERVICE=e.service),null!==e.version&&void 0!==e.version&&(r.VERSION=e.version),null!==e.radius&&void 0!==e.radius&&(r.RADIUS=e.radius),null!==e.queryType&&void 0!==e.queryType&&(r.QUERYTYPE=e.queryType),null!==e.midpos&&void 0!==e.midpos&&(r.MIDPOS=e.midpos),null!==e.avoidPos&&void 0!==e.avoidPos&&(r.AVOIDPOS=e.avoidPos),null!==e.filterRoute&&void 0!==e.filterRoute&&(r.FILTERROUTE=e.filterRoute),null!==e.resultCount&&void 0!==e.resultCount&&(r.RESULTCOUNT=e.resultCount);GeoGlobe.Request.GET({url:this.url,params:r,async:!1,scope:this,success:function(e){var o=this._format.read(e.responseText);if("string"!=typeof o.exceptionInfo){var r=new GeoGlobe.Query.RoutesResult(o),i=r.routes,n=(new GeoGlobe.Format.GeoJSON).write(i),s=new GeoGlobe.Format.JSON;geojsonRoute=s.read(n),r.geojsonRoute=geojsonRoute,t(r)}else t(o)},failure:o})},getRouteInfo:function(e,t,o){var r={REQUEST:"GetRouteInfo",SERVICE:"ROUTE",VERSION:"1.0.0"};if(!e.data||!e.id)throw"Error!Not data and id for bus query.";r.DATA=e.data,r.ID=e.id;GeoGlobe.Request.GET({url:this.url,params:r,scope:this,success:function(e){var o=this._format.read(e.responseText);"string"!=typeof o.exceptionInfo?(o=new GeoGlobe.Query.RouteInfoResult(o),t(o)):t(o)},failure:o})},CLASS_NAME:"GeoGlobe.Query.RouteQuery"}),GeoGlobe.Format.RouteQuery=new GeoGlobe.Class4OL(GeoGlobe.Format.XML,{initialize:function(e){GeoGlobe.Format.XML.prototype.initialize.apply(this,[e])},read:function(e){var t={},o=[];if("string"==typeof e&&(e=GeoGlobe.Format.XML.prototype.read.apply(this,[e])),e&&9==e.nodeType){o=[];var r=GeoGlobe.Format.XML.prototype.getChildEl.apply(this,[e]).nodeName;if("ServiceExceptionReport"===r){var i=GeoGlobe.Format.XML.prototype.getElementsByTagNameNS(e,"*","ServiceException")[0];return{exceptionInfo:GeoGlobe.Format.XML.prototype.getChildValue.apply(this,[i]),exceptionCode:i.getAttribute("code")}}for(var n=e.getElementsByTagName(r)[0].childNodes,s=0;s<n.length;s++){var a=n[s],l=a.nodeName;this._resultPaser[r][l]&&this._resultPaser[r][l].apply(this,[a,o])}}return"routeinfo"===(r=r.toLowerCase())?t.items=o:t[r]=o,t},_resultPaser:{RouteInfo:{Item:function(e,t){var o=e.childNodes,r=e.getAttribute("id"),i={};r&&(i={id:r});for(var n=0;n<o.length;n++){var s=(e=o[n]).nodeName;this._resultPaser.RouteInfo[s]&&this._resultPaser.RouteInfo[s].apply(this,[e,i])}t.push(i)},Name:function(e,t){var o=GeoGlobe.Format.XML.prototype.getChildValue.apply(this,[e]);o&&(t.name=o)},Toll:function(e,t){var o=GeoGlobe.Format.XML.prototype.getChildValue.apply(this,[e]);t.toll=o},Level:function(e,t){var o=GeoGlobe.Format.XML.prototype.getChildValue.apply(this,[e]);t.level=o},Length:function(e,t){var o=GeoGlobe.Format.XML.prototype.getChildValue.apply(this,[e]);t.length=o},Geometry:function(e,t){var o=GeoGlobe.Format.XML.prototype.getElementsByTagNameNS(e,"*","LineString")[0];if(o){var r=GeoGlobe.Format.XML.prototype.getChildValue.apply(this,[o]);if("string"==typeof r&&r.length>0){for(var i=r.split(" "),n=[],s=0,a=i.length;s<a;s++){var l=i[s].split(",");n.push(new GeoGlobe.Geometry.Point(new Number(l[0]),new Number(l[1])))}var u=new GeoGlobe.Geometry.LineString(n);t.geometry=u}}},Directions:function(e,t){t.directions=[];for(var o=e.childNodes,r=0;r<o.length;r++){var i=(e=o[r]).nodeName;this._resultPaser.RouteInfo[i]&&this._resultPaser.RouteInfo[i](e,t.directions)}},Direction:function(e,t){var o={},r=GeoGlobe.Format.XML.prototype.getChildValue.apply(this,[e]);o.direction=r,o.nextID=e.getAttribute("nextID"),o.nextItem=e.getAttribute("nextItem"),t.push(o)}},Routes:{Route:function(e,t){for(var o=e.childNodes,r={},i=0;i<o.length;i++){var n=(e=o[i]).nodeName;this._resultPaser.Routes[n]&&this._resultPaser.Routes[n].apply(this,[e,r])}t.push(r)},Item:function(e,t){GeoGlobe.Util.isArray(t.items)||(t.items=[]);var o=e.childNodes,r=e.getAttribute("id"),i={};r&&(i={id:r});for(var n=0;n<o.length;n++){var s=(e=o[n]).nodeName;this._resultPaser.Routes[s]&&this._resultPaser.Routes[s].apply(this,[e,i])}t.items.push(i)},Distance:function(e,t){var o=GeoGlobe.Format.XML.prototype.getChildValue.apply(this,[e]);t.distance=o},Name:function(e,t){var o=GeoGlobe.Format.XML.prototype.getChildValue.apply(this,[e]);o&&(t.name=o)},Length:function(e,t){var o=GeoGlobe.Format.XML.prototype.getChildValue.apply(this,[e]);t.length=o},Direction:function(e,t){var o={},r=GeoGlobe.Format.XML.prototype.getChildValue.apply(this,[e]);o.direction=r,o.nextID=e.getAttribute("nextID"),o.nextItem=e.getAttribute("nextItem"),t.direction=o},Geometry:function(e,t){var o=GeoGlobe.Format.XML.prototype.getElementsByTagNameNS(e,"*","LineString")[0];if(o){var r=GeoGlobe.Format.XML.prototype.getChildValue.apply(this,[o]);if("string"==typeof r&&r.length>0){for(var i=r.split(" "),n=[],s=0,a=i.length;s<a;s++){var l=i[s].split(",");n.push(new GeoGlobe.Geometry.Point(new Number(l[0]),new Number(l[1])))}var u=new GeoGlobe.Geometry.LineString(n);t.geometry=u}}},Duration:function(e,t){var o=GeoGlobe.Format.XML.prototype.getChildValue.apply(this,[e]);t.duration=o},BoundingBox:function(e,t){for(var o=e.childNodes,r=0;r<o.length;r++){var i=(e=o[r]).nodeName;this._resultPaser.Routes[i]&&this._resultPaser.Routes[i].apply(this,[e,t])}},LowerCorner:function(e,t){var o=GeoGlobe.Format.XML.prototype.getChildValue.apply(this,[e]).replace(/^\s*|\s*$/g,""),r=(o=o.replace(/\s*,\s*/g,",")).split(",");t.left=r[0],t.bottom=r[1]},UpperCorner:function(e,t){var o=GeoGlobe.Format.XML.prototype.getChildValue.apply(this,[e]).replace(/^\s*|\s*$/g,""),r=(o=o.replace(/\s*,\s*/g,",")).split(",");t.right=r[0],t.top=r[1],t.bounds=new GeoGlobe.LngLatBounds(new GeoGlobe.LngLat(t.left,t.bottom),new GeoGlobe.LngLat(t.right,t.top)),delete t.left,delete t.bottom,delete t.right,delete t.top},Count:function(e,t){var o=GeoGlobe.Format.XML.prototype.getChildValue.apply(this,[e]);t.count=o}}}}),GeoGlobe.Query.RoutesResult=GeoGlobe.Class4OL({data:null,routes:null,initialize:function(e){this.routes=[];var t=null;if(e&&e.routes&&(this.data=e,t=e.routes),GeoGlobe.Util.isArray(t))for(var o=0,r=t.length;o<r;o++){var i=new GeoGlobe.Query.RouteResult;for(var n in t[o])i[n]=t[o][n];this.routes.push(i)}},CLASS_NAME:"GeoGlobe.Query.RoutesResult"}),GeoGlobe.Query.RouteResult=GeoGlobe.Class4OL({bounds:null,count:null,distance:null,duration:null,geometry:null,items:null,initialize:function(){},CLASS_NAME:"GeoGlobe.Query.RouteResult"}),GeoGlobe.Query.RouteInfoResult=GeoGlobe.Class4OL({data:null,items:null,initialize:function(e){if(this.items=[],e&&e.items){this.data=e;var t=e.items}if(GeoGlobe.Util.isArray(t))for(var o=0,r=t.length;o<r;o++){var i=new GeoGlobe.Query.RouteInfoItem;for(var n in t[o])i[n]=t[o][n];this.items.push(i)}},CLASS_NAME:"GeoGlobe.Query.RouteInfoResult"}),GeoGlobe.Query.RouteInfoItem=GeoGlobe.Class4OL({id:null,name:null,toll:null,length:null,geometry:null,level:null,directions:null,initialize:function(){},CLASS_NAME:"GeoGlobe.Query.RouteInfoItem"}),GeoGlobe.Query.BusQuery=GeoGlobe.Class4OL(GeoGlobe.Query.Service,{networkName:null,transferScheme:null,initialize:function(e,t,o){this.name=e,this.url=t,GeoGlobe.Util.extend(this,o)},getCapabilities:function(e,t){"function"!=typeof t&&(t=function(){alert("公交服务请求失败，请检查服务是否正常运行或请求地址是否正确。\n请求地址："+this.url+"\n操作类型：GetCapabilities")}),GeoGlobe.Request.GET({url:this.url,params:{REQUEST:"GetCapabilities"},scope:this,async:!1,success:function(t){"function"==typeof e&&e(t)},failure:t})},isExist:function(){var e=!1,t=this.url;GeoGlobe.Request.GET({url:t,scope:this,async:!1,success:function(){e=!0}});return e},queryStation:function(e,t,o){var r={REQUEST:"QueryStation"};if(!e.networkName)throw"Error!Not network name for bus query.";r.NETWORKNAME=e.networkName,null!==e.stationId&&void 0!==e.stationId&&(r.STATIONID=e.stationId),null!==e.stationName&&void 0!==e.stationName&&(r.STATIONNAME=e.stationName),null!==e.lineId&&void 0!==e.lineId&&(r.LINEID=e.lineId),null!==e.lineName&&void 0!==e.lineName&&(r.LINENAME=e.lineName),null!==e.coordinate&&void 0!==e.coordinate&&(r.COORDINATE=e.coordinate),null!==e.bbox&&void 0!==e.bbox&&(r.BOX=e.bbox);GeoGlobe.Request.GET({url:this.url,params:r,scope:this,success:function(e){var o=this._parserFeatures(e.responseText);t(o)},failure:o})},queryLine:function(e,t,o){var r={REQUEST:"QueryLine"};if(!e.networkName)throw"Error!Not network name for bus query.";r.NETWORKNAME=e.networkName,null!==e.lineName&&void 0!==e.lineName&&(r.LINENAME=e.lineName),null!==e.lineId&&void 0!==e.lineId&&(r.LINEID=e.lineId),null!==e.stationName&&void 0!==e.stationName&&(r.STATIONNAME=e.stationName),null!==e.stationId&&void 0!==e.stationId&&(r.STATIONID=e.stationId),null!==e.coordinate&&void 0!==e.coordinate&&(r.COORDINATE=e.coordinate),null!==e.bbox&&void 0!==e.bbox&&(r.BOX=e.bbox);GeoGlobe.Request.GET({url:this.url,params:r,scope:this,success:function(e){var o=this._parserFeatures(e.responseText);t(o)},failure:o})},queryChange:function(e,t,o){var r={REQUEST:"QueryChange"};if(!e.networkName)throw"Error!Not network name for bus query.";r.NETWORKNAME=e.networkName,null!==e.startStationId&&void 0!==e.startStationId&&(r.STARTSTATIONID=e.startStationId),null!==e.endStationId&&void 0!==e.endStationId&&(r.ENDSTATIONID=e.endStationId),null!==e.orderType&&void 0!==e.orderType&&(r.ORDERTYPE=e.orderType),null!==e.startCoordinate&&void 0!==e.startCoordinate&&(r.STARTCOORDINATE=e.startCoordinate),null!==e.endCoordinate&&void 0!==e.endCoordinate&&(r.ENDCOORDINATE=e.endCoordinate),null!==e.maxDepth&&void 0!==e.maxDepth&&(r.MAXDEPTH=e.maxDepth),null!==e.maxCost&&void 0!==e.maxCost&&(r.MAXCOST=e.maxCost),null!==e.maxSolutions&&void 0!==e.maxSolutions&&(r.MAXSOLUTIONS=e.maxSolutions),null!==e.ChangeCount&&void 0!==e.ChangeCount&&(r.CHANGECOUNT=e.ChangeCount);GeoGlobe.Request.GET({url:this.url,params:r,scope:this,success:function(e){for(var o=[],r=(e.responseXML.documentElement?e.responseXML:format.read(e.responseText)).selectNodes("/Features/FeatureCollection"),i=new GeoGlobe.Format.XML,n=0;n<r.length;n++){var s=r[n],a=this._getAttibutionOfNode(s,["cost","price","walkingDistance","transferTimes"]),l=i.write(r[n]),u=this._parserFeatures(l);u.attributes=a;for(var c=s.selectNodes("featureMember"),p=0;p<c.length;p++){var h=c[p].selectNodes("Road");u[p].isOnFoot=h[0].getAttribute("isOnFoot")}o.push(u)}t(o)},failure:o})},_getAttibutionOfNode:function(e,t){var o={};if(e.tagName)for(var r=0;r<t.length;r++)o[t[r]]=e.getAttribute(t[r]);return o},_getGeometryType:function(e){return"polygon"},_pagingToString:function(e,t){return"<numPerPage>"+(t=t||this.maxPerPage)+"</numPerPage><curPage>"+(e=e||1)+"</curPage>"},_orderByToString:function(e,t){return e?"<orderBy><PropertyName>"+e+"</PropertyName></orderBy>":""},_geometryToString:function(e){return'<geometry><Polygon><outerBoundaryIs><LinearRing><coordinates decimal="." cs="," ts=" ">20,30 21,41 52,42 53,33 20,30</coordinates></LinearRing></outerBoundaryIs></Polygon></geometry>'},_stringToGeometry:function(e){return GeoGlobe.Geometry.Polygon.createRegularPolygon(new GeoGlobe.Geometry.Point(360*Math.random()-160,90*Math.random()-70),Math.round(20*Math.random()),Math.round(10*Math.random()))},_parserFeatures:function(e){var t=new GeoGlobe.Format.GML;return t.gmlns="*",t.read(e)},_parserResponseText:function(e,t){if(t){var o=new RegExp("<"+t+">",["g"]),r=new RegExp("</"+t+">",["g"]);e=(e=e.replace(o,"<featureMember><"+t+">")).replace(r,"</"+t+"></featureMember>")}return e=(e=(e=(e=e.replace(/<gml:LineString>/g,"<gml:LineString><gml:coordinates>")).replace(/<\/gml:LineString>/g,"</gml:coordinates></gml:LineString>")).replace(/<gml:Point>/g,"<gml:Point><gml:coordinates>")).replace(/<\/gml:Point>/g,"</gml:coordinates></gml:Point>")},_parserFeaturesNew:function(e,t){var o=new GeoGlobe.Format.GML;return o.gmlns="*",t&&(o.featureName=t),o.read(e)},_parserSuccessResult:function(e){return(new GeoGlobe.Util.Format.XML2JSON).read(e)},_parseToXML:function(e){var t=e.responseXML;return t&&t.documentElement||(t=e.responseText),(new GeoGlobe.Format.XML).read(t)},_parseToJSON:function(e){return(new GeoGlobe.Format.XML2JSON).read(e)},queryTransferScheme:function(e,t,o){var r={request:"QueryTransferScheme",SERVICE:"BUS",VERSION:"1.0.0"};for(var i in{networkName:!0,transferMode:!0,startInput:!0,endInput:!0})if(!(i in e))throw new Error("缺少必选属性：'"+i+"'。");r.networkName=e.networkName,null!==e.service&&void 0!==e.service&&(r.SERVICE=e.service),null!==e.version&&void 0!==e.version&&(r.VERSION=e.version),null!==e.transferMode&&void 0!==e.transferMode&&(r.TRANSFERMODE=e.transferMode),null!==e.startInput&&void 0!==e.startInput&&(r.STARTINPUT=e.startInput),null!==e.endInput&&void 0!==e.endInput&&(r.ENDINPUT=e.endInput),null!==e.inputMode&&void 0!==e.inputMode&&(r.INPUTMODEL=e.inputMode),null!==e.ExistGoTime&&void 0!==e.ExistGoTime&&(r.EXISTGOTIME=e.ExistGoTime),null!==e.StartTime&&void 0!==e.StartTime&&(r.STARTTIME=e.StartTime),null!==e.MaxSearchDistance&&void 0!==e.MaxSearchDistance&&(r.MAXSEARCHDISTANCE=e.MaxSearchDistance),null!==e.PrioritySubset&&void 0!==e.PrioritySubset&&(r.PRIORITYSUBSET=e.PrioritySubset),null!==e.ExistAbsolutePriority&&void 0!==e.ExistAbsolutePriority&&(r.EXISTABSOLUTEPRIORITY=e.ExistAbsolutePriority),null!==e.LagSubset&&void 0!==e.LagSubset&&(r.LAGSUBSET=e.LagSubset),null!==e.OutputPage&&void 0!==e.OutputPage&&(r.OUTPUTPAGE=e.OutputPage),null!==e.PageSize&&void 0!==e.PageSize&&(r.PAGESIZE=e.PageSize),null!==e.ChangeCount&&void 0!==e.ChangeCount&&(r.CHANGECOUNT=e.ChangeCount);GeoGlobe.Request.GET({url:this.url,params:r,async:!1,scope:this,success:GeoGlobe.Function.bind(function(e){var o=e.responseXML,r={startPoint:[],transferScheme:[],endPoint:[]};if(!o)return t(r),r;var i=new GeoGlobe.Format.XML,n=o.selectNodes("/ServiceExceptionReport/ServiceExceptionMessage");if(n&&n.length>0)return t(r),r;var s=o.selectNodes("/QueryTransferSchemeResponse"),a=i.write(s[0]),l=this._parseToJSON(a),u=l.QueryTransferSchemeResponse.StartPoint;GeoGlobe.Util.isArray(u)||(u=[u]);var c=l.QueryTransferSchemeResponse.EndPoint;GeoGlobe.Util.isArray(c)||(c=[c]);var p=l.QueryTransferSchemeResponse.TransferScheme,h=this._getPointGeometryByGMLPointStr(u[0].Geometry.gml_Point),f=new GeoGlobe.Feature(h),d=this._getPointGeometryByGMLPointStr(c[0].Geometry.gml_Point),G=new GeoGlobe.Feature(d),m=this._parserTransferScheme(p);t(r={startPoint:f,transferScheme:m,endPoint:G})},this),failure:o})},_parserTransferScheme:function(e){GeoGlobe.Util.isArray(e)||(e=[e]);for(var t=new Array,o=0;o<e.length;o++){var r=e[o],i=this._parserSectionInfo(r.SectionInfo),n=this._parserSectionRouting(r.SectionRouting),s={Cost:e[o].Cost,SectionInfo:i,SectionRouting:n,TotalDistance:e[o].TotalDistance,TransferCount:e[o].TransferCount};t.push(s)}return t},_parserSectionInfo:function(e){GeoGlobe.Util.isArray(e)||(e=[e]);for(var t=new Array,o=0;o<e.length;o++){var r=this._getPointFeatureByObj(e[o].FromStation);if(e[o].FromStation.PassagewayRouting)(i=this._getPointFeatureByObj(e[o].FromStation.PassagewayRouting)).SectionRouting&&(i.attributes.SectionRouting=i.data.SectionRouting=this._parserSectionRouting(i.SectionRouting)),r.attributes.PassagewayRouting=r.data.PassagewayRouting=i;var i,n=this._getPointFeatureByObj(e[o].ToStation);if(e[o].ToStation.PassagewayRouting)(i=this._getPointFeatureByObj(e[o].ToStation.PassagewayRouting)).SectionRouting&&(i.attributes.SectionRouting=i.data.SectionRouting=this._parserSectionRouting(i.SectionRouting)),n.attributes.PassagewayRouting=n.data.PassagewayRouting=i;var s=this._parserSectionLines(e[o].SectionLines.SectionLine),a=this._parserSectionRouting(e[o].SectionRouting);t.push({FromStation:r,SectionLine:s,ToStation:n,SectionRouting:a})}return t},_parserSectionLines:function(e){GeoGlobe.Util.isArray(e)||(e=[e]);for(var t=new Array,o=0;o<e.length;o++){var r=new GeoGlobe.Feature(null,e[o]);t.push(r)}return t},_parserSectionRouting:function(e){GeoGlobe.Util.isArray(e)||(e=[e]);for(var t=new Array,o=0;o<e.length;o++)t.push(e[o]);return t},_getPointGeometryByGMLPointStr:function(e){var t=e.split(",");return new GeoGlobe.Geometry.Point(parseFloat(t[0]),parseFloat(t[1]))},_getPointFeatureByObj:function(e){var t=null;return e.Geometry&&e.Geometry.gml_Point&&(t=this._getPointGeometryByGMLPointStr(e.Geometry.gml_Point)),new GeoGlobe.Feature(t,e)},_getLineGeometryByGMLLineStr:function(e){if(!e)return null;for(var t=e.split(" "),o=[],r=0,i=t.length;r<i;r++){var n=this._getPointGeometryByGMLPointStr(t[r]);o.push(n)}return new GeoGlobe.Geometry.LineString(o)},queryTransferGeometry:function(e,t,o){var r={request:"QueryTransferGeometry",SERVICE:"BUS",VERSION:"1.0.0"};if(!e.networkName)throw"Error!Not network name for bus query.";if(null===e.parameterInfo||void 0===e.parameterInfo||""===e.parameterInfo)throw"Error!Not parameterInfo for bus query.";r.networkName=e.networkName,r.PARAMETERINFO="";for(var i=0;i<e.parameterInfo.length;i++)r.PARAMETERINFO+=e.parameterInfo[i].toString(),i!=e.parameterInfo.length-1&&(r.PARAMETERINFO+="_");null!==e.service&&void 0!==e.service&&(r.SERVICE=e.service),null!==e.version&&void 0!==e.version&&(r.VERSION=e.version);GeoGlobe.Request.GET({url:this.url,params:r,scope:this,async:!1,success:GeoGlobe.Function.bind(function(e){var o=this._parseQueryTransferGeometryResult(e);t(o)},this),failure:o})},_parseQueryTransferGeometryResult:function(e){resXML=e.responseXML;var t=[];if(!resXML)return t;var o=new GeoGlobe.Format.XML,r=resXML.selectNodes("/QueryTransferGeometryResponse");if(r&&r.length<=0)return t;var i=o.write(r[0]),n=this._parseToJSON(i).QueryTransferGeometryResponse.SectionGeometry;if(n){GeoGlobe.Util.isArray(n)||(n=[n]);for(var s=0;s<n.length;s++){var a=this._getLineGeometryByGMLLineStr(n[s].Geometry.gml_LineString),l=new GeoGlobe.Feature(a,{ID:n[s].ID});t.push(l)}}return t},queryKeyWord:function(e,t,o){var r={REQUEST:"QueryKeyWord",SERVICE:"BUS",VERSION:"1.0.0",SEARCHTYPE:2};if(!e.networkName)throw"Error!Not network name for bus query.";if(null===e.keyWord||void 0===e.keyWord||""===e.keyWord)throw"Error!Not keyWord for bus query.";r.NETWORKNAME=e.networkName,r.KEYWORD=e.keyWord,null!==e.service&&void 0!==e.service&&(r.SERVICE=e.service),null!==e.version&&void 0!==e.version&&(r.VERSION=e.version),null!==e.searchType&&void 0!==e.searchType&&(r.SEARCHTYPE=e.searchType),null!==e.keyWordType&&void 0!==e.keyWordType&&(r.KEYWORDTYPE=e.keyWordType);GeoGlobe.Request.GET({url:this.url,params:r,async:!1,scope:this,success:GeoGlobe.Function.bind(function(o){var r=this._parserQueryKeyWordResult(o,e.keyWordType);t(r)},this),failure:o})},_parserQueryKeyWordResult:function(e,t){var o=e.responseXML,r=[];if(!o)return r;var i=new GeoGlobe.Format.XML,n=o.selectNodes("/ServiceExceptionReport/ServiceExceptionMessage");if(n&&n.length>0)return r;var s=o.selectNodes("/QueryKeyWordResponse"),a=i.write(s[0]),l=this._parseToJSON(a);if(1===t){var u=l.QueryKeyWordResponse.Stations.Station;u&&!GeoGlobe.Util.isArray(u)&&(u=[u]);for(var c=0;c<u.length;c++){var p=this._getPointFeatureByObj(u[c]);r.push(p)}}else if(2===t){var h=l.QueryKeyWordResponse.Passageways.Passageway;h&&!GeoGlobe.Util.isArray(h)&&(h=[h]);for(c=0;c<h.length;c++){p=this._getPointFeatureByObj(h[c]);r.push(p)}}else{var f=l.QueryKeyWordResponse.Lines.Line;f&&!GeoGlobe.Util.isArray(f)&&(f=[f]);for(c=0;c<f.length;c++){var d=new GeoGlobe.Feature(null,f[c]);r.push(d)}}return r},queryStationInfo:function(e,t,o){var r={REQUEST:"QueryStationInfo",SERVICE:"BUS",VERSION:"1.0.0"};if(!e.networkName)throw"Error!Not network name for bus query.";if(null===e.stationId||void 0===e.stationId||""===e.stationId)throw"Error!Not stationId for bus query.";r.NETWORKNAME=e.networkName,null!==e.service&&void 0!==e.service&&(r.SERVICE=e.service),null!==e.version&&void 0!==e.version&&(r.VERSION=e.version),null!==e.stationId&&void 0!==e.stationId&&(r.STATIONID=e.stationId);GeoGlobe.Request.GET({url:this.url,params:r,scope:this,success:function(e){if(resXML=e.responseXML,resXML){for(var o=new GeoGlobe.Format.XML,r=this._parserQueryStationInfoNode("Lines",o,resXML),i=this._parserQueryStationInfoNode("Passageways",o,resXML),n=new Array,s=0;s<i.length;s++){var a=this._getPointFeatureByObj(i[s]);n.push(a)}t({lines:r,passageways:n})}else{t({lines:[],passageways:[]})}},failure:o})},_parserQueryStationInfoNode:function(e,t,o){switch(e){case"Lines":var r=o.selectNodes("/QueryStationInfoResponse/StationInfo/Lines"),i=new Array;if(r.length>0){var n=t.write(r[0]);i=this._parseToJSON(n).Lines.Line,GeoGlobe.Util.isArray(i)||(i=[i])}return i;case"Passageways":r=o.selectNodes("/QueryStationInfoResponse");var s=new Array;if(r.length>0){n=t.write(r[0]);var a=this._parseToJSON(n).QueryStationInfoResponse.StationInfo.Passageways;a&&(s=a.Passageway,GeoGlobe.Util.isArray(s)||(s=[s]))}return s;default:return[]}},queryLineInfo:function(e,t,o){var r={REQUEST:"QueryLineInfo",SERVICE:"BUS",VERSION:"1.0.0"};if(!e.networkName)throw"Error!Not network name for bus query.";if(null===e.lineId||void 0===e.lineId||""===e.lineId)throw"Error!Not lineId for bus query.";r.NETWORKNAME=e.networkName,null!==e.service&&void 0!==e.service&&(r.SERVICE=e.service),null!==e.version&&void 0!==e.version&&(r.VERSION=e.version),null!==e.lineId&&void 0!==e.lineId&&(r.LINEID=e.lineId),null!==e.startNodeNumber&&void 0!==e.startNodeNumber&&(r.STARTNODENUMBER=e.startNodeNumber),null!==e.endNodeNumber&&void 0!==e.endNodeNumber&&(r.ENDNODENUMBER=e.endNodeNumber);GeoGlobe.Request.GET({url:this.url,params:r,scope:this,success:function(e){var o=[],r=null;if(e.responseXML){var i=(r=e.responseXML).selectNodes("/ServiceExceptionReport/ServiceExceptionMessage");if(i&&i.length>0)return void t(o);for(var n=new GeoGlobe.Format.XML,s=this._parserQueryLineInfoNode("Line",n,r),a=new Array,l=0;l<s.length;l++){for(var u=new Array,c=0;c<s[l].VIAStations.Station.length;c++){var p=this._getPointFeatureByObj(s[l].VIAStations.Station[c]);u.push(p)}s[l].Stations=u;var h=this._getLineGeometryByGMLLineStr(s[l].Geometry.gml_LineString),f=new GeoGlobe.Feature(h,s[l]);a.push(f)}o=a}t(o)},failure:o})},_parserQueryLineInfoNode:function(e,t,o){switch(e){case"Line":var r=o.selectNodes("/QueryLineInfoResponse"),i=t.write(r[0]),n=this._parseToJSON(i).QueryLineInfoResponse.Line;new Array;return n&&!GeoGlobe.Util.isArray(n)?[n]:n;default:return[]}},queryPassagewayInfo:function(e,t,o){var r={REQUEST:"QueryPassagewayInfo",SERVICE:"BUS",VERSION:"1.0.0"};if(!e.networkName)throw"Error!Not network name for bus query.";if(null===e.passagewayId||void 0===e.passagewayId||""===e.passagewayId)throw"Error!Not passagewayId for bus query.";r.NETWORKNAME=e.networkName,null!==e.service&&void 0!==e.service&&(r.SERVICE=e.service),null!==e.version&&void 0!==e.version&&(r.VERSION=e.version),null!==e.passagewayId&&void 0!==e.passagewayId&&(r.PASSAGEWAYID=e.passagewayId);GeoGlobe.Request.GET({url:this.url,params:r,scope:this,success:function(e){var o=e.responseXML,r=[];if(!o)return t(r),r;new GeoGlobe.Format.XML;var i=o.selectNodes("/ServiceExceptionReport/ServiceExceptionMessage");if(i&&i.length>0)return t(r),r;var n=this._parserResponseText(e.responseText);r=this._parserFeaturesNew(n,"Stations"),t(r)}})},_queryByName:function(e,t,o){var r=this,i=null;return r.queryKeyWord({networkName:r.networkName,keyWord:e,keyWordType:1,SEARCHTYPE:2},function(e){if(0!=e.length){var n=e[0].geometry.x+" "+e[0].geometry.y;r.queryKeyWord({networkName:r.networkName,keyWord:t,keyWordType:1,SEARCHTYPE:2},function(e){if(0!=e.length){var t=e[0].geometry.x+" "+e[0].geometry.y;i=r._queryTransferScheme(n,t,o)}else alert("没有查询到终点")})}else alert("没有查询到起点")}),i},queryBus:function(e,t,o){var r=this,i=null;return r.getCapabilities(GeoGlobe.Function.bind(function(n){var s=n.responseXML;s&&s.documentElement||(s=n.responseText);var a=(new GeoGlobe.Format.BusCapabilities).read(s);if(a.capability){var l=a.capability.networks[0];if(r.networkName=l,"string"==typeof e&&"string"==typeof t)i=r._queryByName(e,t,o);else{var u=e.lng+" "+e.lat,c=t.lng+" "+t.lat;i=r._queryTransferScheme(u,c,o)}}else alert("公交服务请求失败，请检查服务是否正常运行或请求地址是否正确。\n请求地址："+url+"\n操作类型：GetCapabilities")},this),function(){alert("公交服务请求失败，请检查服务是否正常运行或请求地址是否正确。\n请求地址："+url+"\n操作类型：GetCapabilities")}),{flag:!!i,featuresInfo:i}},failFn:function(){alert("公交服务请求失败，请检查服务是否正常运行或请求地址是否正确。\n请求地址："+url+"\n操作类型：GetCapabilities")},_queryTransferScheme:function(e,t,o){return this.queryTransferScheme({networkName:this.networkName,transferMode:o||0,inputMode:0,startInput:e,endInput:t},function(e){featuresInfo=e}),this.transferScheme=featuresInfo.transferScheme,featuresInfo},queryBusTransferSchemeByIndex:function(e){var t=null,o=parseInt(e),r=this.transferScheme[o].SectionInfo,n=new Array,s=new Array;for(i=0;i<r.length;i++){var a=r[i].SectionLine[0],l=a.data.ID,u=a.data.FromOrdinal,c=a.data.ToOrdinal;n.push([0,l,u,c]),s.push(r[i].FromStation),s.push(r[i].ToStation)}return this.queryTransferGeometry({networkName:this.networkName,parameterInfo:n},function(e){var o=e,r=new GeoGlobe.Format.GeoJSON,i=r.write(o),n=r.write(s),a=new GeoGlobe.Format.JSON,l=a.read(i),u=a.read(n);t={lineFeatures:o,geojsonRoute:l,stationFeatures:s,geojsonStation:u}}),t},CLASS_NAME:"GeoGlobe.Query.BusQuery"}),document.implementation.hasFeature("XPath","3.0")&&(XMLDocument.prototype.selectNodes=function(e,t){t||(t=this);for(var o=this.evaluate(e,t,function(e){return{csw:"http://www.opengis.net/cat/csw",smmd:"http://data.sbsm.gov.cn/smmd/2007",wfs:"http://www.opengis.net/wfs",gml:"http://www.opengis.net/gml",geoglobe:"http://www.geostar.com.cn/geoglobe"}[e]||null},XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null),r=[],i=0;i<o.snapshotLength;i++)r[i]=o.snapshotItem(i);return r},Element.prototype.selectNodes=function(e){if(this.ownerDocument.selectNodes)return this.ownerDocument.selectNodes(e,this);throw"For XML Elements Only"}),document.implementation.hasFeature("XPath","3.0")&&(XMLDocument.prototype.selectSingleNode=function(e,t){t||(t=this);var o=this.selectNodes(e,t);return o.length>0?o[0]:null},Element.prototype.selectSingleNode=function(e){if(this.ownerDocument.selectSingleNode)return this.ownerDocument.selectSingleNode(e,this);throw"For XML Elements Only"}),GeoGlobe.Query.WFSQuery=GeoGlobe.Class4OL({url:null,version:"1.0.0",featureNS:null,isReverse:!1,featurePrefix:"",featureType:"",maxFeatures:10,filter:null,geometryName:"the_geom",protocol:null,format:null,formatOptions:null,isSeparate:!1,srsName:"EPSG:4326",time:null,userecent:!0,sortBy:null,groupBy:null,resultType:"Results",startPosition:null,initialize:function(e,t,o){this.url=e,this.featureType=t;var r=null;o&&(!0===o.isReverse?(this.isReverse=o.isReverse,r=!o.isReverse):!1===o.isReverse?(this.isReverse=o.isReverse,r=!o.isReverse):r=!this.isReverse,o.format?(o.format instanceof GeoGlobe.Format.GML.v2||o.format instanceof GeoGlobe.Format.GML.v3)&&o.format.setFeatureType_(t):this.format=new GeoGlobe.Format.GML({xy:r})),GeoGlobe.Util.extend(this,o)},query:function(e,t,o){this.protocol=new GeoGlobe.Protocol.WFS({readFormat:this.format,formatOptions:this.formatOptions,propertyNames:this.propertyNames,maxFeatures:this.maxFeatures,featurePrefix:this.featurePrefix,featureNS:this.featureNS,url:this.url,version:this.version,geometryName:this.geometryName,featureType:this.featureType,time:this.time,userecent:this.userecent,srsName:this.srsName});var r=e||this.filter,i=t||this.successFn,n=o||this.failFn,s=GeoGlobe.Function.bind(function(e){if(e.success()){var t=e.features;this.isSeparate&&(t=this._separateFeatures(t));var o=this._read_trueName(e);o&&(t.trueNames=o);var r=(new GeoGlobe.Format.GeoJSON).write(t),s=(new GeoGlobe.Format.JSON).read(r);i({features:t,geojson:s})}else n()},this);this.response=this.protocol.read({sortBy:this.sortBy,filter:r,callback:s})},queryPage:function(e,t,o,r){var i=r&&r.perPageNumber||15,n=((r&&r.pageNumber||1)-1)*i+1;this.protocol=new GeoGlobe.Protocol.WFS({readFormat:this.format,multi:!0,formatOptions:this.formatOptions,propertyNames:this.propertyNames,maxFeatures:i,startPosition:n,featurePrefix:this.featurePrefix,url:this.url,featureNS:this.featureNS,version:this.version,geometryName:this.geometryName,featureType:this.featureType,time:this.time,userecent:this.userecent,srsName:this.srsName});var s=e||this.filter,a=t||this.successFn,l=o||this.failFn,u=GeoGlobe.Function.bind(function(e){if(e.success()){var t=e.features;this.isSeparate&&(t=this._separateFeatures(t));var o=this._read_trueName(e);t.trueNames=o;var r=(new GeoGlobe.Format.GeoJSON).write(t),i=(new GeoGlobe.Format.JSON).read(r);a({features:t,geojson:i})}else l()},this);this.response=this.protocol.read({sortBy:this.sortBy,filter:s,callback:u})},queryTotalNumber:function(e,t,o){var r=new GeoGlobe.Format.WFSHits;this.protocol=new GeoGlobe.Protocol.WFS({readFormat:r,propertyNames:this.propertyNames,resultType:"hits",maxFeatures:this.maxFeatures,featurePrefix:this.featurePrefix,featureNS:this.featureNS,url:this.url,version:this.version,geometryName:this.geometryName,featureType:this.featureType,time:this.time,userecent:this.userecent});var i=e||this.filter,n=t||this.successFn,s=o||this.failFn,a=GeoGlobe.Function.bind(function(e){if(e.success()){var t=e.features;n(t)}else s()},this);this.response=this.protocol.read({filter:i,callback:a})},_read_trueName:function(e){var t=[];if(e.priv&&e.priv.responseText){if(null==this.format)return null;var o=this.format.getXMLDoc().getElementsByTagName("trueName");if(null==o||0==o.length)return null;for(var r=0;r<o.length;r++)t.push(o[r].text);return t}return t},getBufferRegion:function(e,t,o){var r=this._getFeaturesCenter(e);switch(o){case"km":t*=1e3;case"m":t=this._meterToDegree(t,r)}return GeoGlobe.Geometry.Polygon.createRegularPolygon(e.geometry,t,40,360)},_getFeaturesCenter:function(e){return this._getFeaturesExtent(e).getCenterLonLat()},_getFeaturesExtent:function(e){GeoGlobe.Util.isArray(e)||(e=[e]);var t=null;if(e&&e.length>0){t=new GeoGlobe.LngLatBounds;for(var o=null,r=0,i=e.length;r<i;r++)(o=e[r].geometry)&&t.extend(o.getBounds())}return t},_meterToDegree:function(e,t){var o=t.lat;return e*(899e-8/Math.cos(GeoGlobe.Util.rad(o)))},pointQuery:function(e,t,o,r,i){t=t||0,o=o||"degree";var n=new GeoGlobe.Filter.Spatial({type:GeoGlobe.Filter.Spatial.DWITHIN,property:this.geometryName,distance:t,distanceUnits:o,value:e});this.query(n,r,i)},pathQuery:function(e,t,o,r,i){t=t||0,o=o||"degree";var n=new GeoGlobe.Filter.Spatial({type:GeoGlobe.Filter.Spatial.DWITHIN,property:this.geometryName,distance:t,distanceUnits:o,value:e});this.query(n,r,i)},polygonQuery:function(e,t,o,r){var i=t?GeoGlobe.Filter.Spatial.CONTAINS:GeoGlobe.Filter.Spatial.INTERSECTS,n=new GeoGlobe.Filter.Spatial({type:i,property:this.geometryName,value:e});this.query(n,o,r)},bboxQuery:function(e,t,o){var r=new GeoGlobe.Filter.Spatial({type:GeoGlobe.Filter.Spatial.BBOX,property:this.geometryName,value:e});this.query(r,t,o)},attributeQuery:function(e,t,o,r,i,n){var s=r&&r.matchCase,a=r?r.lowerBoundary:null,l=r?r.upperBoundary:null,u=new GeoGlobe.Filter.Comparison({type:e,property:t,value:o,matchCase:s,lowerBoundary:a,upperBoundary:l});this.query(u,i,n)},statisticsQuery:function(e,t,o){this.protocol=new GeoGlobe.Protocol.WFS({readFormat:this.format,formatOptions:this.formatOptions,propertyNames:this.propertyNames,resultType:"statistics",maxFeatures:this.maxFeatures,featurePrefix:this.featurePrefix,featureNS:this.featureNS,url:this.url,version:this.version,geometryName:this.geometryName,featureType:this.featureType,time:this.time,userecent:this.userecent});var r=e||this.filter,i=t||this.successFn,n=o||this.failFn,s=GeoGlobe.Function.bind(function(e){if(e.success()){try{var t=e.priv.responseXML,o=this._analysis_StatisticsResult(t)}catch(t){return void i(e.priv.responseText)}i(o)}else n()},this);this.response=this.protocol.read({sortBy:this.sortBy,groupBy:this.groupBy,filter:r,callback:s})},_analysis_StatisticsResult:function(e){var t={},o=e.documentElement.firstChild.childNodes;return 0<o.length&&(t.layers=this._analysis_StatisticsResult_results(o)),t},_analysis_StatisticsResult_results:function(e){for(var t=[],o=0;o<e.length;o++){for(var r={},i=[],n=e[o].childNodes,s=0;s<n.length;s++){var a={};a.layerName=n[s].parentNode.nodeName,"Microsoft Internet Explorer"==navigator.appName?a.result=this._analysis_StatisticsResult_results_result_IE(n[s]):a.result=this._analysis_StatisticsResult_results_result_google(n[s]),i.push(a)}r.results=i,t.push(r)}return t},_analysis_StatisticsResult_results_result_IE:function(e){var t={},o=0;"Key"==e.childNodes[0].nodeName&&(t.Key=e.childNodes[0].text,o=1);for(var r=[],i=[];o<e.childNodes.length;o++){var n={},s={};n.name=e.childNodes[o].getAttribute("name"),s.Value=e.childNodes[o].text,r.push(n),i.push(s)}return t.name=r,t.values=i,t},_analysis_StatisticsResult_results_result_google:function(e){var t={},o=0;"Key"==e.childNodes[0].nodeName&&(t.Key=e.childNodes[0].innerHTML,o=1);for(var r=[],i=[];o<e.childNodes.length;o++){var n={},s={};n.name=e.childNodes[o].getAttribute("name"),s.Value=e.childNodes[o].innerHTML,r.push(n),i.push(s)}return t.name=r,t.values=i,t},successFn:function(e){},failFn:function(){alert("对不起,查询失败,请查询服务是否正常。")},_separateFeatures:function(e){for(var t={},o=0;o<e.length;o++){var r,i=e[o];t[r=i.gml?i.gml.featureType:i.type]||(t[r]=[]),t[r].push(i)}return t},setTime:function(e){this.time=e},setUserecent:function(e){this.userecent=e},CLASS_NAME:"GeoGlobe.Query.WFSQuery"}),GeoGlobe.Query.WFSQuery.reverseGeometryXY=function(e){var t={Point:function(e,t){var o=e.x,r=e.y,i=e.clone(e);return i.x=r,i.y=o,i},LineString:function(e,t){for(var o=e.clone(e),r=0;r<o.components.length;r++){var i=t.Point(o.components[r]);o.components[r]=i}return o},Polygon:function(e,t){for(var o=e.clone(e),r=0;r<o.components.length;r++)for(var i=0;i<o.components[r].components.length-1;i++){var n=t.Point(o.components[r].components[i]);o.components[r].components[i]=n}return o}};return t[{"GeoGlobe.Geometry.Point":"Point","GeoGlobe.Geometry.MultiPoint":"MultiPoint","GeoGlobe.Geometry.LineString":"LineString","GeoGlobe.Geometry.MultiLineString":"MultiLineString","GeoGlobe.Geometry.Polygon":"Polygon","GeoGlobe.Geometry.MultiPolygon":"MultiPolygon","GeoGlobe.Geometry.Collection":"GeometryCollection"}[e.CLASS_NAME]](e,t)},GeoGlobe.Format.WFSHits=GeoGlobe.Class4OL(GeoGlobe.Format.XML,{wfsns:"http://www.opengis.net/wfs",featureCollection:"FeatureCollection",read:function(e){"string"==typeof e&&(e=GeoGlobe.Format.XML.prototype.read.apply(this,[e]));var t=e.documentElement;return{numberOfFeatures:parseInt(t.getAttribute("numberOfFeatures"))}}}),GeoGlobe.Query.GeoCodingQuery=function(e,t){t=GeoGlobe.Util.applyDefaults(t,GeoGlobe.Query.GeoCodingQuery.DEFAULTS);var o=GeoGlobe.Query.GeoCodingQuery["v"+t.version.replace(/\./g,"_")];if(!o)throw"不支持的地址匹配服务版本: "+t.version;return new o(e,t)},GeoGlobe.Query.GeoCodingQuery.DEFAULTS={version:"1.0.0"},GeoGlobe.Query.GeoCodingQuery.v1=GeoGlobe.Class4OL({version:"1.0.0",url:null,initialize:function(e,t){this.url=e,GeoGlobe.Util.extend(this,t),this.format=new GeoGlobe.Format.JSON},getCommonParams:function(e){var t={request:"GetCategory",service:"GeoCoding",version:this.version,output:"json"};return GeoGlobe.Util.extend(t,e),t},getCategoryByName:function(e,t,o){var r=this.getCommonParams();"string"==typeof e&&0!==e.length&&(r.categoryName=e);o=o||this.failFn;GeoGlobe.Function.bind(this._requestCategory,this)(r,t,o)},getCategoryByCode:function(e,t,o){var r=this.getCommonParams();"number"==typeof e&&(r.categoryCode=e),GeoGlobe.Function.bind(this._requestCategory,this)(r,t,o)},getAllCategory:function(e,t){var o=this.getCommonParams();GeoGlobe.Function.bind(this._requestCategory,this)(o,e,t)},_requestCategory:function(e,t,o){o=o||this.failFn;GeoGlobe.loadURL(this.url,e,this,function(e){try{var o=this.format.read(e.responseText)}catch(o){return void t(e.responseText)}t(o)},o)},_analysis_GeoCodeResult:function(e){var t={status:e.status};switch(e.status){case"OK":(o=e.results)&&(t.results=this._analysis_GeoCodeResult_results(o));break;case"INVALID_REQUEST":case"NO_RESULTS":case"UNKNOWN_ERROR":break;default:var o;if(t={requestKeyWord:e.requestKeyWord,count:e.count,statisticsLevel:e.statisticsLevel,statisticsLevelName:e.statisticsLevelName},e&&e.count>0)(o=e.results)&&(t.results=this._analysis_GeoCodeResult_statistics(o))}return t},_analysis_GeoCodeResult_results:function(e){var t=[];if(GeoGlobe.Util.isArray(e)){for(var o=0,r=e.length;o<r;o++){var i={};i.requestKeyWord=e[o].requestKeyWord,e[o].errorCorrectionTips&&(i.errorCorrectionTips=e[o].errorCorrectionTips),i.count=e[o].count,e[o].result&&(i.result=this._analysis_GeoCodeResult_results_result(e[o].result)),t.push(i)}return t}},_analysis_GeoCodeResult_statistics:function(e){var t=[];if(GeoGlobe.Util.isArray(e)){for(var o=0,r=e.length;o<r;o++){var i={};e[o].errorCorrectionTips&&(i.errorCorrectionTips=e[o].errorCorrectionTips),e[o]&&(i.name=e[o].name,i.value=e[o].value,i.remark=e[o].remark),t.push(i)}return t}},_analysis_GeoCodeResult_results_result:function(e){for(var t=[],o=0,r=e.length;o<r;o++){var i={},n={};i.resultType=e[o].resultType,i.precise=e[o].precise,i.isBrief=e[o].isBrief,i.score=e[o].score,e[o].addressComponent.street&&(n=e[o].addressComponent.street),0==i.isBrief&&(i.addressComponent=this._analysis_GeoCodeResult_results_result_address(e[o].addressComponent,i.resultType)),i.poiArray=this._analysispoiArray(e[o].poiArray),e[o].location&&(i.location=e[o].location),0==i.precise&&(i.referenceAddressArray=e[o].referenceAddressArray),n&&(i.street_path=n),t.push(i)}return t},_analysis_GeoCodeResult_results_result_address:function(e,t){var o={country:e.country};if(e.province&&(o.province=e.province),e.city&&(o.city=e.city),e.district&&(o.district=e.district),e.town&&(o.town=e.town),e.street&&(o.street={name:e.street.name},"street"===t&&e.street.geometry)){var r=this.format.read(e.street.geometry),i=null;r.paths?(i=this._getGeometry(r),o.street.geometry=i):r.rings?(i=this._getGeometry(r),o.street.geometry=i):r.x&&r.y&&(i=this._getGeometry(r),o.street.geometry=i)}if(e.streetNumber&&(o.streetNumber=e.streetNumber),e.buildingNumber&&(o.buildingNumber=e.buildingNumber),"adminArea"===t){if(e.geometry){var n=this.format.read(e.geometry),s=null;n.rings?(s=this._getGeometry(n),o.geometry=s):n.paths?(s=this._getGeometry(n),o.geometry=s):"number"==typeof n.x&&"number"==typeof n.y&&(o.geometry=this._getGeometry(n))}e.subordinate&&(o.subordinate=e.subordinate),e.zipCode&&(o.zipCode=e.zipCode),e.callingCode&&(o.callingCode=e.callingCode)}return o},_analysispoiArray:function(e){for(var t=[],o=0,r=e.length;o<r;o++){var i={};for(var n in e[o])i[n]=e[o][n];if(""!=i.geometry&&void 0!=i.geometry){var s=this.format.read(i.geometry);i.geometry=this._getGeometry(s)}t.push(i)}return t},_analysisLocation:function(e){},_getGeometry:function(e){for(var t in e){if("spatialReference"==t)return;if(e.hasOwnProperty("x")&&e.hasOwnProperty("y"))e=new GeoGlobe.Geometry.Point(e.x,e.y);else if(e.hasOwnProperty("xmin")&&e.hasOwnProperty("ymin")&&e.hasOwnProperty("xmax")&&e.hasOwnProperty("ymax"))e=new GeoGlobe.Bounds(e.xmin,e.ymin,e.xmax,e.ymax).toGeometry();else e=this._geometryType[t](e[t]);return e}},_geometryType:{points:function(e){var t=[];if(GeoGlobe.Util.isArray(e))for(var o=0,r=e.length;o<r;o++){var i=new GeoGlobe.Geometry.Point(e[o][0],e[o][1]);t.push(i)}return t},paths:function(e){var t=[];if(GeoGlobe.Util.isArray(e)){for(var o=0,r=e.length;o<r;o++){for(var i=[],n=0,s=e[o].length;n<s;n++)i.push(new GeoGlobe.Geometry.Point(e[o][n][0],e[o][n][1]));var a=new GeoGlobe.Geometry.LineString(i);t.push(a)}var l=new GeoGlobe.Geometry.MultiLineString(t)}return l},rings:function(e){var t=[];if(GeoGlobe.Util.isArray(e)){for(var o=0,r=e.length;o<r;o++){for(var i=[],n=0,s=e[o].length;n<s;n++)i.push(new GeoGlobe.Geometry.Point(e[o][n][0],e[o][n][1]));var a=new GeoGlobe.Geometry.LinearRing(i);t.push(a)}var l=new GeoGlobe.Geometry.Polygon(t)}return l}},failFn:function(e){"string"==typeof e&&alert(e),alert("对不起，查询请求失败！请检查地址匹配服务是否正常运行。\n当前服务地址为："+this.url)},CLASS_NAME:"GeoGlobe.Query.GeoCodingQuery.v1"}),GeoGlobe.Query.GeoCodingQuery.v1_0_0=GeoGlobe.Class4OL(GeoGlobe.Query.GeoCodingQuery.v1,{addressesToLocations:function(e,t,o){var r=this.getCommonParams({request:"GeoCoder"});if("string"==typeof e.address)r.address=e.address;else if(GeoGlobe.Util.isArray(e.address)){for(var i="",n=0;n<e.address.length;n++)i+=e.address[n]+",";i=i.substr(0,i.length-1),r.address=i}else if(void 0==e.address||null==e.address)throw"address是必选参数！";if("number"==typeof e.categoryCode&&(r.categoryCode=e.categoryCode),e.extent instanceof GeoGlobe.LngLatBounds)r.bbox=e.extent.toBBOX(null,!0);else if(e.extent instanceof GeoGlobe.Geometry.Polygon){for(var s=e.extent,a=[],l=(n=0,s.components.length);n<l;n++)for(var u=s.components[n].components,c=0;c<u.length;c++)a.push(u[c].toShortString());r.bbox=a.join(",")}"boolean"==typeof e.fuzzyMatch&&(r.fuzzyMatch=e.fuzzyMatch),"string"==typeof e.resultType&&(r.resultType=e.resultType),"number"==typeof e.maxCount&&(r.maxCount=e.maxCount),"number"==typeof e.startPosition&&(r.startPosition=e.startPosition),GeoGlobe.loadURL(this.url,r,this,function(e){try{var o=this.format.read(e.responseText);if("result"==r.resultType)var i=this._parseQueryResultToFeature(o);else i=this._analysis_GeoCodeResult(o)}catch(o){return void t(e.responseText)}t(i)},this.failFn)},locationToAddresses:function(e,t,o){var r=this.getCommonParams({request:"GeoCoder"});if(!e.lonlat)throw"address是必选参数！请填写正确的数据类型！";r.latlng=e.lonlat.lat+","+e.lonlat.lng,"number"==typeof e.tolerance&&(r.tolerance=e.tolerance),"string"==typeof e.unit&&(r.unit=e.unit),"string"==typeof e.resultType&&(r.resultType=e.resultType),"number"==typeof e.maxCount&&(r.maxCount=e.maxCount),"number"==typeof e.startPosition&&(r.startPosition=e.startPosition),GeoGlobe.loadURL(this.url,r,this,function(e){try{var o=this.format.read(e.responseText);if("result"==r.resultType)var i=this._parseQueryResultToFeature(o);else i=this._analysis_GeoCodeResult(o)}catch(o){return void t(e.responseText)}t(i,o)},this.failFn)},getLocations:function(e,t,o){this.addressesToLocations(e,GeoGlobe.Function.bind(function(e){t(this._parseQueryResultToFeature(e,total))},this),o)},getLocationsByPage:function(e,t,o){e.resultType="hits",this.addressesToLocations(e,GeoGlobe.Function.bind(function(r){if("OK"==r.status){e.resultType="result";var i=r.results[0].count;void 0!=e.maxCount&&null!=e.maxCount||(e.maxCount=3),e.startPosition=(e.startPosition-1)*e.maxCount+1,this.addressesToLocations(e,GeoGlobe.Function.bind(function(e){t(this._parseQueryResultToFeature(e,i))},this),o)}else alert("没有查询到任何数据")},this),o)},getAddresses:function(e,t,o){this.locationToAddresses(e,GeoGlobe.Function.bind(function(e){t(this._parseQueryResultToFeature(e,total))},this),o)},getAddressesByPage:function(e,t,o){e.resultType="hits",this.locationToAddresses(e,GeoGlobe.Function.bind(function(r){if("OK"==r.status){e.resultType="result";var i=r.results[0].count;void 0!=e.maxCount&&null!=e.maxCount||(e.maxCount=3),e.startPosition=(e.startPosition-1)*e.maxCount+1,this.locationToAddresses(e,GeoGlobe.Function.bind(function(e){t(this._parseQueryResultToFeature(e,i))},this),o)}else alert("没有查询到任何数据")},this),o)},_parseQueryResultToFeature:function(e){var t=[];if("OK"==e.status&&e.results)for(var o=0;o<e.results.length;o++){var r=e.results[o].result;if(r)for(var i=0;i<r.length;i++){var n={},s=null;if(n.requestKeyWord=e.results[o].requestKeyWord,GeoGlobe.Util.isArray(r[i].poiArray))for(var a=0;a<r[i].poiArray.length;a++)n.CONTINENT=r[i].poiArray[a].CONTINENT,n.GBCODE=r[i].poiArray[a].GBCODE,n.STANDARDNAME=r[i].poiArray[a].STANDARDNAME,n.name=r[i].poiArray[a].name;if(r[i].addressComponent){var l=r[i].addressComponent;n.address=this._getAddress(l,n.name),n.country=r[i].addressComponent.country,n.province=r[i].addressComponent.province,n.city=r[i].addressComponent.city,n.district=r[i].addressComponent.district,r[i].addressComponent.street?(n.streetName=r[i].addressComponent.street.name,n.streetgeometry=r[i].addressComponent.street.geometry):n.streetName="",n.streetNumber=r[i].addressComponent.streetNumber}r[i].location&&(r[i].location.lng&&(n.lng=r[i].location.lng),r[i].location.lat&&(n.lat=r[i].location.lat),s=new GeoGlobe.Geometry.Point(r[i].location.lng,r[i].location.lat)),n.isBrief=r[i].isBrief,n.precise=r[i].precise,n.resultType=r[i].resultType,n.score=r[i].score;var u=new GeoGlobe.Feature(s,n);t.push(u)}}var c=(new GeoGlobe.Format.GeoJSON).write(t),p=(new GeoGlobe.Format.JSON).read(c);return{status:e.status,features:t,geojsonFeatures:p}},_getAddress:function(e,t){var o="";return e.country&&(o+=e.country),e.province&&(o+=e.province),e.city&&(o+=e.city),e.district&&(o+=e.district),e.street&&(e.street.name&&(o+=e.street.name),e.streetNumber&&(o+=e.streetNumber+"号")),t&&(o+=t),o},CLASS_NAME:"GeoGlobe.Query.GeoCodingQuery.v1_0_0"}),GeoGlobe.Query.GeoCodingQuery.v1_1_0=GeoGlobe.Class4OL(GeoGlobe.Query.GeoCodingQuery.v1,{method:"get",initialize:function(e,t){GeoGlobe.Util.extend(this,t),this.filterFormat=new GeoGlobe.Format.Filter,GeoGlobe.Query.GeoCodingQuery.v1.prototype.initialize.apply(this,arguments)},addressesToLocations:function(e,t,o){var r=this.getCommonParams({request:"GeoCoder"});if(r.reverseMatch=!1,"string"==typeof e.address&&(r.keyword=e.address),"number"==typeof e.categoryCode&&(r.categoryCode=e.categoryCode),!(void 0!=e.address&&null!=e.address||void 0!=e.categoryCode&&null!=e.categoryCode))throw"address是必选参数！";if(e.extent instanceof GeoGlobe.LngLatBounds)r.bbox=e.extent.toBBOX(null,!0);else if(e.extent instanceof GeoGlobe.Geometry.Polygon){for(var i=e.extent,n=[],s=0,a=i.components.length;s<a;s++)for(var l=i.components[s].components,u=0;u<l.length;u++)n.push(l[u].toShortString());r.bbox=n.join(",")}if(e.filter instanceof GeoGlobe.Filter){var c=this.filterFormat.write(e.filter),p=GeoGlobe.Format.XML.prototype.write.apply(this.filterFormat,[c]);r.filter=p}"string"==typeof e.resultType&&(r.resultType=e.resultType),"statistics"==e.resultType&&(r.statisticsLevel=e.statisticsLevel),"number"==typeof e.maxCount&&(r.maxCount=e.maxCount),"number"==typeof e.startPosition&&(r.startPosition=e.startPosition),"boolean"==typeof e.semanticAnalysis&&(r.semanticAnalysis=e.semanticAnalysis),"boolean"==typeof e.customWeight&&(r.customWeight=e.customWeight),this._setGeoCoderCommonProperty(r,e),this._getCodingRequest(r,t,o)},_getCodingRequest:function(e,t,o){if("get"==this.method)GeoGlobe.loadURL(this.url,e,this,function(o){try{var r=this.format.read(o.responseText);if("result"==e.resultType)var i=this._parseQueryResultToFeature(r);else i=this._analysis_GeoCodeResult(r)}catch(e){return void t(o.responseText)}t(i)},this.failFn);else{var r=GeoGlobe.Util.getParameterString(e);GeoGlobe.Request.POST({url:this.url,data:r,success:function(e){try{var o=this.format.read(e.responseText),r=this._analysis_GeoCodeResult(o)}catch(o){return void t(e.responseText)}t(r)},failure:this.failFn,scope:this})}},_setGeoCoderCommonProperty:function(e,t){"string"==typeof t.sortFields&&(e.sortFields=t.sortFields),"string"==typeof t.scoreFilter&&(e.scoreFilter=t.scoreFilter)},locationToAddresses:function(e,t,o){var r=this.getCommonParams({request:"GeoCoder"});if(r.reverseMatch=!0,!e.lonlat)throw"address是必选参数！请填写正确的数据类型！";r.keyword=e.lonlat.lat+","+e.lonlat.lng,"number"==typeof e.tolerance&&(r.tolerance=e.tolerance),"string"==typeof e.unit&&(r.unit=e.unit),"string"==typeof e.resultType&&(r.resultType=e.resultType),"statistics"==e.resultType&&(r.statisticsLevel=e.statisticsLevel),"number"==typeof e.maxCount&&(r.maxCount=e.maxCount),"number"==typeof e.startPosition&&(r.startPosition=e.startPosition),"boolean"==typeof e.customWeight&&(r.customWeight=e.customWeight),this._setGeoCoderCommonProperty(r,e),this._getCodingRequest(r,t,o)},batchAddressesToLocations:function(e,t,o){var r=this.getCommonParams({request:"BatchGeoCoder",service:"GeoCoding"});if(r.reverseMatch=!1,GeoGlobe.Util.isArray(e.address)){for(var i="",n=0;n<e.address.length;n++)i+=e.address[n]+",";i=i.substr(0,i.length-1),r.keywords=i}else if(void 0==e.address||null==e.address)throw"address是必选参数！";if("number"==typeof e.singleKeywordResultCount&&(r.singleKeywordResultCount=e.singleKeywordResultCount),e.filter instanceof GeoGlobe.Filter){var s=this.filterFormat.write(e.filter),a=GeoGlobe.Format.XML.prototype.write.apply(this.filterFormat,[s]);r.filter=a}this._setGeoCoderCommonProperty(r,e),this._getCodingRequest(r,t,o)},batchLocationToAddresses:function(e,t,o){var r=this.getCommonParams({request:"BatchGeoCoder",service:"GeoCoding"});if(r.reverseMatch=!0,e.lonlats instanceof GeoGlobe.LonLat)e.lonlats=[e.lonlats];else if(!GeoGlobe.Util.isArray(e.lonlats))throw"address是必选参数！请填写正确的数据类型！";if(GeoGlobe.Util.isArray(e.lonlats)){for(var i="",n=0;n<e.lonlats.length;n++)i+=e.lonlats[n].lat+","+e.lonlats[n].lng+";";i=i.substr(0,i.length-1),r.keywords=i}"number"==typeof e.tolerance&&(r.tolerance=e.tolerance),"string"==typeof e.unit&&(r.unit=e.unit),"number"==typeof e.singleKeywordResultCount&&(r.singleKeywordResultCount=e.singleKeywordResultCount),this._setGeoCoderCommonProperty(r,e),this._getCodingRequest(r,t,o)},_getAddress:function(e,t){var o="";return e.country&&(o+=e.country),e.province&&(o+=e.province),e.city&&(o+=e.city),e.district&&(o+=e.district),e.street&&(e.street.name&&(o+=e.street.name),e.streetNumber&&(o+=e.streetNumber+"号")),t&&(o+=t),o},getLocations:function(e,t,o){this.addressesToLocations(e,GeoGlobe.Function.bind(function(e){t(this._parseQueryResultToFeature(e,total))},this),o)},getLocationsByPage:function(e,t,o){e.resultType="hits",this.addressesToLocations(e,GeoGlobe.Function.bind(function(r){if("OK"==r.status){e.resultType="result";var i=r.results[0].count;void 0!=e.maxCount&&null!=e.maxCount||(e.maxCount=3),e.startPosition=(e.startPosition-1)*e.maxCount+1,this.addressesToLocations(e,GeoGlobe.Function.bind(function(e){t(this._parseQueryResultToFeature(e,i))},this),o)}else alert("没有查询到任何数据")},this),o)},getAddresses:function(e,t,o){this.locationToAddresses(e,GeoGlobe.Function.bind(function(e){t(this._parseQueryResultToFeature(e,total))},this),o)},getAddressesByPage:function(e,t,o){e.resultType="hits",this.locationToAddresses(e,GeoGlobe.Function.bind(function(r){if("OK"==r.status){e.resultType="result";var i=r.results[0].count;void 0!=e.maxCount&&null!=e.maxCount||(e.maxCount=3),e.startPosition=(e.startPosition-1)*e.maxCount+1,this.locationToAddresses(e,GeoGlobe.Function.bind(function(e){t(this._parseQueryResultToFeature(e,i))},this),o)}else alert("没有查询到任何数据")},this),o)},batchGetAddresses:function(e,t,o){this.batchLocationToAddresses(e,GeoGlobe.Function.bind(function(e){t(this._parseQueryResultToFeature(e))},this),o)},batchGetLocations:function(e,t,o){this.batchAddressesToLocations(e,GeoGlobe.Function.bind(function(e){t(this._parseQueryResultToFeature(e))},this),o)},_parseQueryResultToFeature:function(e){var t=[];if("OK"==e.status&&e.results)for(var o=0;o<e.results.length;o++){var r=e.results[o].result;if(r)for(var i=0;i<r.length;i++){var n={},s=null;if(n.requestKeyWord=e.results[o].requestKeyWord,GeoGlobe.Util.isArray(r[i].poiArray))for(var a=0;a<r[i].poiArray.length;a++)n.CONTINENT=r[i].poiArray[a].CONTINENT,n.GBCODE=r[i].poiArray[a].GBCODE,n.STANDARDNAME=r[i].poiArray[a].STANDARDNAME,n.name=r[i].poiArray[a].name;if(r[i].addressComponent){var l=r[i].addressComponent;n.address=this._getAddress(l,n.name),n.country=r[i].addressComponent.country,n.province=r[i].addressComponent.province,n.city=r[i].addressComponent.city,n.district=r[i].addressComponent.district,r[i].addressComponent.street?(n.streetName=r[i].addressComponent.street.name,n.streetgeometry=r[i].addressComponent.street.geometry):n.streetName="",n.streetNumber=r[i].addressComponent.streetNumber}r[i].location&&(r[i].location.lng&&(n.lng=r[i].location.lng),r[i].location.lat&&(n.lat=r[i].location.lat),s=new GeoGlobe.Geometry.Point(r[i].location.lng,r[i].location.lat)),n.isBrief=r[i].isBrief,n.precise=r[i].precise,n.resultType=r[i].resultType,n.score=r[i].score;var u=new GeoGlobe.Feature(s,n);t.push(u)}}var c=(new GeoGlobe.Format.GeoJSON).write(t),p=(new GeoGlobe.Format.JSON).read(c);return{status:e.status,features:t,geojsonFeatures:p}},CLASS_NAME:"GeoGlobe.Query.GeoCodingQuery.v1_1_0"}),GeoGlobe.Service=GeoGlobe.Class({name:null,url:null,version:null,userid:"test@liferay.com",initialize:function(e,t,o){this.name=e,this.url=t,GeoGlobe.Util.extend(this,o)},getCapabilities:function(e,t){},isExist:function(){},failFn:function(e){alert("服务请求失败，请检查服务是否正常运行或请求地址是否正确。\n请求地址："+this.url+"\n操作类型："+e)},_parseToXML:function(e){var t=e.responseXML;return t&&t.documentElement||(t=e.responseText),(new GeoGlobe.Format.XML).read(t)},_checkIsError:function(e){return(new GeoGlobe.Format.XML).read(e).selectNodes("ServiceExceptionReport").length>0?this._parseToJSON(e):null},_isException:function(e){return!(!e||!e.ServiceExceptionReport)},_parseToJSON:function(e){return(new GeoGlobe.Util.Format.XML2JSON).read(e)},CLASS_NAME:"GeoGlobe.Service"}),GeoGlobe.Service.WFST=GeoGlobe.Class4OL(GeoGlobe.Service,{xy:!0,initialize:function(e,t,o){GeoGlobe.Service.prototype.initialize.apply(this,arguments)},getCapabilities:function(e,t){var o=this.url,r={REQUEST:"GetCapabilities",SERVICE:"WFS",VERSION:"1.0.0"};t||(t=function(){this.failFn(r.REQUEST)}),GeoGlobe.loadURL(o,r,this,function(t){e(t)},t)},isExist:function(){var e=!1,t=this.url;GeoGlobe.Request.GET({url:t,params:{REQUEST:"GetCapabilities",SERVICE:"WFS"},scope:this,async:!1,success:function(){e=!0}});return e},describeFeatureType:function(e,t,o){var r=this.url;GeoGlobe.Util.applyDefaults(e,{SERVICE:"WFS",VERSION:"1.0.0",REQUEST:"DescribeFeatureType"}),o||(o=function(){this.failFn(e.REQUEST)}),GeoGlobe.loadURL(r,e,this,function(e){t(e)},o)},getFeature:function(e,t,o){var r=this.url;GeoGlobe.Util.applyDefaults(e,{SERVICE:"WFS",VERSION:"1.0.0",REQUEST:"GetFeature"}),o||(o=function(){this.failFn(e.REQUEST)}),GeoGlobe.loadURL(r,e,this,function(e){t(e)},o)},lockFeature:function(e,t,o){this.url;GeoGlobe.Util.applyDefaults(e,{service:"WFS",version:"1.0.0",request:"LockFeature",expiry:1,lockAction:"ALL"});var r=this._parserFilterToString(e.filter),i=GeoGlobe.String.format('<?xml version="1.0" encoding="UTF-8"?><LockFeature version="${version}" service="${service}" lockAction="${lockAction}" expiry="${expiry}" xmlns:wfs=" http://www.opengis.net/wfs" xmlns:gml=" http://www.opengis.net/gml" xmlns:myns=" http://www.someserver.com/myns" xmlns:ogc=" http://www.opengis.net/ogc" xmlns:xsi=" http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.opengis.net/wfs ../wfs/1.1.0/WFS.xsd"><Lock typeName="${typeName}">${filterXMLString}</Lock></LockFeature>',{version:e.version,service:e.service,lockAction:e.lockAction,expiry:e.expiry,typeName:e.typeName,filterXMLString:r});o||(o=function(){this.failFn(e.request)});new GeoGlobe.Request.POST({url:this.url,data:i,scope:this,success:t,failure:o})},transaction:function(e,t,o,r,i,n){var s=this.url;GeoGlobe.Util.applyDefaults(e,{service:"WFS",version:"1.0.0",request:"Transaction",releaseAction:"ALL"});var a=e.lockId,l="";a&&(l+="<LockId>"+a+"</LockId>");var u="";t&&(u+=this._getInsertString(t)),o&&(u+=this._getUpdateString(o)),r&&(u+=this._getDeleteString(r));var c=GeoGlobe.String.format('<?xml version="1.0" encoding="UTF-8"?><wfs:Transaction releaseAction="${releaseAction}" handle="Transaction 01" version="${version}" service="${service}" xmlns="http://www.someserver.com/myns" xmlns:gml="http://www.opengis.net/gml" xmlns:ogc="http://www.opengis.net/ogc" xmlns:wfs="http://www.opengis.net/wfs" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">${lockIdString}${transactionString}</wfs:Transaction>',{releaseAction:e.releaseAction,version:e.version,service:e.service,lockIdString:l,transactionString:u});n||(n=function(){this.failFn(e.request)});new GeoGlobe.Request.POST({url:s,data:c,scope:this,success:i,failure:n})},parseTransactionResult:function(e){var t=(new GeoGlobe.Format.XML2JSON).read(e.responseText),o=new Array,r=this._objToArray(t.wfs_WFS_TransactionResponse.wfs_TransactionResult.wfs_Status),i=this._objToArray(t.wfs_WFS_TransactionResponse.wfs_InsertResults);if(!r)return o;for(var n=0;n<r.length;n++)void 0!==r[n].wfs_SUCCESS?o.push({status:"SUCCESS",fid:i&&i[n]?i[n].ogc_FeatureId.fid:null}):o.push({status:"FAILED",fid:null});return o},_objToArray:function(e){return!e||e instanceof Array||(e=[e]),e},_getInsertString:function(e){for(var t=e.features,o=e.typeName,r="",i=0;i<t.length;i++){var n=t[i];r+='<wfs:Insert handle="Insert '+i+'">'+this._getInsertFeatureString(n,o)+"</wfs:Insert>"}return r},_getInsertFeatureString:function(e,t){var o="";for(var r in e.attributes)"OID"!=r&&(o+=GeoGlobe.String.format("<${tag}><![CDATA[${value}]]></${tag}>",{value:e.attributes[r]?e.attributes[r]:"",tag:r}));return o+=GeoGlobe.String.format("<GEOMETRY>${geometry}</GEOMETRY>",{geometry:this._getGeometryStringByFeature(e)}),o=GeoGlobe.String.format("<${typeName}>${content}</${typeName}>",{typeName:t,content:o})},_getUpdateString:function(e){e.filter;for(var t=e.typeName,o=e.features,r="",i=0;i<o.length;i++)if(o[i].geometry){var n=this._getUpdatePropertyString(o[i]),s=new GeoGlobe.Filter.FeatureId({fids:[t+"."+o[i].attributes.OID]});r+='<wfs:Update typeName="'+t+'" handle="Update '+i+'">'+n+this._parserFilterToString(s)+"</wfs:Update>"}return r},_getUpdatePropertyString:function(e){var t="";for(var o in e.data)"OID"!=o&&e.data[o]&&(t+="<wfs:Property><wfs:Name><![CDATA["+o+"]]></wfs:Name><wfs:Value><![CDATA["+(e.data[o]?e.data[o]:"")+"]]></wfs:Value></wfs:Property>");return t+="<wfs:Property><wfs:Name>Geometry</wfs:Name><wfs:Value>"+this._getGeometryStringByFeature(e)+"</wfs:Value></wfs:Property>"},_getGeometryStringByFeature:function(e){var t=new GeoGlobe.Format.GML({xy:this.xy});t.buildCoordinatesNode=GeoGlobe.Function.bind(function(e){var t=this.createElementNS(this.gmlns,"gml:coordinates");t.setAttribute("decimal","."),t.setAttribute("cs",","),t.setAttribute("ts"," ");var o=[];if(e instanceof GeoGlobe.LngLatBounds)this.xy?(o.push(e.left+","+e.bottom),o.push(e.right+","+e.top)):(o.push(e.bottom+","+e.left),o.push(e.top+","+e.right));else for(var r=e.components?e.components:[e],i=0;i<r.length;i++)this.xy?o.push(r[i].x+","+r[i].y):o.push(r[i].y+","+r[i].x);var n=this.createTextNode(o.join(" "));return t.appendChild(n),t},t);var o=t.buildGeometryNode(e.geometry);return(new GeoGlobe.Format.XML).write(o)},_getDeleteString:function(e){for(var t=e.filter,o=e.typeName,r="",i=0;i<t.fids.length;i++){r+='<wfs:Delete typeName="'+o+'" handle="Delete '+i+'">';var n=new GeoGlobe.Filter.FeatureId({fids:[t.fids[i]]});r+=this._parserFilterToString(n),r+="</wfs:Delete>"}return r},_parserFilterToString:function(e){var t="";if(e){var o=(new GeoGlobe.Format.Filter.v1).write(e);return t=(new GeoGlobe.Format.XML).write(o)}return t},CLASS_NAME:"GeoGlobe.Service.WFST"}),GeoGlobe.Service.CTS=GeoGlobe.Class4OL(GeoGlobe.Service,{initialize:function(e,t,o){GeoGlobe.Service.prototype.initialize.apply(this,arguments)},getCapabilities:function(e,t){var o=this.url,r={REQUEST:"GetCapabilities",SERVICE:"CTS"};t||(t=function(){this.failFn(r.REQUEST)}),GeoGlobe.loadURL(o,r,this,function(t){e(t)},t)},isExist:function(){var e=!1,t=this.url;GeoGlobe.Request.GET({url:t,params:{REQUEST:"GetCapabilities",SERVICE:"CTS"},scope:this,async:!1,success:function(){e=!0}});return e},TransCoords:function(e,t,o){var r=this.url;GeoGlobe.Util.applyDefaults(e,{SERVICE:"CTS",REQUEST:"TransCoords"}),o||(o=function(){this.failFn(e.REQUEST)}),GeoGlobe.loadURL(r,e,this,function(o){if("xml"==e.FORMAT){var r={},i=o.responseXML;GeoGlobe.Function.bind(this.xmltoJson,this);var n=this.xmltoJson(i);r.attributes=n.CTS_TransResult["cts:Coordinate"].attributes.dim;for(var s=n.CTS_TransResult["cts:Coordinate"].text.split(","),a=[],l=0;l<s.length;l++)a.push(s[l]);r.coordvalue=a}else if("json"==e.FORMAT){r={},n=o.responseText;var u=(new GeoGlobe.Format.JSON).read(n);r.attributes=u.CTS_TransResult.dim,r.coordvalue=u.CTS_TransResult.Coordinate}t(r)},o)},xmltoJson:function(e){var t={};if(1==e.nodeType){if(e.attributes.length>0){t.attributes={};for(var o=0;o<e.attributes.length;o++){var r=e.attributes.item(o);t.attributes[r.nodeName]=r.nodeValue}}}else 3==e.nodeType&&(t=e.nodeValue);if(e.hasChildNodes())for(var i=0;i<e.childNodes.length;i++){var n=e.childNodes.item(i),s=n.nodeName.replace("ows:","");if(void 0===t[s=s.replace("#","")])t[s]=this.xmltoJson(n);else{if(void 0===t[s].push){var a=t[s];t[s]=[],t[s].push(a)}t[s].push(this.xmltoJson(n))}}return t},AffineTransform:function(e,t,o){var r=this.url;GeoGlobe.Util.applyDefaults(e,{SERVICE:"CTS",REQUEST:"AffineTransform"}),o||(o=function(){this.failFn(e.REQUEST)}),GeoGlobe.loadURL(r,e,this,function(o){if("xml"==e.FORMAT){var r={},i=o.responseXML;GeoGlobe.Function.bind(this.xmltoJson,this);var n=this.xmltoJson(i);r.attributes=n.CTS_AffineTransResult["cts:Coordinate"].attributes.dim;for(var s=n.CTS_AffineTransResult["cts:Coordinate"].text.split(","),a=[],l=0;l<s.length;l++)a.push(s[l]);r.coordvalue=a}else if("json"==e.FORMAT){r={},n=o.responseText;var u=(new GeoGlobe.Format.JSON).read(n);r.attributes=u.CTS_AffineTransResult.dim,r.coordvalue=u.CTS_AffineTransResult.Coordinate}t(r)},o)},CLASS_NAME:"GeoGlobe.Service.CTS"}),GeoGlobe.Service.WMS=GeoGlobe.Class4OL(GeoGlobe.Service,{initialize:function(e,t,o){GeoGlobe.Service.prototype.initialize.apply(this,arguments)},getCapabilities:function(e,t){var o=this.url,r={REQUEST:"GetCapabilities",SERVICE:"WMS"};t||(t=function(){this.failFn(r.REQUEST)}),GeoGlobe.loadURL(o,r,this,function(t){var o=t.responseXML;GeoGlobe.Function.bind(this.xmlToJson,this);var r,i=this.xmlToJson(o),n={},s=i.WMT_MS_Capabilities,a=s.Capability.Layer.Layer,l=s.Capability.Request;r=a.length?a[0]:a,n.version=s.attributes.version,n.format=l.GetMap.Format[1].text,n.layer=r.Title.text,n.bbox=r.BoundingBox.attributes.SRS,n.maxExtent=s.Capability.Layer.LatLonBoundingBox.attributes,e(n,i)},t)},isExist:function(){var e=!1,t=this.url;GeoGlobe.Request.GET({url:t,params:{REQUEST:"GetCapabilities",SERVICE:"WMS"},scope:this,async:!1,success:function(){e=!0}});return e},xmlToJson:function(e){var t={};if(1==e.nodeType){if(e.attributes.length>0){t.attributes={};for(var o=0;o<e.attributes.length;o++){var r=e.attributes.item(o);t.attributes[r.nodeName]=r.nodeValue}}}else 3==e.nodeType&&(t=e.nodeValue);if(e.hasChildNodes())for(var i=0;i<e.childNodes.length;i++){var n=e.childNodes.item(i),s=n.nodeName.replace("ows:","");if(void 0===t[s=s.replace("#","")])t[s]=this.xmlToJson(n);else{if(void 0===t[s].push){var a=t[s];t[s]=[],t[s].push(a)}t[s].push(this.xmlToJson(n))}}return t},getMap:function(e){this.url;var t={};return e.layers&&(t.LAYERS=e.layers),e.format&&(t.FORMAT=e.format),e.bbox&&(t.BBOX="{bbox-epsg-3857}"),e.width&&(t.WIDTH=e.width),e.height&&(t.HEIGHT=e.height),e.version&&(t.VERSION=e.version),e.SRS&&(t.SRS=e.SRS),GeoGlobe.Util.applyDefaults(t,{service:"WMS",request:"GetMap",TRANSPARENT:!0}),this.urlAppend(this.url,this.getParameterString(t||{}))},getParameterString:function(e){var t=[];for(var o in e){var r=e[o];if(null!=r&&"function"!=typeof r){var i;if("object"==typeof r&&r.constructor==Array){for(var n,s=[],a=0,l=r.length;a<l;a++)n=r[a],s.push(encodeURIComponent(null===n||void 0===n?"":n));i=s.join(",")}else i=r;t.push(encodeURIComponent(o)+"="+i)}}return t.join("&")},urlAppend:function(e,t){var o=e;if(t){var r=(e+" ").split(/[?&]/);o+=" "===r.pop()?t:r.length?"&"+t:"?"+t}return o},CLASS_NAME:"GeoGlobe.Service.WMS"}),GeoGlobe.Service.WMTS=GeoGlobe.Class4OL(GeoGlobe.Service,{initialize:function(e,t,o){GeoGlobe.Service.prototype.initialize.apply(this,arguments)},getCapabilities:function(e,t){var o=this.url,r={REQUEST:"GetCapabilities",SERVICE:"WMTS"};t||(t=function(){this.failFn(r.REQUEST)}),GeoGlobe.loadURL(o,r,this,function(t){var o=t.responseXML;GeoGlobe.Function.bind(this.xmlToJson,this);var r=this.xmlToJson(o),i=r.Capabilities,n={},s=i.Contents.Layer;s=s.length?s[0]:s,n.version=i.attributes.version;var a=i.Contents;n.layer=s.Title.text,n.LayerIdentifier=s.Identifier.text,n.StyleIdentifier=s.Style.Identifier.text,n.MatrixSet=s.TileMatrixSetLink[0].TileMatrixSet.text,n.Format=s.Format[1].text,n.Bounding=s.BoundingBox;var l="",u=a.TileMatrixSet[0].TileMatrix;if(u.length>0)for(var c=0,p=u.length;c<p&&c!=p;c++)l+=u[c].ScaleDenominator.text+",";n.Scales=l.substr(0,l.length-1),n.zoomOffset=u[0].Identifier.text,e(n,r)},t)},xmlToJson:function(e){var t={};if(1==e.nodeType){if(e.attributes.length>0){t.attributes={};for(var o=0;o<e.attributes.length;o++){var r=e.attributes.item(o);t.attributes[r.nodeName]=r.nodeValue}}}else 3==e.nodeType&&(t=e.nodeValue);if(e.hasChildNodes())for(var i=0;i<e.childNodes.length;i++){var n=e.childNodes.item(i),s=n.nodeName.replace("ows:","");if(void 0===t[s=s.replace("#","")])t[s]=this.xmlToJson(n);else{if(void 0===t[s].push){var a=t[s];t[s]=[],t[s].push(a)}t[s].push(this.xmlToJson(n))}}return t},isExist:function(){var e=!1,t=this.url;GeoGlobe.Request.GET({url:t,params:{REQUEST:"GetCapabilities",SERVICE:"WMTS"},scope:this,async:!1,success:function(){e=!0}});return e},getTile:function(e){var t={};return e.layer&&(t.LAYER=e.layer),e.format&&(t.FORMAT=e.format),e.tileMatrixSet&&(t.TILEMATRIXSET=e.tileMatrixSet),e.TILEMATRIX&&(t.TILEMATRIX=e.TILEMATRIX),e.TILEROW&&(t.TILEROW=e.TILEROW),e.TILECOL&&(t.TILECOL=e.TILECOL),e.version&&(t.VERSION=e.version),e.style&&(t.STYLE=e.style),GeoGlobe.Util.applyDefaults(t,{service:"WMTS",request:"GetTile"}),this.urlAppend(this.url,this.getParameterString(t||{}))},getParameterString:function(e){var t=[];for(var o in e){var r=e[o];if(null!=r&&"function"!=typeof r){var i;if("object"==typeof r&&r.constructor==Array){for(var n,s=[],a=0,l=r.length;a<l;a++)n=r[a],s.push(encodeURIComponent(null===n||void 0===n?"":n));i=s.join(",")}else i=r;t.push(encodeURIComponent(o)+"="+i)}}return t.join("&")},urlAppend:function(e,t){var o=e;if(t){var r=(e+" ").split(/[?&]/);o+=" "===r.pop()?t:r.length?"&"+t:"?"+t}return o},getCapabilitiesForRest:function(e,t){var o=this.url;o.match(/\/$/)||(o+="/"),o+="1.0.0/WMTSCapabilities.xml",t||(t=function(){this.failFn("GetCapabilities")}),GeoGlobe.loadURL(o,null,this,function(t){e(t)},t)},getTileForRest:function(e){var t=e.layer,o=e.style,r=e.tileMatrixSet,i=e.tileMatrix,n=e.tileRow,s=e.tileCol,a=null,l=e.format?e.format:"image/png";a||(a={"image/png":"png","image/png8":"png","image/png24":"png","image/png32":"png",png:"png","image/jpeg":"jpg","image/jpg":"jpg",jpeg:"jpg",jpg:"jpg"}[l]||l.split("/").pop());var u=t+"/"+o+"/"+r+"/"+i+"/"+n+"/"+s+"."+a,c=this.url;return c.match(/\/$/)||(c+="/"),c+=u},CLASS_NAME:"GeoGlobe.Service.WMTS"}),GeoGlobe.Analysis.BufferAnalysis=GeoGlobe.Class4OL({url:null,type:1,accuracy:32,initialize:function(e,t){this.url=e,GeoGlobe.Util.extend(this,t)},_buildPostXML:function(e,t){return'<?xml version="1.0" encoding="UTF-8" standalone="yes"?><wps:Execute service="WPS" version="1.0.0" xmlns:gml="http://www.opengis.net/gml" xmlns:wps="http://www.opengis.net/wps/1.0.0" xmlns:ows="http://www.opengis.net/ows/1.1" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.opengis.net/wps/1.0.0 ../wpsExecute_request.xsd"><ows:Identifier>Buffer</ows:Identifier><wps:DataInputs><wps:Input><ows:Identifier>InputPolygon</ows:Identifier><wps:Data><wps:ComplexData schema="http://foo.bar/MyComplexValueSchema.xsd" mimeType="text/xml" encoding="UTF-8">'+(new GeoGlobe.Format.GML).write(e)+"</wps:ComplexData></wps:Data></wps:Input><wps:Input><ows:Identifier>BufferDistance</ows:Identifier><wps:Data><wps:LiteralData>"+t+"</wps:LiteralData></wps:Data></wps:Input><wps:Input><ows:Identifier>BufferType</ows:Identifier><wps:Data><wps:LiteralData>"+this.type+"</wps:LiteralData></wps:Data></wps:Input><wps:Input><ows:Identifier>BufferAccuracy</ows:Identifier><wps:Data><wps:LiteralData>"+this.accuracy+"</wps:LiteralData></wps:Data></wps:Input></wps:DataInputs><wps:ResponseForm><wps:RawDataOutput><ows:Identifier>BufferedPolygon</ows:Identifier></wps:RawDataOutput></wps:ResponseForm></wps:Execute>"},_getFeaturesCenter:function(e){return this._getFeaturesExtent(e).getCenterLonLat()},_getFeaturesExtent:function(e){GeoGlobe.Util.isArray(e)||(e=[e]);var t=null;if(e&&e.length>0){t=new GeoGlobe.LngLatBounds;for(var o=null,r=0,i=e.length;r<i;r++)(o=e[r].geometry)&&t.extend(o.getBounds())}return t},startAnalysis:function(e,t,o){var r=(new GeoGlobe.Format.GeoJSON).read(e),i=this._getFeaturesCenter(r);switch(o&&-1!=GeoGlobe.Util.indexOf(["m","km","degree"],o)||(o="m"),o){case"km":t*=1e3;case"m":t=this._meterToDegree(t,i)}var n=this._buildPostXML(r,t);new GeoGlobe.Request.POST({url:this.url,data:n,scope:this,success:function(e){if(""!=e.responseText&&null!=e.responseText){var t=this._parserResult(e),o=(new GeoGlobe.Format.GeoJSON).write(t),r=(new GeoGlobe.Format.JSON).read(o);this.successFn(r)}else this.failFn()},failure:this.failFn})},_meterToDegree:function(e,t){var o=t.lat;return e*(899e-8/Math.cos(GeoGlobe.Util.rad(o)))},successFn:function(e){},failFn:function(){alert("缓冲分析操作失败，请检测服务是否正常运行。")},_parserResult:function(e){var t=new GeoGlobe.Format.XML;return e.responseXML||(e.responseXML=t.read(e.responseText)),(new GeoGlobe.Format.GML).read(e.responseXML)},CLASS_NAME:"GeoGlobe.Analysis.BufferAnalysis"}),GeoGlobe.Analysis.BufferAnalysis.CAP_ROUND=1,GeoGlobe.Analysis.BufferAnalysis.CAP_BUTT=2,GeoGlobe.Analysis.BufferAnalysis.CAP_SQUARE=3,GeoGlobe.Analysis.CoreBufferAnalysis=GeoGlobe.Class({url:null,type:"intersection",_requestStrTemplate:"{'BufferAnalysis': {'service': 'OverlapService','version': '1.0.0','layerName': '${layerName}','bufferRadius': '${bufferRadius}','bufferStyle':'${bufferStyle}','outPutFormat': 'JSON','bufferType': '${bufferType}','isSynchronization': 'true'}}",initialize:function(e,t){this.url=e,GeoGlobe.Util.extend(this,t)},_buildRequestStr:function(){return GeoGlobe.String.format(this._requestStrTemplate,{type:this.type,layerName:this.layerName,bufferRadius:this.bufferRadius,bufferStyle:this.bufferStyle,bufferType:this.bufferType})},startAnalysis:function(e){if(this._checkSet())return!1;var t=this._buildRequestStr();new GeoGlobe.Request.POST({url:this.url,data:t,scope:this,success:function(t){""!=t.responseText&&null!=t.responseText?this.successFn(t,e):this.failFn()},failure:this.failFn})},_checkSet:function(){if(!this.url)return!1},successFn:function(e){},failFn:function(){alert("缓冲分析操作失败，请检测服务是否正常运行")},CLASS_NAME:"GeoGlobe.Analysis.CoreBufferAnalysis"}),GeoGlobe.Analysis.GetFeature=GeoGlobe.Class4OL({url:null,type:"intersection",_reqStrTemplate:"{'GetFeature': {'service': 'OverlapService','version': '1.0.0','dataSource':'${sourceInputs}','Query': [{'typeName':'${dataInputs}'}],'maxFeatures': '','startPosition': '','outPutFormat': 'GeoJSON','resultType': ''}}",initialize:function(e,t){this.url=e,GeoGlobe.Util.extend(this,t)},_buildReqStr:function(){return GeoGlobe.String.format(this._reqStrTemplate,{type:this.type,dataInputs:this.typeName,sourceInputs:this.DataSource})},startAnalysis:function(e){if(this._checkSet())return!1;var t=this._buildReqStr();new GeoGlobe.Request.POST({url:this.url,data:t,scope:this,success:function(e){""!=e.responseText&&null!=e.responseText?this.successFn(e):this.failFn()},failure:this.failFn})},_checkSet:function(){if(!this.url)return!1},successFn:function(e){},failFn:function(){alert("服务请求操作失败，请检测服务是否正常运行。")},CLASS_NAME:"GeoGlobe.Analysis.GetFeature"}),GeoGlobe.Analysis.SpatialAnalysis=GeoGlobe.Class({url:null,type:"intersection",_requestStrTemplate:"{'SpatialAnalysis': {'service': 'OverlapService','version': '1.0.0','origionLayerNames': ['${origionLayerNames}'],'targetLayerNames': ['${targetLayerNames}'],'outPutFormat': 'GeoJSON','operator': '${dataInputs}','isSynchronization': 'true','tolerance': '${tolerance}'}}",initialize:function(e,t){this.url=e,GeoGlobe.Util.extend(this,t)},_buildRequestStr:function(){return GeoGlobe.String.format(this._requestStrTemplate,{type:this.type,dataInputs:this.operator,origionLayerNames:this.origionLayerNames,targetLayerNames:this.targetLayerNames,tolerance:this.tolerance})},startAnalysis:function(e){if(this._checkSet())return!1;var t=this._buildRequestStr();new GeoGlobe.Request.POST({url:this.url,data:t,scope:this,success:function(t){""!=t.responseText&&null!=t.responseText?this.successFn(t,e):this.failFn()},failure:this.failFn})},_checkSet:function(){if(!this.url)return!1},successFn:function(e){},failFn:function(){alert("叠置分析操作失败，请检测服务是否正常运行。")},CLASS_NAME:"GeoGlobe.Analysis.SpatialAnalysis"});